
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<title>Kalkulator klirensu kreatyniny – Vilda Clinic</title>
<link rel="manifest" href="manifest-klirens.webmanifest">
<!-- Configure the viewport to allow the page to extend into safe areas on devices with display cut‑outs -->
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<!-- Progressive Web App meta tags -->
<meta name="theme-color" content="#00838d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<!-- 1. IDENTYCZNA SZATA GRAFICZNA -->
<style>
:root {
  --primary: #00838d;
  --secondary: #00b0a6;
  --bg: #ffffff;
  --card: #f5f9f9;
  --text: #333;
  --radius: 8px;
  --shadow: 0 2px 6px rgba(0,0,0,.08);
  --danger: #c62828;
}
/*
 * Dodatkowe klasy użytkowe, aby ułatwić dostosowanie interfejsu użytkownika.
 *
 *  - .center-text: wyrównuje tekst do środka. Używamy go m.in. dla nagłówków
 *    sekcji, aby etykiety „Wybierz wersję kalkulatora” oraz nagłówki kart
 *    wyników były czytelnie wyśrodkowane.
 *  - .inline-checkbox-label: stosuje flexbox, aby tekst i pole wyboru były
 *    ustawione obok siebie w jednej linii, z niewielkim odstępem między nimi.
 *    Dodatkowo ustawia środkowanie całego wiersza, aby etykieta wraz z
 *    checkboxem była wyśrodkowana względem rodzica.
 *  - .white-checkbox: całkowicie nadpisuje domyślne style przeglądarki dla
 *    pola wyboru. Dzięki własnemu obramowaniu i białemu tłu checkboxy
 *    pozostają jasne nawet w ciemnym motywie systemu. Po zaznaczeniu
 *    rysujemy kolorowy „ptaszek” w kolorze motywu głównego.
 *  - .ktv-grid: wymusza układ pól KT/V w jednej kolumnie nawet na szerokich
 *    ekranach. Umożliwia zachowanie przejrzystości sekcji zaawansowanych
 *    obliczeń.
 */
.center-text {
  text-align: center;
}
.inline-checkbox-label {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  font-weight: 500;
  /* Nie zawijaj poszczególnych elementów w nowej linii, aby checkbox zawsze
     znajdował się obok tekstu.  Dzięki temu checkbox nie zsunie się pod
     tekst nawet na węższych ekranach. */
  flex-wrap: nowrap;
}
.white-checkbox {
  appearance: none;
  -webkit-appearance: none;
  width: 1.1em;
  height: 1.1em;
  border: 1px solid var(--text);
  border-radius: 4px;
  background-color: #fff;
  position: relative;
  cursor: pointer;
}
.white-checkbox:checked::after {
  content: '';
  position: absolute;
  top: 0.15em;
  left: 0.35em;
  width: 0.25em;
  height: 0.55em;
  border: solid var(--primary);
  border-width: 0 0.2em 0.2em 0;
  transform: rotate(45deg);
}
.ktv-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 6px;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  background: var(--bg);
  color: var(--text);
}
header {
  background: var(--primary);
  color: #fff;
  text-align: center;
  padding: 1rem;
}
h1 { margin: 0; font-size: clamp(1.4rem,3vw,2rem); }
.container { max-width: 960px; margin-inline: auto; padding: 1rem; }
fieldset {
  border: 1px solid #d0dede;
  background: var(--card);
  padding: 1.4rem 1rem 1rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 1.5rem;
  position: relative;
}
legend {
  font-weight: 600;
  color: var(--primary);
  background: var(--card);
  padding: 0 .6rem;
  font-size: 1rem;
  position: absolute;
  top: -0.7rem;
  left: 0;
}
label {
  display: block;
  margin-top: 0.7rem;
  font-size: 0.95rem;
}
input, select, option {
  font-family: system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  width: 100%;
  padding: 0.45rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1rem;
}

/*
 * The native select element can render slightly shorter than text inputs on some
 * platforms because the UA stylesheet uses a different internal line-height.
 * To ensure the unit selector for serum creatinine (ScrUnit) aligns neatly
 * with other input fields, give it an explicit height calculated from the
 * input’s font size, padding and borders. The calculation below mirrors
 * 1rem of text height, 0.9rem total vertical padding (0.45rem top and
 * bottom) and 2 px of border, yielding an overall height matching the
 * number inputs. Adjusting only this select avoids unexpectedly resizing
 * all dropdowns across the form.
 */
#ScrUnit {
  /*
   * Match the vertical height of the text inputs. Inputs inherit a
   * line‑height of roughly 1.2, so the height is the sum of that line
   * height (≈1.2 rem), the vertical padding (0.9 rem) and the 2 px borders.
   * Using calc(2.1rem + 2px) yields ~35.6 px, closely aligning the dropdown
   * with the number/text inputs across browsers. Padding is kept
   * consistent with other controls.
   */
  height: calc(2.1rem + 2px);
  padding: 0.45rem 0.65rem;
  line-height: 1rem;
}
.flex {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  /* Zapobiegamy rozciąganiu elementów na jednakową wysokość, aby uniknąć dużych pustych przestrzeni w polu „Parametry z surowicy i DZM” */
  align-items: flex-start;
}
.snack-row, .meal-row {
  display: grid;
  grid-template-columns: 1fr 100px 34px;
  gap: 0.5rem;
  align-items: center;
  margin-top: 0.5rem;
}
button.icon {
  background: none;
  border: none;
  font-size: 1.35rem;
  cursor: pointer;
  color: var(--danger);
  font-weight: 900;
  line-height: 1;
}
button.icon:hover { opacity: 0.8; }
button.add-row {
  background: var(--secondary);
  color: #fff;
  border: none;
  padding: 0.45rem 0.9rem;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 0.7rem;
}
button.add-row:hover { background: var(--primary); }
#results {
  display: none;
  flex-direction: column;
  gap: 1.5rem;
}
.card {
  /* Przywracamy oryginalny kolor tła kart (tzw. card), aby całe sekcje wyników pozostały w barwie motywu */
  background: var(--card);
  padding: 1rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.activity-time {
  margin: 0.4rem 0;
  font-size: 1.25rem;
  font-weight: 700;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0.6rem;
}
th, td {
  border: 1px solid #ddd;
  padding: 0.6rem;
  text-align: center;
  font-size: 0.95rem;
}
th {
  background: var(--secondary);
  color: #fff;
}
footer {
  margin-top: 2rem;
  text-align: center;
  font-size: 0.85rem;
  color: #666;
  padding: 1rem 0;
  background: #fafafa;
}
@media(min-width: 700px) {
  .grid-two {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
}

/* center calorie burn block */
#timesCard { text-align: center; }

/* Powiększone ramki wyników BMI i BMR */
.result-box {
  /* Zmieniamy kolor obramowania pól wyników na turkusowy jak nagłówek */
  border: 2px solid var(--primary);
  border-radius: 8px;
  padding: 10px;
  margin: 12px 0;
  font-size: 1.3rem;
  /* Domyślnie tło wyników ustawiamy na białe, aby kontenery były jaśniejsze */
  background: #ffffff;
  text-align: center;
  /* Dodajemy delikatny cień, aby pola wyników były spójne z kartami */
  box-shadow: var(--shadow);
}

/* --- legenda wewnątrz ramek fieldset --- */
fieldset {
  position: relative;
  padding-top: 1.0rem;   /* miejsce na legendę */
}
legend {
  position: absolute;
  top: 0;
  left: 0;
  font-size: 1.1rem;
  font-weight: 600;
  padding: 0 .5rem;
  background: var(--card); /* kolor karty, zakrywa linię ramki */
  border-radius: var(--radius);
}
/* zaokrąglone logo jak kontenery wyników */
header img {
  border-radius: var(--radius);
  display: inline-block; /* opcjonalnie, żeby mieć pewność */
}
/* Wyśrodkowanie nagłówka w karcie "Droga do normy BMI" */
#toNormCard h2 {
  text-align: center;
}

html, body {
  height: 100%;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  scroll-behavior: smooth;
}
/* =====================  UI REFINEMENTS – 2025‑06‑29  ===================== */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
body {
  font-size: 16px;
  line-height: 1.5;
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}

/* Styl raportu PDF – wyświetlany tylko podczas generowania PDF. Używa większych fontów
   i klarownego układu, aby raport był czytelny na jednej stronie A4. */
#pdfReport {
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  font-size: 14px;
  line-height: 1.4;
  color: var(--text);
  width: 100%;
  max-width: 180mm; /* ogranicz szerokość raportu, aby zmieścił się na stronie A4 (210 mm minus marginesy) */
  margin: 0 auto;
  padding: 0;
}
#pdfReport .section {
  margin-bottom: 10px;
  page-break-inside: avoid;
}
#pdfReport h2 {
  font-size: 22px;
  margin: 0 0 6px;
  color: var(--primary);
}
#pdfReport h3 {
  font-size: 16px;
  margin: 8px 0 4px;
  color: var(--secondary);
}
#pdfReport p {
  margin: 2px 0;
}
#pdfReport .result-item {
  margin: 2px 0;
  font-size: 14px;
}
#pdfReport .result-item strong {
  font-weight: 600;
}
#pdfReport .range {
  color: #666;
  font-style: italic;
  margin-left: 2px;
}
#pdfReport .out-of-range {
  color: var(--danger);
  font-weight: 600;
}

/* Buttons */
button,
input[type="button"],
input[type="submit"] {
  cursor: pointer;
  font: inherit;
  border: none;
  border-radius: var(--radius);
  padding: 0.55rem 1.1rem;
  background: var(--primary);
  color: #fff;
  transition: background 0.2s ease, box-shadow 0.2s ease;
}
button:hover,
input[type="button"]:hover,
input[type="submit"]:hover {
  background: var(--secondary);
  box-shadow: var(--shadow);
}
button:disabled {
  opacity: 0.45;
  cursor: not-allowed;
}

/* Icon (×) buttons inside rows */
button.icon {
  background: transparent;
  color: var(--danger);
  font-size: 1.25rem;
  padding: 0.25rem 0.5rem;
  line-height: 1;
}
button.icon:hover {
  background: rgba(198,40,40,0.1);
}

/* Inputs & selects */
input[type="number"],
input[type="text"],
select {
  width: 100%;
  max-width: 100%;
  padding: 0.45rem 0.65rem;
  border: 1px solid #d0d7da;
  border-radius: var(--radius);
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
input:focus,
select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(0,131,141,0.25);
}

/* Table design */
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 0.6rem 0.75rem;
  text-align: left;
}
thead th {
  background: var(--primary);
  color: #fff;
  font-weight: 600;
}
tbody tr:nth-child(odd) {
  /* Tło kart z wynikami ustawione na białe, zgodnie z prośbą użytkownika */
  background: #ffffff;
}
tbody tr:hover {
  background: rgba(0,176,166,0.08);
}

/* Card shadow & radius unification */
/* Przywracamy kolor tła sekcji (np. kart klirensu) do barwy motywu, pozostawiając białe tło tylko dla pól wyników (.result-box) */
section.card,
#toNormCard {
  border-radius: var(--radius);
  background: var(--card);
  box-shadow: var(--shadow);
  padding: 1rem;
}

/* Responsive horizontal scrolling for wide tables */
.table-scroll {
  overflow-x: auto;
}
.table-scroll > table {
  min-width: 520px;
}

/* Utility */
.text-center { text-align: center; }
.text-right { text-align: right; }

/* Mobile tweaks */
@media(max-width: 600px) {
  th, td { padding: 0.5rem; }
  button, input[type="button"], input[type="submit"] {
    width: 100%;
    margin-top: 0.5rem;
  }

/* (Przycisk czyszczenia formularza jest definiowany poza blokiem mediów. */
}

/* ======================================================================== */

/* ---------- Przycisk czyszczenia formularza ---------- */
/* Kontener otaczający przycisk ma pełną szerokość formularza i
 * wyśrodkowuje jego zawartość.  Margines dolny oddziela go od
 * kolejnej sekcji formularza.  Domyślnie kontener jest ukryty,
 * a jego widoczność jest sterowana przez logikę JS po wypełnieniu
 * minimalnej liczby pól potrzebnych do obliczeń. */
#clearContainer {
  width: 100%;
  text-align: center;
  margin-bottom: 1rem;
  display: none;
}
/* Sam przycisk wykorzystuje kolor zmiennej --danger, białe litery
 * oraz zaokrąglone narożniki.  Po najechaniu kursorem przycisk
 * staje się delikatnie jaśniejszy. */
#clearBtn {
  background: var(--danger);
  color: #fff;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
}
#clearBtn:hover {
  opacity: 0.9;
}
/* === FORM GRID LAYOUT 2025‑07‑02 FIX === */
#clcrForm {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  grid-template-rows: auto 1fr;
  gap: 1rem;
}
#clcrForm > div {
  display: flex;
  flex-direction: column;
}
#clcrForm > div fieldset {
  flex: 1 1 auto;
}
#clcrForm > .patient-card {
  grid-column: 1 / -1;
  align-self: start;
}
#clcrForm > .patient-card fieldset {
  height: auto;
}

/* === RESULT HIGHLIGHT 2025‑06‑29 ===================== */
:root {
  --brand: #00838d;
  --brand-light: #00b0a6;
  --card-bg: #ffffff;
  --radius: 12px;
  --shadow-s: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-l: 0 4px 22px rgba(0,0,0,0.14);
  --anim-fast: 150ms ease;
}

/* === Kalkulator version selection === */
.version-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 1rem;
}
.version-option {
  border: 1px solid #d0dede;
  background: var(--card);
  padding: 1rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  cursor: pointer;
  font-weight: 600;
  text-align: center;
}
.version-option.selected {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(0,131,141,0.25);
}
.version-option.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
button,
input[type="submit"] {
  transition: transform var(--anim-fast), box-shadow var(--anim-fast);
}
button:hover,
input[type="submit"]:hover,
button:focus-visible,
input[type="submit"]:focus-visible {
  transform: translateY(-1px) scale(1.02);
  box-shadow: var(--shadow-l);
}

.result-card {
  background: var(--card-bg);
  border: 2px solid var(--brand);
  border-radius: var(--radius);
  box-shadow: var(--shadow-s);
  padding: 1.25rem 1.5rem;
  position: relative;
  overflow: hidden;
}
.result-card.--pulse::after {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--brand-light);
  opacity: 0;
  z-index: -1;
  animation: pulseBG 1s ease-out forwards;
}
@keyframes pulseBG {
  0% { opacity: 0.15; }
  100% { opacity: 0; }
}

.result-number {
  font: 600 2.75rem/1 "Inter", sans-serif;
  letter-spacing: -0.02em;
  color: var(--brand);
  display: inline-flex;
  align-items: flex-end;
}
.result-number small {
  font-size: 0.45em;
  margin-left: 0.1em;
  color: #444;
}

@keyframes fadeSlideUp {
  0% { opacity: 0; transform: translateY(12px); }
  100% { opacity: 1; transform: translateY(0); }
}
.animate-in {
  animation: fadeSlideUp 0.45s cubic-bezier(0.4,0,0.2,1);
}

@media (prefers-reduced-motion: reduce) {
  * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; }
}

/* === DATA CARDS 2025‑06‑29 ===================== */
.data-card {
  background: var(--card);
  border: 2px solid var(--primary);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 1.25rem 1rem;
  overflow: auto;
}

.data-card table {
  width: 100%;
  border-collapse: collapse;
}

.data-card thead {
  background: var(--primary);
  color: #fff;
}

.data-card th,
.data-card td {
  padding: 0.4rem 0.6rem;
  text-align: center;
}

.data-card tr:nth-child(even) {
  background: rgba(0,0,0,0.03);
}

/* === PLAN RESULTS TWO-COLUMN LAYOUT 2025‑06‑30 === */
#planResults {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
@media(max-width: 600px) {
  #planResults {
    grid-template-columns: 1fr;
  }
}

/* === BMI & BMR BLOCK FRAME PATCH 2025‑06‑30 === */
#bmiCard {
  border: 1px solid #d0dede;
}

/* === TIMES CARD FRAME PATCH 2025‑06‑30 === */
#timesCard {
  border: 1px solid #d0dede;
}

/* === UI TWEAKS – 50 centyl & Plan (2025‑06‑30) === */
.bmi50-info {
  font-size: 1.3rem !important;
  font-weight: 600;
  display: block;
  margin-top: 6px;
}
.bmi50-info .bmi50-number {
  font-size: 1.4rem;
  font-weight: 600;
}
.plan-time {
  font-size: 1.5rem;
  font-weight: 600;
  display: inline-block;
  margin-bottom: 2px;
}

/* === PATCH 2025‑07‑01 – PLAN & 50 centyl UI === */
.small-50 { font-size: 0.1rem; font-weight: 500; }
.plan-time, .plan-month, .plan-year {
  font-size: 1.5rem;
  font-weight: 600;
  display: inline-block;
  margin-bottom: 2px;
}

/* === PLAN CARD – override font size ONLY in plan columns (added 2025‑07‑01) === */
.plan-col .result-number {
  font-size: 1.4rem;
  font-weight: 600;
}

/* === SPACING FIX FOR FIELDSETS – 2025‑08‑01 ===
   Zastępujemy układ grid dla formularza #clcrForm układem kolumnowym flex,
   aby sekcje (Dane pacjenta, Parametry z surowicy i DZM, Parametry z dobowej zbiórki moczu)
   były rozmieszczone w równych odstępach pionowych. Dodatkowo param-row
   jest układem poziomym flex na duże ekrany z zawijaniem, a param-col definiuje
   minimalną szerokość każdej kolumny. */
#clcrForm {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  /* nadpisujemy wrap i align-items z klasy .flex, aby elementy nie zawijały się i
     każdy wiersz zajmował całą szerokość formularza */
  flex-wrap: nowrap;
  align-items: stretch;
}
/* Specjalne dopasowanie kontenera z parametrami – element param-row musi
   nadpisać domyślne ustawienia #clcrForm > div, aby kolumny były ustawione obok
   siebie i miały niezależną wysokość. */
#clcrForm > .param-row {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 1rem;
}
#clcrForm > .param-row > .param-col {
  flex: 1 1 320px;
}

/* === WIDTH EQUALIZATION FOR PATIENT FIELDSET (2025‑08‑03) ===
   Aby sekcja „Dane pacjenta” miała identyczną szerokość jak pola
   „Parametry z surowicy i DZM” oraz „Parametry z dobowej zbiórki moczu”,
   ograniczamy jej szerokość na dużych ekranach do połowy szerokości
   kontenera formularza (z uwzględnieniem odstępu między kolumnami).
   Na mniejszych ekranach pole to wypełnia całą dostępną szerokość,
   dzięki czemu zachowujemy spójny wygląd zarówno w widoku mobilnym,
   jak i w trybie PC. */
@media (min-width: 700px) {
  #clcrForm > .patient-card {
    /* Aby sekcja „Dane pacjenta” miała dokładnie taką samą szerokość
       jak pojedyncza kolumna wiersza parametrów, obliczamy ją na podstawie
       sumy szerokości dwóch kolumn param-row oraz odstępu między nimi.
       Każda kolumna param-row zajmuje połowę szerokości wiersza
       pomniejszoną jedynie o odstęp między kolumnami (1 rem). Dlatego
       odejmujemy jedynie tę przerwę, a nie całkowity padding kontenera. */
    width: calc((100% - 1rem) / 2);
    /* Zapobiegamy automatycznemu rozciąganiu, aby zachować powyższą szerokość. */
    flex: 0 0 auto;
  }
}
@media (max-width: 699px) {
  #clcrForm > .patient-card {
    /* Na małych ekranach sekcja wypełnia pełną szerokość kontenera,
       tak jak pozostałe pola, co zapewnia spójny układ. */
    width: 100%;
  }
}

/* === PATCH 2025‑07‑01 – pełna szerokość karty Inne wskaźniki === */
#elecCard { grid-column: 1 / -1; }
#elecInfo {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
#elecInfo .result-box {
  /*
     Domyślnie każda karta wyniku zajmuje co najmniej około 260 px
     szerokości i może rosnąć w zależności od dostępnego miejsca.
     Ustawiamy min-width na 0, aby elementy mogły się zmniejszać
     poniżej swojego flex-basis bez generowania poziomego przewijania.
  */
  flex: 1 1 260px;
  min-width: 0;
}

/*
  W widokach mobilnych (np. telefony w orientacji pionowej) wymuszamy,
  aby każdy wynik był wyświetlany w osobnym wierszu na pełną
  szerokość kontenera. Dzięki temu długie etykiety nie będą
  wychodziły poza granice sekcji, a układ pozostanie czytelny.
*/
@media (max-width: 600px) {
  #elecInfo .result-box {
    flex: 1 1 100%;
  }
}

/* === OUT-OF-RANGE HIGHLIGHT === */
/* === STAGE HIGHLIGHT COLORS (KDIGO G3a/G3b) === */
.result-box.warn-orange {
  background: #fff3e0;   /* jasny pomarańczowy */
  border-color: #ffa726; /* pomarańcz */
}
.result-box.warn-orange strong {
  color: #ef6c00;
}
.result-box.warn-yellow {
  background: #fffde7;   /* jasny żółty */
  border-color: #fff176; /* żółty */
}
.result-box.warn-yellow strong {
  color: #fbc02d;
}

.result-box.out-of-range {
  background: #ffebee;
  border-color: #e57373;
}
.result-box.out-of-range strong {
  color: #c62828;
}

/* === EQUAL HEIGHT INPUT CARDS (2025-07-02) === */
/* Modyfikujemy układ formularza #clcrForm tak, aby stosował flexbox w pionie zamiast
   siatki. Dzięki temu każda sekcja formularza (Dane pacjenta, Parametry z surowicy i DZM,
   Parametry z dobowej zbiórki moczu) jest renderowana jako osobny wiersz o wysokości
   dopasowanej do zawartości, a odstępy między nimi określa właściwość gap. */
#clcrForm {
  display: flex !important;
  flex-direction: column;
  gap: 1rem;
}
#clcrForm > div {
  display: flex;
  flex-direction: column;
}
#clcrForm fieldset {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
}
/* helper boxes (optional) fill remaining flex space */
.helper-box {
  margin-top: auto;
  font-size: 0.85rem;
  color: #555;
  background: #eef4f4;
  border: 1px dashed var(--primary);
  border-radius: var(--radius);
  padding: 0.6rem;
}

#clcrForm {
  /* Finalna definicja formularza wykorzystuje flexbox w pionie,
     zapewniając równe odstępy między sekcjami bez sztucznego wydłużania wierszy. */
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
#clcrForm > div {
  display: flex;
  flex-direction: column;
  min-width: 0;  /* avoid overflow */
}
#clcrForm > div.patient-card {
  grid-column: 1 / -1;
}
/* two-column layout inside patient fieldset */
#patientSet {
  display: grid;
  grid-template-columns: 1fr 1fr;
  column-gap: 1rem;
}
/* make labels stretch full width inside patient grid */
#patientSet label {
  margin-top: 0.7rem;
}

/* === FULL‑WIDTH “Klirens / eGFR” CARD (2025‑07‑02) === */
#clcrCard {
  grid-column: 1 / -1;  /* rozciąga się na obie kolumny kontenera #results */
}
  /* ------- Walidacja i podpowiedzi ------- */
  .validation-message {
    color: var(--danger);
    font-size: 0.8rem;
    line-height: 1.2;
  }
  .error {
    border-color: var(--danger) !important;
  }
  .info-icon {
    margin-left: 4px;
    cursor: help;
    color: var(--primary);
    font-size: 1rem;
    line-height: 1;
    vertical-align: middle;
    display: inline-block;
  }
  .info-icon:hover {
    color: var(--primary);
  }
  /* additional classes for validation and tooltips */
  .input-error    { border: 2px solid #d00 !important; }
  .tooltip-icon   { cursor: help; font-weight: bold; color: #36c; margin-left: 4px; }

  /* simple cards used for extra sections (e.g. advanced KT/V) */
  /* Ujednolicony wygląd kart – zaokrąglone narożniki jak w innych sekcjach */
  .card{ border: 1px solid #ccc; padding: 12px; margin: 12px 0; border-radius: var(--radius); }
  .card h2{ margin-top: 0; font-size: 1.1rem; text-align: left; }

  /* Layout for advanced KT/V fields: use flex instead of grid to align labels and icons like other inputs */
  #ktvFields > div {
    /* Utrzymuj poziome ułożenie pola i przycisku Info bez zawijania.  
       Poprzednio włączony flex-wrap pozwalał przyciskowi Info zsuwać się pod pole,  
       dlatego wymuszamy nowrap, aby elementy pozostały w jednym wierszu jak w innych sekcjach. */
    display: flex;
    flex-wrap: nowrap;
    gap: 6px;
  }
  #ktvFields label {
    flex: 1 1 160px;
  }

  /* Make form fields white regardless of system dark/light mode */
  input,
  select,
  option {
    background-color: #fff;
    color: var(--text);
  }

  /* === MOBILE BUTTON PADDING – 2025‑08‑03 === */
  @media (max-width: 600px) {
    #downloadPDF,
    #downloadDOCX,
    #askAI {
      /* szerokość jak pola w .container → 100 % minus 2 × 1 rem wewn. odstępu  */
      width: calc(100% - 2rem);
      /* identyczny odstęp boczny jak .container (1 rem) */
      margin-left: 1rem;
      margin-right: 1rem;
    }
  }

  /* === AI FIELDSET WIDTH FIX – 2025‑08‑04 === */
  /*
     Sekcja „Interpretacja AI” jest zawarta w elemencie <fieldset> poza
     głównym kontenerem. Nadawanie jej maksymalnej szerokości 960 px
     powodowało, że w wąskich widokach była szersza niż pozostałe
     karty (takie jak „Inne wskaźniki”). Przywracamy domyślną szerokość,
     aby pole to dziedziczyło szerokość z elementu nadrzędnego, oraz
     stosujemy te same marginesy boczne jak w przypadku przycisków.
  */
  #aiFieldset {
    width: 100%;
    /* Używamy !important, aby nadpisać inline-style "max-width:960px" ustawiony
       na elemencie <fieldset>. Dzięki temu sekcja AI odziedziczy pełną
       szerokość kontenera zamiast ograniczać się do 960 px. */
    max-width: none !important;
  }
  @media (max-width: 600px) {
    #aiFieldset {
      width: calc(100% - 2rem);
      margin-left: 1rem;
      margin-right: 1rem;
    }
  }

  /* === EQUAL HEIGHT PARAM-SECTIONS IN LANDSCAPE – 2025‑08‑03 === */
  /*
     W widoku poziomym (ekrany szersze niż ~700 px) wyrównujemy wysokość
     kolumn z parametrami z surowicy/DZM oraz dobowej zbiórki moczu.
     Domyślnie flexbox rozciąga elementy po przekątnej tylko wtedy, gdy
     align-items ustawione jest na "stretch". Wcześniejsze poprawki
     ustawiają align-items: flex-start, co zapobiegało rozciąganiu
     krótszej kolumny i skutkowało nierównymi wysokościami. Teraz
     przywracamy zachowanie stretch tylko dla wiersza parametrów na
     szerokich ekranach. Dzięki temu sekcja „Parametry z surowicy i DZM”
     w widoku poziomym będzie równa wysokością sekcji „Parametry z
     dobowej zbiórki moczu” i rozciągnie się do dolnej granicy tego
     kontenera.
  */
  @media (min-width: 700px) {
    #clcrForm > .param-row {
      align-items: stretch;
    }
    /* Upewniamy się, że same fieldsety w kolumnach wypełniają przestrzeń
       wysokościową, aby rozciąganie było widoczne. */
    #clcrForm > .param-row > .param-col {
      display: flex;
      flex-direction: column;
    }
    #clcrForm > .param-row > .param-col fieldset {
      /* elementy fieldset elastycznie wypełniają dostępną przestrzeń */
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }
  }

  /* === PLACEHOLDER ROWS FOR SYMMETRY – 2025‑08‑03 === */
  /* Wiersze o klasie .placeholder-row są używane jako niewidoczne odstępy w
     sekcji „Parametry z surowicy i DZM”, aby liczba rzędów w lewej
     kolumnie odpowiadała liczbie pól w kolumnie prawej. W widoku
     poziomym są niewidoczne, ale zachowują wysokość dzięki
     visibility:hidden. W widoku pionowym całkowicie je ukrywamy, aby
     uniknąć dużych pustych przestrzeni. */
  .placeholder-row {
    visibility: hidden;
  }
  @media (max-width: 699px) {
    .placeholder-row {
      display: none;
    }
  }

  /* Hide any info-wrapper following a placeholder row.  Without this rule,
     the automatically inserted .input-group would remain visible in the DOM,
     resulting in blank unlabeled fields.  This rule ensures the wrapper
     stays hidden on all screen sizes. */
  .placeholder-row + .input-group {
    display: none !important;
  }

  /* === INFO‑BUTTON & TOOLTIP – 2025‑08‑03 === */

  /* kontener input + przycisk Info */
  .input-group{
    position:relative;
    display:flex;
    align-items:stretch;
    gap:0.5rem;
  }
  .input-group input,
  .input-group select{
    flex:1 1 auto;           /* przejmij całą dostępną szerokość */
  }

  /* przycisk Info */
  .info-btn{
    flex:0 0 auto;
    background:#00b0a6;      /* turkus – dopasuj do motywu */
    color:#fff;
    font-weight:600;
    border:none;
    border-radius:var(--radius,6px);
    padding:0.5rem 1rem;
    cursor:pointer;
    transition:background .2s,transform .15s;
  }
  .info-btn:hover{background:#00838d;}
  .info-btn:focus{
    outline:2px solid #00838d;
    outline-offset:2px;
  }

  /* dymek */
  .tooltip{
    display:none;            /* ukryty domyślnie */
    position:absolute;
    top:100%; left:0;
    margin-top:0.35rem;
    max-width:280px;
    padding:0.75rem;
    background:#f0f9f9;      /* jasny turkus */
    color:#000;
    border:1px solid #00b0a6;
    border-radius:4px;
    box-shadow:0 2px 8px rgba(0,0,0,.15);
    z-index:1000;
  }
  /* strzałka */
  .tooltip::before{
    content:"";
    position:absolute;
    top:-6px; left:22px;
    border:6px solid transparent;
    border-bottom-color:#f0f9f9;
  }
  /* widoczny dymek */
  .tooltip.visible{display:block;}

  /* Dodatkowa logika dla pól typu checkbox: zawijaj elementy wewnątrz, aby przycisk Info nie wychodził poza kontener */
  .wrap-info{
    flex-wrap: wrap;
  }
  /* Nie rozciągaj pól typu checkbox na całą szerokość w obrębie .wrap-info */
  .wrap-info input[type="checkbox"],
  .wrap-info select[type="checkbox"]{
    flex: 0 0 auto;
  }
  /* Gdy przycisk Info znajduje się obok checkboxa, pozwól mu zawijać się na nową linię bez rozciągania na pełną szerokość */
  .wrap-info .info-btn{
    flex: 0 0 auto;
    margin-top: 0.25rem;
  }

  /* mobile: keep the same horizontal alignment for the Info button as on larger screens.
     Previously we switched the .input-group to a 2/3‑1/3 grid on narrow screens, which
     caused the Info buttons to take up one third of the available width and
     mis‑align relative to their inputs. To ensure the placement and alignment of the
     Info buttons remains consistent between single‑column and two‑column layouts,
     we retain the flex layout on small screens and let the button size itself to
     its content. */
  @media(max-width:600px){
    .input-group{
      display:flex;          /* remain a horizontal flex container */
      align-items:stretch;   /* match the height of its children */
    }
    .info-btn{
      width:auto;            /* do not force full width; size based on content */
      align-self:stretch;    /* match input height */
    }
  }

  /* Center Info buttons for specific checkbox fields. The toggle for advanced KT/V
     calculations (#ktvToggle) and the option to include KT/V in the AI report
     (#includeKTV) are rendered as checkboxes with an adjacent Info button. By default
     checkbox wrappers (.wrap-info) add a top margin to the Info button which pushes it
     down and misaligns it with the checkbox and label. The rules below remove that
     top margin and vertically center the button within the wrapper. */
  #ktvToggle + .info-btn,
  #includeKTV + .info-btn {
    margin-top: 0;
    align-self: center;
  }

  /* When a wrapper has the .center-info class (added in the JS for specific
     checkbox fields), center the checkbox and its Info button horizontally.
     We rely on flexbox to distribute space around the two children evenly. */
  .center-info {
    justify-content: center;
  }
  .center-info .info-btn {
    margin-top: 0;
  }
  /* --------------------------------------------------------------------
   * PWA/iOS dostosowania
   *
   * Na urządzeniach z iOS (np. iPhone z Dynamic Island) należy uwzględnić
   * bezpieczny obszar u góry ekranu.  Dodając wysokość safe‑area do górnego
   * paddingu nagłówka zapobiegamy nakładaniu się logo i tytułu na wycięcie.
   */
  header {
    padding-top: calc(1rem + env(safe-area-inset-top));
  }
</style>

  <!-- Manifest and icons for PWA installation -->
  <link rel="manifest" href="manifest-klirens.webmanifest">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
  <!-- Use the new 180×180 icon from the provided icon set for better iOS integration -->
  <link rel="apple-touch-icon" href="icons-klirens/icon-180.png">

<!-- 2. BIBLIOTEKI -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Biblioteka do generowania plików DOCX. Jeśli z jakiegoś powodu nie zostanie załadowana (np. brak internetu), skrypt wykorzysta prosty fallback HTML/RTF. -->
    <script src="https://cdn.jsdelivr.net/npm/docx@7.7.0/build/index.js"></script>
</head>

<body>
<header>
  <img src="logo_vilda.jpeg" alt="Vilda Clinic logo" style="max-width:160px;margin-bottom:10px;border-radius:var(--radius);">
  <h1>Kalkulator klirensu kreatyniny / eGFR</h1>
</header>

<div class="container">

  <!-- 3. FORMULARZ DANYCH PACJENTA -->
  <form id="clcrForm" class="flex" onsubmit="return false;">
    <div class="patient-card" style="flex:1 1 300px;">
      <fieldset id="patientSet"><legend>Dane pacjenta</legend>
        <label>Imię i nazwisko:
          <input type="text" id="fullName"></label>
        <label>Wiek (lata):
          <input type="number" id="age" min="0" max="120" required></label>
        <label>Płeć:
          <select id="sex">
            <option value="M">Mężczyzna</option>
            <option value="F">Kobieta</option>
          </select></label>
        <label>Masa ciała (kg):
          <input type="number" id="weight" min="2" max="300" required></label>
        <label>Wzrost (cm):
          <input type="number" id="height" min="30" max="250" required></label>
      </fieldset>
    </div>
    <!-- Wybór wersji kalkulatora: Podstawowy / Zaawansowany / Profesjonalny -->
    <div id="versionContainer" class="version-container">
      <!-- Wyśrodkowane pole z etykietą wyboru wersji kalkulatora -->
      <p class="center-text" style="font-weight:600;margin:0 0 0.5rem;">Wybierz wersję kalkulatora</p>
      <div id="version-basic" class="version-option" data-version="basic">Podstawowy</div>
      <div id="version-advanced" class="version-option" data-version="advanced">Zaawansowany</div>
      <!-- Odblokowujemy wersję profesjonalną (usunięto klasę disabled) -->
      <div id="version-pro" class="version-option" data-version="pro">Profesjonalny</div>
    </div>
    <!-- Kontener z przyciskiem do całkowitego czyszczenia formularza.  Początkowo
         jest on niewidoczny; zostanie pokazany dopiero po podaniu minimalnych
         danych (wiek, masa, wzrost, kreatynina w surowicy), tak aby
         użytkownik mógł szybko wyczyścić wszystkie pola przed wprowadzeniem
         nowego pacjenta.  Element znajduje się między sekcją „Dane pacjenta”
         a pierwszą kolumną parametrów, co zapewnia dobrą widoczność w
         układzie formularza. -->
    <div id="clearContainer" style="display:none;">
      <button id="clearBtn" type="button">Wyczyść wszystkie pola</button>
    </div>

    <div class="param-row" style="display:none;">
      <div class="param-col">
        <fieldset><legend>Parametry z surowicy i DZM</legend>
        <!-- Pole kreatyniny z możliwością wyboru jednostki (mg/dl lub µmol/L) -->
        <!-- Podział pola kreatyniny w surowicy na dwie osobne linie: wartość oraz jednostka.
             Dzięki temu w widoku poziomym każdy wiersz zajmuje jedną komórkę siatki,
             co ułatwia wyrównanie pól po lewej i prawej stronie. -->
        <label>Kreatynina w surowicy:
          <input type="number" step="0.01" id="Scr" required>
        </label>
        <label>Jednostka kreatyniny w surowicy:
          <select id="ScrUnit">
            <option value="mg/dl">mg/dl</option>
            <option value="umol">µmol/L</option>
          </select>
        </label>
        <label>Kreatynina w moczu 24 h (mg/dl):
          <input type="number" step="0.1" id="Ucr"></label>
        <label>Objętość dobowej zbiórki moczu (ml):
          <input type="number" id="V24" placeholder="np. 1500"></label>

        <label class="advanced-field">Sód (Na, mmol/L):
          <input type="number" id="S_Na" step="0.1"></label>
        <label class="advanced-field">Potas (K, mmol/L):
          <input type="number" id="S_K" step="0.1"></label>
        <label class="advanced-field">Chlorki (Cl, mmol/L):
          <input type="number" id="S_Cl" step="0.1"></label>
        <label class="advanced-field">HCO₃⁻ (mmol/L):
          <input type="number" id="S_HCO3" step="0.1"></label>
        <label class="advanced-field">Fosfor (PO₄, mg/dl):
          <input type="number" id="S_PO4" step="0.1"></label>
        <label class="advanced-field">Kwas moczowy (mg/dl):
          <input type="number" id="S_UA" step="0.1"></label>
        <!-- === KAMICA (krew / próbka moczu) — START === -->
        <label class="advanced-field pro-field">Wapń całkowity (Ca, mg/dl):
          <input type="number" id="S_Ca" step="0.1"></label>

        <label class="advanced-field pro-field">pH pojedynczej próbki moczu:
          <input type="number" id="U_pH" step="0.01" placeholder="np. 5.8"></label>

        <!-- Zamiast podawać stosunek Ox/Cr i Cit/Cr użytkownik wprowadza stężenie
             szczawianów i cytrynianów w pojedynczej próbce moczu.  Kalkulator
             sam obliczy stosunek do kreatyniny na podstawie podanej kreatyniny
             z dobowej zbiórki. -->
        <label class="advanced-field pro-field">Szczawiany w próbce moczu (Ox, mg/dl):
          <input type="number" id="Ox_Cr_spot" step="0.1"></label>

        <label class="advanced-field pro-field">Cytryniany w próbce moczu (Cit, mg/dl):
          <input type="number" id="Cit_Cr_spot" step="1"></label>

        <label class="advanced-field pro-field">Parathormon (PTH, pg/ml):
          <input type="number" id="S_PTH" step="1"></label>

        <label class="advanced-field pro-field">25‑hydroksy‑witamina D (25‑OHD, ng/ml):
          <input type="number" id="S_VitD" step="1"></label>
        <!-- === KAMICA (krew / próbka moczu) — END === -->
        <!-- Dodajemy ukryte wiersze do wyrównania liczby pól z kolumną po prawej stronie.
             Dzięki temu każdy wiersz po lewej i prawej stronie ma tę samą wysokość
             w widoku poziomym, a cała sekcja pozostaje symetryczna. Wiersze te
             pozostają niewidoczne (przez visibility:hidden), zachowując jednak
             swoją wysokość. Na małych ekranach są całkowicie ukrywane (display:none)
             za pomocą odpowiedniej klasy CSS. -->
        <label class="placeholder-row advanced-field"><input type="number" style="visibility:hidden;"></label>
        </fieldset>
      </div>
      <div class="param-col advanced-field">
        <fieldset><legend>Parametry z dobowej zbiórki moczu</legend>
        <label>Sód (Na, mmol/L):
          <input type="number" id="U_Na" step="0.1"></label>
        <label>Potas (K, mmol/L):
          <input type="number" id="U_K" step="0.1"></label>
        <label>Chlorki (Cl, mmol/L):
          <input type="number" id="U_Cl" step="0.1"></label>
        <label>HCO₃⁻ (mmol/L):
          <input type="number" id="U_HCO3" step="0.1"></label>
        <label>Fosfor (PO₄, mg/dl):
          <input type="number" id="U_PO4" step="0.1"></label>
        <label>Kwas moczowy (mg/dl):
          <input type="number" id="U_UA" step="0.1"></label>
        <!-- Zmiana jednostek: wapń w mmol/L, magnez w mg/L, białko całkowite w mg/24 h -->
        <label>Wapń (Ca, mmol/L):
          <input type="number" id="U_Ca" step="0.1"></label>
        <label>Magnez (Mg, mg/L):
          <input type="number" id="U_Mg" step="0.1"></label>
        <label>Białko całkowite (mg/24 h):
          <input type="number" id="U_Prot" step="1"></label>
        <!-- ======  NOWE POLA  – albumina + automatyczny ACR  ====== -->
        <label>Albumina w próbce moczu (mg/L):
          <input type="number" id="U_Alb" step="0.1"></label>
        <label>Albumina/kreatynina (ACR, mg/g):
          <input type="number" id="U_ACR" step="0.1" readonly></label>

        <!-- === KAMICA (dobowa zbiórka) — START === -->
        <label class="advanced-field pro-field">Szczawiany (Ox, mg/dl):
          <input type="number" id="U_Ox" step="0.1"></label>

        <label class="advanced-field pro-field">Cytryniany (Cit, mg/dl):
          <input type="number" id="U_Cit" step="1"></label>

        <label class="advanced-field pro-field">Cystyna (Cys, mg/dl):
          <input type="number" id="U_Cys" step="1"></label>

        <label class="advanced-field pro-field">pH dobowego moczu:
          <input type="number" id="pH24" step="0.01"></label>
        <!-- === KAMICA (dobowa zbiórka) — END === -->
        </fieldset>
      </div>
    </div>

    <!-- ⚙️ Zaawansowane obliczenia KT/V (ukryte do czasu zaznaczenia) -->
    <div class="card advanced-field" id="ktvCard" style="display:none;">
      <!-- Etykieta z tekstem i przyciskiem wyboru w jednej linii; wyśrodkowana -->
      <label class="inline-checkbox-label center-text">
        <span>Pokaż zaawansowane obliczenia KT/V</span> <input type="checkbox" id="ktvToggle" class="white-checkbox">
      </label>

      <!-- Pola KT/V – usunięto klasę .ktv-grid, aby Info button był w tej samej linii co pole -->
      <div id="ktvFields" style="display:none;margin-top:8px;">
          <label>Czas dializy (h):
            <input type="number" id="ktvTime" step="0.1" data-max="8">
          </label>
          <label>Ubytek masy (UF, kg):
            <input type="number" id="ktvUF" step="0.1" data-max="10">
          </label>
          <label>Masa ciała po dializie (kg):
            <input type="number" id="ktvW" step="0.1" data-max="300">
          </label>
          <label>Mocznik przed (mg/dl):
            <input type="number" id="UreaPre" step="1" data-max="400">
          </label>
          <label>Mocznik po (mg/dl):
            <input type="number" id="UreaPost" step="1" data-max="400">
          </label>
      </div>

      <!-- wyniki -->
      <div id="ktvResult" class="result-box" style="display:none;"></div>
      <div id="ektvResult" class="result-box" style="display:none;"></div>
    </div>
  </form>

  <!-- 4. WYNIKI -->
  <div id="results" class="grid-two" style="display:none;">
    <div class="card" id="clcrCard">
      <h3 id="patientName" class="text-center" style="margin:0 0 0.4rem 0;"></h3>
      <h2 class="text-center">Klirens / eGFR</h2>
      <p class="text-center" style="font-size:1.2em;">w nawiasach podano zakres referencyjny dla płci i wieku</p>
      <div id="clcrInfo"></div>
      <small>*Klirens 24 h obliczany tylko, gdy podasz zarówno Ucr, V24 i Scr.</small>
    </div>
  </div>
  <div class="card" id="elecCard" style="display:none;">
    <h2 class="text-center">Inne wskaźniki</h2>
    <p class="text-center" style="font-size:1.2em;">w nawiasach podano zakres referencyjny dla płci i wieku</p>
    <div id="elecInfo"></div>
  </div>

  <!-- Karta ryzyka kamicy nerkowej: pokazuje dodatkowe wskaźniki i alerty tylko w wersji profesjonalnej -->
  <div class="card advanced-field pro-field" id="stoneCard" style="display:none;">
    <h2 class="text-center">Ryzyko kamicy nerkowej</h2>
    <div id="stoneInfo"></div>
  </div>

</div> <!-- /.container -->

<!-- Kontener do tworzenia eleganckiego raportu PDF. Jest niewidoczny na stronie. -->
<div id="pdfReport" style="display:none;"></div>

<button id="downloadPDF" hidden style="display:block; margin:20px auto;">Pobierz raport PDF</button>
<!-- Przycisk do pobierania raportu w formacie DOCX/RTF; ukryty dopóki nie ma wyników -->
<button id="downloadDOCX" hidden style="display:block; margin:20px auto;">Pobierz raport DOCX</button>
<!-- Sekcja interpretacji AI z opisem i przyciskiem. Zostanie pokazana po obliczeniu wyników. -->
<fieldset id="aiFieldset" hidden style="margin:20px auto; max-width:960px;">
  <legend>Interpretacja AI</legend>
  <p>Po naciśnięciu przycisku poniżej system przygotuje gotowe zapytanie do asystenta AI (np. ChatGPT) na podstawie wprowadzonych danych i wszystkich obliczonych wyników. Zapytanie zostanie automatycznie skopiowane do schowka, aby można je było łatwo wkleić do asystenta i uzyskać interpretację wyników.</p>
  <!-- Opcjonalne dołączenie wyników KT/V do raportu AI.  Etykieta jest wyśrodkowana,
       a checkbox umieszczony w jednej linii obok tekstu.  Użyto niestandardowego
       białego pola wyboru, aby zachować jasny wygląd również w ciemnym motywie. -->
  <label class="inline-checkbox-label center-text" style="margin:0.5rem 0;">
    <span>Uwzględnij wyniki KT/V w raporcie AI</span> <input type="checkbox" id="includeKTV" class="white-checkbox">
  </label>
  <button id="askAI">Zapytaj AI</button>
</fieldset>
<footer>© <script>document.write(new Date().getFullYear())</script> Vilda Clinic</footer>

<!-- 5. LOGIKA JS -->
<script>
/* ---------- 5.1 ŁADOWANIE ARKUSZA Z NORMAMI ---------- */
let normy = null;
(async () => {
  const wb = XLSX.read(await (await fetch('klirens.xlsx')).arrayBuffer());
  // przyjmujemy, że normy i opisy są w pierwszym arkuszu
  normy = XLSX.utils.sheet_to_json(wb.Sheets['Arkusz1'], {header: 1, raw: true});
})();

/* ---------- 5.2 FUNKCJE OBLICZENIOWE ---------- */
function BSA_DuBois(weight, height) {
  return 0.007184 * Math.pow(weight, 0.425) * Math.pow(height, 0.725);
}

/* 1) Klirens dobowy (ml/min/1.73 m²) */
function clCr24h(Ucr_mg_dl, V24_ml, Scr_mg_dl, BSA) {
  const cl = (Ucr_mg_dl * V24_ml) / (Scr_mg_dl * 1440);  // 1440 min = 24 h
  return cl * (1.73 / BSA);
}

/* 2) Cockcroft–Gault (ml/min, *nie* znormalizowany do 1.73 m²) */
function clCrCG(sex, age, weight, Scr) {
  const k = sex === 'F' ? 0.85 : 1;
  return ((140 - age) * weight * k) / (72 * Scr);
}

/*
 * Zmieniono implementację: usunięto starszy wzór CKD‑EPI 2021 bez współczynnika płci.
 * Aktualnie stosowany jest wzór CKD‑EPI 2022 (NEJM 2021, KDIGO 2022), który
 * zawiera w sobie mnożnik 1.012 dla kobiet. Funkcja eGFR_CKD_EPI_2022
 * pozostaje poniżej i jest jedyną używaną w obliczeniach.
 */

/* 3b) eGFR – CKD‑EPI 2022 (creatinine‑only, race‑free)
   Współczynniki wg Inker et al., NEJM 2021; rekomendacja KDIGO 2022.
   GFR = 142 × min(Scr/κ,1)^α × max(Scr/κ,1)^–1.200 × 0.9938^Age × 1.012 (if female) */
function eGFR_CKD_EPI_2022(sex, age, Scr) {
  const κ = sex === 'F' ? 0.7 : 0.9;
  const α = sex === 'F' ? -0.241 : -0.302;
  const min = Math.min(Scr / κ, 1);
  const max = Math.max(Scr / κ, 1);
  let gfr = 142 * Math.pow(min, α) * Math.pow(max, -1.200) * Math.pow(0.9938, age);
  if (sex === 'F') gfr *= 1.012;          // współczynnik płci
  return gfr;
}

/* --- KT/V (Daugirdas) i eKt/V ---------------------------------- */
function ktvDaugirdas(R, tHrs, UFkg, Wkg) {
  if (!R || !tHrs || !UFkg || !Wkg) return null;
  const r  = parseFloat(R);
  const t  = parseFloat(tHrs);
  const UF = parseFloat(UFkg);
  const W  = parseFloat(Wkg);
  if (r <= 0 || r >= 1 || t <= 0) return null;
  const first  = -Math.log(r - 0.008 * t);
  const second = (4 - 3.5 * r) * (UF / W);
  return first + second;           // spKt/V
}
function eKtV(spKtV, tMin) {
  if (!spKtV || !tMin) return null;
  return spKtV * (tMin / (tMin + 35));   // przybliżenie
}

/* 4a) klasyczny Schwartz ze zmiennym k */
function kSchwartzVar(ageY, sex) {
  // ustalanie współczynnika k w zależności od wieku i płci
  if (ageY < 0.083) return 0.33;               // wcześniaki < 1 m‑ca
  if (ageY < 1)      return 0.45;               // niemowlęta 1‑12 m‑cy
  if (ageY < 13)     return 0.55;               // dzieci 1‑<13 l.
  if (ageY < 18)     return (sex === 'M' ? 0.70 : 0.55); // nastolatki
  return 0.55;                                 // fallback
}
function clCrSchwartzVar(height_cm, Scr, ageY, sex) {
  // GFR i zastosowane k zwracane jako obiekt
  const k = kSchwartzVar(ageY, sex);
  return { gfr: (k * height_cm) / Scr, k };
}
/* 4b) Bedside Schwartz (IDMS 2009) – stałe k = 0,413 */
function clCrSchwartzIDMS(height_cm, Scr) {
  const k = 0.413;
  return { gfr: (k * height_cm) / Scr, k };
}

/* ===  NOWE OBLICZENIA  =============================================== */

/* ---------- 5.2a  ZAKRESY REFERENCYJNE ---------- */
const refRanges = {
  UA_mgkg:  { child: {min: 0, max: 12}, adult: {min: 0, max: 13},  senior: {min: 0, max: 13} },
  Ca_mgkg:  { child: {min: 0, max: 4},  adult: {min: 0, max: 3},   senior: {min: 0, max: 3} },
  Mg_mgkg:  { child: {min: 0, max: 3.0}, adult: {min: 0, max: 2.0}, senior: {min: 0, max: 2.0} },
  PO4_mgkg: { child: {min: 0, max: 40}, adult: {min: 0, max: 35},  senior: {min: 0, max: 35} },
  Prot_mgkg:{ child: {min: 0, max: 100}, adult: {min: 0, max: 150}, senior: {min: 0, max: 150} },
  Na_mmol_d:{ child: {min: 20, max: 180}, adult: {min: 40, max: 220}, senior: {min: 40, max: 220} },
  K_mmol_d: { child: {min: 10, max: 80}, adult: {min: 25, max: 100}, senior: {min: 25, max: 100} },
  KM_Cr:    { child: {min: 0, max: 0.8}, adult: {min: 0, max: 0.6}, senior: {min: 0, max: 0.6} },
  Ca_Cr:    { child: {min: 0, max: 0.2}, adult: {min: 0, max: 0.11}, senior: {min: 0, max: 0.11} },
  Mg_Ca:    { child: {min: 0.2, max: 0.6}, adult: {min: 0.2, max: 0.6}, senior: {min: 0.2, max: 0.6} },
  PO4_Cr:   { child: {min: 0, max: 2.5}, adult: {min: 0, max: 2.5}, senior: {min: 0, max: 2.5} },
  B_Cr:     { child: {min: 0, max: 0.15}, adult: {min: 0, max: 0.15}, senior: {min: 0, max: 0.15} },
  TRPpct:   { child: {min: 90, max: 99}, adult: {min: 85, max: 99}, senior: {min: 80, max: 99} },
  FENa_pct: { child: {min: 0, max: 1.5}, adult: {min: 0, max: 1},  senior: {min: 0, max: 1} },
  FEHCO3_pct:{ child: {min: 0, max: 5},   adult: {min: 0, max: 5},   senior: {min: 0, max: 5} },
  K_frac:   { child: {min: 30, max: 70}, adult: {min: 15, max: 80},  senior: {min: 15, max: 80} },
  AGs:      { child: {min: 8, max: 16},  adult: {min: 8, max: 12},  senior: {min: 8, max: 14} },
  AGu:      { child: {min: 30, max: 60}, adult: {min: 30, max: 50}, senior: {min: 30, max: 50} },
  ktv:      { adult: {min: 1.2, max: 2.5}, senior: {min: 1.2, max: 2.5} }
  ,
  /* Normy dla frakcji wydalniczej potasu (FEK) oraz chlorków (FECl). Wartości
     przybliżone: u dzieci FEK 10–25 %, u dorosłych 4–16 %, u seniorów 4–15 %. Dla
     FECl brak jednoznacznych norm – przyjęto zakres 2–15 % u dzieci i 1–15 %
     u dorosłych/seniorów. */
  FEK_pct: { child: {min: 10, max: 25}, adult: {min: 4, max: 16}, senior: {min: 4, max: 15} },
  FECl_pct:{ child: {min: 2, max: 15}, adult: {min: 1, max: 15}, senior: {min: 1, max: 15} }
  ,
  /* === KAMICA — START (refRanges) === */
  Ox_mgkg:   { child: {min: 0, max: 0.6}, adult: {min: 0, max: 0.6}, senior:{min:0,max:0.6} },
  Cit_mgkg:  { child: {min: 5},          adult: {min: 4},            senior:{min:4}          },
  Ox_Cr:     { child: {min: 0, max: 0.05}, adult:{min:0,max:0.05},  senior:{min:0,max:0.05} },
  Cit_Cr:    { child: {min: 0.18},       adult: {min: 0.15},         senior:{min:0.15}       },
  Ca_Cit:    { child: {max: 0.3},        adult: {max: 0.3},          senior:{max:0.3}        },
  pHspot:    { child: {min:5, max:7.5},  adult:{min:5, max:7.5},     senior:{min:5,max:7.5}  }
  /* === KAMICA — END (refRanges) === */
};

const clRefRanges = {
  cl24: { child: {min: 90, max: 140}, adult: {min: 90, max: 130}, senior: {min: 60, max: 120} },
  cg:   { child: {min: 90, max: 140}, adult: {min: 90, max: 130}, senior: {min: 60, max: 120} },
  egfr: { child: {min: 90, max: 140}, adult: {min: 90, max: 120}, senior: {min: 60, max: 120} },
  sch:  { child: {min: 90, max: 140} }
};

/* uniwersalny wzór na wydalanie mg/kg/d (U mg/dl, V ml/24h, w kg) */
const excr_mgkg = (U_mg_dl, V_ml, kg) => (U_mg_dl && V_ml && kg)
       ? (U_mg_dl * V_ml) / (100 * kg) : null;

/* wydalanie mmol/d (U mmol/L, V ml) */
const excr_mmol_d = (U_mmol_L, V_ml) => (U_mmol_L && V_ml)
       ? (U_mmol_L * V_ml) / 1000 : null;

/* frakcja wydalnicza – generyczna (%, U_x, S_x, U_cr, S_cr) */
const FE = (U_x, S_x, U_cr, S_cr) => (U_x && S_x && U_cr && S_cr)
       ? (U_x * S_cr) / (S_x * U_cr) * 100 : null;

/* wskaźnik X/Cr (U mg/dl : U_cr mg/dl) */
const ratio = (U, U_cr) => (U && U_cr) ? U / U_cr : null;

/* TRP – Tubular Reabsorption of Phosphate (%) */
const TRP = (U_PO4, S_PO4, U_Cr, S_Cr) => (U_PO4 && S_PO4 && U_Cr && S_Cr)
       ? (1 - (U_PO4 * S_Cr) / (S_PO4 * U_Cr)) * 100 : null;

/* anion gap (serum) = Na + K – Cl – HCO3 [mmol/L] */
const AG_serum = (Na, K, Cl, HCO3) => (Na && Cl && HCO3)
       ? ((Na + (K || 0)) - Cl - HCO3) : null;

/* anion gap (urine) = U_Na + U_K – U_Cl [mmol/L] */
const AG_urine = (U_Na, U_K, U_Cl) => (U_Na && U_Cl)
       ? ((U_Na + (U_K || 0)) - U_Cl) : null;

/* wskaźnik K/(K+Na) w moczu (%) */
const K_frac = (U_K, U_Na) => (U_K && U_Na) ? U_K / (U_K + U_Na) * 100 : null;

/* KT/V (jedno-zabiegowy uproszczony dializacyjny): K – klirens mocznika,
   t – czas dializy (h), V – TBW; tu przyjmujemy K = CG‑ClCr, t = 4 h,
   V = 0.6 * kg; –> możesz dostosować wg ośrodka */
const KT_V = (ClCr, kg, tHrs = 4) => (ClCr && kg)
       ? (ClCr * tHrs * 60) / (0.6 * kg) : null;

/* ---------- 5.3 PRZELICZANIE I WYŚWIETLANIE ---------- */
const $ = id => document.getElementById(id);
document.querySelectorAll('#clcrForm input, #clcrForm select')
        .forEach(el => el.addEventListener('input', update));

// Maksymalne realistyczne wartości dla pól liczbowych – używane do walidacji
const maxValues = {
  age: 120,
  weight: 300,
  height: 250,
  Scr: 20,
  Ucr: 500,
  V24: 10000,
  S_Na: 200,
  S_K: 10,
  S_Cl: 200,
  S_HCO3: 50,
  S_PO4: 20,
  S_UA: 30,
  U_Na: 300,
  U_K: 200,
  U_Cl: 300,
  U_HCO3: 200,
  U_PO4: 200,
  U_UA: 200,
  U_Ca: 10,
  U_Mg: 100,
  U_Prot: 5000,
  U_Alb: 5000,
  U_ACR: 20000,
  /* === KAMICA — START (maxValues) === */
  S_Ca: 15,
  U_Ox: 120,
  U_Cit: 400,
  // Dla pola stężenia szczawianów i cytrynianów w próbce moczu używamy
  // maksymalnych wartości zbliżonych do wartości z dobowej zbiórki (mg/dl).
  Ox_Cr_spot: 120,
  Cit_Cr_spot: 400,
  U_Cys: 2000,
  U_pH: 9,
  pH24: 9,
  S_PTH: 2000,
  S_VitD: 200
  /* === KAMICA — END (maxValues) === */
};

// Krótkie opisy dla każdej zmiennej; używane w dymkach informacyjnych
const infoTexts = {
  fullName: 'Imię i nazwisko pacjenta.',
  age: 'Wiek pacjenta w latach.',
  sex: 'Płeć pacjenta (M – mężczyzna, F – kobieta).',
  weight: 'Masa ciała w kilogramach, używana w obliczeniach BSA i Cockcroft–Gault.',
  height: 'Wzrost w centymetrach, używany w obliczeniach BSA.',
  Scr: 'Stężenie kreatyniny w surowicy; potrzebne do obliczeń klirensu i eGFR.',
  Ucr: 'Stężenie kreatyniny w moczu z dobowej zbiórki; niezbędne do obliczenia klirensu.',
  V24: 'Objętość dobowej zbiórki moczu w mililitrach.',
  S_Na: 'Stężenie sodu w surowicy (mmol/L).',
  S_K: 'Stężenie potasu w surowicy (mmol/L).',
  S_Cl: 'Stężenie chlorków w surowicy (mmol/L).',
  S_HCO3: 'Stężenie wodorowęglanów w surowicy (mmol/L).',
  S_PO4: 'Stężenie fosforanów w surowicy (mg/dl).',
  S_UA: 'Stężenie kwasu moczowego w surowicy (mg/dl).',
  U_Na: 'Stężenie sodu w moczu (mmol/L).',
  U_K: 'Stężenie potasu w moczu (mmol/L).',
  U_Cl: 'Stężenie chlorków w moczu (mmol/L).',
  U_HCO3: 'Stężenie wodorowęglanów w moczu (mmol/L).',
  U_PO4: 'Stężenie fosforanów w moczu (mg/dl).',
  U_UA: 'Stężenie kwasu moczowego w moczu (mg/dl).',
  U_Ca: 'Stężenie wapnia w moczu (mmol/L).',
  U_Mg: 'Stężenie magnezu w moczu (mg/L).',
  U_Prot: 'Białko całkowite wydalone w moczu w ciągu 24 godzin (mg).',
  U_Alb: 'Stężenie albuminy w próbce moczu (mg/L); używane do obliczenia ACR.',
  U_ACR: 'Stosunek albuminy do kreatyniny (mg/g), obliczany automatycznie.'
  ,
  /* === KAMICA — START (infoTexts) === */
  S_Ca: 'Stężenie wapnia całkowitego w surowicy (mg/dl).',
  U_pH: 'pH pojedynczej (porannej) próbki moczu.',
  // Wprowadzamy stężenie szczawianów i cytrynianów w próbce moczu zamiast stosunku do kreatyniny.
  Ox_Cr_spot: 'Stężenie szczawianów w próbce moczu (mg/dl).',
  Cit_Cr_spot: 'Stężenie cytrynianów w próbce moczu (mg/dl).',
  S_PTH: 'Parathormon w surowicy (pg/ml).',
  S_VitD: '25‑hydroksy‑witamina D w surowicy (ng/ml).',
  U_Ox: 'Stężenie szczawianów w dobowej zbiórce moczu (mg/dl).',
  U_Cit: 'Stężenie cytrynianów w dobowej zbiórce moczu (mg/dl).',
  U_Cys: 'Stężenie cystyny w dobowej zbiórce moczu (mg/dl).',
  pH24: 'Średnie pH moczu w dobowej zbiórce.',
  /* === KAMICA — END (infoTexts) === */
  /* Dodatkowe pola bez opisu w oryginalnej tabeli */
  ScrUnit: 'Jednostka stężenia kreatyniny w surowicy (mg/dl lub µmol/L).'
  ,
  /* Pola zaawansowanych obliczeń KT/V i opcje raportu AI */
  ktvToggle: 'Zaznacz to pole, aby pokazać sekcję zaawansowanych obliczeń KT/V.',
  ktvTime:   'Czas trwania pojedynczej sesji dializy w godzinach (t, h).',
  ktvUF:     'Ubytek masy podczas dializy, czyli ultrafiltracja, w kilogramach (UF, kg).',
  ktvW:      'Masa ciała pacjenta po zakończeniu dializy, w kilogramach (W, kg).',
  UreaPre:   'Stężenie mocznika we krwi przed rozpoczęciem dializy (mg/dl).',
  UreaPost:  'Stężenie mocznika we krwi po zakończeniu dializy (mg/dl).',
  includeKTV:'Zaznacz to pole, aby dołączyć obliczone wyniki KT/V w raporcie AI.'
};

// Po załadowaniu dokumentu dodaj elementy walidacyjne i ikony informacyjne
document.addEventListener('DOMContentLoaded', () => {
  // Initialize the globally exposed version state.  The default is the
  // "basic" calculator; this value will be updated whenever the user
  // clicks on one of the version buttons.  Other parts of the code
  // (particularly the update() routine) consult window.currentVersion to
  // decide whether to render professional-only metrics such as KT/V.
  window.currentVersion = 'basic';
  // Dodaj kontener na komunikat walidacyjny pod każdym polem liczbowym
  document.querySelectorAll('#clcrForm input[type="number"]').forEach(input => {
    const msg = document.createElement('div');
    msg.className = 'validation-message';
    input.parentNode.appendChild(msg);
  });
  // Dodaj ikony informacyjne do etykiet
  // (Ten kod został dezaktywowany, gdyż nowe przyciski Info generują dymki automatycznie)
  /*
  Object.keys(infoTexts).forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      const label = el.closest('label');
      if (label && !label.querySelector('.info-icon')) {
        const icon = document.createElement('span');
        icon.className = 'info-icon';
        icon.title = infoTexts[id];
        icon.textContent = 'ℹ️';
        // Znajdź pierwszy element formularza w etykiecie i wstaw ikonę przed nim
        const firstFormEl = label.querySelector('input, select, textarea');
        if (firstFormEl) {
          label.insertBefore(icon, firstFormEl);
        } else {
          label.appendChild(icon);
        }
      }
    }
  });
  */
});

// Funkcja walidująca pojedyncze pole. Zwraca true, jeśli poprawne.
function validateField(input) {
  const id = input.id;
  const val = parseFloat(input.value);
  const msg = input.parentNode.querySelector('.validation-message');
  // Jeżeli pole puste, usuń błąd
  if (!input.value) {
    if (msg) msg.textContent = '';
    input.classList.remove('error');
    return true;
  }
  if (isNaN(val)) {
    if (msg) msg.textContent = 'Nieprawidłowa liczba';
    input.classList.add('error');
    return false;
  }
  if (val < 0) {
    if (msg) msg.textContent = 'Wartość nie może być ujemna';
    input.classList.add('error');
    return false;
  }
  // Specjalny przypadek dla kreatyniny w surowicy – uwzględnij jednostkę
  if (id === 'Scr') {
    let mgdlVal = val;
    const unitEl = document.getElementById('ScrUnit');
    const unit = unitEl ? unitEl.value : 'mg/dl';
    if (unit === 'umol') mgdlVal = val / 88.4;
    if (maxValues.Scr !== undefined && mgdlVal > maxValues.Scr) {
      if (msg) msg.textContent = 'Wartość wydaje się zbyt wysoka';
      input.classList.add('error');
      return false;
    }
  } else if (maxValues[id] !== undefined && val > maxValues[id]) {
    if (msg) msg.textContent = 'Wartość wydaje się zbyt wysoka';
    input.classList.add('error');
    return false;
  }
  if (msg) msg.textContent = '';
  input.classList.remove('error');
  return true;
}

function update() {
  const fullName = $('fullName').value.trim();
  $('patientName').textContent = fullName || '';
  const age    = +$('age').value;
  const sex    = $('sex').value;
  const weight = +$('weight').value;
  const height = +$('height').value;
  // Przeliczanie kreatyniny w surowicy z uwzględnieniem wybranej jednostki.
  const scrInput = +$('Scr').value;
  const scrUnit  = $('ScrUnit') ? $('ScrUnit').value : 'mg/dl';
  const Scr    = (scrInput && scrUnit === 'umol') ? (scrInput / 88.4) : scrInput;
  const Ucr    = +$('Ucr').value;
  const U_Alb  = +$('U_Alb').value;        // albumina w moczu (mg/L)

  /* ----------  ACR: automatyczne wyliczenie ---------- */
  const manualACR = +$('U_ACR').value;     // ewentualna wartość wpisana ręcznie
  let   ACR = manualACR;
  if (!ACR && U_Alb && Ucr) {
    // przelicz albuminę z mg/L → mg/dl (÷10), następnie mg/g kreatyniny (×1000 / Ucr)
    const Alb_mg_dl = U_Alb / 10;
    ACR = (Alb_mg_dl * 1000) / Ucr;
    // wpisz do pola (z 1 miejscem po przecinku); readonly → pokazujemy wynik userowi
    $('U_ACR').value = ACR.toFixed(1);
  }
  const V24    = +$('V24').value;

  // Walidacja wszystkich pól liczbowych. Jeżeli istnieje błąd, ukrywamy wyniki.
  document.querySelectorAll('#clcrForm input[type="number"]').forEach(el => validateField(el));
  if (document.querySelector('#clcrForm .error')) {
    $('results').style.display = 'none';
    $('elecCard').style.display = 'none';
    return;
  }

  const coreReady = age && weight && height && Scr;  // baza do klirensu
  const somethingReady = [...document.querySelectorAll('#clcrForm input')].some(el => el.value);
  if (!somethingReady) {
    $('results').style.display = 'none';
    return; // nic nie wpisano
  }

  const BSA = BSA_DuBois(weight, height);
  let clHtml = `<div class="result-box"><strong>Powierzchnia ciała</strong> ${BSA.toFixed(2)} m²</div>`;

  /* === Funkcja do wstawiania wyników z normą i kolorem === */
  function clBox(label, val, unit = '', code) {
    if (val === null || isNaN(val)) return;
    const ageGroup = age < 18 ? 'child' : (age < 65 ? 'adult' : 'senior');
    const rangeSet = clRefRanges[code]?.[ageGroup] || null;
    let inRange = true;
    let rangeText = '';
    if (rangeSet) {
      const lo = (rangeSet.min !== undefined) ? rangeSet.min : '';
      const hi = (rangeSet.max !== undefined) ? rangeSet.max : '';
      rangeText = ` (<span class="range">${lo !== '' ? lo : '–'}‑${hi !== '' ? hi : '–'}${unit}</span>)`;
      if ((rangeSet.min !== undefined && val < rangeSet.min) || (rangeSet.max !== undefined && val > rangeSet.max)) {
        inRange = false;
      }
    }
    clHtml += `<div class="result-box${inRange ? '' : ' out-of-range'}"><strong>${label}:</strong> ${val.toFixed(0)}${unit}${rangeText}</div>`;
  }

  /* — Klirens dobowy — */
  // Klirens kreatyniny z dobowej zbiórki moczu (ml/min/1.73 m²)
  if (Ucr && V24 && Scr && BSA) {
    const cl24 = clCr24h(Ucr, V24, Scr, BSA);
    clBox('Klirens 24 h (DZM)', cl24, ' ml/min/1.73 m²', 'cl24');
  }
  /* — Cockcroft‑Gault — */
  const cg = clCrCG(sex, age, weight, Scr);
  clBox('Cockcroft–Gault', cg, ' ml/min', 'cg');

  /* — Cockcroft‑Gault znormalizowany do 1,73 m² — */
  if (BSA) {
    const cgNorm = cg * 1.73 / BSA;          // przeliczenie jak w 24‑h klirensie
    clBox('Cockcroft–Gault (1,73 m²)', cgNorm, ' ml/min/1.73 m²', 'cg');
  }

  /* — aktualny eGFR CKD‑EPI — */
  // Wzór CKD‑EPI (NEJM 2021; KDIGO 2022) jest wykorzystywany jako domyślny.
  // Starsza wersja (bez współczynnika 1.012 dla kobiet) została usunięta.
  const egfr = eGFR_CKD_EPI_2022(sex, age, Scr);
  clBox('eGFR (CKD‑EPI)', egfr, ' ml/min/1.73 m²', 'egfr');

  /* — Klasyfikacja PChN (KDIGO) — */
  let stageDesc = '', stageClass = '';
  if (egfr >= 90) {
    stageDesc = 'G1 – prawidłowa funkcja';
  } else if (egfr >= 60) {
    stageDesc = 'G2 – łagodne ↓';
  } else if (egfr >= 45) {
    stageDesc = 'G3a – umiarkowane ↓';
    stageClass = 'warn-yellow';
  } else if (egfr >= 30) {
    stageDesc = 'G3b – umiark./ciężkie ↓';
    stageClass = 'warn-orange';
  } else if (egfr >= 15) {
    stageDesc = 'G4 – ciężkie ↓';
    stageClass = 'out-of-range';
  } else {
    stageDesc = 'G5 – niewydolność (dializa)';
    stageClass = 'out-of-range';
  }
  clHtml += `<div class="result-box${stageClass ? ' ' + stageClass : ''}"><strong>Klasyfikacja PChN (KDIGO):</strong> ${stageDesc}</div>`;

  /* ---------  Albuminuria KDIGO (A1–A3)  --------- */
  let albuminDesc = null, albuminClass = '';
  if (ACR) {
    if (ACR < 30) {
      albuminDesc = 'A1 – <30 mg/g (prawidłowa)';
    } else if (ACR <= 300) {
      albuminDesc = 'A2 – 30‑300 mg/g (umiarkowana)';
      albuminClass = 'warn-yellow';
    } else {
      albuminDesc = 'A3 – >300 mg/g (znaczna)';
      albuminClass = 'out-of-range';
    }
    clHtml += `<div class="result-box ${albuminClass}"><strong>Albuminuria (KDIGO):</strong> ${albuminDesc}</div>`;
  }

  /* ---------  Pełna klasyfikacja Gx/Ax  --------- */
  if (stageDesc && albuminDesc) {
    const gCode = stageDesc.split(' ')[0];  // np. G3a
    const aCode = albuminDesc.split(' ')[0]; // np. A2
    clHtml += `<div class="result-box"><strong>Pełna klasyfikacja KDIGO:</strong> ${gCode}/${aCode}</div>`;
  }

  /* — Schwartz (jeśli <18 l.) — */
  if (age < 18) {
    /* klasyczny Schwartz ze zmiennym k */
    const { gfr: schVar, k: kVar } = clCrSchwartzVar(height, Scr, age, sex);
    clBox(`Schwartz (k=${kVar})`, schVar, ' ml/min/1.73 m²', 'sch');
    /* Bedside Schwartz IDMS */
    const { gfr: schIDMS } = clCrSchwartzIDMS(height, Scr);
    clBox('Schwartz Bedside IDMS (k = 0,413)', schIDMS,
      ' ml/min/1.73 m²', 'sch');
  }
  // Show the Klirens / eGFR results only when the essential core parameters have been provided.
  // Without this guard the card could appear with no values (for example when toggling
  // advanced KT/V without entering basic data).  We explicitly set the results display
  // based on the ``coreReady`` flag computed above.
  if (coreReady) {
    $('clcrInfo').innerHTML = clHtml;
    $('results').style.display = 'grid';
  } else {
    // Clear any previous content and hide the results card entirely until basic inputs are ready
    $('clcrInfo').innerHTML = '';
    $('results').style.display = 'none';
  }

  /* ----------  RACHUNEK ELEKTROLITÓW  ---------- */
  const U_Cr = +$('Ucr').value;  // kreatynina w moczu (mg/dl)
  // V24 already defined above
  const kg = weight;

  /* ––– wartości z nowych pól ––– */
  const U_UA  = +$('U_UA').value,  S_UA  = +$('S_UA').value;
  const U_Ca  = +$('U_Ca').value;
  const U_Mg  = +$('U_Mg').value;
  const U_PO4 = +$('U_PO4').value, S_PO4 = +$('S_PO4').value;
  const U_Na  = +$('U_Na').value,  S_Na  = +$('S_Na').value;
  const U_K   = +$('U_K').value,   S_K   = +$('S_K').value;
  const U_Cl  = +$('U_Cl').value,  S_Cl  = +$('S_Cl').value;
  const U_HCO3= +$('U_HCO3').value, S_HCO3 = +$('S_HCO3').value;
  const U_Prot= +$('U_Prot').value;

  /* === KAMICA — START (pobranie danych) === */
  const S_Ca   = +$('S_Ca').value;
  const U_pH   = +$('U_pH').value;
  // Wczytujemy stężenie szczawianów i cytrynianów w próbce moczu (mg/dl).
  const U_Ox_spot  = +$('Ox_Cr_spot').value;
  const U_Cit_spot = +$('Cit_Cr_spot').value;
  const S_PTH  = +$('S_PTH').value;
  const S_VitD = +$('S_VitD').value;
  const U_Ox   = +$('U_Ox').value;
  const U_Cit  = +$('U_Cit').value;
  const U_Cys  = +$('U_Cys').value;
  const pH24   = +$('pH24').value;
  /* === KAMICA — END (pobranie danych) === */

  // --- Przeliczanie jednostek dla pól z nowymi jednostkami ---
  // Wapń podawany w mmol/L konwertujemy na mg/dl: 1 mmol Ca ≈ 40 mg,
  // a 1 L = 10 dL, więc mg/dl = (mmol/L × 40) / 10 = mmol/L × 4
  const U_Ca_mgdl = U_Ca ? U_Ca * 4 : null;
  // Magnez podawany w mg/L konwertujemy na mg/dl (1 L = 10 dL)
  const U_Mg_mgdl = U_Mg ? U_Mg / 10 : null;

  /* === KAMICA — START (dodatkowe obliczenia) === */
  // Wydalanie szczawianów i cytrynianów – mg/kg/d
  const Ox_mgkg  = excr_mgkg(U_Ox, V24, kg);
  const Cit_mgkg = excr_mgkg(U_Cit, V24, kg);

  // Stosunek Ca/Cit (mg/mg) – przydadzą się oba pola
  const Ca_Cit_ratio = (U_Ca_mgdl && U_Cit) ? (U_Ca_mgdl / U_Cit) : null;

  // Stosunek szczawianu i cytrynianu do kreatyniny w próbce (mg/mg).
  // Użytkownik wprowadza stężenie szczawianów i cytrynianów w próbce moczu (mg/dl);
  // poniżej obliczamy stosunek do kreatyniny z dobowej zbiórki. Funkcja ratio
  // zwraca wartość tylko wtedy, gdy dostępne są oba składniki.
  const Ox_Cr_spot  = ratio(U_Ox_spot, U_Cr);
  const Cit_Cr_spot = ratio(U_Cit_spot, U_Cr);
  /* === KAMICA — END (dodatkowe obliczenia) === */

  /* --- WYDALANIA mg/kg/d --- */
  const UA_mgkg  = excr_mgkg(U_UA, V24, kg);
  // Ca i Mg wprowadzane odpowiednio w mmol/L i mg/L – przeliczamy je na mg/dl
  const Ca_mgkg  = excr_mgkg(U_Ca_mgdl, V24, kg);
  const Mg_mgkg  = excr_mgkg(U_Mg_mgdl, V24, kg);
  const PO4_mgkg = excr_mgkg(U_PO4, V24, kg);
  // Białko całkowite podawane w mg/24 h – dla mg/kg/d dzielimy przez masę ciała
  const Prot_mgkg= (U_Prot && kg) ? U_Prot / kg : null;

  /* --- WYDALANIA mmol/d --- */
  const Na_mmol_d = excr_mmol_d(U_Na, V24);
  const K_mmol_d  = excr_mmol_d(U_K, V24);

  /* --- WSKAŹNIKI / RATIO --- */
  const KM_Cr = ratio(U_UA, U_Cr);
  // Ca/Cr: używamy przeliczonego Ca w mg/dl
  const Ca_Cr = ratio(U_Ca_mgdl, U_Cr);
  // Stosunek magnezu do wapnia (Mg/Ca): obie wartości w mg/dl
  const Mg_Ca = (U_Mg_mgdl && U_Ca_mgdl) ? U_Mg_mgdl / U_Ca_mgdl : null;
  const PO4_Cr = ratio(U_PO4, U_Cr);
  // Białko/kreatynina: białko w mg/24h, kreatynina w mg/dl → konwersja kreatyniny na mg/24h
  // mg kreatyniny/24h = U_Cr (mg/dl) * V24 (ml) / 100 (ml per dl)
  const B_Cr  = (U_Prot && U_Cr && V24) ? U_Prot / ((U_Cr * V24) / 100) : null;
  const K_KNa = K_frac(U_K, U_Na);

  /* --- FRAKCJE I LUKI --- */
  const TRPpct    = TRP(U_PO4, S_PO4, U_Cr, Scr);
  const FENa_pct  = FE(U_Na, S_Na, U_Cr, Scr);
  const FEHCO3_pct= FE(U_HCO3, S_HCO3, U_Cr, Scr);
  const AGs = AG_serum(S_Na, S_K, S_Cl, S_HCO3);
  const AGu = AG_urine(U_Na, U_K, U_Cl);

  // Frakcja wydalnicza potasu i chlorków – obliczana analogicznie do FENa.
  const FEK_pct  = FE(U_K, S_K, U_Cr, Scr);
  const FECl_pct = FE(U_Cl, S_Cl, U_Cr, Scr);

  /* --- KT/V (orientacyjnie) --- */
  const ktv = KT_V(cg, kg);  // używamy Cockcroft‑Gault jako K

  /* --- BUDUJEMY HTML --- */
  let ehtml = '';

  function box(label, val, unit = '', code) {
    // Skip rendering values that are null, NaN or infinite.  When required
    // inputs are missing, certain calculations (such as KT/V) can result in
    // Infinity due to division by zero.  Such values should not be shown to
    // the user, so we check for finiteness using the built‑in isFinite().
    if (val === null || !isFinite(val)) return;
    // Zamieniamy twarde spacje (U+00A0) w etykiecie na zwykłe spacje,
    // aby tekst mógł łamać się w naturalnych miejscach. Jeśli pozostawimy
    // spacje nierozdzielające, cała etykieta staje się jednym długim
    // „słowem”, które może wychodzić poza kontener w wąskim układzie.
    const safeLabel = label.replace(/\u00A0/g, ' ');
    const ageGroup = age < 18 ? 'child' : (age < 65 ? 'adult' : 'senior');
    const rangeSet = refRanges[code]?.[ageGroup] || null;
    let inRange = true;
    let rangeText = '';
    if (rangeSet) {
      const lo = (rangeSet.min !== undefined) ? rangeSet.min : '';
      const hi = (rangeSet.max !== undefined) ? rangeSet.max : '';
      rangeText = ` (<span class="range">${lo !== '' ? lo : '–'}‑${hi !== '' ? hi : '–'}${unit}</span>)`;
      if ((rangeSet.min !== undefined && val < rangeSet.min) || (rangeSet.max !== undefined && val > rangeSet.max)) {
        inRange = false;
      }
    }
    ehtml += `<div class="result-box${inRange ? '' : ' out-of-range'}"><strong>${safeLabel}:</strong> ${val.toFixed(1)} ${unit}${rangeText}</div>`;
  }

  box('Wydalanie kw. moczowego', UA_mgkg, 'mg/kg/d');
  // Rozwinięcie skrótu KM/Cr: stosunek kwasu moczowego do kreatyniny w moczu
  box('KM/Cr (kwas moczowy / kreatynina)', KM_Cr, '');
  // Zastąpienie skrótów opisami zrozumiałymi dla osób spoza branży medycznej.
  // Wydalanie wapnia i stosunek wapnia do kreatyniny
  box('Wydalanie wapnia (Ca)', Ca_mgkg, 'mg/kg/d', 'Ca_mgkg');        box('Stosunek wapnia do kreatyniny (Ca/Cr)', Ca_Cr, '', 'Ca_Cr');
  // Wydalanie magnezu oraz stosunek magnezu do wapnia – rozszerzamy etykiety dla większej czytelności
  // Nowa etykieta „Wydalanie magnezu (Mg)” jasno wskazuje, że chodzi o całkowite wydalanie magnezu w dobowej zbiórce
  // Nowa etykieta „Stosunek magnezu do wapnia (Mg/Ca)” wyjaśnia, że obie wartości w liczniku i mianowniku odnoszą się do stężeń w mg/dl
  box('Wydalanie magnezu (Mg)', Mg_mgkg, 'mg/kg/d', 'Mg_mgkg');                  box('Stosunek magnezu do wapnia (Mg/Ca)', Mg_Ca, '', 'Mg_Ca');
  // Wydalanie fosforanów i stosunek fosforanów do kreatyniny
  box('Wydalanie fosforanów (PO₄)', PO4_mgkg, 'mg/kg/d', 'PO4_mgkg'); box('Stosunek fosforanów do kreatyniny (PO₄/Cr)', PO4_Cr, '', 'PO4_Cr');
  // TRP – reabsorpcja fosforanów (podajemy wyjaśnienie)
  box('Reabsorpcja fosforanów (TRP)', TRPpct, '%', 'TRPpct');
  // Wydalanie sodu i frakcja wydalnicza sodu
  box('Wydalanie sodu (Na)', Na_mmol_d, 'mmol/d', 'Na_mmol_d');       box('Frakcja wydalnicza sodu (FENa)', FENa_pct, '%', 'FENa_pct');
  // Frakcja wydalnicza potasu i chlorków pozostają bez zmian
  box('Frakcja wydalnicza potasu (FEK)', FEK_pct, '%', 'FEK_pct');
  box('Frakcja wydalnicza chlorków (FECl)', FECl_pct, '%', 'FECl_pct');
  // Wydalanie potasu i stosunek potasu do sumy potasu i sodu
  box('Wydalanie potasu (K)', K_mmol_d, 'mmol/d', 'K_mmol_d');        // Wydalanie potasu (K)
  box('Stosunek potasu do sumy potasu i sodu (K/(K+Na))', K_KNa, '%', 'K_frac');
  // Luka anionowa w surowicy i w moczu pozostają bez zmian
  box('Luka anionowa (surowica)', AGs, 'mmol/L', 'AGs');
  box('Luka anionowa (mocz)', AGu, 'mmol/L', 'AGu');
  // Frakcja wodorowęglanów – rozszerzamy opis skrótu
  box('Frakcja wodorowęglanów (HCO₃)', FEHCO3_pct, '%', 'FEHCO3_pct');
  box('Białkomocz', Prot_mgkg, 'mg/kg/d', 'Prot_mgkg');      box('Białko/kreatynina (B/Cr)', B_Cr, '', 'B_Cr');
  // Rozwinięcie skrótu KT/V: stosunek klirensu mocznika do objętości dystrybucji
  // (wartość orientacyjna).  Ten orientacyjny wskaźnik powinien być
  // dostępny wyłącznie w wersji profesjonalnej.  W pozostałych trybach
  // (podstawowym i zaawansowanym) pomijamy jego renderowanie, aby
  // użytkownik nie widział wartości KT/V zanim odblokuje wersję pro.
  if ((window.currentVersion || 'basic') === 'pro') {
    box('KT/V (klirens mocznika / obj. dystryb., orient.)', ktv, '', 'ktv');
  }

  /* wyświetl lub ukryj kartę */
  $('elecInfo').innerHTML = ehtml;
  $('elecCard').style.display = ehtml ? 'block' : 'none';

  /* === KAMICA — START (wyniki) === */
  // Wyniki związane z ryzykiem kamicy prezentowane w oddzielnej karcie.
  let stoneHtml = '';
  function stoneBox(label, val, unit = '', code) {
    /*
     * Zmieniamy sposób pomijania wartości: oprócz braku
     * (null) i liczby nienaturalnej (NaN), odrzucamy
     * również zera. W polach ryzyka kamicy użytkownik może
     * pozostawić dane puste; użycie operatora unarnego '+'
     * konwertowało takie puste pola na 0, co skutkowało
     * wyświetlaniem pustych wyników (np. pH = 0.0).  Zero jest
     * ponadto nielogiczne dla większości parametrów (pH, wydalania),
     * dlatego traktujemy je tak jak brak danych i nie tworzymy
     * boksu z wynikiem. Dzięki temu karta „Ryzyko kamicy nerkowej”
     * pojawi się dopiero, gdy wprowadzone zostaną rzeczywiste
     * wartości.
     */
    if (val === null || !isFinite(val) || val === 0) return;
    // Zamieniamy nierozdzielające spacje w etykiecie na zwykłe spacje, aby umożliwić łamanie wąskiego tekstu
    const safeLabel = label.replace(/\u00A0/g, ' ');
    const ageGroup = age < 18 ? 'child' : (age < 65 ? 'adult' : 'senior');
    const rangeSet = refRanges[code]?.[ageGroup] || null;
    let inRange = true;
    let rangeText = '';
    if (rangeSet) {
      /*
       * Build a user‑friendly reference range. The previous implementation
       * always rendered a start and end value separated by a hyphen,
       * inserting an em dash when either boundary was missing (e.g.
       * "0.15‑–mg/mg"). This is confusing for users. Instead we
       * explicitly show a lower bound using ≥ when only a minimum is
       * defined, or an upper bound using ≤ when only a maximum is
       * defined. When both bounds exist we join them with an en dash.
       * A space is added before the unit for readability.
       */
      const loVal = (rangeSet.min !== undefined) ? rangeSet.min : null;
      const hiVal = (rangeSet.max !== undefined) ? rangeSet.max : null;
      /*
       * Build the reference text without leaving stray spaces.  Only insert a
       * space before the unit when a unit is provided.  For parameters such as
       * Ca/Cit and pH, where the display is unitless, omitting the extra
       * space prevents an awkward trailing space.
       */
      const unitSuffix = unit ? ` ${unit}` : '';
      if (loVal !== null && hiVal !== null) {
        rangeText = ` (<span class="range">${loVal}–${hiVal}${unitSuffix}</span>)`;
      } else if (loVal !== null) {
        rangeText = ` (<span class="range">≥${loVal}${unitSuffix}</span>)`;
      } else if (hiVal !== null) {
        rangeText = ` (<span class="range">≤${hiVal}${unitSuffix}</span>)`;
      } else {
        rangeText = '';
      }
      // Determine whether the value falls outside the reference range. If only a
      // minimum is defined, values below that threshold are flagged; if only
      // a maximum is defined, values above that threshold are flagged.
      if ((loVal !== null && val < loVal) || (hiVal !== null && val > hiVal)) {
        inRange = false;
      }
    }
    /*
     * For most stone risk markers we display a single decimal place
     * (e.g. 0.0). However, the spot ratios of citrate/creatinine
     * and oxalate/creatinine are often very small numbers where
     * a single decimal would obscure meaningful differences. To
     * accommodate this, detect when the provided code corresponds
     * to the Cit/Cr or Ox/Cr spot ratios and increase the number
     * of decimal places to three. For all other markers we keep
     * the historical one‑decimal precision.
     */
    const decimals = (code === 'Cit_Cr' || code === 'Ox_Cr') ? 3 : 1;
    /*
     * As above, avoid adding an extra space when there is no unit.  This makes
     * the output for ratios like Ca/Cit cleaner (e.g. "0.25" instead of
     * "0.25 ").
     */
    const unitText = unit ? ` ${unit}` : '';
    stoneHtml += `<div class="result-box${inRange ? '' : ' out-of-range'}"><strong>${safeLabel}:</strong> ${val.toFixed(decimals)}${unitText}${rangeText}</div>`;
  }
  // Generuj boxy tylko w wersji profesjonalnej
  if ((window.currentVersion || 'basic') === 'pro') {
    stoneBox('Wydalanie szczawianów (Ox)', Ox_mgkg, 'mg/kg/d', 'Ox_mgkg');
    stoneBox('Wydalanie cytrynianów (Cit)', Cit_mgkg, 'mg/kg/d', 'Cit_mgkg');
    stoneBox('Ox/Cr (spot)', Ox_Cr_spot, 'mg/mg', 'Ox_Cr');
    stoneBox('Cit/Cr (spot)', Cit_Cr_spot, 'mg/mg', 'Cit_Cr');
    stoneBox('Stosunek Ca/Cit', Ca_Cit_ratio, '', 'Ca_Cit');
    stoneBox('pH próbki moczu', U_pH, '', 'pHspot');
    stoneBox('pH dobowej zbiórki', pH24, '', 'pHspot');
  }
  // Generator krótkiego podsumowania ryzyka kamicy – ostrzeżenia warunkowe
  let shtml = '';
  function alertLine(txt){
    shtml += `<p style="margin:4px 0;"><strong>${txt}</strong></p>`;
  }
  if ((window.currentVersion || 'basic') === 'pro') {
    // — objętość dobowego moczu —
    if (V24 && V24 < 2000){
      alertLine(`Mała objętość moczu (${(V24/1000).toFixed(2)} L/d) – ryzyko wszystkich typów kamicy.`);
    }
    // — hiperkalciuria —
    if (Ca_mgkg && Ca_mgkg > 4){
      alertLine('Hiperkalciuria – sprzyja kamicy wapniowej.');
    }
    // — hiperoksaluria —
    if (Ox_mgkg && Ox_mgkg > 0.6){
      alertLine('Hiperoksaluria – zwiększone ryzyko kamieni szczawianowych.');
    }
    // — hipocytraturia —
    if (Cit_mgkg && Cit_mgkg < (age < 18 ? 5 : 4)){
      alertLine('Hipocytraturia – niski inhibitor krystalizacji.');
    }
    // — kwaśny mocz a kamica moczanowa —
    if ( (U_pH && U_pH < 5.5) || (pH24 && pH24 < 5.5) ){
      alertLine('Kwaśny mocz (pH <5,5) – ryzyko kamicy z kwasu moczowego.');
    }
    // — zasadowy mocz a kamica fosforanowa —
    if ( (U_pH && U_pH > 7.0) || (pH24 && pH24 > 7.0) ){
      alertLine('Zasadowy mocz (pH >7,0) – ryzyko kamicy fosforanowej / struwitowej.');
    }
    // — cystynuria —
    if (U_Cys && U_Cys > 250){
      alertLine('Cystynuria – bardzo wysokie ryzyko kamicy cystynowej (cystyna >250 mg/L).');
    }
  }
  // Aktualizuj zawartość i widoczność karty z ryzykiem kamicy
  {
    const stoneInfoEl = document.getElementById('stoneInfo');
    const stoneCardEl = document.getElementById('stoneCard');
    if (stoneInfoEl && stoneCardEl) {
      if ((window.currentVersion || 'basic') === 'pro' && (stoneHtml || shtml)) {
        let combined = '';
        if (stoneHtml) combined += stoneHtml;
        if (shtml) {
          if (stoneHtml) combined += '<hr>';
          combined += shtml;
        }
        stoneInfoEl.innerHTML = combined;
        stoneCardEl.style.display = 'block';
      } else {
        stoneInfoEl.innerHTML = '';
        stoneCardEl.style.display = 'none';
      }
    }
  }
  /* === KAMICA — END (wyniki) === */

  /* ----------  Zaawansowane KT/V  ---------- */
  const advBox   = document.getElementById('ktvFields');
  const advCheck = document.getElementById('ktvToggle');
  if (advBox && advCheck) {
    // Pokaż lub ukryj sekcję z polami KT/V w zależności od zaznaczenia
    advBox.style.display = advCheck.checked ? 'block' : 'none';
    if (advCheck.checked) {
      // Upewnij się, że w sekcji KT/V znajdują się ikony informacyjne przy każdym polu
      const advTips = {
        ktvTime: 'Czas trwania sesji dializy w godzinach (t, h).',
        ktvUF:   'Ubytek masy podczas dializy (ultrafiltracja), w kilogramach (UF, kg).',
        ktvW:    'Masa ciała pacjenta po dializie, w kilogramach (W, kg).',
        UreaPre: 'Stężenie mocznika we krwi przed dializą (mg/dl).',
        UreaPost:'Stężenie mocznika we krwi po dializie (mg/dl).'
      };
      ['ktvTime','ktvUF','ktvW','UreaPre','UreaPost'].forEach(fid => {
        const field = document.getElementById(fid);
        if (field) {
          const lab = field.closest('label');
          if (lab && !lab.querySelector('.info-icon')) {
            const ico = document.createElement('span');
            ico.className = 'info-icon';
            ico.title = advTips[fid] || '';
            ico.textContent = 'ℹ️';
            lab.insertBefore(ico, field);
          }
        }
      });
      // zbierz dane
      const tHrs  = +$('ktvTime').value;
      const UFkg  = +$('ktvUF').value;
      const Wkg   = +$('ktvW').value;
      const pre   = +$('UreaPre').value;
      const post  = +$('UreaPost').value;
      const R     = post && pre ? post / pre : null;

      const spKtv = ktvDaugirdas(R, tHrs, UFkg, Wkg);
      const ekTv  = spKtv ? eKtV(spKtv, tHrs * 60) : null;

      if (spKtv) {
        $('ktvResult').innerHTML = `<strong>KT/V (Daugirdas):</strong> ${spKtv.toFixed(2)}`;
        $('ktvResult').style.display = 'block';
      } else {
        $('ktvResult').style.display = 'none';
      }
      if (ekTv) {
        $('ektvResult').innerHTML = `<strong>eKt/V (wyrównany):</strong> ${ekTv.toFixed(2)}`;
        $('ektvResult').style.display = 'block';
      } else {
        $('ektvResult').style.display = 'none';
      }
    } else {
      // gdy checkbox jest odznaczony, ukryj wyniki KT/V
      if (document.getElementById('ktvResult')) document.getElementById('ktvResult').style.display = 'none';
      if (document.getElementById('ektvResult')) document.getElementById('ektvResult').style.display = 'none';
    }
  }

  // Po zakończeniu wszystkich obliczeń zdecyduj, czy pokazać
  // przycisk czyszczenia formularza.  Przyciski są widoczne tylko wtedy,
  // gdy dostępne są dane podstawowe (age, weight, height i Scr) –
  // zmienna coreReady określa, czy można przeprowadzić obliczenia
  // klirensu/eGFR.  Gdy coreReady jest prawdziwe, kontener z
  // przyciskiem jest wyświetlany; w przeciwnym wypadku zostaje ukryty.
  const clearContainer = document.getElementById('clearContainer');
  if (clearContainer) {
    clearContainer.style.display = coreReady ? 'block' : 'none';
  }
}


/* ---------- 5.4 EKSPORT PDF (wersja dopracowana – jedna strona) ---------- */
$('downloadPDF').addEventListener('click', async () => {
  // Upewnij się, że wartości są aktualne
  if (typeof update === 'function') update();
  const { jsPDF } = window.jspdf;

  // Przygotuj kontener raportu
  const reportDiv = document.getElementById('pdfReport');
  reportDiv.innerHTML = '';

  // Nagłówek raportu
  const title = document.createElement('h2');
  title.textContent = 'Raport klirensu / eGFR';
  reportDiv.appendChild(title);

  // Dane pacjenta
  const patientSection = document.createElement('div');
  patientSection.className = 'section';
  const patientHeader = document.createElement('h3');
  patientHeader.textContent = 'Dane pacjenta';
  patientSection.appendChild(patientHeader);
  const sexSelect = document.getElementById('sex');
  const sexText = sexSelect?.options[sexSelect.selectedIndex]?.text || '';
  patientSection.innerHTML += `<p><strong>Imię i nazwisko:</strong> ${($('fullName').value || '').trim() || '–'}</p>`;
  patientSection.innerHTML += `<p><strong>Wiek:</strong> ${$('age').value || '–'} lata</p>`;
  patientSection.innerHTML += `<p><strong>Płeć:</strong> ${sexText || '–'}</p>`;
  patientSection.innerHTML += `<p><strong>Masa:</strong> ${$('weight').value || '–'} kg</p>`;
  patientSection.innerHTML += `<p><strong>Wzrost:</strong> ${$('height').value || '–'} cm</p>`;
  reportDiv.appendChild(patientSection);

  // Funkcja pomocnicza kopiująca wynik z kart wyników
  const appendResultsSection = (containerId, sectionTitle) => {
    const src = document.getElementById(containerId);
    if (!src || !src.children || src.children.length === 0) return;
    const section = document.createElement('div');
    section.className = 'section';
    const h3 = document.createElement('h3');
    h3.textContent = sectionTitle;
    section.appendChild(h3);
    Array.from(src.children).forEach(child => {
      const p = document.createElement('p');
      p.className = 'result-item';
      // przenieś klasę out-of-range, jeśli istnieje
      if (child.classList.contains('out-of-range')) p.classList.add('out-of-range');
      // kopiuj HTML etykiety i wartości, zachowując span.range
      p.innerHTML = child.innerHTML;
      section.appendChild(p);
    });
    reportDiv.appendChild(section);
  };
  // Sekcja: Klirens / eGFR
  appendResultsSection('clcrInfo', 'Klirens / eGFR');
  // Sekcja: Inne wskaźniki
  appendResultsSection('elecInfo', 'Inne wskaźniki');
  // Sekcja: Ryzyko kamicy nerkowej (wyniki i ostrzeżenia)
  appendResultsSection('stoneInfo', 'Ryzyko kamicy nerkowej');
  // Sekcja: KT/V (jeżeli obliczone)
  {
    const ktv1 = document.getElementById('ktvResult');
    const ktv2 = document.getElementById('ektvResult');
    const hasKTV = (ktv1 && ktv1.style.display !== 'none') || (ktv2 && ktv2.style.display !== 'none');
    if (hasKTV) {
      const section = document.createElement('div');
      section.className = 'section';
      const h3 = document.createElement('h3');
      h3.textContent = 'Wyniki KT/V';
      section.appendChild(h3);
      [ktv1, ktv2].forEach(elem => {
        if (elem && elem.style.display !== 'none') {
          const p = document.createElement('p');
          p.className = 'result-item';
          // skopiuj zawartość wyników KT/V
          p.innerHTML = elem.innerHTML;
          section.appendChild(p);
        }
      });
      reportDiv.appendChild(section);
    }
  }

  // Pokaż raport (konieczne do renderowania przez html2canvas)
  reportDiv.style.display = 'block';

  // Ustal margines w mm oraz rozmiary strony
  const margin = 10;
  const page = { w: 210, h: 297 };
  const avail = { w: page.w - margin * 2, h: page.h - margin * 2 };

  // Utwórz canvas z raportu; scale=2 zapewnia wyższą rozdzielczość
  const canvas = await html2canvas(reportDiv, { scale: 2, useCORS: true, backgroundColor: null });

  // Ukryj raport ponownie
  reportDiv.style.display = 'none';

  // Oblicz przeliczniki – piksele na milimetry
  const pxPerMm = canvas.width / avail.w;
  const imgHfull = canvas.height / pxPerMm;
  // Skalowanie, aby obraz zmieścił się w obszarze avail
  const scale = imgHfull > avail.h ? avail.h / imgHfull : 1;
  const imgWmm = avail.w * scale;
  const imgHmm = imgHfull * scale;

  // Utwórz PDF
  const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', compress: true });
  const offsetX = margin + (avail.w - imgWmm) / 2;
  const offsetY = margin + (avail.h - imgHmm) / 2;
  const imgData = canvas.toDataURL('image/png');
  pdf.addImage(imgData, 'PNG', offsetX, offsetY, imgWmm, imgHmm);
  // Nazwa pliku
  const nameSlug = $('fullName').value.trim().replace(/\s+/g, '_');
  const fileName = (nameSlug ? nameSlug + '_' : '') + 'Klirens_VildaClinic.pdf';
  pdf.save(fileName);
});

/* ---------- 5.4b EKSPORT DOCX/RTF (raport tekstowy) ---------- */
// Generuje plik DOCX przy użyciu biblioteki docx, a jeżeli nie jest dostępna – używa prostej wersji HTML w pliku .doc
$('downloadDOCX').addEventListener('click', async () => {
  // upewnij się, że aktualne wyniki są przeliczone
  if (typeof update === 'function') update();
  // przygotuj dane pacjenta
  const sexSelect = document.getElementById('sex');
  const sexText = sexSelect?.options[sexSelect.selectedIndex]?.text || '';
  const patientLines = [
    ['Imię i nazwisko:', ($('fullName').value || '').trim() || '–'],
    ['Wiek:', $('age').value ? $('age').value + ' lata' : '–'],
    ['Płeć:', sexText || '–'],
    ['Masa:', $('weight').value ? $('weight').value + ' kg' : '–'],
    ['Wzrost:', $('height').value ? $('height').value + ' cm' : '–'],
  ];
  // funkcje pomocnicze do pobierania wyników
  function collectResults(containerId) {
    const arr = [];
    const container = document.getElementById(containerId);
    if (!container || !container.children) return arr;
    Array.from(container.children).forEach(child => {
      const text = child.textContent.trim().replace(/\u00A0/g, ' ');
      const isOut = child.classList.contains('out-of-range') || child.classList.contains('warn-orange') || child.classList.contains('warn-yellow');
      arr.push({ text, isOut });
    });
    return arr;
  }
  const clcrResults = collectResults('clcrInfo');
  const elecResults = collectResults('elecInfo');
  const stoneResults = collectResults('stoneInfo');
  // Zbierz wyniki KT/V, jeśli są widoczne
  const ktvResults = [];
  const ktvElem1 = document.getElementById('ktvResult');
  const ktvElem2 = document.getElementById('ektvResult');
  [ktvElem1, ktvElem2].forEach(elem => {
    if (elem && elem.style.display !== 'none') {
      const text = elem.textContent.trim().replace(/\u00A0/g, ' ');
      if (text) ktvResults.push({ text, isOut: false });
    }
  });
  // sprawdź, czy biblioteka docx jest dostępna
  if (typeof docx !== 'undefined' && docx.Packer) {
    try {
      const { Document, Paragraph, Packer, TextRun, AlignmentType } = docx;
      const children = [];
      // nagłówek
      children.push(new Paragraph({
        children: [new TextRun({ text: 'Raport klirensu / eGFR', bold: true, size: 32 })],
        alignment: AlignmentType.CENTER,
        spacing: { after: 300 },
      }));
      // dane pacjenta
      children.push(new Paragraph({
        children: [new TextRun({ text: 'Dane pacjenta', bold: true, size: 28 })],
        spacing: { before: 200, after: 100 },
      }));
      patientLines.forEach(([label, value]) => {
        children.push(new Paragraph({
          children: [
            new TextRun({ text: label + ' ', bold: true }),
            new TextRun({ text: value }),
          ],
          spacing: { after: 50 },
        }));
      });
      // sekcje wyników
      function appendDocxSection(title, items) {
        if (!items || items.length === 0) return;
        children.push(new Paragraph({
          children: [new TextRun({ text: title, bold: true, size: 28 })],
          spacing: { before: 200, after: 100 },
        }));
        items.forEach(({ text, isOut }) => {
          children.push(new Paragraph({
            children: [new TextRun({ text: text, color: isOut ? 'C62828' : '000000' })],
            spacing: { after: 50 },
          }));
        });
      }
      appendDocxSection('Klirens / eGFR', clcrResults);
      appendDocxSection('Inne wskaźniki', elecResults);
      appendDocxSection('Ryzyko kamicy nerkowej', stoneResults);
      appendDocxSection('Wyniki KT/V', ktvResults);
      // utwórz dokument
      const doc = new Document({
        creator: 'Vilda Clinic',
        description: 'Raport wygenerowany przez kalkulator klirensu kreatyniny / eGFR',
        title: 'Raport klirensu / eGFR',
      });
      doc.addSection({ children });
      const blob = await Packer.toBlob(doc);
      const nameSlug = $('fullName').value.trim().replace(/\s+/g, '_');
      const filename = (nameSlug ? nameSlug + '_' : '') + 'Klirens_VildaClinic.docx';
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      return;
    } catch (e) {
      // jeśli wygenerowanie DOCX się nie powiedzie, przejdź do fallbacku
      console.error('DOCX generation failed, falling back to HTML', e);
    }
  }
  // fallback: wygeneruj prosty dokument HTML/RTF otwieralny w Wordzie
  const htmlParts = [];
  htmlParts.push('<h1 style="text-align:center;">Raport klirensu / eGFR</h1>');
  // dane pacjenta
  htmlParts.push('<h2>Dane pacjenta</h2>');
  patientLines.forEach(([label, value]) => {
    htmlParts.push(`<p><strong>${label}</strong> ${value}</p>`);
  });
  // sekcje wyników
  function appendHtmlSection(title, items) {
    if (!items || items.length === 0) return;
    htmlParts.push(`<h2>${title}</h2>`);
    items.forEach(({ text, isOut }) => {
      const style = isOut ? ' style="color:#c62828;"' : '';
      htmlParts.push(`<p${style}>${text}</p>`);
    });
  }
  appendHtmlSection('Klirens / eGFR', clcrResults);
  appendHtmlSection('Inne wskaźniki', elecResults);
  appendHtmlSection('Ryzyko kamicy nerkowej', stoneResults);
  appendHtmlSection('Wyniki KT/V', ktvResults);
  const htmlContent = `<html><head><meta charset="utf-8"><title>Raport</title></head><body>${htmlParts.join('')}</body></html>`;
  const fallbackBlob = new Blob([String.fromCharCode(0xFEFF) + htmlContent], { type: 'application/msword' });
  const nameSlug2 = $('fullName').value.trim().replace(/\s+/g, '_');
  const fallbackFilename = (nameSlug2 ? nameSlug2 + '_' : '') + 'Klirens_VildaClinic.doc';
  const fallbackUrl = URL.createObjectURL(fallbackBlob);
  const fallbackLink = document.createElement('a');
  fallbackLink.href = fallbackUrl;
  fallbackLink.download = fallbackFilename;
  document.body.appendChild(fallbackLink);
  fallbackLink.click();
  document.body.removeChild(fallbackLink);
  setTimeout(() => URL.revokeObjectURL(fallbackUrl), 1000);
});

/* ---------- 5.4c ZAPYTAJ AI (wysyłanie raportu do modelu językowego) ---------- */
// Ten przycisk tworzy streszczenie raportu i wysyła go do API ChatGPT, aby uzyskać interpretację.
// Aby skorzystać z tej funkcji, należy podać własny klucz API w zmiennej apiKey.
// Więcej informacji: https://platform.openai.com/docs/api-reference/chat/create
$('askAI').addEventListener('click', async () => {
  // Najpierw upewnij się, że wszystkie pola i wyniki są aktualne
  if (typeof update === 'function') update();
  // Zbuduj tekstowy raport na podstawie danych pacjenta i wyników
  const sexSelect = document.getElementById('sex');
  const sexText = sexSelect?.options[sexSelect.selectedIndex]?.text || '';
  const patientInfo = [];
  patientInfo.push(`Imię i nazwisko: ${($('fullName').value || '').trim() || '–'}`);
  patientInfo.push(`Wiek: ${$('age').value || '–'} lata`);
  patientInfo.push(`Płeć: ${sexText || '–'}`);
  patientInfo.push(`Masa: ${$('weight').value || '–'} kg`);
  patientInfo.push(`Wzrost: ${$('height').value || '–'} cm`);
  // Funkcja pomocnicza do zebrania wyników z kontenera
  function collectTexts(id) {
    const arr = [];
    const container = document.getElementById(id);
    if (!container || !container.children) return arr;
    Array.from(container.children).forEach(child => {
      arr.push(child.textContent.trim().replace(/\u00A0/g, ' '));
    });
    return arr;
  }
  // Zbierz wszystkie wyniki do raportu AI. Zawsze dołączamy wszystkie obliczone
  // sekcje: wyniki klirensu/eGFR, inne wskaźniki, ryzyko kamicy oraz KT/V (jeśli są obliczone).
  const clcrTexts = collectTexts('clcrInfo');
  const elecTexts = collectTexts('elecInfo');
  const stoneTexts = collectTexts('stoneInfo');
  const ktvTexts = [];
  const ktvElem1 = document.getElementById('ktvResult');
  const ktvElem2 = document.getElementById('ektvResult');
  [ktvElem1, ktvElem2].forEach(elem => {
    if (elem && elem.style.display !== 'none') {
      const txt = elem.textContent.trim().replace(/\u00A0/g, ' ');
      if (txt) ktvTexts.push(txt);
    }
  });
  // Scal tekst raportu
  let report = 'Raport klirensu / eGFR\n\n';
  report += 'Dane pacjenta:\n' + patientInfo.join('\n') + '\n\n';
  if (clcrTexts.length > 0) {
    report += 'Klirens / eGFR:\n' + clcrTexts.join('\n') + '\n\n';
  }
  if (elecTexts.length > 0) {
    report += 'Inne wskaźniki:\n' + elecTexts.join('\n') + '\n\n';
  }
  if (stoneTexts.length > 0) {
    report += 'Ryzyko kamicy nerkowej:\n' + stoneTexts.join('\n') + '\n\n';
  }
  if (ktvTexts.length > 0) {
    report += 'Wyniki KT/V:\n' + ktvTexts.join('\n') + '\n\n';
  }
  // Przygotuj treść zapytania do modelu językowego. Obejmuje ona rolę oraz prośbę o interpretację.
  const prompt = [
    'Jesteś asystentem medycznym, który interpretuje raporty laboratoryjne i obliczenia eGFR.',
    'Zinterpretuj następujący raport pacjenta. Podaj krótkie podsumowanie i ewentualne zalecenia:',
    report
  ].join('\n\n');
  const apiKey = '';
  // Jeżeli klucz API nie został ustawiony, przygotuj zapytanie do samodzielnego użycia przez użytkownika
  if (!apiKey) {
    try {
      // Spróbuj skopiować zapytanie do schowka, aby ułatwić wklejenie do ChatGPT
      await navigator.clipboard.writeText(prompt);
      alert('Przygotowano zapytanie do AI. Zostało ono skopiowane do schowka. Wklej je w ChatGPT, aby uzyskać interpretację wyników:\n\n' + prompt);
    } catch (e) {
      // Jeśli kopiowanie do schowka nie jest możliwe (np. z powodów bezpieczeństwa), wyświetl tekst do skopiowania ręcznie
      alert('Przygotowano zapytanie do AI. Z powodu ustawień przeglądarki nie można było automatycznie skopiować tekstu. Skopiuj poniższy tekst ręcznie i wklej go w ChatGPT, aby uzyskać interpretację wyników:\n\n' + prompt);
    }
    return;
  }
  // Jeśli klucz API jest skonfigurowany, wyślij zapytanie do OpenAI i pokaż interpretację.
  const apiUrl = 'https://api.openai.com/v1/chat/completions';
  const payload = {
    model: 'gpt-3.5-turbo',
    messages: [
      { role: 'system', content: 'Jesteś asystentem medycznym, który interpretuje raporty laboratoryjne i obliczenia eGFR.' },
      { role: 'user', content: 'Zinterpretuj następujący raport pacjenta. Podaj krótkie podsumowanie i ewentualne zalecenia:\n\n' + report }
    ],
    temperature: 0.4,
    max_tokens: 400
  };
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify(payload)
    });
    if (!response.ok) {
      throw new Error('Błąd zapytania API: ' + response.status);
    }
    const data = await response.json();
    const answer = data.choices?.[0]?.message?.content || 'Brak odpowiedzi.';
    // Pokaż interpretację w nowym oknie alert (lub w przyszłości w dedykowanym elemencie)
    alert('Interpretacja AI:\n\n' + answer);
  } catch (err) {
    console.error(err);
    alert('Wystąpił błąd podczas łączenia z API. Sprawdź konfigurację i połączenie internetowe.');
  }
});

/* ---------- 5.5 POKAŻ PRZYCISKI EKSPORTU PO WYNIKACH ---------- */
const observer = new MutationObserver(() => {
  const hidden = $('results').style.display === 'none';
  $('downloadPDF').hidden = hidden;
  $('downloadDOCX').hidden = hidden;
  // Sekcja interpretacji AI pokazujemy tylko, gdy są wyniki
  const aiFieldset = document.getElementById('aiFieldset');
  if (aiFieldset) aiFieldset.hidden = hidden;
});
observer.observe($('results'), { attributes: true, attributeFilter: ['style'] });
observer.observe($('elecCard'), { attributes: true, attributeFilter: ['style'] });

  /* ---------- 5.6 PRZYCISK CZYSZCZENIA FORMULARZA ---------- */
  // Po załadowaniu skryptu dodajemy obsługę zdarzenia kliknięcia dla
  // przycisku „Wyczyść wszystkie pola”.  Akcja resetuje cały formularz,
  // usuwa komunikaty walidacyjne, ukrywa wyniki oraz przywraca domyślne
  // ustawienia sekcji zaawansowanej KT/V.  Przy pierwszym uruchomieniu
  // przycisk jest ukryty i pojawia się dopiero po wprowadzeniu
  // minimalnych danych (obsługa w funkcji update()).
  const clearBtn = document.getElementById('clearBtn');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      const form = document.getElementById('clcrForm');
      if (form) form.reset();
      // Ręcznie wyczyść pola tylko do odczytu (np. ACR), ponieważ
      // reset() może je pozostawić
      const acrField = document.getElementById('U_ACR');
      if (acrField) acrField.value = '';
      // Usuń komunikaty walidacyjne i klasy błędu
      document.querySelectorAll('.validation-message').forEach(div => { div.textContent = ''; });
      document.querySelectorAll('#clcrForm input').forEach(inp => inp.classList.remove('error'));
      // Ukryj wyniki i sekcje z dodatkowymi informacjami
      const resultsCard = document.getElementById('results');
      const elecCard = document.getElementById('elecCard');
      if (resultsCard) resultsCard.style.display = 'none';
      if (elecCard) elecCard.style.display = 'none';
      const clcrInfo = document.getElementById('clcrInfo');
      const elecInfo = document.getElementById('elecInfo');
      if (clcrInfo) clcrInfo.innerHTML = '';
      if (elecInfo) elecInfo.innerHTML = '';
      // Wyczyść imię i nazwisko w nagłówku wyników
      const patientNameEl = document.getElementById('patientName');
      if (patientNameEl) patientNameEl.textContent = '';
      // Przywróć stan zaawansowanych pól KT/V
      const advToggle = document.getElementById('ktvToggle');
      const advBox = document.getElementById('ktvFields');
      if (advToggle) advToggle.checked = false;
      if (advBox) advBox.style.display = 'none';
      // Ukryj wyniki KT/V, jeśli istnieją
      const ktvRes = document.getElementById('ktvResult');
      const ektvRes = document.getElementById('ektvResult');
      if (ktvRes) ktvRes.style.display = 'none';
      if (ektvRes) ektvRes.style.display = 'none';
      // Ukryj przycisk czyszczenia po resecie
      const clearContainer = document.getElementById('clearContainer');
      if (clearContainer) clearContainer.style.display = 'none';
    });
  }
</script>

<!-- 6. INFO BUTTONS: automatyczne dodawanie przycisków „Info” oraz dymków narzędziowych -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ------- 3.1 AUTOMATYCZNE DODAWANIE PRZYCISKU INFO (jeśli go brak) ------- */
  document.querySelectorAll('input[id], select[id]').forEach(field => {
    // pomiń, jeśli już przerobione lub brak rodzica
    if (field.parentElement && field.parentElement.classList.contains('input-group')) return;

    const label = field.closest('label');
    if (!label) return;
    // Skip placeholder rows entirely – these labels are only used to
    // maintain equal row heights and should never produce a visible
    // input-group wrapper.  Without this guard, the wrapper would
    // unhide the underlying input and create unlabeled fields.
    if (label.classList.contains('placeholder-row')) return;

    /* utwórz kontener .input-group */
    const wrapper = document.createElement('div');
    wrapper.className = 'input-group';

    // wstaw wrapper tuż po label (zachowuje semantykę)
    label.insertAdjacentElement('afterend', wrapper);
    wrapper.appendChild(field);
    // Jeżeli pole jest typu checkbox, umożliwiamy zawijanie przycisku Info pod polem,
    // aby zapobiec wychodzeniu przycisku poza kontener w widoku poziomym.
    if (field.type === 'checkbox') {
      wrapper.classList.add('wrap-info');
      // For specific checkbox fields we want the Info button centered relative to
      // the control. Add a special marker class so CSS can target these wrappers.
      if (field.id === 'ktvToggle' || field.id === 'includeKTV') {
        wrapper.classList.add('center-info');
      }
    }

    /* przycisk Info */
    const btn = document.createElement('button');
    btn.type  = 'button';
    btn.className = 'info-btn';
    btn.textContent = 'Info';
    const tipId = 'tip-' + field.id;
    btn.setAttribute('aria-controls', tipId);
    btn.setAttribute('aria-expanded','false');
    wrapper.appendChild(btn);

    /* tooltip */
    const tooltip = document.createElement('div');
    tooltip.id = tipId;
    tooltip.className = 'tooltip';
    tooltip.setAttribute('role','tooltip');
    tooltip.setAttribute('aria-hidden','true');

    /* treść: z data-info albo z globalnej tablicy infoTexts */
    const customText = field.dataset.info ||
                       (typeof infoTexts === 'object' ? infoTexts[field.id] : '');
    tooltip.textContent = customText || 'Brak opisu.';
    wrapper.appendChild(tooltip);
  });

  /* ------- 3.2 OBSŁUGA PRZYCISKÓW ------- */
  const hideAllTips = () => {
    document.querySelectorAll('.tooltip.visible').forEach(tip => {
      tip.classList.remove('visible');
      tip.setAttribute('aria-hidden','true');
      const btn = document.querySelector(`[aria-controls="${tip.id}"]`);
      if (btn) btn.setAttribute('aria-expanded','false');
    });
  };

  document.addEventListener('click', e => {
    const btn = e.target.closest('.info-btn');
    if (!btn){
      hideAllTips();               /* kliknięcie poza – zamknij */
      return;
    }

    /* kliknięto przycisk Info */
    const tipId    = btn.getAttribute('aria-controls');
    const tooltip  = document.getElementById(tipId);
    if (!tooltip) return;

    const isOpen = tooltip.classList.contains('visible');
    hideAllTips();
    if (!isOpen){
      tooltip.classList.add('visible');
      tooltip.setAttribute('aria-hidden','false');
      btn.setAttribute('aria-expanded','true');
    }
  });

  /* klawisz Esc zamyka dymki */
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') hideAllTips();
  });
});
</script>

<!-- Script: version selection and dynamic form handling -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const paramRow = document.querySelector('.param-row');
  const ktvCard = document.getElementById('ktvCard');
  // Ensure param row and KT/V card are hidden initially
  if (paramRow) paramRow.style.display = 'none';
  if (ktvCard) ktvCard.style.display = 'none';
  const versionOptions = document.querySelectorAll('.version-option');
  function applyVersion(version) {
    // Persist the chosen version on the global object so that update()
    // can tailor the displayed results accordingly.  Without this the
    // update() routine has no knowledge of the user’s version choice.
    window.currentVersion = version;
    // Highlight selected option
    versionOptions.forEach(el => {
      el.classList.toggle('selected', el.dataset.version === version);
    });
    // Always show param row when a version is chosen
    if (paramRow) paramRow.style.display = '';
    // Show/hide advanced fields
    const advFields = document.querySelectorAll('.advanced-field');
    if (version === 'basic') {
      advFields.forEach(el => {
        // Hide the advanced element itself
        el.style.display = 'none';
        // If this element is a label followed by an input-group wrapper, hide the wrapper too
        const next = el.nextElementSibling;
        if (next && next.classList && next.classList.contains('input-group')) {
          next.style.display = 'none';
          // Clear values in inputs/selects inside the wrapper
          next.querySelectorAll('input, select').forEach(inp => { inp.value = ''; });
        } else {
          // Clear values of any inputs/selects inside the advanced element
          el.querySelectorAll('input, select').forEach(inp => { inp.value = ''; });
        }
      });
      // When using the basic version, also hide the results card for other indicators
      const elecCardEl = document.getElementById('elecCard');
      const elecInfoEl = document.getElementById('elecInfo');
      if (elecCardEl) elecCardEl.style.display = 'none';
      if (elecInfoEl) elecInfoEl.innerHTML = '';

      // Additionally hide any KT/V result boxes when using the basic version.
      // These elements may persist if they were previously shown in advanced
      // mode. Clearing them here ensures they stay hidden when the user
      // switches back to the basic calculator.
      const ktvResEl  = document.getElementById('ktvResult');
      const ektvResEl = document.getElementById('ektvResult');
      if (ktvResEl)  ktvResEl.style.display  = 'none';
      if (ektvResEl) ektvResEl.style.display = 'none';
    } else if (version === 'advanced') {
      // Show all advanced fields except those reserved exclusively for the
      // profesjonalny tryb (oznaczone klasą pro-field) oraz kartę KT/V.
      // Dzięki temu kalkulator zaawansowany udostępnia dodatkowe pola
      // elektrolitowe, ale ukrywa elementy dostępne tylko w wersji pro.
      advFields.forEach(el => {
        // Determine if the element belongs to a pro‑only field or is a placeholder row.
        const isProOrPlaceholder = (el.id === 'ktvCard' || el.classList.contains('pro-field') || el.classList.contains('placeholder-row'));
        if (isProOrPlaceholder) {
          // Hide the label itself
          el.style.display = 'none';
          // Clear any values inside this element
          el.querySelectorAll('input, select').forEach(inp => { inp.value = ''; });
        } else {
          el.style.display = '';
        }
        const next = el.nextElementSibling;
        if (next && next.classList && next.classList.contains('input-group')) {
          // Hide the wrapper for pro‑only fields and placeholder rows; otherwise show it
          next.style.display = isProOrPlaceholder ? 'none' : '';
          if (isProOrPlaceholder) {
            next.querySelectorAll('input, select').forEach(inp => { inp.value = ''; });
          }
        }
      });
      // Hide any KT/V result boxes when in the advanced version.  These may
      // have been populated during a prior professional session and
      // therefore must be cleared explicitly.
      const ktvResEl  = document.getElementById('ktvResult');
      const ektvResEl = document.getElementById('ektvResult');
      if (ktvResEl)  ktvResEl.style.display  = 'none';
      if (ektvResEl) ektvResEl.style.display = 'none';
      // In advanced mode, the results card can be displayed based on available results (update() will control visibility)
    } else if (version === 'pro') {
      // In the professional version all advanced fields should be visible
      // except for placeholder rows, which serve purely as spacers.  Show
      // the KT/V card and all pro‑specific fields, but hide the placeholder
      // labels and their wrappers.
      advFields.forEach(el => {
        const isPlaceholder = el.classList.contains('placeholder-row');
        if (isPlaceholder) {
          el.style.display = 'none';
        } else {
          el.style.display = '';
        }
        const next = el.nextElementSibling;
        if (next && next.classList && next.classList.contains('input-group')) {
          next.style.display = isPlaceholder ? 'none' : '';
        }
      });
    } else {
      // Unknown or not-yet-supported version.  For forward compatibility we
      // retain the previous behaviour of notifying the user about the
      // professional version’s unavailability and aborting the switch.
      alert('Wersja profesjonalna będzie dostępna w przyszłości.');
      return;
    }
    // Trigger recalculation of results
    if (typeof update === 'function') update();
  }
  versionOptions.forEach(el => {
    el.addEventListener('click', () => {
      // Ignore clicks on disabled options
      if (el.classList.contains('disabled')) return;

      /*
       * Provide subtle haptic feedback on devices that support the
       * Vibration API.  When a user selects one of the calculator
       * versions (basic, advanced or professional) on a touchscreen
       * smartphone, the device will vibrate briefly to acknowledge the
       * selection.  The check for navigator.vibrate ensures that the
       * method exists before calling it, avoiding errors on desktop
       * browsers.  A vibration pattern of ~30 ms is short enough
       * to feel responsive without being distracting.  On devices
       * without vibration support the call is silently ignored.
       */
      if (typeof navigator !== 'undefined' && typeof navigator.vibrate === 'function') {
        try {
          navigator.vibrate(30);
        } catch (err) {
          // Some browsers may throw if vibration is not allowed; fail silently
        }
      }

      const version = el.dataset.version;
      applyVersion(version);
    });
  });
});
</script>

<!-- Service worker registration for Progressive Web App functionality -->
<script>
  if ('serviceWorker' in navigator) {
    // Register the Workbox-based service worker once the page has loaded.
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js').catch(function(err) {
        console.warn('ServiceWorker registration failed:', err);
      });
    });
  }
</script>
</body>
</html>
