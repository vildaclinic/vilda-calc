
<!DOCTYPE html>
<!-- Kalkulator klirensu kreatyniny/eGFR – zmodyfikowany, aby automatycznie aktywować zaawansowane pola KT/V -->
<html lang="pl">
<head>
<meta charset="utf-8">
<title>Kalkulator klirensu kreatyniny – Vilda Clinic</title>
<link rel="manifest" href="manifest-klirens.webmanifest">
<!-- Configure the viewport to allow the page to extend into safe areas on devices with display cut‑outs -->
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<!-- Progressive Web App meta tags -->
<meta name="theme-color" content="#00838d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<!-- 1. IDENTYCZNA SZATA GRAFICZNA -->
<style>
:root {
  --primary: #00838d;
  --secondary: #00b0a6;
  --bg: #ffffff;
  --card: #f5f9f9;
  --text: #333;
  --radius: 8px;
  --shadow: 0 2px 6px rgba(0,0,0,.08);
  --danger: #c62828;
}
/*
 * Dodatkowe klasy użytkowe, aby ułatwić dostosowanie interfejsu użytkownika.
 *
 *  - .center-text: wyrównuje tekst do środka. Używamy go m.in. dla nagłówków
 *    sekcji, aby etykiety „Wybierz wersję kalkulatora” oraz nagłówki kart
 *    wyników były czytelnie wyśrodkowane.
 *  - .inline-checkbox-label: stosuje flexbox, aby tekst i pole wyboru były
 *    ustawione obok siebie w jednej linii, z niewielkim odstępem między nimi.
 *    Dodatkowo ustawia środkowanie całego wiersza, aby etykieta wraz z
 *    checkboxem była wyśrodkowana względem rodzica.
 *  - .white-checkbox: całkowicie nadpisuje domyślne style przeglądarki dla
 *    pola wyboru. Dzięki własnemu obramowaniu i białemu tłu checkboxy
 *    pozostają jasne nawet w ciemnym motywie systemu. Po zaznaczeniu
 *    rysujemy kolorowy „ptaszek” w kolorze motywu głównego.
 *  - .ktv-grid: wymusza układ pól KT/V w jednej kolumnie nawet na szerokich
 *    ekranach. Umożliwia zachowanie przejrzystości sekcji zaawansowanych
 *    obliczeń.
 */
.center-text {
  text-align: center;
}
.inline-checkbox-label {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  font-weight: 500;
  /* Nie zawijaj poszczególnych elementów w nowej linii, aby checkbox zawsze
     znajdował się obok tekstu.  Dzięki temu checkbox nie zsunie się pod
     tekst nawet na węższych ekranach. */
  flex-wrap: nowrap;
}
.white-checkbox {
  appearance: none;
  -webkit-appearance: none;
  width: 1.1em;
  height: 1.1em;
  border: 1px solid var(--text);
  border-radius: 4px;
  background-color: #fff;
  position: relative;
  cursor: pointer;
}
.white-checkbox:checked::after {
  content: '';
  position: absolute;
  top: 0.15em;
  left: 0.35em;
  width: 0.25em;
  height: 0.55em;
  border: solid var(--primary);
  border-width: 0 0.2em 0.2em 0;
  transform: rotate(45deg);
}
.ktv-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 6px;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  background: var(--bg);
  color: var(--text);
}

/*
 * Pasek instalacyjny PWA
 *
 * Ten baner pojawia się u dołu strony podczas pierwszej wizyty,
 * kiedy przeglądarka emituje zdarzenie `beforeinstallprompt`. Umożliwia
 * użytkownikowi zainstalowanie aplikacji jako PWA lub pominięcie instalacji.
 * Po instalacji lub zamknięciu zapamiętujemy decyzję w localStorage,
 * aby nie wyświetlać ponownie banera przy kolejnych uruchomieniach.
 */
#pwaInstallBanner {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 10000;
  background: var(--card);
  color: var(--text);
  border-top: 2px solid var(--primary);
  box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
  padding: 0.8rem 1rem;
  display: none; /* ukryty domyślnie, pokażemy go w JS */
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
  font-size: 0.9rem;
}

#pwaInstallBanner .pwa-message {
  flex: 1 1 auto;
  margin-right: 0.5rem;
}

#pwaInstallBanner button {
  flex: 0 0 auto;
  margin-top: 0.3rem;
}
header {
  background: var(--primary);
  color: #fff;
  text-align: center;
  padding: 1rem;
}
h1 { margin: 0; font-size: clamp(1.4rem,3vw,2rem); }
.container { max-width: 960px; margin-inline: auto; padding: 1rem; }
fieldset {
  border: 1px solid #d0dede;
  background: var(--card);
  padding: 1.4rem 1rem 1rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 1.5rem;
  position: relative;
}
legend {
  font-weight: 600;
  color: var(--primary);
  background: var(--card);
  padding: 0 .6rem;
  font-size: 1rem;
  position: absolute;
  top: -0.7rem;
  left: 0;
}
label {
  display: block;
  margin-top: 0.7rem;
  font-size: 0.95rem;
}
input, select, option {
  font-family: system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  width: 100%;
  padding: 0.45rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1rem;
}

/*
 * The native select element can render slightly shorter than text inputs on some
 * platforms because the UA stylesheet uses a different internal line-height.
 * To ensure the unit selector for serum creatinine (ScrUnit) aligns neatly
 * with other input fields, give it an explicit height calculated from the
 * input’s font size, padding and borders. The calculation below mirrors
 * 1rem of text height, 0.9rem total vertical padding (0.45rem top and
 * bottom) and 2 px of border, yielding an overall height matching the
 * number inputs. Adjusting only this select avoids unexpectedly resizing
 * all dropdowns across the form.
 */
#ScrUnit {
  /*
   * Match the vertical height of the text inputs. Inputs inherit a
   * line‑height of roughly 1.2, so the height is the sum of that line
   * height (≈1.2 rem), the vertical padding (0.9 rem) and the 2 px borders.
   * Using calc(2.1rem + 2px) yields ~35.6 px, closely aligning the dropdown
   * with the number/text inputs across browsers. Padding is kept
   * consistent with other controls.
   */
  height: calc(2.1rem + 2px);
  padding: 0.45rem 0.65rem;
  line-height: 1rem;
}
/* Ensure serum calcium and phosphate unit selectors match input height */
#S_Ca_unit,
#S_PO4_unit {
  /* Match the height of other inputs (similar to #ScrUnit) */
  height: calc(2.1rem + 2px);
  padding: 0.45rem 0.65rem;
  line-height: 1rem;
}
/* Ensure the unit selector for creatinine in a spot urine sample (#Ucr_spot_unit) matches the height of other inputs.
   This mirrors the sizing applied to the serum creatinine and calcium/phosphate selectors so that the layout remains
   consistent when switching units between mg/dl and µmol/L. */
#Ucr_spot_unit {
  height: calc(2.1rem + 2px);
  padding: 0.45rem 0.65rem;
  line-height: 1rem;
}
.flex {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  /* Zapobiegamy rozciąganiu elementów na jednakową wysokość, aby uniknąć dużych pustych przestrzeni w polu „Parametry z surowicy i DZM” */
  align-items: flex-start;
}
.snack-row, .meal-row {
  display: grid;
  grid-template-columns: 1fr 100px 34px;
  gap: 0.5rem;
  align-items: center;
  margin-top: 0.5rem;
}
button.icon {
  background: none;
  border: none;
  font-size: 1.35rem;
  cursor: pointer;
  color: var(--danger);
  font-weight: 900;
  line-height: 1;
}
button.icon:hover { opacity: 0.8; }
button.add-row {
  background: var(--secondary);
  color: #fff;
  border: none;
  padding: 0.45rem 0.9rem;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 0.7rem;
}
button.add-row:hover { background: var(--primary); }
#results {
  display: none;
  flex-direction: column;
  gap: 1.5rem;
}
.card {
  /* Przywracamy oryginalny kolor tła kart (tzw. card), aby całe sekcje wyników pozostały w barwie motywu */
  background: var(--card);
  padding: 1rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.activity-time {
  margin: 0.4rem 0;
  font-size: 1.25rem;
  font-weight: 700;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0.6rem;
}
th, td {
  border: 1px solid #ddd;
  padding: 0.6rem;
  text-align: center;
  font-size: 0.95rem;
}
th {
  background: var(--secondary);
  color: #fff;
}
footer {
  margin-top: 2rem;
  text-align: center;
  font-size: 0.85rem;
  color: #666;
  padding: 1rem 0;
  background: #fafafa;
}
@media(min-width: 700px) {
  .grid-two {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
}

/* center calorie burn block */
#timesCard { text-align: center; }

/* Powiększone ramki wyników BMI i BMR */
.result-box {
  /* Zmieniamy kolor obramowania pól wyników na turkusowy jak nagłówek */
  border: 2px solid var(--primary);
  border-radius: 8px;
  padding: 10px;
  margin: 12px 0;
  font-size: 1.3rem;
  /* Domyślnie tło wyników ustawiamy na białe, aby kontenery były jaśniejsze */
  background: #ffffff;
  text-align: center;
  /* Dodajemy delikatny cień, aby pola wyników były spójne z kartami */
  box-shadow: var(--shadow);
}

/* --- legenda wewnątrz ramek fieldset --- */
fieldset {
  position: relative;
  padding-top: 1.0rem;   /* miejsce na legendę */
}
legend {
  position: absolute;
  top: 0;
  left: 0;
  font-size: 1.1rem;
  font-weight: 600;
  padding: 0 .5rem;
  background: var(--card); /* kolor karty, zakrywa linię ramki */
  border-radius: var(--radius);
}
/* zaokrąglone logo jak kontenery wyników */
header img {
  border-radius: var(--radius);
  display: inline-block; /* opcjonalnie, żeby mieć pewność */
}
/* Wyśrodkowanie nagłówka w karcie "Droga do normy BMI" */
#toNormCard h2 {
  text-align: center;
}

html, body {
  height: 100%;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  scroll-behavior: smooth;
}
/* =====================  UI REFINEMENTS – 2025‑06‑29  ===================== */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
body {
  font-size: 16px;
  line-height: 1.5;
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}

/* Styl raportu PDF – wyświetlany tylko podczas generowania PDF. Używa większych fontów
   i klarownego układu, aby raport był czytelny na jednej stronie A4. */
#pdfReport {
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  font-size: 14px;
  line-height: 1.4;
  color: var(--text);
  width: 100%;
  max-width: 180mm; /* ogranicz szerokość raportu, aby zmieścił się na stronie A4 (210 mm minus marginesy) */
  margin: 0 auto;
  padding: 0;
}
#pdfReport .section {
  margin-bottom: 10px;
  page-break-inside: avoid;
}
#pdfReport h2 {
  font-size: 22px;
  margin: 0 0 6px;
  color: var(--primary);
}
#pdfReport h3 {
  font-size: 16px;
  margin: 8px 0 4px;
  color: var(--secondary);
}
#pdfReport p {
  margin: 2px 0;
}
#pdfReport .result-item {
  margin: 2px 0;
  font-size: 14px;
}
#pdfReport .result-item strong {
  font-weight: 600;
}
#pdfReport .range {
  color: #666;
  font-style: italic;
  margin-left: 2px;
}
#pdfReport .out-of-range {
  color: var(--danger);
  font-weight: 600;
}

/* Buttons */
button,
input[type="button"],
input[type="submit"] {
  cursor: pointer;
  font: inherit;
  border: none;
  border-radius: var(--radius);
  padding: 0.55rem 1.1rem;
  background: var(--primary);
  color: #fff;
  transition: background 0.2s ease, box-shadow 0.2s ease;
}
button:hover,
input[type="button"]:hover,
input[type="submit"]:hover {
  background: var(--secondary);
  box-shadow: var(--shadow);
}
button:disabled {
  opacity: 0.45;
  cursor: not-allowed;
}

/* Icon (×) buttons inside rows */
button.icon {
  background: transparent;
  color: var(--danger);
  font-size: 1.25rem;
  padding: 0.25rem 0.5rem;
  line-height: 1;
}
button.icon:hover {
  background: rgba(198,40,40,0.1);
}

/* Inputs & selects */
input[type="number"],
input[type="text"],
select {
  width: 100%;
  max-width: 100%;
  padding: 0.45rem 0.65rem;
  border: 1px solid #d0d7da;
  border-radius: var(--radius);
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
input:focus,
select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(0,131,141,0.25);
}

/* Stała (poza fokusem) turkusowa ramka dla pól wypełnionych poprawnie */
.is-filled {
  /* Utrzymuj tę samą turkusową ramkę, co podczas fokusa. Używamy !important,
     aby nadpisać inne reguły, które mogłyby zmienić obramowanie lub cień. */
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 2px rgba(0,131,141,0.25) !important;
}

/* === Dodatkowe podświetlenie dla pól wymaganych przez selektor formuł === */
.must-fill {
  /* Pomarańczowa ramka sygnalizująca brakujące dane */
  border-color: #ff9800 !important;
  box-shadow: 0 0 0 2px rgba(255,152,0,0.35) !important;
}

/* === Wygląd sekcji wyboru formuły === */
.formula-picker {
  border: 1px solid #d0dede;
  background: var(--card);
  padding: 0.9rem 1rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin: 0.25rem 0 1rem;
}
.formula-picker label {
  font-weight: 600;
}
#formulaPicker {
  margin-top: 0.35rem;
}
.formula-note {
  font-size: 0.9rem;
  color: #555;
  margin-top: 0.5rem;
}

/* Table design */
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 0.6rem 0.75rem;
  text-align: left;
}
thead th {
  background: var(--primary);
  color: #fff;
  font-weight: 600;
}
tbody tr:nth-child(odd) {
  /* Tło kart z wynikami ustawione na białe, zgodnie z prośbą użytkownika */
  background: #ffffff;
}
tbody tr:hover {
  background: rgba(0,176,166,0.08);
}

/* Card shadow & radius unification */
/* Przywracamy kolor tła sekcji (np. kart klirensu) do barwy motywu, pozostawiając białe tło tylko dla pól wyników (.result-box) */
section.card,
#toNormCard {
  border-radius: var(--radius);
  background: var(--card);
  box-shadow: var(--shadow);
  padding: 1rem;
}

/* Responsive horizontal scrolling for wide tables */
.table-scroll {
  overflow-x: auto;
}
.table-scroll > table {
  min-width: 520px;
}

/* Utility */
.text-center { text-align: center; }
.text-right { text-align: right; }

  /*
   * Dodatkowe dostosowania dla kart wyników i przycisków „Info”.
   *
   * W związku z prośbą o wyśrodkowanie nagłówków „Klirens / eGFR”, „Inne wskaźniki”
   * oraz „Ryzyko kamicy nerkowej” nadajemy im jednoznaczne wyrównanie do środka.
   * Nagłówki te znajdują się wewnątrz kart wyników (#clcrCard, #elecCard, #stoneCard),
   * dlatego selektory są zawężone do odpowiednich identyfikatorów, aby nie wpływać
   * na inne tytuły w aplikacji.
   */
  #clcrCard h2,
  #elecCard h2,
  #stoneCard h2 {
    text-align: center;
    margin-left: auto;
    margin-right: auto;
  }

  /*
   * Aby karty dodatkowych wyników („Inne wskaźniki”, „Ryzyko kamicy nerkowej”) były
   * wyrównane do środka w szerokim widoku, nadajemy im automatyczne marginesy
   * w poziomie. Dzięki temu po zakończeniu obliczeń karty te prezentują się
   * symetrycznie względem osi strony.
   */
  #elecCard,
  #stoneCard {
    margin-left: auto;
    margin-right: auto;
  }

  /*
   * Ukryj przycisk Info oraz odpowiadający mu dymek narzędziowy dla pól
   * #ktvToggle (przełącznik pokazywania zaawansowanych obliczeń KT/V)
   * i #includeKTV (opcja dołączenia wyników KT/V do raportu AI).  Skrypt
   * automatycznego generowania przycisków Info tworzy te elementy, jednak w
   * przypadku tych dwóch pól nie chcemy ich wyświetlać – kryjemy je więc
   * całkowicie za pomocą CSS.  Zastosowano wysoki priorytet (!important), aby
   * nadpisać dowolne inne reguły.
   */
  #ktvToggle + .info-btn,
  #includeKTV + .info-btn,
  #ktvToggle + .info-btn + .tooltip,
  #includeKTV + .info-btn + .tooltip {
    display: none !important;
  }

/* Mobile tweaks */
@media(max-width: 600px) {
  th, td { padding: 0.5rem; }
  button, input[type="button"], input[type="submit"] {
    width: 100%;
    margin-top: 0.5rem;
  }

/* (Przycisk czyszczenia formularza jest definiowany poza blokiem mediów. */
}

/* ======================================================================== */

/* ---------- Przycisk czyszczenia formularza ---------- */
/* Kontener otaczający przycisk ma pełną szerokość formularza i
 * wyśrodkowuje jego zawartość.  Margines dolny oddziela go od
 * kolejnej sekcji formularza.  Domyślnie kontener jest ukryty,
 * a jego widoczność jest sterowana przez logikę JS po wypełnieniu
 * minimalnej liczby pól potrzebnych do obliczeń. */
#clearContainer {
  width: 100%;
  text-align: center;
  margin-bottom: 1rem;
  display: none;
}
/* Sam przycisk wykorzystuje kolor zmiennej --danger, białe litery
 * oraz zaokrąglone narożniki.  Po najechaniu kursorem przycisk
 * staje się delikatnie jaśniejszy. */
#clearBtn {
  background: var(--danger);
  color: #fff;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
}
#clearBtn:hover {
  opacity: 0.9;
}
/* === FORM GRID LAYOUT 2025‑07‑02 FIX === */
#clcrForm {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  grid-template-rows: auto 1fr;
  gap: 1rem;
}
#clcrForm > div {
  display: flex;
  flex-direction: column;
}
#clcrForm > div fieldset {
  flex: 1 1 auto;
}
#clcrForm > .patient-card {
  grid-column: 1 / -1;
  align-self: start;
}
#clcrForm > .patient-card fieldset {
  height: auto;
}

/* === RESULT HIGHLIGHT 2025‑06‑29 ===================== */
:root {
  --brand: #00838d;
  --brand-light: #00b0a6;
  --card-bg: #ffffff;
  --radius: 12px;
  --shadow-s: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-l: 0 4px 22px rgba(0,0,0,0.14);
  --anim-fast: 150ms ease;
}

/* === Kalkulator version selection === */
.version-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 1rem;
}
.version-option {
  border: 1px solid #d0dede;
  background: var(--card);
  padding: 1rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  cursor: pointer;
  font-weight: 600;
  text-align: center;
}
.version-option.selected {
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(0,131,141,0.25);
}
.version-option.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
button,
input[type="submit"] {
  transition: transform var(--anim-fast), box-shadow var(--anim-fast);
}
button:hover,
input[type="submit"]:hover,
button:focus-visible,
input[type="submit"]:focus-visible {
  transform: translateY(-1px) scale(1.02);
  box-shadow: var(--shadow-l);
}

.result-card {
  background: var(--card-bg);
  border: 2px solid var(--brand);
  border-radius: var(--radius);
  box-shadow: var(--shadow-s);
  padding: 1.25rem 1.5rem;
  position: relative;
  overflow: hidden;
}
.result-card.--pulse::after {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--brand-light);
  opacity: 0;
  z-index: -1;
  animation: pulseBG 1s ease-out forwards;
}
@keyframes pulseBG {
  0% { opacity: 0.15; }
  100% { opacity: 0; }
}

.result-number {
  font: 600 2.75rem/1 "Inter", sans-serif;
  letter-spacing: -0.02em;
  color: var(--brand);
  display: inline-flex;
  align-items: flex-end;
}
.result-number small {
  font-size: 0.45em;
  margin-left: 0.1em;
  color: #444;
}

@keyframes fadeSlideUp {
  0% { opacity: 0; transform: translateY(12px); }
  100% { opacity: 1; transform: translateY(0); }
}
.animate-in {
  animation: fadeSlideUp 0.45s cubic-bezier(0.4,0,0.2,1);
}

@media (prefers-reduced-motion: reduce) {
  * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; }
}

/* === DATA CARDS 2025‑06‑29 ===================== */
.data-card {
  background: var(--card);
  border: 2px solid var(--primary);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 1.25rem 1rem;
  overflow: auto;
}

.data-card table {
  width: 100%;
  border-collapse: collapse;
}

.data-card thead {
  background: var(--primary);
  color: #fff;
}

.data-card th,
.data-card td {
  padding: 0.4rem 0.6rem;
  text-align: center;
}

.data-card tr:nth-child(even) {
  background: rgba(0,0,0,0.03);
}

/* === PLAN RESULTS TWO-COLUMN LAYOUT 2025‑06‑30 === */
#planResults {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
@media(max-width: 600px) {
  #planResults {
    grid-template-columns: 1fr;
  }
}

/* === BMI & BMR BLOCK FRAME PATCH 2025‑06‑30 === */
#bmiCard {
  border: 1px solid #d0dede;
}

/* === TIMES CARD FRAME PATCH 2025‑06‑30 === */
#timesCard {
  border: 1px solid #d0dede;
}

/* === UI TWEAKS – 50 centyl & Plan (2025‑06‑30) === */
.bmi50-info {
  font-size: 1.3rem !important;
  font-weight: 600;
  display: block;
  margin-top: 6px;
}
.bmi50-info .bmi50-number {
  font-size: 1.4rem;
  font-weight: 600;
}
.plan-time {
  font-size: 1.5rem;
  font-weight: 600;
  display: inline-block;
  margin-bottom: 2px;
}

/* === PATCH 2025‑07‑01 – PLAN & 50 centyl UI === */
.small-50 { font-size: 0.1rem; font-weight: 500; }
.plan-time, .plan-month, .plan-year {
  font-size: 1.5rem;
  font-weight: 600;
  display: inline-block;
  margin-bottom: 2px;
}

/* === PLAN CARD – override font size ONLY in plan columns (added 2025‑07‑01) === */
.plan-col .result-number {
  font-size: 1.4rem;
  font-weight: 600;
}

/* === SPACING FIX FOR FIELDSETS – 2025‑08‑01 ===
   Zastępujemy układ grid dla formularza #clcrForm układem kolumnowym flex,
   aby sekcje (Dane pacjenta, Parametry z surowicy i DZM, Parametry z dobowej zbiórki moczu)
   były rozmieszczone w równych odstępach pionowych. Dodatkowo param-row
   jest układem poziomym flex na duże ekrany z zawijaniem, a param-col definiuje
   minimalną szerokość każdej kolumny. */
#clcrForm {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  /* nadpisujemy wrap i align-items z klasy .flex, aby elementy nie zawijały się i
     każdy wiersz zajmował całą szerokość formularza */
  flex-wrap: nowrap;
  align-items: stretch;
}
/* Specjalne dopasowanie kontenera z parametrami – element param-row musi
   nadpisać domyślne ustawienia #clcrForm > div, aby kolumny były ustawione obok
   siebie i miały niezależną wysokość. */
#clcrForm > .param-row {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 1rem;
}
#clcrForm > .param-row > .param-col {
  flex: 1 1 320px;
}

/* === WIDTH EQUALIZATION FOR PATIENT FIELDSET (2025‑08‑03) ===
   Aby sekcja „Dane pacjenta” miała identyczną szerokość jak pola
   „Parametry z surowicy i DZM” oraz „Parametry z dobowej zbiórki moczu”,
   ograniczamy jej szerokość na dużych ekranach do połowy szerokości
   kontenera formularza (z uwzględnieniem odstępu między kolumnami).
   Na mniejszych ekranach pole to wypełnia całą dostępną szerokość,
   dzięki czemu zachowujemy spójny wygląd zarówno w widoku mobilnym,
   jak i w trybie PC. */
@media (min-width: 700px) {
  #clcrForm > .patient-card {
    /* Aby sekcja „Dane pacjenta” miała dokładnie taką samą szerokość
       jak pojedyncza kolumna wiersza parametrów, obliczamy ją na podstawie
       sumy szerokości dwóch kolumn param-row oraz odstępu między nimi.
       Każda kolumna param-row zajmuje połowę szerokości wiersza
       pomniejszoną jedynie o odstęp między kolumnami (1 rem). Dlatego
       odejmujemy jedynie tę przerwę, a nie całkowity padding kontenera. */
    width: calc((100% - 1rem) / 2);
    /* Zapobiegamy automatycznemu rozciąganiu, aby zachować powyższą szerokość. */
    flex: 0 0 auto;
  }
}
@media (max-width: 699px) {
  #clcrForm > .patient-card {
    /* Na małych ekranach sekcja wypełnia pełną szerokość kontenera,
       tak jak pozostałe pola, co zapewnia spójny układ. */
    width: 100%;
  }
}

/* === PATCH 2025‑07‑01 – pełna szerokość karty Inne wskaźniki === */
#elecCard { grid-column: 1 / -1; }
#elecInfo {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
#elecInfo .result-box {
  /*
     Domyślnie każda karta wyniku zajmuje co najmniej około 260 px
     szerokości i może rosnąć w zależności od dostępnego miejsca.
     Ustawiamy min-width na 0, aby elementy mogły się zmniejszać
     poniżej swojego flex-basis bez generowania poziomego przewijania.
  */
  flex: 1 1 260px;
  min-width: 0;
}

/*
  W widokach mobilnych (np. telefony w orientacji pionowej) wymuszamy,
  aby każdy wynik był wyświetlany w osobnym wierszu na pełną
  szerokość kontenera. Dzięki temu długie etykiety nie będą
  wychodziły poza granice sekcji, a układ pozostanie czytelny.
*/
@media (max-width: 600px) {
  #elecInfo .result-box {
    flex: 1 1 100%;
  }
}

/* === OUT-OF-RANGE HIGHLIGHT === */
/* === STAGE HIGHLIGHT COLORS (KDIGO G3a/G3b) === */
.result-box.warn-orange {
  background: #fff3e0;   /* jasny pomarańczowy */
  border-color: #ffa726; /* pomarańcz */
}
.result-box.warn-orange strong {
  color: #ef6c00;
}
.result-box.warn-yellow {
  background: #fffde7;   /* jasny żółty */
  border-color: #fff176; /* żółty */
}
.result-box.warn-yellow strong {
  color: #fbc02d;
}

.result-box.out-of-range {
  background: #ffebee;
  border-color: #e57373;
}
.result-box.out-of-range strong {
  color: #c62828;
}

/* === EQUAL HEIGHT INPUT CARDS (2025-07-02) === */
/* Modyfikujemy układ formularza #clcrForm tak, aby stosował flexbox w pionie zamiast
   siatki. Dzięki temu każda sekcja formularza (Dane pacjenta, Parametry z surowicy i DZM,
   Parametry z dobowej zbiórki moczu) jest renderowana jako osobny wiersz o wysokości
   dopasowanej do zawartości, a odstępy między nimi określa właściwość gap. */
#clcrForm {
  display: flex !important;
  flex-direction: column;
  gap: 1rem;
}
#clcrForm > div {
  display: flex;
  flex-direction: column;
}
#clcrForm fieldset {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
}
/* helper boxes (optional) fill remaining flex space */
.helper-box {
  margin-top: auto;
  font-size: 0.85rem;
  color: #555;
  background: #eef4f4;
  border: 1px dashed var(--primary);
  border-radius: var(--radius);
  padding: 0.6rem;
}

#clcrForm {
  /* Finalna definicja formularza wykorzystuje flexbox w pionie,
     zapewniając równe odstępy między sekcjami bez sztucznego wydłużania wierszy. */
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
#clcrForm > div {
  display: flex;
  flex-direction: column;
  min-width: 0;  /* avoid overflow */
}
#clcrForm > div.patient-card {
  grid-column: 1 / -1;
}
/* two-column layout inside patient fieldset */
#patientSet {
  display: grid;
  grid-template-columns: 1fr 1fr;
  column-gap: 1rem;
}
/* make labels stretch full width inside patient grid */
#patientSet label {
  margin-top: 0.7rem;
}

/* === FULL‑WIDTH “Klirens / eGFR” CARD (2025‑07‑02) === */
#clcrCard {
  grid-column: 1 / -1;  /* rozciąga się na obie kolumny kontenera #results */
}
  /* ------- Walidacja i podpowiedzi ------- */
  .validation-message {
    color: var(--danger);
    font-size: 0.8rem;
    line-height: 1.2;
  }
  .error {
    border-color: var(--danger) !important;
  }
  .info-icon {
    margin-left: 4px;
    cursor: help;
    color: var(--primary);
    font-size: 1rem;
    line-height: 1;
    vertical-align: middle;
    display: inline-block;
  }
  .info-icon:hover {
    color: var(--primary);
  }
  /* additional classes for validation and tooltips */
  .input-error    { border: 2px solid #d00 !important; }
  .tooltip-icon   { cursor: help; font-weight: bold; color: #36c; margin-left: 4px; }

  /* simple cards used for extra sections (e.g. advanced KT/V) */
  /* Ujednolicony wygląd kart – zaokrąglone narożniki jak w innych sekcjach */
  .card{ border: 1px solid #ccc; padding: 12px; margin: 12px 0; border-radius: var(--radius); }
  .card h2{ margin-top: 0; font-size: 1.1rem; text-align: left; }

  /* Layout for advanced KT/V fields: use flex instead of grid to align labels and icons like other inputs */
  #ktvFields > div {
    /* Utrzymuj poziome ułożenie pola i przycisku Info bez zawijania.  
       Poprzednio włączony flex-wrap pozwalał przyciskowi Info zsuwać się pod pole,  
       dlatego wymuszamy nowrap, aby elementy pozostały w jednym wierszu jak w innych sekcjach. */
    display: flex;
    flex-wrap: nowrap;
    gap: 6px;
  }
  #ktvFields label {
    flex: 1 1 160px;
  }

  /* Make form fields white regardless of system dark/light mode */
  input,
  select,
  option {
    background-color: #fff;
    color: var(--text);
  }

  /* === MOBILE BUTTON PADDING – 2025‑08‑03 === */
  @media (max-width: 600px) {
    #downloadPDF,
    #downloadDOCX,
    #askAI {
      /* szerokość jak pola w .container → 100 % minus 2 × 1 rem wewn. odstępu  */
      width: calc(100% - 2rem);
      /* identyczny odstęp boczny jak .container (1 rem) */
      margin-left: 1rem;
      margin-right: 1rem;
    }
  }

  /* === AI FIELDSET WIDTH FIX – 2025‑08‑09 === */
  /*
     W trybie pełnoekranowym sekcja „Interpretacja AI” nie powinna być
     szersza od kart znajdujących się w głównym kontenerze.  Poprzednia
     poprawka wymuszała pełną szerokość, co powodowało zbyt szeroki wygląd
     tej sekcji na średnich i szerokich urządzeniach, zwłaszcza w orientacji
     poziomej na telefonie.  Ustawiamy maksymalną szerokość na 960 px (taką jak
     kontener) i centrujemy pole w osi X.  Dodatkowo, dla widoków o
     szerokości mniejszej niż ok. 992 px (maksymalna szerokość kontenera wraz
     z odstępami) element uzyskuje szerokość 100% pomniejszoną o 2×1 rem,
     aby linie kart pokrywały się z innymi kartami wewnątrz kontenera.
  */
  #aiFieldset {
    /* Wewnątrz kontenera przyjmij 100 % dostępnej szerokości.  Nie
       ustawiaj maksymalnej szerokości tutaj – kontrolę nad rozmiarem
       przejmuje otaczający kontener (.container). */
    width: 100%;
    max-width: none;
    /* Reset poziomych marginesów – szerokość jest ustalana przez
       kontener, więc nie chcemy dodatkowego centrowania. */
    margin-left: 0;
    margin-right: 0;
  }

  /* === FIX CLIRENS CARD WIDTH ON NARROW SCREENS – 2025‑08‑12 === */
  /*
     Na niektórych urządzeniach mobilnych (np. Beam Pro z Androidem 14) karta
     „Klirens / eGFR” była renderowana nieco szerzej niż pozostałe karty wyników.
     Stało się tak dlatego, że w trybie siatki wymuszaliśmy rozciągnięcie jej
     na wszystkie kolumny poprzez właściwość `grid-column: 1 / -1`.  Gdy przeglądarka
     przełączała się na układ jednokolumnowy, ta deklaracja pozostawała aktywna
     i powodowała drobne rozbieżności w szerokości względem pozostałych kart.

     Poniższe media query resetuje tę właściwość na wąskich ekranach, dzięki czemu
     karta klirensu przyjmuje standardową szerokość kart w kontenerze .container.
  */
  @media (max-width: 699px) {
    #clcrCard {
      /* Usuń wymuszanie rozciągania na wiele kolumn w siatce */
      grid-column: auto;
    }
    /* W widoku jednokolumnowym wszystkie karty wyników powinny mieć taką samą szerokość.
       Usuwamy automatyczne marginesy poziome z kart „Inne wskaźniki” i „Ryzyko kamicy
       nerkowej”, dzięki czemu wąskie widoki prezentują spójny układ kart. */
    #elecCard,
    #stoneCard {
      margin-left: 0;
      margin-right: 0;
    }
  }

  /* === EQUAL HEIGHT PARAM-SECTIONS IN LANDSCAPE – 2025‑08‑03 === */
  /*
     W widoku poziomym (ekrany szersze niż ~700 px) wyrównujemy wysokość
     kolumn z parametrami z surowicy/DZM oraz dobowej zbiórki moczu.
     Domyślnie flexbox rozciąga elementy po przekątnej tylko wtedy, gdy
     align-items ustawione jest na "stretch". Wcześniejsze poprawki
     ustawiają align-items: flex-start, co zapobiegało rozciąganiu
     krótszej kolumny i skutkowało nierównymi wysokościami. Teraz
     przywracamy zachowanie stretch tylko dla wiersza parametrów na
     szerokich ekranach. Dzięki temu sekcja „Parametry z surowicy i DZM”
     w widoku poziomym będzie równa wysokością sekcji „Parametry z
     dobowej zbiórki moczu” i rozciągnie się do dolnej granicy tego
     kontenera.
  */
  @media (min-width: 700px) {
    #clcrForm > .param-row {
      align-items: stretch;
    }
    /* Upewniamy się, że same fieldsety w kolumnach wypełniają przestrzeń
       wysokościową, aby rozciąganie było widoczne. */
    #clcrForm > .param-row > .param-col {
      display: flex;
      flex-direction: column;
    }
    #clcrForm > .param-row > .param-col fieldset {
      /* elementy fieldset elastycznie wypełniają dostępną przestrzeń */
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }
  }

  /* === PLACEHOLDER ROWS FOR SYMMETRY – 2025‑08‑03 === */
  /* Wiersze o klasie .placeholder-row są używane jako niewidoczne odstępy w
     sekcji „Parametry z surowicy i DZM”, aby liczba rzędów w lewej
     kolumnie odpowiadała liczbie pól w kolumnie prawej. W widoku
     poziomym są niewidoczne, ale zachowują wysokość dzięki
     visibility:hidden. W widoku pionowym całkowicie je ukrywamy, aby
     uniknąć dużych pustych przestrzeni. */
  .placeholder-row {
    visibility: hidden;
  }
  @media (max-width: 699px) {
    .placeholder-row {
      display: none;
    }
  }

  /* Hide any info-wrapper following a placeholder row.  Without this rule,
     the automatically inserted .input-group would remain visible in the DOM,
     resulting in blank unlabeled fields.  This rule ensures the wrapper
     stays hidden on all screen sizes. */
  .placeholder-row + .input-group {
    display: none !important;
  }

  /* === INFO‑BUTTON & TOOLTIP – 2025‑08‑03 === */

  /* kontener input + przycisk Info */
  .input-group{
    position:relative;
    display:flex;
    align-items:stretch;
    gap:0.5rem;
  }
  .input-group input,
  .input-group select{
    flex:1 1 auto;           /* przejmij całą dostępną szerokość */
  }

  /* przycisk Info */
  .info-btn{
    flex:0 0 auto;
    background:#00b0a6;      /* turkus – dopasuj do motywu */
    color:#fff;
    font-weight:600;
    border:none;
    border-radius:var(--radius,6px);
    padding:0.5rem 1rem;
    cursor:pointer;
    transition:background .2s,transform .15s;
  }
  .info-btn:hover{background:#00838d;}
  .info-btn:focus{
    outline:2px solid #00838d;
    outline-offset:2px;
  }

  /* dymek */
  .tooltip{
    display:none;            /* ukryty domyślnie */
    position:absolute;
    top:100%; left:0;
    margin-top:0.35rem;
    max-width:280px;
    padding:0.75rem;
    background:#f0f9f9;      /* jasny turkus */
    color:#000;
    border:1px solid #00b0a6;
    border-radius:4px;
    box-shadow:0 2px 8px rgba(0,0,0,.15);
    z-index:1000;
  }
  /* strzałka */
  .tooltip::before{
    content:"";
    position:absolute;
    top:-6px; left:22px;
    border:6px solid transparent;
    border-bottom-color:#f0f9f9;
  }
  /* widoczny dymek */
  .tooltip.visible{display:block;}

  /* Dodatkowa logika dla pól typu checkbox: zawijaj elementy wewnątrz, aby przycisk Info nie wychodził poza kontener */
  .wrap-info{
    flex-wrap: wrap;
  }
  /* Nie rozciągaj pól typu checkbox na całą szerokość w obrębie .wrap-info */
  .wrap-info input[type="checkbox"],
  .wrap-info select[type="checkbox"]{
    flex: 0 0 auto;
  }
  /* Gdy przycisk Info znajduje się obok checkboxa, pozwól mu zawijać się na nową linię bez rozciągania na pełną szerokość */
  .wrap-info .info-btn{
    flex: 0 0 auto;
    margin-top: 0.25rem;
  }

  /* mobile: keep the same horizontal alignment for the Info button as on larger screens.
     Previously we switched the .input-group to a 2/3‑1/3 grid on narrow screens, which
     caused the Info buttons to take up one third of the available width and
     mis‑align relative to their inputs. To ensure the placement and alignment of the
     Info buttons remains consistent between single‑column and two‑column layouts,
     we retain the flex layout on small screens and let the button size itself to
     its content. */
  @media(max-width:600px){
    .input-group{
      display:flex;          /* remain a horizontal flex container */
      align-items:stretch;   /* match the height of its children */
    }
    .info-btn{
      width:auto;            /* do not force full width; size based on content */
      align-self:stretch;    /* match input height */
    }
  }

  /* Center Info buttons for specific checkbox fields. The toggle for advanced KT/V
     calculations (#ktvToggle) and the option to include KT/V in the AI report
     (#includeKTV) are rendered as checkboxes with an adjacent Info button. By default
     checkbox wrappers (.wrap-info) add a top margin to the Info button which pushes it
     down and misaligns it with the checkbox and label. The rules below remove that
     top margin and vertically center the button within the wrapper. */
  #ktvToggle + .info-btn,
  #includeKTV + .info-btn {
    margin-top: 0;
    align-self: center;
  }

  /* When a wrapper has the .center-info class (added in the JS for specific
     checkbox fields), center the checkbox and its Info button horizontally.
     We rely on flexbox to distribute space around the two children evenly. */
  .center-info {
    justify-content: center;
  }
  .center-info .info-btn {
    margin-top: 0;
  }
  /* --------------------------------------------------------------------
   * PWA/iOS dostosowania
   *
   * Na urządzeniach z iOS (np. iPhone z Dynamic Island) należy uwzględnić
   * bezpieczny obszar u góry ekranu.  Dodając wysokość safe‑area do górnego
   * paddingu nagłówka zapobiegamy nakładaniu się logo i tytułu na wycięcie.
   */
  header {
    padding-top: calc(1rem + env(safe-area-inset-top));
  }

  /*
   * W orientacji poziomej (landscape) aplikacja może rozszerzać się na całą
   * szerokość ekranu, co powoduje, że zawartość nachodzi na wycięcie (notch)
   * urządzeń iPhone.  Aby temu zapobiec, dodajemy wewnętrzny padding
   * po lewej i prawej stronie dokumentu równy bezpiecznym odstępom.
   * Używamy zmiennych środowiskowych `safe-area-inset-left` i
   * `safe-area-inset-right`.  Na nowoczesnych przeglądarkach wspierających
   * funkcję `max()` stosujemy większy z tych odstępów po obu stronach,
   * tak aby odległości były symetryczne.  Dzięki temu aplikacja nie będzie
   * nachodzić na wycięcie w trybie poziomym, a marginesy będą równomierne.
   */
  @media (orientation: landscape) {
    body {
      /* Podstawowe odstępy odpowiadające lewemu i prawemu bezpiecznemu obszarowi */
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    @supports (padding-left: max(0px)) {
      body {
        /* Zastosuj większy z odstępów po obu stronach, aby były symetryczne */
        padding-left: max(env(safe-area-inset-left), env(safe-area-inset-right));
        padding-right: max(env(safe-area-inset-left), env(safe-area-inset-right));
      }
    }
  }
</style>

  <!-- Manifest and icons for PWA installation -->
  <link rel="manifest" href="manifest-klirens.webmanifest">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
  <!-- Use the new 180×180 icon from the provided icon set for better iOS integration -->
  <link rel="apple-touch-icon" href="icons-klirens/icon-180.png">

<!-- 2. BIBLIOTEKI -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Biblioteka do generowania plików DOCX. Jeśli z jakiegoś powodu nie zostanie załadowana (np. brak internetu), skrypt wykorzysta prosty fallback HTML/RTF. -->
    <script src="https://cdn.jsdelivr.net/npm/docx@7.7.0/build/index.js"></script>
</head>

<body>
<header>
  <!-- 
    Otaczamy logo linkiem prowadzącym do strony Vilda Clinic.
    Używamy atrybutu target="_blank" aby otworzyć stronę w nowej karcie,
    a także rel="noopener noreferrer", co zapobiega potencjalnym atakom
    typu reverse tabnabbing i nie przekazuje nagłówka referrer na zewnętrzną witrynę.
  -->
  <a href="https://vildaclinic.pl" target="_blank" rel="noopener noreferrer">
    <img src="logo_vilda.jpeg" alt="Vilda Clinic logo" style="max-width:160px;margin-bottom:10px;border-radius:var(--radius);">
  </a>
  <h1>Kalkulator klirensu kreatyniny / eGFR</h1>
</header>

  <!-- Pasek instalacyjny PWA.  Ukryty domyślnie, wyświetlany tylko gdy spełnione są warunki instalacji. -->
  <div id="pwaInstallBanner" role="dialog" aria-live="polite" aria-label="Okno instalacji PWA">
    <span class="pwa-message">Możesz zainstalować tę aplikację i korzystać z niej offline.</span>
    <button id="pwaInstallButton">Zainstaluj</button>
    <button id="pwaDismissButton" type="button">Nie&nbsp;teraz</button>
  </div>

<div class="container">

  <!-- 3. FORMULARZ DANYCH PACJENTA -->
  <form id="clcrForm" class="flex" onsubmit="return false;">
    <div class="patient-card" style="flex:1 1 300px;">
      <fieldset id="patientSet"><legend>Dane pacjenta</legend>
        <label>Imię i nazwisko:
          <input type="text" id="fullName"></label>
        <label>Wiek (lata):
          <input type="number" id="age" min="0" max="120" required></label>
        <label>Płeć:
          <select id="sex">
            <option value="M">Mężczyzna</option>
            <option value="F">Kobieta</option>
          </select></label>
        <label>Masa ciała (kg):
          <input type="number" id="weight" min="2" max="300" required></label>
        <label>Wzrost (cm):
          <input type="number" id="height" min="30" max="250" required></label>
      </fieldset>

      <!-- ✨ Wybór formuły (alfabetycznie). Ten moduł pojawia się pomiędzy kartą „Dane pacjenta” a wyborem wersji kalkulatora. -->
      <div class="formula-picker" id="formulaPickerWrap">
        <label for="formulaPicker">Wybierz formułę do obliczenia</label>
        <!-- Pole wyszukiwarki filtrującej listę formuł -->
        <input id="formulaSearch" type="text" placeholder="Filtruj formuły…" aria-label="Filtruj formuły" style="margin:.35rem 0 .35rem 0;">
        <!-- Lista wyników filtra wyświetlana na żywo.  Pojawia się tylko gdy pole filtrowania nie jest puste. -->
        <!-- Lista wyników do debugowania: początkowo ukryta (display:none) zostanie dynamicznie ustawiona przez JS.
             Tymczasowo zmieniono display na block, aby łatwiej dostrzec, czy element jest tworzony (podczas testów). -->
        <div id="formulaLive" style="display:none; border:1px solid #d0dede; border-radius:6px; background:#fff; margin:4px 0 6px 0; max-height:220px; overflow:auto; box-shadow:0 2px 6px rgba(0,0,0,.08);"></div>
        <select id="formulaPicker">
          <option value="">— wybierz —</option>
        </select>
        <div class="formula-note" id="formulaNote" style="display:none;"></div>
      </div>
    </div>
    <!-- Wybór wersji kalkulatora: Podstawowy / Zaawansowany / Obliczenia z próbki moczu / Profesjonalny -->
    <div id="versionContainer" class="version-container">
      <!-- Wyśrodkowane pole z etykietą wyboru wersji kalkulatora -->
      <p class="center-text" style="font-weight:600;margin:0 0 0.5rem;">Wybierz wersję kalkulatora</p>
      <div id="version-basic" class="version-option" data-version="basic">Podstawowy</div>
      <div id="version-advanced" class="version-option" data-version="advanced">Zaawansowany</div>
      <!-- Dodano wersję "Obliczenia z próbki moczu" umożliwiającą wyświetlenie jedynie sekcji próbki moczu -->
      <div id="version-spot" class="version-option" data-version="spot">Obliczenia z próbki moczu</div>
      <!-- Odblokowujemy wersję profesjonalną (usunięto klasę disabled) -->
      <div id="version-pro" class="version-option" data-version="pro">Profesjonalny</div>
    </div>
    <!-- Kontener z przyciskiem do całkowitego czyszczenia formularza.  Początkowo
         jest on niewidoczny; zostanie pokazany dopiero po podaniu minimalnych
         danych (wiek, masa, wzrost, kreatynina w surowicy), tak aby
         użytkownik mógł szybko wyczyścić wszystkie pola przed wprowadzeniem
         nowego pacjenta.  Element znajduje się między sekcją „Dane pacjenta”
         a pierwszą kolumną parametrów, co zapewnia dobrą widoczność w
         układzie formularza. -->
    <div id="clearContainer" style="display:none;">
      <button id="clearBtn" type="button">Wyczyść wszystkie pola</button>
    </div>

    <div class="param-row" style="display:none;">
      <!-- Lewa kolumna: Parametry z surowicy (u góry) i Parametry z próbki moczu (na dole) -->
      <div class="param-col">
        <!-- Parametry z surowicy -->
        <fieldset id="serumSet"><legend>Parametry z surowicy</legend>
          <!-- Pole kreatyniny z możliwością wyboru jednostki (mg/dl lub µmol/L) -->
          <label>Kreatynina w surowicy:
            <input type="number" step="0.01" id="Scr" required />
          </label>
          <label>Jednostka kreatyniny w surowicy:
            <select id="ScrUnit">
              <!-- Domyślnie ustawiamy jednostkę kreatyniny na mg/dl.  Dzięki temu
                   we wszystkich wersjach kalkulatora, w których używana jest
                   kreatynina z surowicy, użytkownik zawsze ma wybraną
                   prawidłową jednostkę.  Atrybut selected gwarantuje, że
                   przeglądarka nie ustawi pustej wartości nawet po zmianie
                   wersji kalkulatora. -->
              <option value="mg/dl" selected>mg/dl</option>
              <option value="umol">µmol/L</option>
            </select>
          </label>
          <!-- Parametry z surowicy (elektrolity i inne) -->
          <label class="advanced-field">Sód (Na, mmol/L):
            <input type="number" id="S_Na" step="0.1" />
          </label>
          <label class="advanced-field">Potas (K, mmol/L):
            <input type="number" id="S_K" step="0.1" />
          </label>
          <label class="advanced-field">Chlorki (Cl, mmol/L):
            <input type="number" id="S_Cl" step="0.1" />
          </label>
          <label class="advanced-field">HCO₃⁻ (mmol/L):
            <input type="number" id="S_HCO3" step="0.1" />
          </label>
          <!-- Serum phosphate with selectable units (mg/dl or mmol/L).  The unit selector defaults to mg/dl. -->
          <label class="advanced-field">Fosfor (PO₄):
            <input type="number" id="S_PO4" step="0.1" />
          </label>
          <label class="advanced-field">Jednostka fosforu w surowicy:
            <select id="S_PO4_unit">
              <option value="mg/dl" selected>mg/dl</option>
              <option value="mmol/L">mmol/L</option>
            </select>
          </label>
          <label class="advanced-field">Kwas moczowy (mg/dl):
            <input type="number" id="S_UA" step="0.1" />
          </label>
          <!-- === KAMICA (krew) — START === -->
          <!-- Serum total calcium with selectable units.  Default unit is mmol/L for clinical practice. -->
          <label class="advanced-field pro-field">Wapń całkowity (Ca):
            <input type="number" id="S_Ca" step="0.1" />
          </label>
          <label class="advanced-field pro-field">Jednostka wapnia w surowicy:
            <select id="S_Ca_unit">
              <option value="mg/dl">mg/dl</option>
              <option value="mmol/L" selected>mmol/L</option>
            </select>
          </label>
          <label class="advanced-field pro-field">Parathormon (PTH, pg/ml):
            <input type="number" id="S_PTH" step="1" />
          </label>
          <label class="advanced-field pro-field">25‑hydroksy‑witamina D (25‑OHD, ng/ml):
            <input type="number" id="S_VitD" step="1" />
          </label>
          <!-- === KAMICA (krew) — END === -->
        </fieldset>

        <!-- Parametry z próbki moczu (nowa sekcja) -->
        <fieldset id="spotSet" class="advanced-field pro-field"><legend>Parametry z próbki moczu</legend>
          <!-- Kreatynina w próbce moczu (nowe pole) -->
          <label>Kreatynina w próbce moczu:
            <input type="number" step="0.1" id="Ucr_spot" />
          </label>
          <!-- Jednostka kreatyniny w próbce moczu (mg/dl lub µmol/L). Domyślnie ustawiamy mg/dl. -->
          <label>Jednostka kreatyniny w próbce moczu:
            <select id="Ucr_spot_unit">
              <option value="mg/dl" selected>mg/dl</option>
              <option value="umol">µmol/L</option>
            </select>
          </label>
          <label>Albumina w próbce moczu (mg/L):
            <input type="number" step="0.1" id="U_Alb" />
          </label>
          <label>Albumina/kreatynina (ACR, mg/g):
            <input type="number" step="0.1" id="U_ACR" readonly />
          </label>
        <!-- Wapń w próbce moczu wraz z wyborem jednostki (mg/dl lub mmol/L).  
             Użytkownik może podać stężenie wapnia w dowolnej z tych jednostek,
             a skrypt automatycznie przeliczy je do mg/dl podczas obliczeń
             wskaźnika Ca/Cr (spot).  
             Pola są oznaczone jako zaawansowane i profesjonalne, aby były
             widoczne w trybie „Obliczenia z próbki moczu” oraz „Profesjonalnym”. -->
        <label class="advanced-field pro-field">Wapń w próbce moczu:
          <input type="number" step="0.1" id="Ca_spot" />
        </label>
        <label class="advanced-field pro-field">Jednostka wapnia w próbce moczu:
          <select id="Ca_spot_unit">
            <!-- Domyślnie ustawiamy jednostkę wapnia na mmol/L.  Dzięki temu użytkownik
                 ma wybraną jednostkę od razu po wejściu w sekcję próbki moczu.  Jeśli
                 później zmieni wersję kalkulatora, wybrana jednostka zostanie zachowana. -->
            <option value="mg/dl">mg/dl</option>
            <option value="mmol/L" selected>mmol/L</option>
          </select>
        </label>
          <!-- === KAMICA (próbka moczu) — START === -->
          <label class="advanced-field pro-field">pH pojedynczej próbki moczu:
            <input type="number" id="U_pH" step="0.01" placeholder="np. 5.8" />
          </label>
          <label class="advanced-field pro-field">Szczawiany w próbce moczu (Ox, mg/dl):
            <input type="number" id="Ox_Cr_spot" step="0.1" />
          </label>
          <label class="advanced-field pro-field">Cytryniany w próbce moczu (Cit, mg/dl):
            <input type="number" id="Cit_Cr_spot" step="1" />
          </label>
          <!-- === KAMICA (próbka moczu) — END === -->

          <!-- === TmP/GFR (próbka moczu) — START === -->
          <!-- Pola do obliczania wskaźnika TmP/GFR w trybie próbki moczu.
               Użytkownik wprowadza stężenie fosforanów w próbce oraz kreatyninę w surowicy
               i fosfor w surowicy wraz z jednostkami.  Pola te będą widoczne w wersji
               „Obliczenia z próbki moczu” oraz w wersji profesjonalnej. -->
          <label class="advanced-field pro-field">Fosforany w próbce moczu:
            <input type="number" step="0.1" id="U_PO4_spot" />
          </label>
          <label class="advanced-field pro-field">Jednostka fosforanów w próbce moczu:
            <select id="U_PO4_spot_unit">
              <option value="mg/dl" selected>mg/dl</option>
              <option value="mmol/L">mmol/L</option>
            </select>
          </label>
          <label class="advanced-field pro-field">Fosfor w surowicy:
            <input type="number" step="0.1" id="S_PO4_spot" />
          </label>
          <label class="advanced-field pro-field">Jednostka fosforu w surowicy:
            <select id="S_PO4_spot_unit">
              <option value="mg/dl" selected>mg/dl</option>
              <option value="mmol/L">mmol/L</option>
            </select>
          </label>
          <label class="advanced-field pro-field">Kreatynina w surowicy:
            <input type="number" step="0.01" id="Scr_spot" />
          </label>
          <label class="advanced-field pro-field">Jednostka kreatyniny w surowicy:
            <select id="Scr_spot_unit">
              <option value="mg/dl" selected>mg/dl</option>
              <option value="umol">µmol/L</option>
            </select>
          </label>
          <!-- === TmP/GFR (próbka moczu) — END === -->
        </fieldset>
      </div>
      <!-- Prawa kolumna: Parametry z dobowej zbiórki moczu -->
      <div class="param-col">
        <fieldset id="dzmSet"><legend>Parametry z dobowej zbiórki moczu</legend>
          <label>Kreatynina w moczu 24 h (mg/dl):
            <input type="number" step="0.1" id="Ucr" />
          </label>
          <label>Objętość dobowej zbiórki moczu (ml):
            <input type="number" id="V24" placeholder="np. 1500" />
          </label>
          <label class="advanced-field">Sód (Na, mmol/L):
            <input type="number" id="U_Na" step="0.1" />
          </label>
          <label class="advanced-field">Potas (K, mmol/L):
            <input type="number" id="U_K" step="0.1" />
          </label>
          <label class="advanced-field">Chlorki (Cl, mmol/L):
            <input type="number" id="U_Cl" step="0.1" />
          </label>
          <label class="advanced-field">HCO₃⁻ (mmol/L):
            <input type="number" id="U_HCO3" step="0.1" />
          </label>
          <label class="advanced-field">Fosfor (PO₄, mg/dl):
            <input type="number" id="U_PO4" step="0.1" />
          </label>
          <label class="advanced-field">Kwas moczowy (mg/dl):
            <input type="number" id="U_UA" step="0.1" />
          </label>
          <!-- Zmiana jednostek: wapń w mmol/L, magnez w mg/L, białko całkowite w mg/24 h -->
          <label class="advanced-field">Wapń (Ca, mmol/L):
            <input type="number" id="U_Ca" step="0.1" />
          </label>
          <label class="advanced-field">Magnez (Mg, mg/L):
            <input type="number" id="U_Mg" step="0.1" />
          </label>
          <label class="advanced-field">Białko całkowite (mg/24 h):
            <input type="number" id="U_Prot" step="1" />
          </label>
          <!-- === KAMICA (dobowa zbiórka) — START === -->
          <label class="advanced-field pro-field">Szczawiany (Ox, mg/dl):
            <input type="number" id="U_Ox" step="0.1" />
          </label>
          <label class="advanced-field pro-field">Cytryniany (Cit, mg/dl):
            <input type="number" id="U_Cit" step="1" />
          </label>
          <label class="advanced-field pro-field">Cystyna (Cys, mg/dl):
            <input type="number" id="U_Cys" step="1" />
          </label>
          <label class="advanced-field pro-field">pH dobowego moczu:
            <input type="number" id="pH24" step="0.01" />
          </label>
          <!-- === KAMICA (dobowa zbiórka) — END === -->
        </fieldset>
      </div>
    </div>

    <!-- ⚙️ Zaawansowane obliczenia KT/V (ukryte do czasu zaznaczenia) -->
    <div class="card advanced-field" id="ktvCard" style="display:none;">
      <!-- Etykieta z tekstem i przyciskiem wyboru w jednej linii; wyśrodkowana -->
      <label class="inline-checkbox-label center-text">
        <span>Pokaż zaawansowane obliczenia KT/V</span> <input type="checkbox" id="ktvToggle" class="white-checkbox">
      </label>

      <!-- Pola KT/V – usunięto klasę .ktv-grid, aby Info button był w tej samej linii co pole -->
      <div id="ktvFields" style="display:none;margin-top:8px;">
          <label>Czas dializy (h):
            <input type="number" id="ktvTime" step="0.1" data-max="8">
          </label>
          <label>Ubytek masy (UF, kg):
            <input type="number" id="ktvUF" step="0.1" data-max="10">
          </label>
          <label>Masa ciała po dializie (kg):
            <input type="number" id="ktvW" step="0.1" data-max="300">
          </label>
          <label>Mocznik przed (mg/dl):
            <input type="number" id="UreaPre" step="1" data-max="400">
          </label>
          <label>Mocznik po (mg/dl):
            <input type="number" id="UreaPost" step="1" data-max="400">
          </label>
      </div>

      <!-- wyniki -->
      <div id="ktvResult" class="result-box" style="display:none;"></div>
      <div id="ektvResult" class="result-box" style="display:none;"></div>
    </div>
  </form>

  <!-- 4. WYNIKI -->
  <div id="results" class="grid-two" style="display:none;">
    <div class="card" id="clcrCard">
      <h3 id="patientName" class="text-center" style="margin:0 0 0.4rem 0;"></h3>
      <h2 class="text-center">Klirens / eGFR</h2>
      <p class="text-center" style="font-size:1.2em;">w nawiasach podano zakres referencyjny dla płci i wieku</p>
      <div id="clcrInfo"></div>
      <small>*Klirens 24 h obliczany tylko, gdy podasz zarówno Ucr, V24 i Scr.</small>
    </div>
  </div>
  <div class="card" id="elecCard" style="display:none;">
    <h2 class="text-center">Inne wskaźniki</h2>
    <p class="text-center" style="font-size:1.2em;">w nawiasach podano zakres referencyjny dla płci i wieku</p>
    <div id="elecInfo"></div>
  </div>

  <!-- Karta ryzyka kamicy nerkowej: pokazuje dodatkowe wskaźniki i alerty tylko w wersji profesjonalnej -->
  <div class="card advanced-field pro-field" id="stoneCard" style="display:none;">
    <h2 class="text-center">Ryzyko kamicy nerkowej</h2>
    <div id="stoneInfo"></div>
  </div>

</div> <!-- /.container -->

<!-- Kontener do tworzenia eleganckiego raportu PDF. Jest niewidoczny na stronie. -->
<div id="pdfReport" style="display:none;"></div>

<!--
      Przyciski eksportu raportu PDF i DOCX są domyślnie ukryte.  Zmieniamy
      sposób ich ukrywania z atrybutu `hidden` na styl `display: none`,
      ponieważ specyfikacja HTML pozwala przebić działanie `hidden` przez
      deklarację `display:block` w atrybucie style.  Bez tej zmiany
      przyciski były widoczne od razu po załadowaniu strony, mimo iż
      powinny pojawić się dopiero po obliczeniu wyników (tak jak karta
      „Interpretacja AI”).  Używając `display: none` na starcie i
      manipulując tym stylem z poziomu JavaScriptu możemy niezawodnie
      sterować widocznością przycisków.
-->
<button id="downloadPDF" style="display:none; margin:20px auto;">Pobierz raport PDF</button>
<!-- Przycisk do pobierania raportu w formacie DOCX/RTF; ukryty dopóki nie ma wyników -->
<button id="downloadDOCX" style="display:none; margin:20px auto;">Pobierz raport DOCX</button>

    <!-- === Rozszerzony moduł wyboru formuł === -->
    <script>
    (function(){
      // Mapowanie wersji formularza na atrybuty data-version w HTML.  Jeżeli zmienisz
      // identyfikatory wersji (np. na spolszczone), dodaj odpowiedni alias poniżej.
      const VERSION = { basic:'basic', advanced:'advanced', spot:'spot', pro:'pro' };

      /**
       * Pełny rejestr formuł obsługiwanych przez kalkulator.  Każdy element określa:
       *  - id: unikalny identyfikator formuły,
       *  - label: tekst wyświetlany w selektorze,
       *  - version: najmniejsza wersja kalkulatora, która udostępnia wymagane pola
       *             (basic, advanced, spot lub pro),
       *  - requires: lista identyfikatorów pól (input/select), które użytkownik musi
       *              wypełnić, aby móc obliczyć wskazany wskaźnik,
       *  - note: (opcjonalnie) krótka informacja wyświetlana pod selektorem.
       */
      const FORMULAS = [
        // ======= Podstawowy (klirens/eGFR) =======
        { id:'egfr', label:'eGFR (CKD‑EPI 2022)', version:'basic',
          requires:['age','sex','Scr','ScrUnit','weight','height'],
          note:'Aby zobaczyć wyniki, uzupełnij również masę i wzrost (obliczenie BSA).'},
        { id:'cg', label:'Cockcroft–Gault', version:'basic',
          requires:['sex','age','weight','Scr','ScrUnit'] },
        { id:'cg_norm', label:'Cockcroft–Gault (1,73 m²)', version:'basic',
          requires:['sex','age','weight','height','Scr','ScrUnit'],
          note:'Do przeliczenia na 1,73 m² potrzebny jest wzrost.' },
        { id:'cl24', label:'Klirens 24 h (DZM)', version:'basic',
          requires:['age','Ucr','V24','Scr','ScrUnit','weight','height'],
          note:'Wymaga: Ucr, V24, Scr i jednostki oraz masy i wzrostu (BSA).'},
        { id:'sch_var', label:'Schwartz (zmienny k)', version:'basic',
          requires:['age','sex','height','Scr','ScrUnit'],
          note:'Użyteczny u dzieci; wymaga wzrostu i kreatyniny w surowicy.' },
        { id:'sch_idms', label:'Schwartz Bedside IDMS', version:'basic',
          requires:['age','height','Scr','ScrUnit'],
          note:'Wersja IDMS (k=0,413) dla dzieci; wymaga wzrostu i Scr.' },

        // ======= Zaawansowany (dobowa zbiórka moczu i surowica) =======
        { id:'UA_mgkg', label:'Wydalanie kw. moczowego (mg/kg/d)', version:'advanced',
          requires:['age','U_UA','V24','weight'] },
        { id:'Ca_mgkg', label:'Wydalanie wapnia (mg/kg/d)', version:'advanced',
          requires:['age','U_Ca','V24','weight'] },
        { id:'Mg_mgkg', label:'Wydalanie magnezu (mg/kg/d)', version:'advanced',
          requires:['age','U_Mg','V24','weight'] },
        { id:'PO4_mgkg', label:'Wydalanie fosforanów (mg/kg/d)', version:'advanced',
          requires:['age','U_PO4','V24','weight'] },
        { id:'Prot_mgkg', label:'Białkomocz (mg/kg/d)', version:'advanced',
          requires:['age','U_Prot','weight'] },
        { id:'Na_mmol_d', label:'Wydalanie sodu (mmol/d)', version:'advanced',
          requires:['age','U_Na','V24'] },
        { id:'K_mmol_d', label:'Wydalanie potasu (mmol/d)', version:'advanced',
          requires:['age','U_K','V24'] },
        { id:'KM_Cr', label:'KM/Cr (kw. moczowy/kreatynina)', version:'advanced',
          requires:['age','U_UA','Ucr'] },
        { id:'Ca_Cr', label:'Ca/Cr (DZM)', version:'advanced',
          requires:['age','U_Ca','Ucr'] },
        { id:'Mg_Ca', label:'Mg/Ca (DZM)', version:'advanced',
          requires:['U_Mg','U_Ca'] },
        { id:'PO4_Cr', label:'PO₄/Cr (DZM)', version:'advanced',
          requires:['U_PO4','Ucr'] },
        { id:'B_Cr', label:'Białko/kreatynina (B/Cr)', version:'advanced',
          requires:['U_Prot','Ucr','V24'] },
        { id:'FENa_pct', label:'FENa – frakcja wydalnicza sodu (%)', version:'advanced',
          requires:['age','U_Na','S_Na','Ucr','Scr','ScrUnit'] },
        { id:'FEK_pct', label:'FEK – frakcja wydalnicza potasu (%)', version:'advanced',
          requires:['age','U_K','S_K','Ucr','Scr','ScrUnit'] },
        { id:'FECl_pct', label:'FECl – frakcja wydalnicza chlorków (%)', version:'advanced',
          requires:['age','U_Cl','S_Cl','Ucr','Scr','ScrUnit'] },
        { id:'FEHCO3_pct', label:'Frakcja wodorowęglanów (HCO₃) (%)', version:'advanced',
          requires:['U_HCO3','S_HCO3','Ucr','Scr','ScrUnit'] },
        { id:'AGs', label:'Luka anionowa (surowica)', version:'advanced',
          requires:['age','S_Na','S_Cl','S_HCO3'] },
        { id:'AGu', label:'Luka anionowa (mocz)', version:'advanced',
          requires:['age','U_Na','U_K','U_Cl'] },
        { id:'K_frac', label:'K/(K+Na) w moczu (%)', version:'advanced',
          requires:['age','U_K','U_Na'] },
        { id:'TRPpct_24', label:'TRP – reabsorpcja fosforanów (24 h)', version:'advanced',
          requires:['age','U_PO4','S_PO4','S_PO4_unit','Ucr','Scr','ScrUnit'],
          note:'Wymaga: U_PO₄, S_PO₄ (z jednostką), U_Cr i Scr.' },
        // Ogólna reabsorpcja fosforanów (TRP) – wykorzystuje stężenia z dobowej zbiórki (DZM).
        { id:'TRPpct', label:'TRP – reabsorpcja fosforanów (ogólna) [%]', version:'advanced',
          requires:['age','U_PO4','S_PO4','S_PO4_unit','Ucr','Scr','ScrUnit'],
          note:'Wymaga: U_PO₄, S_PO₄ (z jednostką), U_Cr i Scr.' },
        { id:'TmP_24_mgdl', label:'TmP/GFR (24 h)', version:'advanced',
          requires:['age','U_PO4','S_PO4','S_PO4_unit','Ucr','Scr','ScrUnit'] },
        { id:'TmP_24_mmol', label:'TmP/GFR (24 h) [mmol/L]', version:'advanced',
          requires:['age','U_PO4','S_PO4','S_PO4_unit','Ucr','Scr','ScrUnit'] },

        // ======= Obliczenia z próbki moczu (spot) =======
        { id:'ACR', label:'ACR – albumina/kreatynina (spot) [mg/g]', version:'spot',
          requires:['U_Alb','Ucr_spot','Ucr_spot_unit'],
          note:'Podaj albuminę (mg/L) i kreatyninę w próbce (mg/dl lub µmol/L).' },
        { id:'CaCr_spot', label:'Ca/Cr (spot) [mg/mg]', version:'spot',
          requires:['age','Ca_spot','Ca_spot_unit','Ucr_spot','Ucr_spot_unit'] },
        { id:'OxCr_spot', label:'Ox/Cr (spot) [mg/mg]', version:'spot',
          requires:['Ox_Cr_spot','Ucr_spot','Ucr_spot_unit'] },
        { id:'CitCr_spot', label:'Cit/Cr (spot) [mg/mg]', version:'spot',
          requires:['age','Cit_Cr_spot','Ucr_spot','Ucr_spot_unit'] },
        { id:'TRPpct_spot', label:'TRP – reabsorpcja fosforanów (spot)', version:'spot',
          requires:['age','U_PO4_spot','U_PO4_spot_unit','S_PO4_spot','S_PO4_spot_unit','Ucr_spot','Ucr_spot_unit','Scr_spot','Scr_spot_unit'] },
        { id:'TmP_spot_mgdl', label:'TmP/GFR (spot)', version:'spot',
          requires:['age','U_PO4_spot','U_PO4_spot_unit','S_PO4_spot','S_PO4_spot_unit','Ucr_spot','Ucr_spot_unit','Scr_spot','Scr_spot_unit'] },
        { id:'TmP_spot_mmol', label:'TmP/GFR (spot) [mmol/L]', version:'spot',
          requires:['age','U_PO4_spot','U_PO4_spot_unit','S_PO4_spot','S_PO4_spot_unit','Ucr_spot','Ucr_spot_unit','Scr_spot','Scr_spot_unit'] },
        { id:'pH_spot', label:'pH próbki moczu (spot)', version:'spot',
          requires:['U_pH'] },

        // ======= Profesjonalny (zaawansowane wskaźniki kamicy i KT/V) =======
        { id:'Ox_mgkg', label:'Wydalanie szczawianów (mg/kg/d)', version:'pro',
          requires:['U_Ox','V24','weight'] },
        { id:'Cit_mgkg', label:'Wydalanie cytrynianów (mg/kg/d)', version:'pro',
        requires:['age','U_Cit','V24','weight'] },
        { id:'Ca_Cit', label:'Stosunek Ca/Cit (mg/mg)', version:'pro',
          requires:['U_Ca','U_Cit'] },
        { id:'pH24', label:'pH dobowej zbiórki (24 h)', version:'pro',
          requires:['pH24'] },
        { id:'KTV', label:'KT/V (Daugirdas)', version:'pro',
          requires:['ktvTime','ktvUF','ktvW','UreaPre','UreaPost'],
          note:'Najpierw zaznacz „Pokaż zaawansowane obliczenia KT/V” w panelu.' }
      ];

      /*
       * Po zdefiniowaniu listy FORMULAS ustal, które wskaźniki wymagają
       * podania wieku (age) lub płci (sex) do określenia zakresu referencyjnego.
       * W wielu przypadkach normy różnią się w zależności od wieku
       * (np. TRP, TmP/GFR, klirensy, wydalania mg/kg/d, frakcje wydalnicze).
       * Niniejszy blok modyfikuje tablicę FORMULAS tak, aby dodać pole 'age'
       * do listy wymaganych pól dla każdego identyfikatora, którego normy są
       * zależne od wieku.  W razie potrzeby można w podobny sposób
       * dodać 'sex' do formuł zależnych od płci, poprzez uzupełnienie
       * poniższego zbioru SEX_DEP.
       */
      (function(){
        // Zbiór identyfikatorów formuł, dla których zakresy referencyjne zależą od wieku.
        const AGE_DEP = new Set([
          // Klirens/eGFR i wzory podstawowe
          'cl24','cg','cg_norm','egfr','sch_var','sch_idms',
          // mg/kg/d lub mmol/d – wydalania dobowego
          'UA_mgkg','Ca_mgkg','Mg_mgkg','PO4_mgkg','Prot_mgkg',
          'Na_mmol_d','K_mmol_d',
          // Stosunki i frakcje wydalnicze zależne od wieku
          'KM_Cr','Ca_Cr','CaCr_spot','CitCr_spot','Cit_mgkg',
          'FENa_pct','FEK_pct','FECl_pct','K_frac','AGs','AGu',
          // Reabsorpcja fosforanów / TmP – różne warianty
          'TRPpct_24','TRPpct','TRPpct_spot',
          'TmP_24_mgdl','TmP_24_mmol','TmP_spot_mgdl','TmP_spot_mmol'
        ]);
        // Zbiór identyfikatorów formuł, których normy zależą od płci (obecnie brak)
        const SEX_DEP = new Set([
          // Przykład: 'przyklad_id'
        ]);
        FORMULAS.forEach(f => {
          // Dodaj wiek jako wymagane pole, jeśli formuła należy do AGE_DEP
          if (AGE_DEP.has(f.id) && Array.isArray(f.requires) && !f.requires.includes('age')) {
            f.requires.unshift('age');
          }
          // Dodaj płeć jako wymagane pole, jeśli formuła należy do SEX_DEP
          if (SEX_DEP.has(f.id) && Array.isArray(f.requires) && !f.requires.includes('sex')) {
            f.requires.unshift('sex');
          }
        });
      })();

      // --- Grupy kategorii (optgroup) do listy formuł ---
      const CAT = {
        'Klirens/eGFR': new Set(['egfr','cg','cg_norm','cl24','sch_var','sch_idms']),
        'DZM': new Set([
          'UA_mgkg','Ca_mgkg','Mg_mgkg','PO4_mgkg','Prot_mgkg',
          'Na_mmol_d','K_mmol_d','KM_Cr','Ca_Cr','Mg_Ca','PO4_Cr','B_Cr',
          'FENa_pct','FEK_pct','FECl_pct','FEHCO3_pct','AGs','AGu','K_frac',
          'TRPpct_24','TmP_24_mgdl'
        ]),
        'Próbka moczu (spot)': new Set([
          'ACR','CaCr_spot','OxCr_spot','CitCr_spot',
          'TRPpct_spot','TmP_spot_mgdl','pH_spot'
        ]),
        'Kamica': new Set(['Ox_mgkg','Cit_mgkg','Ca_Cit','pH24']),
        'KT/V': new Set(['KTV'])
      };
      // Bufor sortowanych formuł – używany do filtra
      let ALL_FORMS_SORTED = [];

      // Renderuj opcje w <select> z kategoriami; użyj opcjonalnego filtra tekstu
      function renderFormulaOptions(filterText = '') {
        const sel  = document.getElementById('formulaPicker');
        const live = document.getElementById('formulaLive');
        if (!sel || !live) return;
        // Usuń wszystkie opcje i optgroup poza pierwszą (placeholder)
        [...sel.options].slice(1).forEach(o => o.remove());
        sel.querySelectorAll('optgroup').forEach(g => g.remove());
        // Zbierz widoczne elementy (po filtrowaniu) do płaskiej listy
        let flatVisible = [];
        const order = ['Klirens/eGFR','DZM','Próbka moczu (spot)','Kamica','KT/V'];
        order.forEach(groupName => {
          const items = ALL_FORMS_SORTED.filter(f => CAT[groupName] && CAT[groupName].has(f.id));
          const visible = filterText
            ? items.filter(f => f.label.toLowerCase().includes(filterText.toLowerCase()))
            : items;
          if (visible.length === 0) return;
          const og = document.createElement('optgroup');
          og.label = groupName;
          visible.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.id;
            opt.textContent = f.label;
            og.appendChild(opt);
          });
          sel.appendChild(og);
          flatVisible = flatVisible.concat(visible);
        });
        // Utwórz listę wyników na żywo
        if (filterText && flatVisible.length) {
          live.style.display = '';
          const top = flatVisible.slice(0, 30)
            .map(f => `<div class="fl-item" data-id="${f.id}" style="padding:.4rem .55rem; cursor:pointer; border-top:1px solid #f1f3f3;">${f.label}</div>`)
            .join('');
          live.innerHTML = top;
        } else {
          live.style.display = 'none';
          live.innerHTML = '';
        }
      }

      // Wypełnij selektor formuł oraz podłącz filtr wyszukiwania
      function populateFormulaPicker(){
        const sel = document.getElementById('formulaPicker');
        if (!sel) return;
        // Wybierz tylko formuły należące do którejkolwiek kategorii
        ALL_FORMS_SORTED = [...FORMULAS]
          .filter(f => Object.values(CAT).some(set => set.has(f.id)))
          .sort((a,b) => a.label.localeCompare(b.label, 'pl', { sensitivity:'base' }));
        // renderuj bez filtra
        renderFormulaOptions('');
        // Podłącz zdarzenie filtra
        const filter = document.getElementById('formulaSearch');
        if (filter) {
          filter.addEventListener('input', () => {
            renderFormulaOptions(filter.value || '');
          });
        }
      }

      // Ustaw wersję kalkulatora (korzysta z window.applyVersion, jeśli dostępna, w przeciwnym razie klika odpowiedni przycisk)
      function setVersion(ver){
        const versionKey = VERSION[ver] || ver;
        if (typeof window.applyVersion === 'function') {
          window.applyVersion(versionKey);
        } else {
          const btn = document.querySelector(`.version-option[data-version="${versionKey}"]`);
          if (btn && !btn.classList.contains('selected')) btn.click();
        }
      }

      // Usuń oznaczenia .must-fill ze wszystkich pól formularza.
      //
      // Wcześniej usuwaliśmy klasę tylko z elementów znajdujących się w formularzu
      // #clcrForm.  Jednak wymagane pola mogą również znajdować się poza tym
      // formularzem (np. w sekcji „Parametry z surowicy” lub „Parametry z dobowej
      // zbiórki moczu” wyświetlanej w zależności od wybranej wersji
      // kalkulatora).  Aby upewnić się, że podświetlenia znikną po kliknięciu
      // przycisku „Wyczyść wszystkie pola”, usuwamy klasę .must-fill globalnie z
      // całego dokumentu.
      function clearMust(){
        document.querySelectorAll('.must-fill').forEach(el => el.classList.remove('must-fill'));
      }

      // Wyświetl lub ukryj notatkę pod selektorem formuł
      function showNote(text){
        const n = document.getElementById('formulaNote');
        if (!n) return;
        if (text) {
          n.style.display = '';
          n.textContent = text;
        } else {
          n.style.display = 'none';
          n.textContent = '';
        }
      }

      // Podświetl wymagane pola dla wybranej formuły.  Jeśli pole jest puste, dodaj .must-fill.
      // Opcjonalny parametr doScroll decyduje, czy przewinąć do pierwszego brakującego (tylko po wyborze formuły).
      function highlightFields(formula, doScroll = false){
        clearMust();
        if (!formula) return;
        let firstMissing = null;
        formula.requires.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          const isEmpty = (el.tagName === 'SELECT') ? (el.value === '' || el.value == null) : (el.value === '' || el.value == null);
          if (isEmpty) {
            el.classList.add('must-fill');
            if (!firstMissing) firstMissing = el;
          }
        });
        if (firstMissing && doScroll) {
          try { firstMissing.scrollIntoView({ behavior:'smooth', block:'center' }); } catch(e){}
        }
      }

      // Obsługa zmiany formuły: ustaw wersję, podświetl wymagane pola, wyświetl notatkę i odśwież wyniki
      function onFormulaChange(){
        // Najpierw zresetuj aplikację, zachowując wybraną formułę
        if (typeof resetApp === 'function') resetApp(true);
        const sel = document.getElementById('formulaPicker');
        const f = sel ? FORMULAS.find(item => item.id === sel.value) : null;
        // Zawsze czyść notatkę i podświetlenia
        showNote('');
        clearMust();
        if (!f) return;
        // Sprawdzamy, czy wybrano formułę KT/V (Daugirdas).  Jeśli tak, włączamy tryb
        // profesjonalny oraz automatycznie rozwijamy sekcję zaawansowanych obliczeń KT/V.
        if (f.id === 'KTV') {
          // Ustaw wersję kalkulatora na profesjonalną – odblokuje to kartę KT/V.
          setVersion('pro');
          // Zaznacz przełącznik zaawansowanych obliczeń KT/V, aby pokazać pola.
          const advToggle = document.getElementById('ktvToggle');
          if (advToggle && !advToggle.checked) {
            advToggle.checked = true;
          }
          // Przelicz wyniki, aby sekcja KT/V została rozwinięta.
          if (typeof window.update === 'function') window.update();
          // Podświetl brakujące pola i przewiń do pierwszego wymagającego wartości.
          highlightFields(f, true);
          // Nie pokazuj notatki o zaznaczeniu przełącznika (wykonaliśmy to automatycznie).
        } else {
          // Dla innych formuł ustaw właściwą wersję kalkulatora i podświetl brakujące pola.
          setVersion(f.version);
          highlightFields(f, true);
          if (f.note) showNote(f.note);
          if (typeof window.update === 'function') window.update();
        }
      }

      // Inicjalizacja po załadowaniu DOM
      document.addEventListener('DOMContentLoaded', () => {
        populateFormulaPicker();
        const sel = document.getElementById('formulaPicker');
        if (sel) {
          // Nasłuchuj zmiany na selektorze formuł (uruchamia onFormulaChange)
          sel.addEventListener('change', onFormulaChange);
          // Przy otwarciu selektora zawsze przywracaj pełną listę formuł i czyść filtr
          const resetToFull = () => {
            // Wyczyść tekst filtra
            const searchInput = document.getElementById('formulaSearch');
            if (searchInput && searchInput.value) searchInput.value = '';
            // Odbuduj listę opcji bez filtra (wszystkie kategorie)
            if (typeof renderFormulaOptions === 'function') {
              renderFormulaOptions('');
            }
            // Ukryj dynamiczną listę wyników
            const live = document.getElementById('formulaLive');
            if (live) {
              live.style.display = 'none';
              live.innerHTML = '';
            }
          };
          // Klik myszą na selektorze
          sel.addEventListener('mousedown', resetToFull);
          // Wejście klawiaturą (focus)
          sel.addEventListener('focus', resetToFull);
        }
        // Po wprowadzeniu danych w dowolnym polu odświeżamy podświetlenia wymagań
        document.querySelectorAll('#clcrForm input, #clcrForm select').forEach(el => {
          el.addEventListener('input', () => {
            const curSel = document.getElementById('formulaPicker');
            const current = curSel ? FORMULAS.find(item => item.id === curSel.value) : null;
            if (current) highlightFields(current, false);
          });
        });
      });
    })();
    </script>
<!-- Sekcja interpretacji AI z opisem i przyciskiem.  Umieszczamy ją w kontenerze
     .container, aby szerokość pola była zgodna z kartami wyników (np. Klirens/eGFR).
     Pole pozostaje ukryte (hidden) dopóki nie ma wyników. -->
<div class="container" id="aiContainer" style="margin-top:1.5rem;">
  <fieldset id="aiFieldset" hidden>
    <legend>Interpretacja AI</legend>
    <p>Po naciśnięciu przycisku poniżej system przygotuje gotowe zapytanie do asystenta AI (np. ChatGPT) na podstawie wprowadzonych danych i wszystkich obliczonych wyników. Zapytanie zostanie automatycznie skopiowane do schowka, aby można je było łatwo wkleić do asystenta i uzyskać interpretację wyników.</p>
    <!-- Opcjonalne dołączenie wyników KT/V do raportu AI.  Etykieta jest wyśrodkowana,
         a checkbox umieszczony w jednej linii obok tekstu.  Użyto niestandardowego
         białego pola wyboru, aby zachować jasny wygląd również w ciemnym motywie. -->
    <label class="inline-checkbox-label center-text" style="margin:0.5rem 0;">
      <span>Uwzględnij wyniki KT/V w raporcie AI</span> <input type="checkbox" id="includeKTV" class="white-checkbox">
    </label>
    <button id="askAI">Zapytaj AI</button>
  </fieldset>
</div>
<footer>© <script>document.write(new Date().getFullYear())</script> Vilda Clinic</footer>

<!-- 5. LOGIKA JS -->
<script>
/* ---------- 5.1 ŁADOWANIE ARKUSZA Z NORMAMI ---------- */
let normy = null;
(async () => {
  const wb = XLSX.read(await (await fetch('klirens.xlsx')).arrayBuffer());
  // przyjmujemy, że normy i opisy są w pierwszym arkuszu
  normy = XLSX.utils.sheet_to_json(wb.Sheets['Arkusz1'], {header: 1, raw: true});
})();

/* ---------- 5.2 FUNKCJE OBLICZENIOWE ---------- */
function BSA_DuBois(weight, height) {
  return 0.007184 * Math.pow(weight, 0.425) * Math.pow(height, 0.725);
}

/* 1) Klirens dobowy (ml/min/1.73 m²) */
function clCr24h(Ucr_mg_dl, V24_ml, Scr_mg_dl, BSA) {
  const cl = (Ucr_mg_dl * V24_ml) / (Scr_mg_dl * 1440);  // 1440 min = 24 h
  return cl * (1.73 / BSA);
}

/* 2) Cockcroft–Gault (ml/min, *nie* znormalizowany do 1.73 m²) */
function clCrCG(sex, age, weight, Scr) {
  const k = sex === 'F' ? 0.85 : 1;
  return ((140 - age) * weight * k) / (72 * Scr);
}

/*
 * Zmieniono implementację: usunięto starszy wzór CKD‑EPI 2021 bez współczynnika płci.
 * Aktualnie stosowany jest wzór CKD‑EPI 2022 (NEJM 2021, KDIGO 2022), który
 * zawiera w sobie mnożnik 1.012 dla kobiet. Funkcja eGFR_CKD_EPI_2022
 * pozostaje poniżej i jest jedyną używaną w obliczeniach.
 */

/* 3b) eGFR – CKD‑EPI 2022 (creatinine‑only, race‑free)
   Współczynniki wg Inker et al., NEJM 2021; rekomendacja KDIGO 2022.
   GFR = 142 × min(Scr/κ,1)^α × max(Scr/κ,1)^–1.200 × 0.9938^Age × 1.012 (if female) */
function eGFR_CKD_EPI_2022(sex, age, Scr) {
  const κ = sex === 'F' ? 0.7 : 0.9;
  const α = sex === 'F' ? -0.241 : -0.302;
  const min = Math.min(Scr / κ, 1);
  const max = Math.max(Scr / κ, 1);
  let gfr = 142 * Math.pow(min, α) * Math.pow(max, -1.200) * Math.pow(0.9938, age);
  if (sex === 'F') gfr *= 1.012;          // współczynnik płci
  return gfr;
}

/* --- KT/V (Daugirdas) i eKt/V ---------------------------------- */
function ktvDaugirdas(R, tHrs, UFkg, Wkg) {
  if (!R || !tHrs || !UFkg || !Wkg) return null;
  const r  = parseFloat(R);
  const t  = parseFloat(tHrs);
  const UF = parseFloat(UFkg);
  const W  = parseFloat(Wkg);
  if (r <= 0 || r >= 1 || t <= 0) return null;
  const first  = -Math.log(r - 0.008 * t);
  const second = (4 - 3.5 * r) * (UF / W);
  return first + second;           // spKt/V
}
function eKtV(spKtV, tMin) {
  if (!spKtV || !tMin) return null;
  return spKtV * (tMin / (tMin + 35));   // przybliżenie
}

/* 4a) klasyczny Schwartz ze zmiennym k */
function kSchwartzVar(ageY, sex) {
  // ustalanie współczynnika k w zależności od wieku i płci
  if (ageY < 0.083) return 0.33;               // wcześniaki < 1 m‑ca
  if (ageY < 1)      return 0.45;               // niemowlęta 1‑12 m‑cy
  if (ageY < 13)     return 0.55;               // dzieci 1‑<13 l.
  if (ageY < 18)     return (sex === 'M' ? 0.70 : 0.55); // nastolatki
  return 0.55;                                 // fallback
}
function clCrSchwartzVar(height_cm, Scr, ageY, sex) {
            // Jeśli brakuje wzrostu lub kreatyniny, nie wykonuj obliczenia
            if (!(height_cm > 0) || !(Scr > 0)) return { gfr: null, k: null };
            // GFR i zastosowane k zwracane jako obiekt
            const k = kSchwartzVar(ageY, sex);
            return { gfr: (k * height_cm) / Scr, k };
}
/* 4b) Bedside Schwartz (IDMS 2009) – stałe k = 0,413 */
function clCrSchwartzIDMS(height_cm, Scr) {
            // Jeśli brakuje wzrostu lub kreatyniny, zwróć null
            if (!(height_cm > 0) || !(Scr > 0)) return { gfr: null, k: 0.413 };
            const k = 0.413;
            return { gfr: (k * height_cm) / Scr, k };
}

/* ===  NOWE OBLICZENIA  =============================================== */

/* ---------- 5.2a  ZAKRESY REFERENCYJNE ---------- */
const refRanges = {
  UA_mgkg:  { child: {min: 0, max: 12}, adult: {min: 0, max: 13},  senior: {min: 0, max: 13} },
  Ca_mgkg:  { child: {min: 0, max: 4},  adult: {min: 0, max: 3},   senior: {min: 0, max: 3} },
  Mg_mgkg:  { child: {min: 0, max: 3.0}, adult: {min: 0, max: 2.0}, senior: {min: 0, max: 2.0} },
  PO4_mgkg: { child: {min: 0, max: 40}, adult: {min: 0, max: 35},  senior: {min: 0, max: 35} },
  Prot_mgkg:{ child: {min: 0, max: 100}, adult: {min: 0, max: 150}, senior: {min: 0, max: 150} },
  Na_mmol_d:{ child: {min: 20, max: 180}, adult: {min: 40, max: 220}, senior: {min: 40, max: 220} },
  K_mmol_d: { child: {min: 10, max: 80}, adult: {min: 25, max: 100}, senior: {min: 25, max: 100} },
  KM_Cr:    { child: {min: 0, max: 0.8}, adult: {min: 0, max: 0.6}, senior: {min: 0, max: 0.6} },
  Ca_Cr:    { child: {min: 0, max: 0.2}, adult: {min: 0, max: 0.11}, senior: {min: 0, max: 0.11} },
  Mg_Ca:    { child: {min: 0.2, max: 0.6}, adult: {min: 0.2, max: 0.6}, senior: {min: 0.2, max: 0.6} },
  PO4_Cr:   { child: {min: 0, max: 2.5}, adult: {min: 0, max: 2.5}, senior: {min: 0, max: 2.5} },
  B_Cr:     { child: {min: 0, max: 0.15}, adult: {min: 0, max: 0.15}, senior: {min: 0, max: 0.15} },
  TRPpct:   { child: {min: 90, max: 99}, adult: {min: 85, max: 99}, senior: {min: 80, max: 99} },
  FENa_pct: { child: {min: 0, max: 1.5}, adult: {min: 0, max: 1},  senior: {min: 0, max: 1} },
  FEHCO3_pct:{ child: {min: 0, max: 5},   adult: {min: 0, max: 5},   senior: {min: 0, max: 5} },
  K_frac:   { child: {min: 30, max: 70}, adult: {min: 15, max: 80},  senior: {min: 15, max: 80} },
  AGs:      { child: {min: 8, max: 16},  adult: {min: 8, max: 12},  senior: {min: 8, max: 14} },
  AGu:      { child: {min: 30, max: 60}, adult: {min: 30, max: 50}, senior: {min: 30, max: 50} },
  ktv:      { adult: {min: 1.2, max: 2.5}, senior: {min: 1.2, max: 2.5} }
  ,
  /* Normy dla frakcji wydalniczej potasu (FEK) oraz chlorków (FECl). Wartości
     przybliżone: u dzieci FEK 10–25 %, u dorosłych 4–16 %, u seniorów 4–15 %. Dla
     FECl brak jednoznacznych norm – przyjęto zakres 2–15 % u dzieci i 1–15 %
     u dorosłych/seniorów. */
  FEK_pct: { child: {min: 10, max: 25}, adult: {min: 4, max: 16}, senior: {min: 4, max: 15} },
  FECl_pct:{ child: {min: 2, max: 15}, adult: {min: 1, max: 15}, senior: {min: 1, max: 15} }
  ,
  /* === KAMICA — START (refRanges) === */
  Ox_mgkg:   { child: {min: 0, max: 0.6}, adult: {min: 0, max: 0.6}, senior:{min:0,max:0.6} },
  Cit_mgkg:  { child: {min: 5},          adult: {min: 4},            senior:{min:4}          },
  Ox_Cr:     { child: {min: 0, max: 0.05}, adult:{min:0,max:0.05},  senior:{min:0,max:0.05} },
  Cit_Cr:    { child: {min: 0.18},       adult: {min: 0.15},         senior:{min:0.15}       },
  Ca_Cit:    { child: {max: 0.3},        adult: {max: 0.3},          senior:{max:0.3}        },
  pHspot:    { child: {min:5, max:7.5},  adult:{min:5, max:7.5},     senior:{min:5,max:7.5}  }
  ,
  /* Normy Ca/Cr (spot) zależne od wieku.  Dolna granica zawsze wynosi 0, a górna
     jest określana dynamicznie w funkcji update() na podstawie wieku pacjenta.
     Wartości początkowe służą jako ogólny zakres – zostaną nadpisane w update(). */
  Ca_Cr_spot: { child: {min: 0, max: 0.9}, adult: {min: 0, max: 0.2}, senior: {min: 0, max: 0.2} }
  /* === KAMICA — END (refRanges) === */
};

const clRefRanges = {
  cl24: { child: {min: 90, max: 140}, adult: {min: 90, max: 130}, senior: {min: 60, max: 120} },
  cg:   { child: {min: 90, max: 140}, adult: {min: 90, max: 130}, senior: {min: 60, max: 120} },
  egfr: { child: {min: 90, max: 140}, adult: {min: 90, max: 120}, senior: {min: 60, max: 120} },
  sch:  { child: {min: 90, max: 140} }
};

/* uniwersalny wzór na wydalanie mg/kg/d (U mg/dl, V ml/24h, w kg) */
const excr_mgkg = (U_mg_dl, V_ml, kg) => (U_mg_dl && V_ml && kg)
       ? (U_mg_dl * V_ml) / (100 * kg) : null;

/* wydalanie mmol/d (U mmol/L, V ml) */
const excr_mmol_d = (U_mmol_L, V_ml) => (U_mmol_L && V_ml)
       ? (U_mmol_L * V_ml) / 1000 : null;

/* frakcja wydalnicza – generyczna (%, U_x, S_x, U_cr, S_cr) */
const FE = (U_x, S_x, U_cr, S_cr) => (U_x && S_x && U_cr && S_cr)
       ? (U_x * S_cr) / (S_x * U_cr) * 100 : null;

/* wskaźnik X/Cr (U mg/dl : U_cr mg/dl) */
const ratio = (U, U_cr) => (U && U_cr) ? U / U_cr : null;

/* TRP – Tubular Reabsorption of Phosphate (%) */
const TRP = (U_PO4, S_PO4, U_Cr, S_Cr) => (U_PO4 && S_PO4 && U_Cr && S_Cr)
       ? (1 - (U_PO4 * S_Cr) / (S_PO4 * U_Cr)) * 100 : null;

/* anion gap (serum) = Na + K – Cl – HCO3 [mmol/L] */
const AG_serum = (Na, K, Cl, HCO3) => (Na && Cl && HCO3)
       ? ((Na + (K || 0)) - Cl - HCO3) : null;

/* anion gap (urine) = U_Na + U_K – U_Cl [mmol/L] */
const AG_urine = (U_Na, U_K, U_Cl) => (U_Na && U_Cl)
       ? ((U_Na + (U_K || 0)) - U_Cl) : null;

/* wskaźnik K/(K+Na) w moczu (%) */
const K_frac = (U_K, U_Na) => (U_K && U_Na) ? U_K / (U_K + U_Na) * 100 : null;

/* KT/V (jedno-zabiegowy uproszczony dializacyjny): K – klirens mocznika,
   t – czas dializy (h), V – TBW; tu przyjmujemy K = CG‑ClCr, t = 4 h,
   V = 0.6 * kg; –> możesz dostosować wg ośrodka */
const KT_V = (ClCr, kg, tHrs = 4) => (ClCr && kg)
       ? (ClCr * tHrs * 60) / (0.6 * kg) : null;

/* ---------- 5.3 PRZELICZANIE I WYŚWIETLANIE ---------- */
const $ = id => document.getElementById(id);
document.querySelectorAll('#clcrForm input, #clcrForm select')
        .forEach(el => el.addEventListener('input', update));

// 📌 W niektórych przeglądarkach zdarzenie „input” nie jest wyzwalane dla pól typu
// checkbox.  W rezultacie kliknięcie przełącznika KT/V w wersji profesjonalnej
// nie powodowało ponownego wywołania funkcji update() i sekcja zaawansowanych
// obliczeń pozostawała widoczna mimo odznaczenia pola.  Aby zapewnić, że
// przełączniki (w szczególności #ktvToggle) zawsze sterują widocznością
// zaawansowanej sekcji KT/V, dodajemy obsługę zdarzenia „change” dla
// wszystkich checkboxów w formularzu.  Funkcja update() przelicza wyniki
// i ukrywa lub pokazuje sekcję w zależności od stanu zaznaczenia.
document.querySelectorAll('#clcrForm input[type="checkbox"]').forEach(el => {
  el.addEventListener('change', () => {
    if (typeof update === 'function') update();
  });
});

// 👇 Upewnij się, że kliknięcie przełącznika KT/V zawsze wywoła funkcję update().
// W niektórych przeglądarkach zdarzenie „change” na checkboxie nie jest propagowane
// tak, aby odświeżyć sekcję.  Dlatego, po załadowaniu DOM, dodajemy obsługę
// zdarzenia „click” dla konkretnego przełącznika #ktvToggle, która bezpośrednio
// uruchamia update().  Dzięki temu pola KT/V są poprawnie ukrywane i
// odsłaniane niezależnie od wybranej wersji kalkulatora.
document.addEventListener('DOMContentLoaded', () => {
  const ktvToggleEl = document.getElementById('ktvToggle');
  if (ktvToggleEl) {
    /*
     * Ręcznie steruj sekcją KT/V przy kliknięciu checkboxa.  Standardowe
     * zdarzenia „input” i „change” nie zawsze aktywują funkcję update()
     * dla pól typu checkbox w różnych przeglądarkach, co powodowało, że
     * pola KT/V pozostawały rozwinięte po odznaczeniu przełącznika.  Po
     * kliknięciu ustaw widoczność pola #ktvFields w zależności od stanu
     * zaznaczenia oraz wyczyść wyniki KT/V w przypadku ukrycia.
     */
    const syncKtvVisibility = () => {
      const advBox  = document.getElementById('ktvFields');
      const ktvRes  = document.getElementById('ktvResult');
      const ektvRes = document.getElementById('ektvResult');
      if (advBox) {
        advBox.style.display = ktvToggleEl.checked ? 'block' : 'none';
      }
      // When hiding the KT/V fields, also hide any displayed results
      if (!ktvToggleEl.checked) {
        if (ktvRes)  ktvRes.style.display  = 'none';
        if (ektvRes) ektvRes.style.display = 'none';
      }
      // Invoke update() to refresh any dependent calculations (if defined)
      if (typeof update === 'function') update();
    };
    // Bind both click and change to cover all browsers
    ktvToggleEl.addEventListener('click', syncKtvVisibility);
    ktvToggleEl.addEventListener('change', syncKtvVisibility);
  }
});

// Maksymalne realistyczne wartości dla pól liczbowych – używane do walidacji
const maxValues = {
  age: 120,
  weight: 300,
  height: 250,
  Scr: 20,
  Ucr: 500,
  V24: 10000,
  S_Na: 200,
  S_K: 10,
  S_Cl: 200,
  S_HCO3: 50,
  S_PO4: 20,
  S_UA: 30,
  U_Na: 300,
  U_K: 200,
  U_Cl: 300,
  U_HCO3: 200,
  U_PO4: 200,
  U_UA: 200,
  U_Ca: 10,
  U_Mg: 100,
  U_Prot: 5000,
  U_Alb: 5000,
  U_ACR: 20000,
  /* === KAMICA — START (maxValues) === */
  S_Ca: 15,
  U_Ox: 120,
  U_Cit: 400,
  // Dla pola stężenia szczawianów i cytrynianów w próbce moczu używamy
  // maksymalnych wartości zbliżonych do wartości z dobowej zbiórki (mg/dl).
  Ox_Cr_spot: 120,
  Cit_Cr_spot: 400,
  // Wapń w próbce moczu (mg/dl).  Przyjmujemy górną realistyczną granicę 30 mg/dl
  Ca_spot: 30,
  U_Cys: 2000,
  U_pH: 9,
  pH24: 9,
  S_PTH: 2000,
  S_VitD: 200
  /* === KAMICA — END (maxValues) === */
};

// Krótkie opisy dla każdej zmiennej; używane w dymkach informacyjnych
const infoTexts = {
  fullName: 'Imię i nazwisko pacjenta.',
  age: 'Wiek pacjenta w latach.',
  sex: 'Płeć pacjenta (M – mężczyzna, F – kobieta).',
  weight: 'Masa ciała w kilogramach, używana w obliczeniach BSA i Cockcroft–Gault.',
  height: 'Wzrost w centymetrach, używany w obliczeniach BSA.',
  Scr: 'Stężenie kreatyniny w surowicy; potrzebne do obliczeń klirensu i eGFR.',
  Ucr: 'Stężenie kreatyniny w moczu z dobowej zbiórki; niezbędne do obliczenia klirensu.',
  V24: 'Objętość dobowej zbiórki moczu w mililitrach.',
  S_Na: 'Stężenie sodu w surowicy (mmol/L).',
  S_K: 'Stężenie potasu w surowicy (mmol/L).',
  S_Cl: 'Stężenie chlorków w surowicy (mmol/L).',
  S_HCO3: 'Stężenie wodorowęglanów w surowicy (mmol/L).',
  S_PO4: 'Stężenie fosforanów w surowicy (mg/dl lub mmol/L).',
  S_UA: 'Stężenie kwasu moczowego w surowicy (mg/dl).',
  U_Na: 'Stężenie sodu w moczu (mmol/L).',
  U_K: 'Stężenie potasu w moczu (mmol/L).',
  U_Cl: 'Stężenie chlorków w moczu (mmol/L).',
  U_HCO3: 'Stężenie wodorowęglanów w moczu (mmol/L).',
  U_PO4: 'Stężenie fosforanów w moczu (mg/dl).',
  U_UA: 'Stężenie kwasu moczowego w moczu (mg/dl).',
  U_Ca: 'Stężenie wapnia w moczu (mmol/L).',
  U_Mg: 'Stężenie magnezu w moczu (mg/L).',
  U_Prot: 'Białko całkowite wydalone w moczu w ciągu 24 godzin (mg).',
  U_Alb: 'Stężenie albuminy w próbce moczu (mg/L); używane do obliczenia ACR.',
  U_ACR: 'Stosunek albuminy do kreatyniny (mg/g), obliczany automatycznie.'
  ,
  /* === KAMICA — START (infoTexts) === */
  S_Ca: 'Stężenie wapnia całkowitego w surowicy (mg/dl lub mmol/L).',
  U_pH: 'pH pojedynczej (porannej) próbki moczu.',
  // Wprowadzamy stężenie szczawianów i cytrynianów w próbce moczu zamiast stosunku do kreatyniny.
  Ox_Cr_spot: 'Stężenie szczawianów w próbce moczu (mg/dl).',
  Cit_Cr_spot: 'Stężenie cytrynianów w próbce moczu (mg/dl).',
  S_PTH: 'Parathormon w surowicy (pg/ml).',
  S_VitD: '25‑hydroksy‑witamina D w surowicy (ng/ml).',
  U_Ox: 'Stężenie szczawianów w dobowej zbiórce moczu (mg/dl).',
  U_Cit: 'Stężenie cytrynianów w dobowej zbiórce moczu (mg/dl).',
  U_Cys: 'Stężenie cystyny w dobowej zbiórce moczu (mg/dl).',
  pH24: 'Średnie pH moczu w dobowej zbiórce.',
  /* === KAMICA — END (infoTexts) === */
  /* Dodatkowe pola bez opisu w oryginalnej tabeli */
  ScrUnit: 'Jednostka stężenia kreatyniny w surowicy (mg/dl lub µmol/L).'
  ,
  /* Jednostki dla wapnia i fosforanów w surowicy */
  S_Ca_unit: 'Jednostka stężenia wapnia całkowitego w surowicy (mg/dl lub mmol/L).',
  S_PO4_unit:'Jednostka stężenia fosforanów w surowicy (mg/dl lub mmol/L).',
  /* Pola zaawansowanych obliczeń KT/V i opcje raportu AI */
  ktvToggle: 'Zaznacz to pole, aby pokazać sekcję zaawansowanych obliczeń KT/V.',
  ktvTime:   'Czas trwania pojedynczej sesji dializy w godzinach (t, h).',
  ktvUF:     'Ubytek masy podczas dializy, czyli ultrafiltracja, w kilogramach (UF, kg).',
  ktvW:      'Masa ciała pacjenta po zakończeniu dializy, w kilogramach (W, kg).',
  UreaPre:   'Stężenie mocznika we krwi przed rozpoczęciem dializy (mg/dl).',
  UreaPost:  'Stężenie mocznika we krwi po zakończeniu dializy (mg/dl).',
  includeKTV:'Zaznacz to pole, aby dołączyć do raportu AI szczegółowe wyniki KT/V z sekcji zaawansowanej. Orientacyjne wartości KT/V nie są już uwzględniane.'
};

// Po załadowaniu dokumentu dodaj elementy walidacyjne i ikony informacyjne
document.addEventListener('DOMContentLoaded', () => {
  // Initialize the globally exposed version state.  The default is the
  // "basic" calculator; this value will be updated whenever the user
  // clicks on one of the version buttons.  Other parts of the code
  // (particularly the update() routine) consult window.currentVersion to
  // decide whether to render professional-only metrics such as KT/V.
  window.currentVersion = 'basic';
  // Dodaj kontener na komunikat walidacyjny pod każdym polem liczbowym
  document.querySelectorAll('#clcrForm input[type="number"]').forEach(input => {
    const msg = document.createElement('div');
    msg.className = 'validation-message';
    input.parentNode.appendChild(msg);
  });
  // Dodaj ikony informacyjne do etykiet
  // (Ten kod został dezaktywowany, gdyż nowe przyciski Info generują dymki automatycznie)
  /*
  Object.keys(infoTexts).forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      const label = el.closest('label');
      if (label && !label.querySelector('.info-icon')) {
        const icon = document.createElement('span');
        icon.className = 'info-icon';
        icon.title = infoTexts[id];
        icon.textContent = 'ℹ️';
        // Znajdź pierwszy element formularza w etykiecie i wstaw ikonę przed nim
        const firstFormEl = label.querySelector('input, select, textarea');
        if (firstFormEl) {
          label.insertBefore(icon, firstFormEl);
        } else {
          label.appendChild(icon);
        }
      }
    }
  });
  */
});

// Funkcja walidująca pojedyncze pole. Zwraca true, jeśli poprawne.
function validateField(input) {
  const id = input.id;
  const val = parseFloat(input.value);
  const msg = input.parentNode.querySelector('.validation-message');
  // Jeżeli pole puste, usuń błąd
  if (!input.value) {
    if (msg) msg.textContent = '';
    input.classList.remove('error');
    return true;
  }
  if (isNaN(val)) {
    if (msg) msg.textContent = 'Nieprawidłowa liczba';
    input.classList.add('error');
    return false;
  }
  if (val < 0) {
    if (msg) msg.textContent = 'Wartość nie może być ujemna';
    input.classList.add('error');
    return false;
  }
  // Specjalny przypadek dla kreatyniny w surowicy – uwzględnij jednostkę
  if (id === 'Scr') {
    let mgdlVal = val;
    const unitEl = document.getElementById('ScrUnit');
    const unit = unitEl ? unitEl.value : 'mg/dl';
    if (unit === 'umol') mgdlVal = val / 88.4;
    if (maxValues.Scr !== undefined && mgdlVal > maxValues.Scr) {
      if (msg) msg.textContent = 'Wartość wydaje się zbyt wysoka';
      input.classList.add('error');
      return false;
    }
  }
  // Specjalne przypadki dla wapnia i fosforanów w surowicy – przelicz na mg/dl przed porównaniem
  else if (id === 'S_Ca') {
    let mgdlVal = val;
    const unitEl = document.getElementById('S_Ca_unit');
    const unit = unitEl ? unitEl.value : 'mg/dl';
    // 1 mmol/L Ca ≈ 4 mg/dl (40 mg na litr → 4 mg/dl)
    if (unit === 'mmol/L') mgdlVal = val * 4;
    if (maxValues.S_Ca !== undefined && mgdlVal > maxValues.S_Ca) {
      if (msg) msg.textContent = 'Wartość wydaje się zbyt wysoka';
      input.classList.add('error');
      return false;
    }
  }
  else if (id === 'S_PO4') {
    let mgdlVal = val;
    const unitEl = document.getElementById('S_PO4_unit');
    const unit = unitEl ? unitEl.value : 'mg/dl';
    // 1 mmol/L fosforanów ≈ 3.1 mg/dl (na podstawie przelicznika 0,3229 mmol/L na 1 mg/dl【811682241390017†L88-L97】)
    if (unit === 'mmol/L') mgdlVal = val * 3.1;
    if (maxValues.S_PO4 !== undefined && mgdlVal > maxValues.S_PO4) {
      if (msg) msg.textContent = 'Wartość wydaje się zbyt wysoka';
      input.classList.add('error');
      return false;
    }
  }
  else if (maxValues[id] !== undefined && val > maxValues[id]) {
    if (msg) msg.textContent = 'Wartość wydaje się zbyt wysoka';
    input.classList.add('error');
    return false;
  }
  if (msg) msg.textContent = '';
  input.classList.remove('error');
  return true;
}

// Sprawdza, czy dane wymagane przez formułę są wypełnione (niepuste po uwzględnieniu jednostek)
function canComputeFormula(formulaId) {
  const f = (typeof FORMULAS !== 'undefined') ? FORMULAS.find(x => x.id === formulaId) : null;
  if (!f) return false;
  return f.requires.every(id => {
    const el = document.getElementById(id);
    if (!el) return false;
    // SELECT musi mieć wartość niepustą
    if (el.tagName === 'SELECT') return el.value !== '' && el.value != null;
    // INPUT: puste traktujemy jako brak
    const raw = el.value;
    if (raw === '' || raw == null) return false;
    // wartości liczbowe: 0 uznajemy za brak
    const num = +raw;
    return !Number.isNaN(num) && num !== 0;
  });
}
// Bezpieczne sprawdzanie liczby (odrzuca null/NaN/±Infinity)
function isFiniteNum(v){ return v != null && Number.isFinite(v); }

function update() {
  const fullName = $('fullName').value.trim();
  $('patientName').textContent = fullName || '';
  const age    = +$('age').value;
  const sex    = $('sex').value;
  const weight = +$('weight').value;
  const height = +$('height').value;
  // Przeliczanie kreatyniny w surowicy z uwzględnieniem wybranej jednostki.
  const scrInput = +$('Scr').value;
  const scrUnit  = $('ScrUnit') ? $('ScrUnit').value : 'mg/dl';
  // Jeśli nie wybrano jednostki kreatyniny w surowicy, nie wykonuj obliczeń zależnych od Scr
  let Scr;
  if (!scrUnit || scrUnit === '') {
    Scr = null;
  } else if (scrInput) {
    Scr = (scrUnit === 'umol') ? (scrInput / 88.4) : scrInput;
  } else {
    Scr = null;
  }
  const Ucr    = +$('Ucr').value;
  // Odczyt kreatyniny w próbce moczu wraz z wyborem jednostki.  Umożliwiamy podanie stężenia
  // w mg/dl lub w µmol/L; przy jednostce µmol/L przeliczamy na mg/dl za pomocą przelicznika
  // 1 mg/dl ≈ 88.4 µmol/L (czyli mg/dl = µmol/L / 88.4).  Dla pustej jednostki lub braku wartości
  // ustawiamy null, dzięki czemu poniższe obliczenia (np. ACR) pomijają niewypełnione pole.
  const UcrSpotInput = +$('Ucr_spot').value;
  const UcrSpotUnit  = $('Ucr_spot_unit') ? $('Ucr_spot_unit').value : 'mg/dl';
  let U_Cr_spot = null;
  if (UcrSpotUnit && UcrSpotUnit !== '') {
    if (UcrSpotInput) {
      U_Cr_spot = (UcrSpotUnit === 'umol') ? (UcrSpotInput / 88.4) : UcrSpotInput;
    } else {
      U_Cr_spot = null;
    }
  } else {
    U_Cr_spot = null;
  }
  const U_Alb  = +$('U_Alb').value;        // albumina w próbce moczu (mg/L)

  // Odczyt wapnia w próbce moczu oraz jednostki.  Umożliwiamy wprowadzanie
  // stężenia w mg/dl lub mmol/L; przy jednostce mmol/L przeliczamy na mg/dl
  // (1 mmol Ca ≈ 40 mg, 1 L = 10 dl, więc 1 mmol/L ≈ 4 mg/dl).
  const Ca_spot_val  = +$('Ca_spot').value;
  const Ca_spot_unit = $('Ca_spot_unit') ? $('Ca_spot_unit').value : 'mg/dl';
  let   Ca_spot_mgdl = null;
  if (Ca_spot_val && Ca_spot_unit && Ca_spot_unit !== '') {
    // Jeżeli wybrano jednostkę mmol/L, przeliczamy na mg/dl (×4); w przeciwnym razie
    // zakładamy mg/dl.  Dla nieobsługiwanych lub pustych jednostek pozostawiamy null.
    if (Ca_spot_unit === 'mmol/L') {
      Ca_spot_mgdl = Ca_spot_val * 4;
    } else if (Ca_spot_unit === 'mg/dl') {
      Ca_spot_mgdl = Ca_spot_val;
    }
  }

  /* --- Odczyt fosforanów w próbce moczu (spot) oraz konwersja na mg/dl --- */
  const U_PO4_spot_val = +$('U_PO4_spot').value;
  const U_PO4_spot_unitEl = document.getElementById('U_PO4_spot_unit');
  const U_PO4_spot_unit = U_PO4_spot_unitEl ? U_PO4_spot_unitEl.value : 'mg/dl';
  let U_PO4_spot_mgdl = null;
  if (U_PO4_spot_val && U_PO4_spot_unit && U_PO4_spot_unit !== '') {
    // Przelicz jednostkę mmol/L na mg/dl (1 mmol/L ≈ 3.097 mg/dl).  W przeciwnym razie użyj wartości bez zmian.
    U_PO4_spot_mgdl = (U_PO4_spot_unit === 'mmol/L') ? (U_PO4_spot_val * 3.097) : U_PO4_spot_val;
  }

  /* --- Odczyt fosforu w surowicy (spot) oraz konwersja na mg/dl --- */
  const S_PO4_spot_val = +$('S_PO4_spot').value;
  const S_PO4_spot_unitEl = document.getElementById('S_PO4_spot_unit');
  const S_PO4_spot_unit = S_PO4_spot_unitEl ? S_PO4_spot_unitEl.value : 'mg/dl';
  let S_PO4_spot_mgdl = null;
  if (S_PO4_spot_val && S_PO4_spot_unit && S_PO4_spot_unit !== '') {
    S_PO4_spot_mgdl = (S_PO4_spot_unit === 'mmol/L') ? (S_PO4_spot_val * 3.097) : S_PO4_spot_val;
  }

  /* --- Odczyt kreatyniny w surowicy (spot) oraz konwersja na mg/dl --- */
  const Scr_spot_input = +$('Scr_spot').value;
  const Scr_spot_unitEl = document.getElementById('Scr_spot_unit');
  const Scr_spot_unit = Scr_spot_unitEl ? Scr_spot_unitEl.value : 'mg/dl';
  let Scr_spot_mgdl = null;
  if (Scr_spot_input && Scr_spot_unit && Scr_spot_unit !== '') {
    Scr_spot_mgdl = (Scr_spot_unit === 'umol') ? (Scr_spot_input / 88.4) : Scr_spot_input;
  }

  /* ----------  ACR: automatyczne wyliczenie ---------- */
  let ACR = null;
  // Jeżeli podano albuminę i kreatyninę w próbce moczu, oblicz ACR za każdym razem.
  // Albumina w mg/L przeliczana jest na mg/dl (÷10), następnie przeliczamy na mg/g kreatyniny
  // (×1000 / U_Cr_spot).  Jeśli któreś z pól jest puste, czyścimy pole ACR.
  if (U_Alb && U_Cr_spot) {
    const Alb_mg_dl = U_Alb / 10;
    ACR = (Alb_mg_dl * 1000) / U_Cr_spot;
    // zaokrąglamy do jednego miejsca po przecinku
    $('U_ACR').value = ACR.toFixed(1);
  } else {
    // brak danych – usuń poprzednią wartość z pola ACR
    $('U_ACR').value = '';
  }

  // --- Ustal granice norm Ca/Cr (spot) w zależności od wieku.
  // Zakresy referencyjne (mg/mg kreatyniny) ustalono na podstawie
  // danych pediatrycznych i klinicznych.  W poniższych przedziałach
  // podano dolną i górną granicę normy:       
  // 1 miesiąc–<12 miesięcy: 0,03–0,81
  // 12 miesięcy–<24 miesięcy: 0,03–0,56
  // 24 miesiące–<3 lata: 0,02–0,50
  // 3 lata–<5 lat: 0,02–0,41
  // 5 lat–<7 lat: 0,01–0,30
  // 7 lat–<10 lat: 0,01–0,25
  // 10 lat–<18 lat: 0,01–0,24
  // >=18 lat (dorośli): 0–0,20 (dotychczasowa wartość graniczna dla dorosłych)
  let Ca_Cr_spot_min;
  let Ca_Cr_spot_max;
  if (age) {
    if (age < 1) {
      // 1 miesiąc–<12 miesięcy
      Ca_Cr_spot_min = 0.03;
      Ca_Cr_spot_max = 0.81;
    } else if (age < 2) {
      Ca_Cr_spot_min = 0.03;
      Ca_Cr_spot_max = 0.56;
    } else if (age < 3) {
      Ca_Cr_spot_min = 0.02;
      Ca_Cr_spot_max = 0.50;
    } else if (age < 5) {
      Ca_Cr_spot_min = 0.02;
      Ca_Cr_spot_max = 0.41;
    } else if (age < 7) {
      Ca_Cr_spot_min = 0.01;
      Ca_Cr_spot_max = 0.30;
    } else if (age < 10) {
      Ca_Cr_spot_min = 0.01;
      Ca_Cr_spot_max = 0.25;
    } else if (age < 18) {
      Ca_Cr_spot_min = 0.01;
      Ca_Cr_spot_max = 0.24;
    } else {
      // Dorośli (≥18 lat)
      Ca_Cr_spot_min = 0;
      Ca_Cr_spot_max = 0.20;
    }
  } else {
    // Jeśli wiek nie jest podany, przyjmij zakres dla dorosłych
    Ca_Cr_spot_min = 0;
    Ca_Cr_spot_max = 0.20;
  }
  // Aktualizuj zakres referencyjny dynamicznie.
  refRanges.Ca_Cr_spot = {
    child: { min: Ca_Cr_spot_min, max: Ca_Cr_spot_max },
    adult: { min: Ca_Cr_spot_min, max: Ca_Cr_spot_max },
    senior:{ min: Ca_Cr_spot_min, max: Ca_Cr_spot_max }
  };

  // --- Ustal granice norm TmP/GFR w zależności od wieku (na podstawie gpn.de) ---
  let TmP_mgdl_min, TmP_mgdl_max, TmP_mmol_min, TmP_mmol_max;
  if (age) {
    // Wiek w latach.  Zakresy: 0–5 mies., 6–12 mies., 1–5 lat, 6–12 lat, 13–15 lat, ≥16 lat.
    if (age < (5 / 12)) {
      // 0–5 miesięcy
      TmP_mgdl_min = 3.16;
      TmP_mgdl_max = 6.19;
      TmP_mmol_min = 1.02;
      TmP_mmol_max = 2.00;
    } else if (age < 1) {
      // 6–12 miesięcy
      TmP_mgdl_min = 3.50;
      TmP_mgdl_max = 5.82;
      TmP_mmol_min = 1.13;
      TmP_mmol_max = 1.88;
    } else if (age < 5) {
      // 1–5 lat
      TmP_mgdl_min = 3.25;
      TmP_mgdl_max = 5.51;
      TmP_mmol_min = 1.05;
      TmP_mmol_max = 1.78;
    } else if (age < 12) {
      // 6–12 lat
      TmP_mgdl_min = 3.00;
      TmP_mgdl_max = 5.08;
      TmP_mmol_min = 0.97;
      TmP_mmol_max = 1.64;
    } else if (age < 16) {
      // 13–15 lat
      TmP_mgdl_min = 2.82;
      TmP_mgdl_max = 5.20;
      TmP_mmol_min = 0.91;
      TmP_mmol_max = 1.68;
    } else {
      // ≥16 lat (dorośli)
      TmP_mgdl_min = 2.60;
      TmP_mgdl_max = 3.80;
      TmP_mmol_min = 0.84;
      TmP_mmol_max = 1.23;
    }
  } else {
    // Jeżeli wiek nie jest znany, przyjmij zakres dla dorosłych.
    TmP_mgdl_min = 2.60;
    TmP_mgdl_max = 3.80;
    TmP_mmol_min = 0.84;
    TmP_mmol_max = 1.23;
  }
  // Zapisz dynamiczne zakresy referencyjne w obiekcie refRanges, tak aby box() mógł
  // pobrać min/max.  Używamy tych samych przedziałów dla dzieci, dorosłych i seniorów,
  // ponieważ już powyżej uwzględniliśmy wiek w obliczeniach.
  refRanges.TmP_mgdl = {
    child: { min: TmP_mgdl_min, max: TmP_mgdl_max },
    adult: { min: TmP_mgdl_min, max: TmP_mgdl_max },
    senior:{ min: TmP_mgdl_min, max: TmP_mgdl_max }
  };
  refRanges.TmP_mmol = {
    child: { min: TmP_mmol_min, max: TmP_mmol_max },
    adult: { min: TmP_mmol_min, max: TmP_mmol_max },
    senior:{ min: TmP_mmol_min, max: TmP_mmol_max }
  };
  const V24    = +$('V24').value;

  // Walidacja wszystkich pól liczbowych. Jeżeli istnieje błąd, ukrywamy wyniki.
  document.querySelectorAll('#clcrForm input[type="number"]').forEach(el => validateField(el));

  /* --- Stała turkusowa ramka dla prawidłowo wypełnionych pól (poza „Dane pacjenta”) --- */
  document.querySelectorAll('#clcrForm input[type="number"], #clcrForm input[type="text"]').forEach(inp => {
    // Pomiń kartę „Dane pacjenta”
    if (inp.closest('#patientSet')) {
      inp.classList.remove('is-filled');
      return;
    }
    // Pomiń pola tylko do odczytu (np. automatycznie liczone) i checkboxy
    if (inp.readOnly || inp.type === 'checkbox') {
      inp.classList.remove('is-filled');
      return;
    }
    const hasValue = (inp.value || '').trim() !== '';
    const isValid = !inp.classList.contains('error');
    if (hasValue && isValid) {
      inp.classList.add('is-filled');
    } else {
      inp.classList.remove('is-filled');
    }
  });
  if (document.querySelector('#clcrForm .error')) {
    $('results').style.display = 'none';
    $('elecCard').style.display = 'none';
    return;
  }

  // Uznaj, że zestaw podstawowy do wyświetlenia wyników jest kompletny, jeśli
  // użytkownik podał wiek, masę ciała oraz kreatyninę w surowicy.  Wysokość
  // (height) jest wymagana wyłącznie do obliczenia pola powierzchni ciała (BSA)
  // i nie powinna blokować obliczeń Cockcroft‑Gault ani eGFR, które same
  // nie wykorzystują wzrostu.  Dlatego rezygnujemy z wymogu height w tym
  // warunku, aby wyniki były generowane po uzupełnieniu minimalnych danych.
  
  // Dla wzorów Schwartza masa ciała nie jest wymagana — wystarczy wiek i Scr.
  // (Wzory same sprawdzą, czy mają potrzebny wzrost.)
  const coreReady = age && Scr;

  // Sprawdź, czy użytkownik wprowadził cokolwiek w formularzu lub wybrał formułę.
  // Dla checkboxów bierzemy pod uwagę tylko zaznaczenie, ponieważ właściwość
  // `value` zawiera stały ciąg znaków („on”), który wcześniej powodował
  // niewłaściwe ustawienie przycisku.  W przypadku zwykłych pól input
  // sprawdzamy, czy wartość nie jest pusta po obcięciu spacji.  Dodatkowo,
  // jeżeli użytkownik wybrał jakąkolwiek formułę z listy rozwijalnej
  // (#formulaPicker), przycisk czyszczenia powinien być dostępny nawet wtedy,
  // gdy nie wpisano żadnych danych liczbowych.
  const inputsList = [...document.querySelectorAll('#clcrForm input')];
  const hasInput = inputsList.some(el => {
    if (el.type === 'checkbox') {
      return el.checked;
    }
    return (el.value || '').trim() !== '';
  });
  let formulaSelected = false;
  {
    const fp = document.getElementById('formulaPicker');
    if (fp && (fp.value || '').trim() !== '') {
      formulaSelected = true;
    }
  }
  const somethingReady = hasInput || formulaSelected;
  if (!somethingReady) {
    $('results').style.display = 'none';
    return; // nic nie wpisano i nie wybrano formuły
  }

  // Oblicz BSA tylko wtedy, gdy zarówno masa ciała, jak i wzrost są podane.
  // Jeżeli brakuje któregoś z tych parametrów, BSA pozostaje null i pole
  // powierzchni ciała nie jest dodawane do wyników.  Zapobiega to
  // wyświetlaniu „0.00 m²” przy braku wzrostu.
  let BSA = null;
  if (weight && height) {
    BSA = BSA_DuBois(weight, height);
  }
  let clHtml = '';
  if (BSA) {
    clHtml += `<div class="result-box"><strong>Powierzchnia ciała</strong> ${BSA.toFixed(2)} m²</div>`;
  }

  /* === Funkcja do wstawiania wyników z normą i kolorem === */
  function clBox(label, val, unit = '', code) {
              if (!isFiniteNum(val)) return;
    const ageGroup = age < 18 ? 'child' : (age < 65 ? 'adult' : 'senior');
    const rangeSet = clRefRanges[code]?.[ageGroup] || null;
    let inRange = true;
    let rangeText = '';
    if (rangeSet) {
      const lo = (rangeSet.min !== undefined) ? rangeSet.min : '';
      const hi = (rangeSet.max !== undefined) ? rangeSet.max : '';
      rangeText = ` (<span class="range">${lo !== '' ? lo : '–'}‑${hi !== '' ? hi : '–'}${unit}</span>)`;
      if ((rangeSet.min !== undefined && val < rangeSet.min) || (rangeSet.max !== undefined && val > rangeSet.max)) {
        inRange = false;
      }
    }
    clHtml += `<div class="result-box${inRange ? '' : ' out-of-range'}"><strong>${label}:</strong> ${val.toFixed(0)}${unit}${rangeText}</div>`;
  }

  /* — Klirens dobowy — */
  // Klirens kreatyniny z dobowej zbiórki moczu (ml/min/1.73 m²)
  if (Ucr && V24 && Scr && BSA) {
    const cl24 = clCr24h(Ucr, V24, Scr, BSA);
    clBox('Klirens 24 h (DZM)', cl24, ' ml/min/1.73 m²', 'cl24');
  }
  /* — Cockcroft‑Gault — */
  // Cockcroft–Gault wyłącznie, gdy znana jest masa ciała
  let cg = null;
  if (weight > 0 && Scr > 0) {
    cg = clCrCG(sex, age, weight, Scr);
    clBox('Cockcroft–Gault', cg, ' ml/min', 'cg');
  }

  /* — Cockcroft‑Gault znormalizowany do 1,73 m² — */
  if (BSA && cg != null) {
    const cgNorm = cg * 1.73 / BSA;
    clBox('Cockcroft–Gault (1,73 m²)', cgNorm, ' ml/min/1.73 m²', 'cg');
  }

  /* — aktualny eGFR CKD‑EPI — */
  // Wzór CKD‑EPI (NEJM 2021; KDIGO 2022) jest wykorzystywany jako domyślny.
  // Starsza wersja (bez współczynnika 1.012 dla kobiet) została usunięta.
  const egfr = eGFR_CKD_EPI_2022(sex, age, Scr);
  clBox('eGFR (CKD‑EPI)', egfr, ' ml/min/1.73 m²', 'egfr');

  /* — Klasyfikacja PChN (KDIGO) — */
  // KDIGO klasyfikacja G1–G5 dotyczy przede wszystkim osób dorosłych.
  // Dla pacjentów <18 lat nie wyświetlamy klasyfikacji G, ponieważ
  // pediatryczna ocena funkcji nerek opiera się na innych kryteriach (np. wzór Schwartza).
  let stageDesc = null;
  let stageClass = '';
  if (age >= 18) {
    if (egfr >= 90) {
      stageDesc = 'G1 – prawidłowa funkcja';
    } else if (egfr >= 60) {
      stageDesc = 'G2 – łagodne ↓';
    } else if (egfr >= 45) {
      stageDesc = 'G3a – umiarkowane ↓';
      stageClass = 'warn-yellow';
    } else if (egfr >= 30) {
      stageDesc = 'G3b – umiark./ciężkie ↓';
      stageClass = 'warn-orange';
    } else if (egfr >= 15) {
      stageDesc = 'G4 – ciężkie ↓';
      stageClass = 'out-of-range';
    } else {
      stageDesc = 'G5 – niewydolność (dializa)';
      stageClass = 'out-of-range';
    }
    clHtml += `<div class="result-box${stageClass ? ' ' + stageClass : ''}"><strong>Klasyfikacja PChN (KDIGO):</strong> ${stageDesc}</div>`;
  }

  /* ---------  Albuminuria KDIGO (A1–A3)  --------- */
  // Albuminuria KDIGO (A1–A3) można stosować zarówno u dorosłych, jak i u dzieci.
  let albuminDesc = null;
  let albuminClass = '';
  if (ACR) {
    if (ACR < 30) {
      albuminDesc = 'A1 – <30 mg/g (prawidłowa)';
    } else if (ACR <= 300) {
      albuminDesc = 'A2 – 30‑300 mg/g (umiarkowana)';
      albuminClass = 'warn-yellow';
    } else {
      albuminDesc = 'A3 – >300 mg/g (znaczna)';
      albuminClass = 'out-of-range';
    }
    clHtml += `<div class="result-box ${albuminClass}"><strong>Albuminuria (KDIGO):</strong> ${albuminDesc}</div>`;
  }

  /* ---------  Pełna klasyfikacja Gx/Ax  --------- */
  // Pełna klasyfikacja G/A pokazuje jednocześnie kategorię G i A.  U dzieci G‑kod nie jest wyświetlany,
  // więc pomijamy tę kombinację, jeśli stageDesc nie został ustawiony.
  if (stageDesc && albuminDesc) {
    const gCode = stageDesc.split(' ')[0];  // np. G3a
    const aCode = albuminDesc.split(' ')[0]; // np. A2
    clHtml += `<div class="result-box"><strong>Pełna klasyfikacja KDIGO:</strong> ${gCode}/${aCode}</div>`;
  }

  /* ---------  Ostrzeżenie dla dzieci przy wzorach dla dorosłych --------- */
  // Jeżeli wiek pacjenta jest poniżej 18 lat, a użytkownik wybrał
  // formułę Cockcroft–Gault (cg) lub CKD‑EPI (egfr), to te metody są
  // przeznaczone głównie dla dorosłych.  Zgodnie z zaleceniami, u dzieci
  // preferowane są wzory Schwartza.  Dlatego dodajemy ostrzeżenie
  // informujące, aby rozważyć użycie wzorów Schwartza.  Ostrzeżenie
  // pojawi się tylko w wersji podstawowej i tylko wtedy, gdy wybrano
  // jedną z dwóch wspomnianych formuł.  Inne formuły wyświetlane w
  // podstawowym panelu (np. CG znormalizowany) nie wywołują ostrzeżenia,
  // ponieważ wynik i tak zależy bezpośrednio od Cockcroft–Gault.
  {
    const formulaPicker = document.getElementById('formulaPicker');
    const selectedFormula = formulaPicker ? formulaPicker.value : '';
    if (age && age < 18 && (selectedFormula === 'cg' || selectedFormula === 'egfr')) {
      clHtml += `<div class="result-box warn-yellow"><strong>Uwaga:</strong> u dzieci zaleca się stosować wzory Schwartza do oceny GFR.</div>`;
    }
  }

  /* — Schwartz (jeśli <18 l.) — */
  if (age < 18) {
    /* klasyczny Schwartz ze zmiennym k */
    const { gfr: schVar, k: kVar } = clCrSchwartzVar(height, Scr, age, sex);
    clBox(`Schwartz (k=${kVar})`, schVar, ' ml/min/1.73 m²', 'sch');
    /* Bedside Schwartz IDMS */
    const { gfr: schIDMS } = clCrSchwartzIDMS(height, Scr);
    clBox('Schwartz Bedside IDMS (k = 0,413)', schIDMS,
      ' ml/min/1.73 m²', 'sch');
  }
  // Wersja podstawowa wymaga pełnego zestawu parametrów, aby pokazać klirens/eGFR.
  // Wersja „Obliczenia z próbki moczu” wyświetla kartę wyników, jeżeli obliczono albuminurię (ACR).
            const curVer = window.currentVersion || 'basic';
            // Zastąp wyświetlanie klirens/eGFR logiką „tylko możliwe do obliczenia” i wybraną formułą.
            (function() {
              // Odczytaj identyfikator wybranej formuły (lub pusty ciąg, jeśli brak wyboru)
              const formulaPickerEl = document.getElementById('formulaPicker');
              const selectedFormulaId = formulaPickerEl ? (formulaPickerEl.value || '') : '';
              const isAdult = age >= 18;
              let customHtml = '';
              // Pomocnicza funkcja do dodawania boxu z wynikiem wraz z normą
              function addClBox(label, value, unit = '', code) {
                if (!isFiniteNum(value)) return;
                const ageGroup = age < 18 ? 'child' : (age < 65 ? 'adult' : 'senior');
                const rangeSet = clRefRanges[code]?.[ageGroup] || null;
                let inRange = true;
                let rangeText = '';
                if (rangeSet) {
                  const lo = (rangeSet.min !== undefined) ? rangeSet.min : '';
                  const hi = (rangeSet.max !== undefined) ? rangeSet.max : '';
                  rangeText = ` (<span class="range">${lo !== '' ? lo : '–'}‑${hi !== '' ? hi : '–'}${unit}</span>)`;
                  if ((rangeSet.min !== undefined && value < rangeSet.min) || (rangeSet.max !== undefined && value > rangeSet.max)) {
                    inRange = false;
                  }
                }
                customHtml += `<div class="result-box${inRange ? '' : ' out-of-range'}"><strong>${label}:</strong> ${value.toFixed(0)}${unit}${rangeText}</div>`;
              }
              // Funkcje do dodawania dodatków u dorosłych i dzieci (BSA, KDIGO, ACR)
              function addAdultExtras() {
                if (BSA) {
                  customHtml = `<div class="result-box"><strong>Powierzchnia ciała</strong> ${BSA.toFixed(2)} m²</div>` + customHtml;
                }
                if (isFiniteNum(egfr)) {
                  let stageDesc = null, stageCls = '';
                  if (egfr >= 90)      stageDesc = 'G1 – prawidłowa funkcja';
                  else if (egfr >= 60) stageDesc = 'G2 – łagodne ↓';
                  else if (egfr >= 45) { stageDesc = 'G3a – umiarkowane ↓'; stageCls = 'warn-yellow'; }
                  else if (egfr >= 30) { stageDesc = 'G3b – umiark./ciężkie ↓'; stageCls = 'warn-orange'; }
                  else if (egfr >= 15) { stageDesc = 'G4 – ciężkie ↓'; stageCls = 'out-of-range'; }
                  else                 { stageDesc = 'G5 – niewydolność (dializa)'; stageCls = 'out-of-range'; }
                  customHtml += `<div class="result-box${stageCls ? ' ' + stageCls : ''}"><strong>Klasyfikacja PChN (KDIGO):</strong> ${stageDesc}</div>`;
                }
                if (ACR) {
                  let albDesc = 'A1 – <30 mg/g (prawidłowa)', albCls = '';
                  if (ACR >= 30 && ACR <= 300) { albDesc = 'A2 – 30‑300 mg/g (umiarkowana)'; albCls = 'warn-yellow'; }
                  else if (ACR > 300)          { albDesc = 'A3 – >300 mg/g (znaczna)'; albCls = 'out-of-range'; }
                  customHtml += `<div class="result-box ${albCls}"><strong>Albuminuria (KDIGO):</strong> ${albDesc}</div>`;
                }
              }
              function addChildExtras() {
                if (BSA) {
                  customHtml = `<div class="result-box"><strong>Powierzchnia ciała</strong> ${BSA.toFixed(2)} m²</div>` + customHtml;
                }
              }
              // Oblicz wartości poszczególnych formuł, stosując bezpieczne sprawdzenie ich wykonalności
              const results = {};
              results.egfr = isFiniteNum(egfr) ? egfr : null;
              // CG tylko jeśli podano wagę; inaczej ukryj
              results.cg     = (weight > 0 && isFiniteNum(cg)) ? cg : null;
              results.cg_norm = (BSA && weight > 0 && isFiniteNum(cg)) ? (cg * 1.73 / BSA) : null;
              // Oblicz klirens 24 h tylko, jeśli wszystkie składniki są dostępne
              let cl24Value = null;
              if (Ucr && V24 && Scr && BSA) {
                const tmp = clCr24h(Ucr, V24, Scr, BSA);
                cl24Value = isFiniteNum(tmp) ? tmp : null;
              }
              results.cl24 = cl24Value;
              // Oblicz Schwartz:
              //  - zawsze u dzieci (<18),
              //  - u dorosłych (>=18) tylko wtedy, gdy użytkownik ręcznie wybrał daną formułę.
              results.sch_var = null;
              results.sch_idms = null;
              if (height > 0 && Scr > 0) {
                if (age < 18 || selectedFormulaId === 'sch_var') {
                  const resVar = clCrSchwartzVar(height, Scr, age, sex);
                  if (resVar && isFiniteNum(resVar.gfr)) results.sch_var = resVar;
                }
                if (age < 18 || selectedFormulaId === 'sch_idms') {
                  const resID = clCrSchwartzIDMS(height, Scr);
                  if (resID && isFiniteNum(resID.gfr)) results.sch_idms = resID;
                  }
                }
              // Funkcja do renderowania konkretnego wyniku według identyfikatora
              function appendResultById(fid) {
                switch (fid) {
                  case 'egfr':
                    if (results.egfr != null) addClBox('eGFR (CKD‑EPI)', results.egfr, ' ml/min/1.73 m²', 'egfr');
                    break;
                  case 'cg':
                    if (results.cg != null) addClBox('Cockcroft–Gault', results.cg, ' ml/min', 'cg');
                    break;
                  case 'cg_norm':
                    if (results.cg_norm != null) addClBox('Cockcroft–Gault (1,73 m²)', results.cg_norm, ' ml/min/1.73 m²', 'cg');
                    break;
                  case 'cl24':
                    if (results.cl24 != null) addClBox('Klirens 24 h (DZM)', results.cl24, ' ml/min/1.73 m²', 'cl24');
                    break;
                  case 'sch_var':
                    if (results.sch_var != null) addClBox(`Schwartz (k=${results.sch_var.k})`, results.sch_var.gfr, ' ml/min/1.73 m²', 'sch');
                    break;
                  case 'sch_idms':
                    if (results.sch_idms != null) addClBox('Schwartz Bedside IDMS (k = 0,413)', results.sch_idms.gfr, ' ml/min/1.73 m²', 'sch');
                    break;
                }
              }
              if (selectedFormulaId) {
                // Gdy wybrano jedną formułę → pokaż tylko jej wynik (jeśli istnieje)
                appendResultById(selectedFormulaId);
                if (isAdult) addAdultExtras(); else addChildExtras();
                // [NOWE] Ostrzeżenie przy użyciu wzoru Schwartza u dorosłych (tylko jeśli wynik został policzony)
                if (isAdult) {
                  const schComputed =
                    (selectedFormulaId === 'sch_var' && results.sch_var != null) ||
                    (selectedFormulaId === 'sch_idms' && results.sch_idms != null);
                  if (schComputed && (selectedFormulaId === 'sch_var' || selectedFormulaId === 'sch_idms')) {
                    customHtml += `<div class="result-box warn-yellow"><strong>Uwaga:</strong> Formuła Schwartza jest zalecana przede wszystkim u dzieci. U dorosłych rekomendowane są wzory eGFR (CKD‑EPI) i Cockcroft–Gault.</div>`;
                  }
                }
              } else {
                // Brak wyboru formuły → pokaż wszystkie dostępne wyniki
                appendResultById('cl24');
                appendResultById('cg');
                appendResultById('cg_norm');
                appendResultById('egfr');
                appendResultById('sch_var');
                appendResultById('sch_idms');
                if (isAdult) addAdultExtras(); else addChildExtras();
              }
              // Nadpisz clHtml nowo utworzonym HTML-em
              clHtml = customHtml;
            })();
            if (coreReady || (curVer === 'spot' && albuminDesc)) {
              $('clcrInfo').innerHTML = clHtml;
              $('results').style.display = 'grid';
            } else {
              $('clcrInfo').innerHTML = '';
              $('results').style.display = 'none';
            }

  /* ----------  RACHUNEK ELEKTROLITÓW  ---------- */
  const U_Cr = +$('Ucr').value;  // kreatynina w moczu (mg/dl)
  // V24 already defined above
  const kg = weight;

  /* ––– wartości z nowych pól ––– */
  const U_UA  = +$('U_UA').value,  S_UA  = +$('S_UA').value;
  const U_Ca  = +$('U_Ca').value;
  const U_Mg  = +$('U_Mg').value;
  const U_PO4 = +$('U_PO4').value;
  // Serum phosphate value and unit conversion.  Convert mmol/L to mg/dl (1 mmol/L ≈ 3.1 mg/dl【811682241390017†L88-L97】).
  const S_PO4_val  = +$('S_PO4').value;
  const S_PO4_unitEl = document.getElementById('S_PO4_unit');
  const S_PO4_unit = S_PO4_unitEl ? S_PO4_unitEl.value : 'mg/dl';
  let S_PO4_mgdl = null;
  if (S_PO4_val && S_PO4_unit && S_PO4_unit !== '') {
    S_PO4_mgdl = (S_PO4_unit === 'mmol/L') ? (S_PO4_val * 3.1) : S_PO4_val;
  }
  const U_Na  = +$('U_Na').value,  S_Na  = +$('S_Na').value;
  const U_K   = +$('U_K').value,   S_K   = +$('S_K').value;
  const U_Cl  = +$('U_Cl').value,  S_Cl  = +$('S_Cl').value;
  const U_HCO3= +$('U_HCO3').value, S_HCO3 = +$('S_HCO3').value;
  const U_Prot= +$('U_Prot').value;

  /* === KAMICA — START (pobranie danych) === */
  // Serum calcium value and unit conversion.  Convert mmol/L to mg/dl (1 mmol/L ≈ 4 mg/dl).
  const S_Ca_val   = +$('S_Ca').value;
  const S_Ca_unitEl  = document.getElementById('S_Ca_unit');
  const S_Ca_unit  = S_Ca_unitEl ? S_Ca_unitEl.value : 'mg/dl';
  let S_Ca_mgdl = null;
  if (S_Ca_val && S_Ca_unit && S_Ca_unit !== '') {
    S_Ca_mgdl = (S_Ca_unit === 'mmol/L') ? (S_Ca_val * 4) : S_Ca_val;
  }
  const S_Ca   = S_Ca_mgdl;
  const U_pH   = +$('U_pH').value;
  // Wczytujemy stężenie szczawianów i cytrynianów w próbce moczu (mg/dl).
  const U_Ox_spot  = +$('Ox_Cr_spot').value;
  const U_Cit_spot = +$('Cit_Cr_spot').value;
  const S_PTH  = +$('S_PTH').value;
  const S_VitD = +$('S_VitD').value;
  const U_Ox   = +$('U_Ox').value;
  const U_Cit  = +$('U_Cit').value;
  const U_Cys  = +$('U_Cys').value;
  const pH24   = +$('pH24').value;
  /* === KAMICA — END (pobranie danych) === */

  // --- Przeliczanie jednostek dla pól z nowymi jednostkami ---
  // Wapń podawany w mmol/L konwertujemy na mg/dl: 1 mmol Ca ≈ 40 mg,
  // a 1 L = 10 dL, więc mg/dl = (mmol/L × 40) / 10 = mmol/L × 4
  const U_Ca_mgdl = U_Ca ? U_Ca * 4 : null;
  // Magnez podawany w mg/L konwertujemy na mg/dl (1 L = 10 dL)
  const U_Mg_mgdl = U_Mg ? U_Mg / 10 : null;

  /* === KAMICA — START (dodatkowe obliczenia) === */
  // Wydalanie szczawianów i cytrynianów – mg/kg/d
  const Ox_mgkg  = excr_mgkg(U_Ox, V24, kg);
  const Cit_mgkg = excr_mgkg(U_Cit, V24, kg);

  // Stosunek Ca/Cit (mg/mg) – przydadzą się oba pola
  const Ca_Cit_ratio = (U_Ca_mgdl && U_Cit) ? (U_Ca_mgdl / U_Cit) : null;

  // Stosunek szczawianu i cytrynianu do kreatyniny w próbce (mg/mg).
  // Użytkownik wprowadza stężenie szczawianów i cytrynianów w próbce moczu (mg/dl);
  // poniżej obliczamy stosunek do kreatyniny z dobowej zbiórki. Funkcja ratio
  // zwraca wartość tylko wtedy, gdy dostępne są oba składniki.
  const Ox_Cr_spot  = ratio(U_Ox_spot, U_Cr_spot);
  const Cit_Cr_spot = ratio(U_Cit_spot, U_Cr_spot);
  // Stosunek wapnia do kreatyniny w próbce moczu (Ca/Cr, mg/mg).  Wapń jest przeliczany
  // na mg/dl w zmiennej Ca_spot_mgdl, a kreatynina w próbce moczu (U_Cr_spot) jest
  // podawana w mg/dl.  Funkcja ratio() zwróci null, jeśli brakuje danych.
  const Ca_Cr_spot  = ratio(Ca_spot_mgdl, U_Cr_spot);
  /* === KAMICA — END (dodatkowe obliczenia) === */

  /* --- WYDALANIA mg/kg/d --- */
  const UA_mgkg  = excr_mgkg(U_UA, V24, kg);
  // Ca i Mg wprowadzane odpowiednio w mmol/L i mg/L – przeliczamy je na mg/dl
  const Ca_mgkg  = excr_mgkg(U_Ca_mgdl, V24, kg);
  const Mg_mgkg  = excr_mgkg(U_Mg_mgdl, V24, kg);
  const PO4_mgkg = excr_mgkg(U_PO4, V24, kg);
  // Białko całkowite podawane w mg/24 h – dla mg/kg/d dzielimy przez masę ciała
  const Prot_mgkg= (U_Prot && kg) ? U_Prot / kg : null;

  /* --- WYDALANIA mmol/d --- */
  const Na_mmol_d = excr_mmol_d(U_Na, V24);
  const K_mmol_d  = excr_mmol_d(U_K, V24);

  /* --- WSKAŹNIKI / RATIO --- */
  const KM_Cr = ratio(U_UA, U_Cr);
  // Ca/Cr: używamy przeliczonego Ca w mg/dl
  const Ca_Cr = ratio(U_Ca_mgdl, U_Cr);
  // Stosunek magnezu do wapnia (Mg/Ca): obie wartości w mg/dl
  const Mg_Ca = (U_Mg_mgdl && U_Ca_mgdl) ? U_Mg_mgdl / U_Ca_mgdl : null;
  const PO4_Cr = ratio(U_PO4, U_Cr);
  // Białko/kreatynina: białko w mg/24h, kreatynina w mg/dl → konwersja kreatyniny na mg/24h
  // mg kreatyniny/24h = U_Cr (mg/dl) * V24 (ml) / 100 (ml per dl)
  const B_Cr  = (U_Prot && U_Cr && V24) ? U_Prot / ((U_Cr * V24) / 100) : null;
  const K_KNa = K_frac(U_K, U_Na);

  /* --- FRAKCJE I LUKI --- */
  // Use converted serum phosphate in mg/dl for TRP calculation.
  const TRPpct    = TRP(U_PO4, S_PO4_mgdl, U_Cr, Scr);
  const FENa_pct  = FE(U_Na, S_Na, U_Cr, Scr);
  const FEHCO3_pct= FE(U_HCO3, S_HCO3, U_Cr, Scr);
  const AGs = AG_serum(S_Na, S_K, S_Cl, S_HCO3);
  const AGu = AG_urine(U_Na, U_K, U_Cl);

  // Frakcja wydalnicza potasu i chlorków – obliczana analogicznie do FENa.
  const FEK_pct  = FE(U_K, S_K, U_Cr, Scr);
  const FECl_pct = FE(U_Cl, S_Cl, U_Cr, Scr);

  /* --- KT/V (orientacyjnie) --- */
  const ktv = KT_V(cg, kg);  // używamy Cockcroft‑Gault jako K

  /* --- Obliczenia TmP/GFR --- */
  // TmP/GFR obliczamy zarówno dla danych z próbki moczu (spot), jak i dla dobowej zbiórki (24 h), jeśli są dostępne.
  let TRPpct_spot = null;
  let TmP_spot_mgdl = null;
  let TmP_spot_mmol = null;
  if (U_PO4_spot_mgdl && S_PO4_spot_mgdl && U_Cr_spot && Scr_spot_mgdl) {
    TRPpct_spot = TRP(U_PO4_spot_mgdl, S_PO4_spot_mgdl, U_Cr_spot, Scr_spot_mgdl);
    TmP_spot_mgdl = S_PO4_spot_mgdl - (U_PO4_spot_mgdl / U_Cr_spot) * Scr_spot_mgdl;
    TmP_spot_mmol = TmP_spot_mgdl / 3.097;
  }
  let TRPpct_24 = null;
  let TmP_24_mgdl = null;
  let TmP_24_mmol = null;
  let tmp24_comment = '';
  if (U_PO4 && S_PO4_mgdl && U_Cr && Scr) {
    TRPpct_24 = TRP(U_PO4, S_PO4_mgdl, U_Cr, Scr);
    TmP_24_mgdl = S_PO4_mgdl - (U_PO4 / U_Cr) * Scr;
    TmP_24_mmol = TmP_24_mgdl / 3.097;
    // Dodaj ostrzeżenie, jeśli dane pochodzą z dobowej zbiórki (V24 > 0).
    if (V24) {
      tmp24_comment = 'W literaturze medycznej za standard przyjęto obliczanie TmP/GFR na podstawie jednoczesnego oznaczenia stężenia fosforu nieorganicznego i kreatyniny we krwi oraz w pojedynczej próbce moczu pobranej w tym samym czasie, a nie z dobowej zbiórki moczu.';
    }
  }

  /* --- BUDUJEMY HTML --- */
  let ehtml = '';

  function box(label, val, unit = '', code) {
    // Skip rendering values that are null, NaN or infinite.  When required
    // inputs are missing, certain calculations (such as KT/V) can result in
    // Infinity due to division by zero.  Such values should not be shown to
    // the user, so we check for finiteness using the built‑in isFinite().
              if (!isFiniteNum(val)) return;
    // Zamieniamy twarde spacje (U+00A0) w etykiecie na zwykłe spacje,
    // aby tekst mógł łamać się w naturalnych miejscach. Jeśli pozostawimy
    // spacje nierozdzielające, cała etykieta staje się jednym długim
    // „słowem”, które może wychodzić poza kontener w wąskim układzie.
    const safeLabel = label.replace(/\u00A0/g, ' ');
    const ageGroup = age < 18 ? 'child' : (age < 65 ? 'adult' : 'senior');
    const rangeSet = refRanges[code]?.[ageGroup] || null;
    let inRange = true;
    let rangeText = '';
    if (rangeSet) {
      const lo = (rangeSet.min !== undefined) ? rangeSet.min : '';
      const hi = (rangeSet.max !== undefined) ? rangeSet.max : '';
      rangeText = ` (<span class="range">${lo !== '' ? lo : '–'}‑${hi !== '' ? hi : '–'}${unit}</span>)`;
      if ((rangeSet.min !== undefined && val < rangeSet.min) || (rangeSet.max !== undefined && val > rangeSet.max)) {
        inRange = false;
      }
    }
    ehtml += `<div class="result-box${inRange ? '' : ' out-of-range'}"><strong>${safeLabel}:</strong> ${val.toFixed(1)} ${unit}${rangeText}</div>`;
  }

  box('Wydalanie kw. moczowego', UA_mgkg, 'mg/kg/d');
  // Rozwinięcie skrótu KM/Cr: stosunek kwasu moczowego do kreatyniny w moczu
  box('KM/Cr (kwas moczowy / kreatynina)', KM_Cr, '');
  // Zastąpienie skrótów opisami zrozumiałymi dla osób spoza branży medycznej.
  // Wydalanie wapnia i stosunek wapnia do kreatyniny
  box('Wydalanie wapnia (Ca)', Ca_mgkg, 'mg/kg/d', 'Ca_mgkg');        box('Stosunek wapnia do kreatyniny (Ca/Cr)', Ca_Cr, '', 'Ca_Cr');
  // Wydalanie magnezu oraz stosunek magnezu do wapnia – rozszerzamy etykiety dla większej czytelności
  // Nowa etykieta „Wydalanie magnezu (Mg)” jasno wskazuje, że chodzi o całkowite wydalanie magnezu w dobowej zbiórce
  // Nowa etykieta „Stosunek magnezu do wapnia (Mg/Ca)” wyjaśnia, że obie wartości w liczniku i mianowniku odnoszą się do stężeń w mg/dl
  box('Wydalanie magnezu (Mg)', Mg_mgkg, 'mg/kg/d', 'Mg_mgkg');                  box('Stosunek magnezu do wapnia (Mg/Ca)', Mg_Ca, '', 'Mg_Ca');
  // Wydalanie fosforanów i stosunek fosforanów do kreatyniny
  box('Wydalanie fosforanów (PO₄)', PO4_mgkg, 'mg/kg/d', 'PO4_mgkg'); box('Stosunek fosforanów do kreatyniny (PO₄/Cr)', PO4_Cr, '', 'PO4_Cr');
  // TRP – reabsorpcja fosforanów (podajemy wyjaśnienie)
  box('Reabsorpcja fosforanów (TRP)', TRPpct, '%', 'TRPpct');
  // Wydalanie sodu i frakcja wydalnicza sodu
  box('Wydalanie sodu (Na)', Na_mmol_d, 'mmol/d', 'Na_mmol_d');       box('Frakcja wydalnicza sodu (FENa)', FENa_pct, '%', 'FENa_pct');
  // Frakcja wydalnicza potasu i chlorków pozostają bez zmian
  box('Frakcja wydalnicza potasu (FEK)', FEK_pct, '%', 'FEK_pct');
  box('Frakcja wydalnicza chlorków (FECl)', FECl_pct, '%', 'FECl_pct');
  // Wydalanie potasu i stosunek potasu do sumy potasu i sodu
  box('Wydalanie potasu (K)', K_mmol_d, 'mmol/d', 'K_mmol_d');        // Wydalanie potasu (K)
  box('Stosunek potasu do sumy potasu i sodu (K/(K+Na))', K_KNa, '%', 'K_frac');
  // Luka anionowa w surowicy i w moczu pozostają bez zmian
  box('Luka anionowa (surowica)', AGs, 'mmol/L', 'AGs');
  box('Luka anionowa (mocz)', AGu, 'mmol/L', 'AGu');
  // Frakcja wodorowęglanów – rozszerzamy opis skrótu
  box('Frakcja wodorowęglanów (HCO₃)', FEHCO3_pct, '%', 'FEHCO3_pct');
  box('Białkomocz', Prot_mgkg, 'mg/kg/d', 'Prot_mgkg');      box('Białko/kreatynina (B/Cr)', B_Cr, '', 'B_Cr');
  // Rozwinięcie skrótu KT/V (klirens mocznika / objętości dystrybucji) – wartość orientacyjna
  // została usunięta z sekcji „Inne wskaźniki”. Użytkownik może zobaczyć
  // szczegółowe wartości KT/V jedynie w sekcji zaawansowanych obliczeń KT/V,
  // dostępnej poprzez osobny przełącznik. Dzięki temu raport AI i sekcja
  // „Inne wskaźniki” nie prezentują już orientacyjnych wartości KT/V.

  // --- TmP/GFR i TRP — wyniki ---
  // Dodajemy wskaźniki transportu fosforanów, zarówno z pojedynczej próbki moczu, jak i z dobowej zbiórki.
  // Wartości null są ignorowane przez funkcję box().  Normy są ustawiane dynamicznie w zależności od wieku.
  box('Reabsorpcja fosforanów (TRP, próbka moczu)', TRPpct_spot, '%', 'TRPpct');
  box('TmP/GFR (próbka moczu)', TmP_spot_mgdl, 'mg/dl', 'TmP_mgdl');
  box('TmP/GFR (próbka moczu)', TmP_spot_mmol, 'mmol/L', 'TmP_mmol');
  // Wyniki z dobowej zbiórki moczu (24 h)
  box('Reabsorpcja fosforanów (TRP, 24 h)', TRPpct_24, '%', 'TRPpct');
  box('TmP/GFR (dobowa zbiórka)', TmP_24_mgdl, 'mg/dl', 'TmP_mgdl');
  box('TmP/GFR (dobowa zbiórka)', TmP_24_mmol, 'mmol/L', 'TmP_mmol');
  // Jeżeli obliczono TmP/GFR z danych dobowej zbiórki, dodaj informacyjny komentarz.
  if (tmp24_comment) {
    ehtml += `<div class="result-box warn-yellow"><strong>Uwaga:</strong> ${tmp24_comment}</div>`;
  }


  /* wyświetl lub ukryj kartę */
  $('elecInfo').innerHTML = ehtml;
  $('elecCard').style.display = ehtml ? 'block' : 'none';

  /* === KAMICA — START (wyniki) === */
  // Wyniki związane z ryzykiem kamicy prezentowane w oddzielnej karcie.
  let stoneHtml = '';
  function stoneBox(label, val, unit = '', code) {
    /*
     * Zmieniamy sposób pomijania wartości: oprócz braku
     * (null) i liczby nienaturalnej (NaN), odrzucamy
     * również zera. W polach ryzyka kamicy użytkownik może
     * pozostawić dane puste; użycie operatora unarnego '+'
     * konwertowało takie puste pola na 0, co skutkowało
     * wyświetlaniem pustych wyników (np. pH = 0.0).  Zero jest
     * ponadto nielogiczne dla większości parametrów (pH, wydalania),
     * dlatego traktujemy je tak jak brak danych i nie tworzymy
     * boksu z wynikiem. Dzięki temu karta „Ryzyko kamicy nerkowej”
     * pojawi się dopiero, gdy wprowadzone zostaną rzeczywiste
     * wartości.
     */
    if (val === null || !isFinite(val) || val === 0) return;
    // Zamieniamy nierozdzielające spacje w etykiecie na zwykłe spacje, aby umożliwić łamanie wąskiego tekstu
    const safeLabel = label.replace(/\u00A0/g, ' ');
    const ageGroup = age < 18 ? 'child' : (age < 65 ? 'adult' : 'senior');
    const rangeSet = refRanges[code]?.[ageGroup] || null;
    let inRange = true;
    let rangeText = '';
    if (rangeSet) {
      /*
       * Build a user‑friendly reference range. The previous implementation
       * always rendered a start and end value separated by a hyphen,
       * inserting an em dash when either boundary was missing (e.g.
       * "0.15‑–mg/mg"). This is confusing for users. Instead we
       * explicitly show a lower bound using ≥ when only a minimum is
       * defined, or an upper bound using ≤ when only a maximum is
       * defined. When both bounds exist we join them with an en dash.
       * A space is added before the unit for readability.
       */
      const loVal = (rangeSet.min !== undefined) ? rangeSet.min : null;
      const hiVal = (rangeSet.max !== undefined) ? rangeSet.max : null;
      /*
       * Build the reference text without leaving stray spaces.  Only insert a
       * space before the unit when a unit is provided.  For parameters such as
       * Ca/Cit and pH, where the display is unitless, omitting the extra
       * space prevents an awkward trailing space.
       */
      const unitSuffix = unit ? ` ${unit}` : '';
      if (loVal !== null && hiVal !== null) {
        rangeText = ` (<span class="range">${loVal}–${hiVal}${unitSuffix}</span>)`;
      } else if (loVal !== null) {
        rangeText = ` (<span class="range">≥${loVal}${unitSuffix}</span>)`;
      } else if (hiVal !== null) {
        rangeText = ` (<span class="range">≤${hiVal}${unitSuffix}</span>)`;
      } else {
        rangeText = '';
      }
      // Determine whether the value falls outside the reference range. If only a
      // minimum is defined, values below that threshold are flagged; if only
      // a maximum is defined, values above that threshold are flagged.
      if ((loVal !== null && val < loVal) || (hiVal !== null && val > hiVal)) {
        inRange = false;
      }
    }
    /*
     * For most stone risk markers we display a single decimal place
     * (e.g. 0.0). However, the spot ratios of citrate/creatinine
     * and oxalate/creatinine are often very small numbers where
     * a single decimal would obscure meaningful differences. To
     * accommodate this, detect when the provided code corresponds
     * to the Cit/Cr or Ox/Cr spot ratios and increase the number
     * of decimal places to three. For all other markers we keep
     * the historical one‑decimal precision.
     */
    const decimals = (code === 'Cit_Cr' || code === 'Ox_Cr') ? 3 : 1;
    /*
     * As above, avoid adding an extra space when there is no unit.  This makes
     * the output for ratios like Ca/Cit cleaner (e.g. "0.25" instead of
     * "0.25 ").
     */
    const unitText = unit ? ` ${unit}` : '';
    stoneHtml += `<div class="result-box${inRange ? '' : ' out-of-range'}"><strong>${safeLabel}:</strong> ${val.toFixed(decimals)}${unitText}${rangeText}</div>`;
  }
  // Generuj boxy w wersji profesjonalnej oraz w wersji „Obliczenia z próbki moczu”
  if ((window.currentVersion || 'basic') === 'pro' || (window.currentVersion || 'basic') === 'spot') {
    stoneBox('Wydalanie szczawianów (Ox)', Ox_mgkg, 'mg/kg/d', 'Ox_mgkg');
    stoneBox('Wydalanie cytrynianów (Cit)', Cit_mgkg, 'mg/kg/d', 'Cit_mgkg');
    stoneBox('Ox/Cr (spot)', Ox_Cr_spot, 'mg/mg', 'Ox_Cr');
    stoneBox('Cit/Cr (spot)', Cit_Cr_spot, 'mg/mg', 'Cit_Cr');
    stoneBox('Stosunek Ca/Cit', Ca_Cit_ratio, '', 'Ca_Cit');
    // Stosunek Ca/Cr w próbce moczu; norma zależna od wieku została ustawiona powyżej
    stoneBox('Ca/Cr (spot)', Ca_Cr_spot, 'mg/mg', 'Ca_Cr_spot');
    stoneBox('pH próbki moczu', U_pH, '', 'pHspot');
    stoneBox('pH dobowej zbiórki', pH24, '', 'pHspot');
  }
  // Generator krótkiego podsumowania ryzyka kamicy – ostrzeżenia warunkowe
  let shtml = '';
  function alertLine(txt){
    shtml += `<p style="margin:4px 0;"><strong>${txt}</strong></p>`;
  }
  if ((window.currentVersion || 'basic') === 'pro' || (window.currentVersion || 'basic') === 'spot') {
    // — objętość dobowego moczu —
    // Zamiast stałego progu 2 L/d, stosujemy progi zależne od wieku i masy ciała dziecka.
    // Tabela norm diurezy (dolna granica) w ml/kg/h wg Medycyna Praktyczna:
    //  noworodki <1 rok – ≥ 2 ml/kg/h;
    //  1‑3 lata – ≥ 1,5 ml/kg/h;
    //  4‑12 lat – ≥ 1 ml/kg/h (i nie mniej niż 30 ml/h);
    //  >12 lat – ≥ 0,5 ml/kg/h (i nie mniej niż 40 ml/h).
    // Dla dorosłych (≥18 lat) przyjmujemy próg 2000 ml/d (2 L/d) jak dotychczas.
    if (V24) {
      let lowUrineThreshold = 2000; // domyślny próg dla dorosłych
      // Ustal próg zależnie od wieku dziecka (wiek podany w latach)
      if (age < 18) {
        let mlPerKgPerHour;
        let absoluteMinPerHour = 0;
        if (age < 1) {
          // noworodki i niemowlęta – 2 ml/kg/h (w źródle 2‑3 ml/kg/h, przyjmujemy dolną granicę 2)
          mlPerKgPerHour = 2;
        } else if (age < 3) {
          // 1‑3 lata – 1,5 ml/kg/h
          mlPerKgPerHour = 1.5;
        } else if (age <= 12) {
          // 4‑12 lat – 1 ml/kg/h, z minimalnym absolutnym przepływem 30 ml/h
          mlPerKgPerHour = 1;
          absoluteMinPerHour = 30;
        } else {
          // >12 lat – 0,5 ml/kg/h, z minimalnym absolutnym przepływem 40 ml/h
          mlPerKgPerHour = 0.5;
          absoluteMinPerHour = 40;
        }
        // Oblicz wartość progową w ml/d
        lowUrineThreshold = mlPerKgPerHour * weight * 24;
        // Jeśli wprowadzono minimalny przepływ absolutny, pilnuj aby wartość progu nie była niższa
        if (absoluteMinPerHour) {
          const absoluteMinDaily = absoluteMinPerHour * 24;
          if (lowUrineThreshold < absoluteMinDaily) {
            lowUrineThreshold = absoluteMinDaily;
          }
        }
      }
      // Jeśli uzyskana objętość dobowego moczu jest niższa od progu, wyświetl ostrzeżenie
      if (V24 < lowUrineThreshold) {
        alertLine(`Mała objętość moczu (${(V24/1000).toFixed(2)} L/d) – ryzyko wszystkich typów kamicy.`);
      }
    }
    // — hiperkalciuria —
    if (Ca_mgkg && Ca_mgkg > 4){
      alertLine('Hiperkalciuria – sprzyja kamicy wapniowej.');
    }
    // — hiperoksaluria —
    if (Ox_mgkg && Ox_mgkg > 0.6){
      alertLine('Hiperoksaluria – zwiększone ryzyko kamieni szczawianowych.');
    }
    // — hipocytraturia —
    if (Cit_mgkg && Cit_mgkg < (age < 18 ? 5 : 4)){
      alertLine('Hipocytraturia – niski inhibitor krystalizacji.');
    }
    // — kwaśny mocz a kamica moczanowa —
    if ( (U_pH && U_pH < 5.5) || (pH24 && pH24 < 5.5) ){
      alertLine('Kwaśny mocz (pH <5,5) – ryzyko kamicy z kwasu moczowego.');
    }
    // — zasadowy mocz a kamica fosforanowa —
    if ( (U_pH && U_pH > 7.0) || (pH24 && pH24 > 7.0) ){
      alertLine('Zasadowy mocz (pH >7,0) – ryzyko kamicy fosforanowej / struwitowej.');
    }
    // — cystynuria —
    if (U_Cys && U_Cys > 250){
      alertLine('Cystynuria – bardzo wysokie ryzyko kamicy cystynowej (cystyna >250 mg/L).');
    }
  }
  // Aktualizuj zawartość i widoczność karty z ryzykiem kamicy
  {
    const stoneInfoEl = document.getElementById('stoneInfo');
    const stoneCardEl = document.getElementById('stoneCard');
    if (stoneInfoEl && stoneCardEl) {
      if (((window.currentVersion || 'basic') === 'pro' || (window.currentVersion || 'basic') === 'spot') && (stoneHtml || shtml)) {
        let combined = '';
        if (stoneHtml) combined += stoneHtml;
        if (shtml) {
          if (stoneHtml) combined += '<hr>';
          combined += shtml;
        }
        stoneInfoEl.innerHTML = combined;
        stoneCardEl.style.display = 'block';
      } else {
        stoneInfoEl.innerHTML = '';
        stoneCardEl.style.display = 'none';
      }
    }
  }
  /* === KAMICA — END (wyniki) === */

  /* ----------  Zaawansowane KT/V  ---------- */
  const advBox   = document.getElementById('ktvFields');
  const advCheck = document.getElementById('ktvToggle');
  if (advBox && advCheck) {
    // Pokaż lub ukryj sekcję z polami KT/V w zależności od zaznaczenia
    advBox.style.display = advCheck.checked ? 'block' : 'none';
    if (advCheck.checked) {
      // Upewnij się, że w sekcji KT/V znajdują się ikony informacyjne przy każdym polu
      const advTips = {
        ktvTime: 'Czas trwania sesji dializy w godzinach (t, h).',
        ktvUF:   'Ubytek masy podczas dializy (ultrafiltracja), w kilogramach (UF, kg).',
        ktvW:    'Masa ciała pacjenta po dializie, w kilogramach (W, kg).',
        UreaPre: 'Stężenie mocznika we krwi przed dializą (mg/dl).',
        UreaPost:'Stężenie mocznika we krwi po dializie (mg/dl).'
      };
      ['ktvTime','ktvUF','ktvW','UreaPre','UreaPost'].forEach(fid => {
        const field = document.getElementById(fid);
        if (field) {
          const lab = field.closest('label');
          if (lab && !lab.querySelector('.info-icon')) {
            const ico = document.createElement('span');
            ico.className = 'info-icon';
            ico.title = advTips[fid] || '';
            ico.textContent = 'ℹ️';
            lab.insertBefore(ico, field);
          }
        }
      });
      // zbierz dane
      const tHrs  = +$('ktvTime').value;
      const UFkg  = +$('ktvUF').value;
      const Wkg   = +$('ktvW').value;
      const pre   = +$('UreaPre').value;
      const post  = +$('UreaPost').value;
      const R     = post && pre ? post / pre : null;

      const spKtv = ktvDaugirdas(R, tHrs, UFkg, Wkg);
      const ekTv  = spKtv ? eKtV(spKtv, tHrs * 60) : null;

      if (spKtv) {
        $('ktvResult').innerHTML = `<strong>KT/V (Daugirdas):</strong> ${spKtv.toFixed(2)}`;
        $('ktvResult').style.display = 'block';
      } else {
        $('ktvResult').style.display = 'none';
      }
      if (ekTv) {
        $('ektvResult').innerHTML = `<strong>eKt/V (wyrównany):</strong> ${ekTv.toFixed(2)}`;
        $('ektvResult').style.display = 'block';
      } else {
        $('ektvResult').style.display = 'none';
      }
    } else {
      // gdy checkbox jest odznaczony, ukryj wyniki KT/V
      if (document.getElementById('ktvResult')) document.getElementById('ktvResult').style.display = 'none';
      if (document.getElementById('ektvResult')) document.getElementById('ektvResult').style.display = 'none';
    }
  }

  // Po zakończeniu wszystkich obliczeń zdecyduj, czy pokazać przycisk czyszczenia formularza.
  // Przy wyczyszczonym formularzu przycisk nie powinien być widoczny.  We wszystkich
  // wersjach kalkulatora (Podstawowy, Zaawansowany, Obliczenia z próbki moczu i Profesjonalny)
  // używamy zmiennej `somethingReady` do określenia, czy cokolwiek zostało wpisane – jeśli tak,
  // pokaż przycisk, w przeciwnym razie ukryj.  Dzięki temu użytkownik może szybko
  // wyczyścić formularz bez względu na wybrany tryb.
  {
    const clearContainer = document.getElementById('clearContainer');
    if (clearContainer) {
      clearContainer.style.display = somethingReady ? 'block' : 'none';
    }
  }
}


/* ---------- 5.4 EKSPORT PDF (wersja dopracowana – jedna strona) ---------- */
$('downloadPDF').addEventListener('click', async () => {
  // Upewnij się, że wartości są aktualne
  if (typeof update === 'function') update();
  const { jsPDF } = window.jspdf;

  // Przygotuj kontener raportu
  const reportDiv = document.getElementById('pdfReport');
  reportDiv.innerHTML = '';

  // Nagłówek raportu
  const title = document.createElement('h2');
  title.textContent = 'Raport klirensu / eGFR';
  reportDiv.appendChild(title);

  // Dane pacjenta
  const patientSection = document.createElement('div');
  patientSection.className = 'section';
  const patientHeader = document.createElement('h3');
  patientHeader.textContent = 'Dane pacjenta';
  patientSection.appendChild(patientHeader);
  const sexSelect = document.getElementById('sex');
  const sexText = sexSelect?.options[sexSelect.selectedIndex]?.text || '';
  patientSection.innerHTML += `<p><strong>Imię i nazwisko:</strong> ${($('fullName').value || '').trim() || '–'}</p>`;
  patientSection.innerHTML += `<p><strong>Wiek:</strong> ${$('age').value || '–'} lata</p>`;
  patientSection.innerHTML += `<p><strong>Płeć:</strong> ${sexText || '–'}</p>`;
  patientSection.innerHTML += `<p><strong>Masa:</strong> ${$('weight').value || '–'} kg</p>`;
  patientSection.innerHTML += `<p><strong>Wzrost:</strong> ${$('height').value || '–'} cm</p>`;
  reportDiv.appendChild(patientSection);

  // Funkcja pomocnicza kopiująca wynik z kart wyników
  const appendResultsSection = (containerId, sectionTitle) => {
    const src = document.getElementById(containerId);
    if (!src || !src.children || src.children.length === 0) return;
    const section = document.createElement('div');
    section.className = 'section';
    const h3 = document.createElement('h3');
    h3.textContent = sectionTitle;
    section.appendChild(h3);
    Array.from(src.children).forEach(child => {
      const p = document.createElement('p');
      p.className = 'result-item';
      // przenieś klasę out-of-range, jeśli istnieje
      if (child.classList.contains('out-of-range')) p.classList.add('out-of-range');
      // kopiuj HTML etykiety i wartości, zachowując span.range
      p.innerHTML = child.innerHTML;
      section.appendChild(p);
    });
    reportDiv.appendChild(section);
  };
  // Sekcja: Klirens / eGFR
  appendResultsSection('clcrInfo', 'Klirens / eGFR');
  // Sekcja: Inne wskaźniki
  appendResultsSection('elecInfo', 'Inne wskaźniki');
  // Sekcja: Ryzyko kamicy nerkowej (wyniki i ostrzeżenia)
  appendResultsSection('stoneInfo', 'Ryzyko kamicy nerkowej');
  // Sekcja: KT/V (jeżeli obliczone)
  {
    const ktv1 = document.getElementById('ktvResult');
    const ktv2 = document.getElementById('ektvResult');
    const hasKTV = (ktv1 && ktv1.style.display !== 'none') || (ktv2 && ktv2.style.display !== 'none');
    if (hasKTV) {
      const section = document.createElement('div');
      section.className = 'section';
      const h3 = document.createElement('h3');
      h3.textContent = 'Wyniki KT/V';
      section.appendChild(h3);
      [ktv1, ktv2].forEach(elem => {
        if (elem && elem.style.display !== 'none') {
          const p = document.createElement('p');
          p.className = 'result-item';
          // skopiuj zawartość wyników KT/V
          p.innerHTML = elem.innerHTML;
          section.appendChild(p);
        }
      });
      reportDiv.appendChild(section);
    }
  }

  // Pokaż raport (konieczne do renderowania przez html2canvas)
  reportDiv.style.display = 'block';

  // Ustal margines w mm oraz rozmiary strony
  const margin = 10;
  const page = { w: 210, h: 297 };
  const avail = { w: page.w - margin * 2, h: page.h - margin * 2 };

  // Utwórz canvas z raportu; scale=2 zapewnia wyższą rozdzielczość
  const canvas = await html2canvas(reportDiv, { scale: 2, useCORS: true, backgroundColor: null });

  // Ukryj raport ponownie
  reportDiv.style.display = 'none';

  // Oblicz przeliczniki – piksele na milimetry
  const pxPerMm = canvas.width / avail.w;
  const imgHfull = canvas.height / pxPerMm;
  // Skalowanie, aby obraz zmieścił się w obszarze avail
  const scale = imgHfull > avail.h ? avail.h / imgHfull : 1;
  const imgWmm = avail.w * scale;
  const imgHmm = imgHfull * scale;

  // Utwórz PDF
  const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', compress: true });
  const offsetX = margin + (avail.w - imgWmm) / 2;
  const offsetY = margin + (avail.h - imgHmm) / 2;
  const imgData = canvas.toDataURL('image/png');
  pdf.addImage(imgData, 'PNG', offsetX, offsetY, imgWmm, imgHmm);
  // Nazwa pliku
  const nameSlug = $('fullName').value.trim().replace(/\s+/g, '_');
  const fileName = (nameSlug ? nameSlug + '_' : '') + 'Klirens_VildaClinic.pdf';
  pdf.save(fileName);
});

/* ---------- 5.4b EKSPORT DOCX/RTF (raport tekstowy) ---------- */
// Generuje plik DOCX przy użyciu biblioteki docx, a jeżeli nie jest dostępna – używa prostej wersji HTML w pliku .doc
$('downloadDOCX').addEventListener('click', async () => {
  // upewnij się, że aktualne wyniki są przeliczone
  if (typeof update === 'function') update();
  // przygotuj dane pacjenta
  const sexSelect = document.getElementById('sex');
  const sexText = sexSelect?.options[sexSelect.selectedIndex]?.text || '';
  const patientLines = [
    ['Imię i nazwisko:', ($('fullName').value || '').trim() || '–'],
    ['Wiek:', $('age').value ? $('age').value + ' lata' : '–'],
    ['Płeć:', sexText || '–'],
    ['Masa:', $('weight').value ? $('weight').value + ' kg' : '–'],
    ['Wzrost:', $('height').value ? $('height').value + ' cm' : '–'],
  ];
  // funkcje pomocnicze do pobierania wyników
  function collectResults(containerId) {
    const arr = [];
    const container = document.getElementById(containerId);
    if (!container || !container.children) return arr;
    Array.from(container.children).forEach(child => {
      const text = child.textContent.trim().replace(/\u00A0/g, ' ');
      const isOut = child.classList.contains('out-of-range') || child.classList.contains('warn-orange') || child.classList.contains('warn-yellow');
      arr.push({ text, isOut });
    });
    return arr;
  }
  const clcrResults = collectResults('clcrInfo');
  const elecResults = collectResults('elecInfo');
  const stoneResults = collectResults('stoneInfo');
  // Zbierz wyniki KT/V, jeśli są widoczne
  const ktvResults = [];
  // Pobierz elementy z wynikami KT/V. Są one widoczne tylko wtedy, gdy
  // użytkownik wypełni odpowiednie pola i włączy sekcję zaawansowanych
  // obliczeń KT/V. Orientacyjny KT/V (obliczany w uproszczony sposób)
  // został całkowicie usunięty z sekcji „Inne wskaźniki”, więc jedynymi
  // źródłami danych są kontenery #ktvResult i #ektvResult.
  const ktvElem1 = document.getElementById('ktvResult');
  const ktvElem2 = document.getElementById('ektvResult');
  [ktvElem1, ktvElem2].forEach(elem => {
    /*
     * Pobierz tekst z elementów KT/V niezależnie od ich właściwości display.
     * Wcześniej filtrowaliśmy elementy na podstawie style.display !== 'none',
     * co w niektórych przypadkach prowadziło do pominięcia wyników, gdy
     * styl był ustawiony przez zewnętrzny arkusz lub dynamicznie modyfikowany.
     * Teraz weryfikujemy jedynie, czy tekst nie jest pusty.
     */
    if (elem) {
      const text = elem.textContent.trim().replace(/\u00A0/g, ' ');
      if (text) {
        ktvResults.push({ text, isOut: false });
      }
    }
  });
  // Sprawdź, czy użytkownik życzy sobie dołączenia wyników KT/V do raportu.
  // Od teraz zaznaczenie pola "Uwzględnij wyniki KT/V w raporcie AI" odnosi się
  // wyłącznie do szczegółowych obliczeń z sekcji zaawansowanej, a nie do
  // orientacyjnego KT/V.
  const includeKtv = document.getElementById('includeKTV')?.checked;
  // sprawdź, czy biblioteka docx jest dostępna
  if (typeof docx !== 'undefined' && docx.Packer) {
    try {
      const { Document, Paragraph, Packer, TextRun, AlignmentType } = docx;
      const children = [];
      // nagłówek
      children.push(new Paragraph({
        children: [new TextRun({ text: 'Raport klirensu / eGFR', bold: true, size: 32 })],
        alignment: AlignmentType.CENTER,
        spacing: { after: 300 },
      }));
      // dane pacjenta
      children.push(new Paragraph({
        children: [new TextRun({ text: 'Dane pacjenta', bold: true, size: 28 })],
        spacing: { before: 200, after: 100 },
      }));
      patientLines.forEach(([label, value]) => {
        children.push(new Paragraph({
          children: [
            new TextRun({ text: label + ' ', bold: true }),
            new TextRun({ text: value }),
          ],
          spacing: { after: 50 },
        }));
      });
      // sekcje wyników
      function appendDocxSection(title, items) {
        if (!items || items.length === 0) return;
        children.push(new Paragraph({
          children: [new TextRun({ text: title, bold: true, size: 28 })],
          spacing: { before: 200, after: 100 },
        }));
        items.forEach(({ text, isOut }) => {
          children.push(new Paragraph({
            children: [new TextRun({ text: text, color: isOut ? 'C62828' : '000000' })],
            spacing: { after: 50 },
          }));
        });
      }
      appendDocxSection('Klirens / eGFR', clcrResults);
      appendDocxSection('Inne wskaźniki', elecResults);
      appendDocxSection('Ryzyko kamicy nerkowej', stoneResults);
      if (includeKtv) appendDocxSection('Wyniki KT/V', ktvResults);
      // utwórz dokument
      const doc = new Document({
        creator: 'Vilda Clinic',
        description: 'Raport wygenerowany przez kalkulator klirensu kreatyniny / eGFR',
        title: 'Raport klirensu / eGFR',
      });
      doc.addSection({ children });
      const blob = await Packer.toBlob(doc);
      const nameSlug = $('fullName').value.trim().replace(/\s+/g, '_');
      const filename = (nameSlug ? nameSlug + '_' : '') + 'Klirens_VildaClinic.docx';
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      return;
    } catch (e) {
      // jeśli wygenerowanie DOCX się nie powiedzie, przejdź do fallbacku
      console.error('DOCX generation failed, falling back to HTML', e);
    }
  }
  // fallback: wygeneruj prosty dokument HTML/RTF otwieralny w Wordzie
  const htmlParts = [];
  htmlParts.push('<h1 style="text-align:center;">Raport klirensu / eGFR</h1>');
  // dane pacjenta
  htmlParts.push('<h2>Dane pacjenta</h2>');
  patientLines.forEach(([label, value]) => {
    htmlParts.push(`<p><strong>${label}</strong> ${value}</p>`);
  });
  // sekcje wyników
  function appendHtmlSection(title, items) {
    if (!items || items.length === 0) return;
    htmlParts.push(`<h2>${title}</h2>`);
    items.forEach(({ text, isOut }) => {
      const style = isOut ? ' style="color:#c62828;"' : '';
      htmlParts.push(`<p${style}>${text}</p>`);
    });
  }
  appendHtmlSection('Klirens / eGFR', clcrResults);
  appendHtmlSection('Inne wskaźniki', elecResults);
  appendHtmlSection('Ryzyko kamicy nerkowej', stoneResults);
  if (includeKtv) appendHtmlSection('Wyniki KT/V', ktvResults);
  const htmlContent = `<html><head><meta charset="utf-8"><title>Raport</title></head><body>${htmlParts.join('')}</body></html>`;
  const fallbackBlob = new Blob([String.fromCharCode(0xFEFF) + htmlContent], { type: 'application/msword' });
  const nameSlug2 = $('fullName').value.trim().replace(/\s+/g, '_');
  const fallbackFilename = (nameSlug2 ? nameSlug2 + '_' : '') + 'Klirens_VildaClinic.doc';
  const fallbackUrl = URL.createObjectURL(fallbackBlob);
  const fallbackLink = document.createElement('a');
  fallbackLink.href = fallbackUrl;
  fallbackLink.download = fallbackFilename;
  document.body.appendChild(fallbackLink);
  fallbackLink.click();
  document.body.removeChild(fallbackLink);
  setTimeout(() => URL.revokeObjectURL(fallbackUrl), 1000);
});

/* ---------- 5.4c ZAPYTAJ AI (wysyłanie raportu do modelu językowego) ---------- */
// Ten przycisk tworzy streszczenie raportu i wysyła go do API ChatGPT, aby uzyskać interpretację.
// Aby skorzystać z tej funkcji, należy podać własny klucz API w zmiennej apiKey.
// Więcej informacji: https://platform.openai.com/docs/api-reference/chat/create
$('askAI').addEventListener('click', async () => {
  // Najpierw upewnij się, że wszystkie pola i wyniki są aktualne
  if (typeof update === 'function') update();
  // Zbuduj tekstowy raport na podstawie danych pacjenta i wyników
  const sexSelect = document.getElementById('sex');
  const sexText = sexSelect?.options[sexSelect.selectedIndex]?.text || '';
  const patientInfo = [];
  patientInfo.push(`Imię i nazwisko: ${($('fullName').value || '').trim() || '–'}`);
  patientInfo.push(`Wiek: ${$('age').value || '–'} lata`);
  patientInfo.push(`Płeć: ${sexText || '–'}`);
  patientInfo.push(`Masa: ${$('weight').value || '–'} kg`);
  patientInfo.push(`Wzrost: ${$('height').value || '–'} cm`);
  // Funkcja pomocnicza do zebrania wyników z kontenera
  function collectTexts(id) {
    const arr = [];
    const container = document.getElementById(id);
    if (!container || !container.children) return arr;
    Array.from(container.children).forEach(child => {
      arr.push(child.textContent.trim().replace(/\u00A0/g, ' '));
    });
    return arr;
  }
  // Zbierz wszystkie wyniki do raportu AI. Zawsze dołączamy wszystkie obliczone
  // sekcje: wyniki klirensu/eGFR, inne wskaźniki, ryzyko kamicy oraz KT/V (jeśli są obliczone).
  const clcrTexts = collectTexts('clcrInfo');
  const elecTexts = collectTexts('elecInfo');
  const stoneTexts = collectTexts('stoneInfo');
  const ktvTexts = [];
  const ktvElem1 = document.getElementById('ktvResult');
  const ktvElem2 = document.getElementById('ektvResult');
  /*
   * Zbierz treść wyników KT/V niezależnie od bieżącego stylu display.
   * Poprzednio sprawdzaliśmy tylko elementy, których style.display nie było "none".
   * Jednak w niektórych przeglądarkach style inline i style z arkusza mogą się różnić,
   * co powodowało pominięcie poprawnych wartości.  Teraz pobieramy tekst
   * z elementów zawsze, a pomijamy tylko puste treści.  Dzięki temu sekcja
   * „Wyniki KT/V” zostanie dołączona do raportu AI, jeśli checkbox
   * includeKTV jest zaznaczony i wyniki istnieją.
   */
  [ktvElem1, ktvElem2].forEach(elem => {
    if (elem) {
      const txt = elem.textContent.trim().replace(/\u00A0/g, ' ');
      if (txt) {
        ktvTexts.push(txt);
      }
    }
  });
  // Scal tekst raportu
  let report = 'Raport klirensu / eGFR\n\n';
  report += 'Dane pacjenta:\n' + patientInfo.join('\n') + '\n\n';
  if (clcrTexts.length > 0) {
    report += 'Klirens / eGFR:\n' + clcrTexts.join('\n') + '\n\n';
  }
  if (elecTexts.length > 0) {
    report += 'Inne wskaźniki:\n' + elecTexts.join('\n') + '\n\n';
  }
  if (stoneTexts.length > 0) {
    report += 'Ryzyko kamicy nerkowej:\n' + stoneTexts.join('\n') + '\n\n';
  }

          const includeKtv = document.getElementById('includeKTV')?.checked;
          if (includeKtv && ktvTexts.length > 0) {
            // Dołącz wyniki KT/V tylko wtedy, gdy użytkownik zaznaczył tę opcję.
            // Poszczególne linie oddzielamy znakami nowej linii, a na końcu
            // wstawiamy podwójną przerwę dla czytelności.
            report += 'Wyniki KT/V:\n' + ktvTexts.join('\n') + '\n\n';
          }
// Przygotuj treść zapytania do modelu językowego. Obejmuje ona rolę oraz prośbę o interpretację.
  const prompt = [
    'Jesteś asystentem medycznym, który interpretuje raporty laboratoryjne i obliczenia eGFR.',
    'Zinterpretuj następujący raport pacjenta. Podaj krótkie podsumowanie i ewentualne zalecenia:',
    report
  ].join('\n\n');
  const apiKey = '';
  // Jeżeli klucz API nie został ustawiony, przygotuj zapytanie do samodzielnego użycia przez użytkownika
  if (!apiKey) {
    try {
      // Spróbuj skopiować zapytanie do schowka, aby ułatwić wklejenie do ChatGPT
      await navigator.clipboard.writeText(prompt);
      alert('Przygotowano zapytanie do AI. Zostało ono skopiowane do schowka. Wklej je w ChatGPT, aby uzyskać interpretację wyników:\n\n' + prompt);
    } catch (e) {
      // Jeśli kopiowanie do schowka nie jest możliwe (np. z powodów bezpieczeństwa), wyświetl tekst do skopiowania ręcznie
      alert('Przygotowano zapytanie do AI. Z powodu ustawień przeglądarki nie można było automatycznie skopiować tekstu. Skopiuj poniższy tekst ręcznie i wklej go w ChatGPT, aby uzyskać interpretację wyników:\n\n' + prompt);
    }
    return;
  }
  // Jeśli klucz API jest skonfigurowany, wyślij zapytanie do OpenAI i pokaż interpretację.
  const apiUrl = 'https://api.openai.com/v1/chat/completions';
  const payload = {
    model: 'gpt-3.5-turbo',
    messages: [
      { role: 'system', content: 'Jesteś asystentem medycznym, który interpretuje raporty laboratoryjne i obliczenia eGFR.' },
      { role: 'user', content: 'Zinterpretuj następujący raport pacjenta. Podaj krótkie podsumowanie i ewentualne zalecenia:\n\n' + report }
    ],
    temperature: 0.4,
    max_tokens: 400
  };
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify(payload)
    });
    if (!response.ok) {
      throw new Error('Błąd zapytania API: ' + response.status);
    }
    const data = await response.json();
    const answer = data.choices?.[0]?.message?.content || 'Brak odpowiedzi.';
    // Pokaż interpretację w nowym oknie alert (lub w przyszłości w dedykowanym elemencie)
    alert('Interpretacja AI:\n\n' + answer);
  } catch (err) {
    console.error(err);
    alert('Wystąpił błąd podczas łączenia z API. Sprawdź konfigurację i połączenie internetowe.');
  }
});

/* ---------- 5.5 POKAŻ PRZYCISKI EKSPORTU PO WYNIKACH ---------- */
// Wcześniej status wyświetlania sekcji raportów (przyciski PDF/DOCX) oraz pola „Interpretacja AI”
// był uzależniony wyłącznie od widoczności karty #results.  W trybie zaawansowanym lub
// profesjonalnym część wyników może się pojawiać wyłącznie w innych kartach, np.
// #elecCard (Inne wskaźniki), #stoneCard (Ryzyko kamicy nerkowej) albo w polach z wynikiem
// KT/V (#ktvResult, #ektvResult).  Jeśli #results pozostawał ukryty, poprzednia logika
// pozostawiała przyciski i pole AI w stanie ukrytym, mimo że użytkownik widział wyniki.
// Aby zapewnić poprawne działanie, sprawdzamy widoczność wszystkich kart z wynikami.
const observer = new MutationObserver(() => {
  // sprawdź, czy choć jedna karta wyników jest widoczna.  W razie dodania nowych
  // kart w przyszłości można je tutaj dopisać.
  const resVisible   = $('results')   && $('results').style.display   !== 'none';
  const elecVisible  = $('elecCard')  && $('elecCard').style.display  !== 'none';
  const stoneVisible = $('stoneCard') && $('stoneCard').style.display !== 'none';
  // Kontenery z wynikiem KT/V nie mają własnego tła ani obramowania kart, jednak
  // korzystają z właściwości style.display, dzięki czemu możemy na tej podstawie
  // określić ich widoczność.  Jeżeli którykolwiek z nich jest widoczny, uznajemy,
  // że obliczenia są gotowe i powinny być dostępne raporty oraz AI.
  const ktvVisible   = (document.getElementById('ktvResult')  && document.getElementById('ktvResult').style.display  !== 'none') ||
                       (document.getElementById('ektvResult') && document.getElementById('ektvResult').style.display !== 'none');
  // Brak widocznych wyników → ukryj przyciski i sekcję AI; w przeciwnym razie pokaż
  const hidden = !(resVisible || elecVisible || stoneVisible || ktvVisible);
  $('downloadPDF').style.display  = hidden ? 'none' : 'block';
  $('downloadDOCX').style.display = hidden ? 'none' : 'block';
  const aiFieldset = document.getElementById('aiFieldset');
  if (aiFieldset) aiFieldset.hidden = hidden;
});
// Obserwuj zmiany widoczności wszystkich kart z wynikami.  Dodajemy stoneCard
// oraz kontenery KT/V, aby callback był wywoływany również przy zmianie tych pól.
['results', 'elecCard', 'stoneCard'].forEach(id => {
  const el = $(id);
  if (el) observer.observe(el, { attributes: true, attributeFilter: ['style'] });
});
['ktvResult','ektvResult'].forEach(id => {
  const el = document.getElementById(id);
  if (el) observer.observe(el, { attributes: true, attributeFilter: ['style'] });
});
  /* ---------- FUNKCJA RESETUJĄCA APLIKACJĘ ---------- */
  /**
   * Resetuje formularz, czyści wyniki i komunikaty.
   * @param {boolean} keepFormula – jeśli true, zachowuje aktualny wybór w selektorze formuł
   */
  function resetApp(keepFormula = true) {
    const form = document.getElementById('clcrForm');
    const sel = document.getElementById('formulaPicker');
    const currentFormula = (keepFormula && sel) ? sel.value : '';

    // Reset formularza do stanu początkowego
    if (form) form.reset();

    // 🔹 NOWE: pełny reset modułu formuł + wersji + ukrycie przycisku czyszczenia
    if (!keepFormula) {
      // (1) wyczyść i schowaj podpowiedź pod selektorem formuły
      const noteEl = document.getElementById('formulaNote');
      if (noteEl) { noteEl.textContent = ''; noteEl.style.display = 'none'; }

      // (2) wróć do placeholdera w selektorze formuł
      if (sel) sel.value = '';

      // (3) odznacz aktualnie wybraną wersję kalkulatora i zwiń parametry
      const selectedVersion = document.querySelector('.version-option.selected');
      if (selectedVersion) {
        // uruchamia istniejącą gałąź „deselect” (zwija .param-row, chowa wyniki itd.)
        selectedVersion.click();
      } else {
        const pr = document.querySelector('.param-row');
        if (pr) pr.style.display = 'none';
        window.currentVersion = '';
      }

      // (4) upewnij się, że karta KT/V jest schowana
      const ktvCard = document.getElementById('ktvCard');
      if (ktvCard) ktvCard.style.display = 'none';

      // (5) natychmiast schowaj przycisk „Wyczyść wszystkie pola”
      const clearContainer = document.getElementById('clearContainer');
      if (clearContainer) clearContainer.style.display = 'none';
    }
    
    // Przywróć wybór formuły, jeśli ma zostać zachowany
    if (keepFormula && sel) sel.value = currentFormula;

    // Wyczyść pola tylko-do-odczytu (np. ACR)
    const acrField = document.getElementById('U_ACR');
    if (acrField) acrField.value = '';

    // Usuń komunikaty walidacyjne i klasy styli (błędy, podświetlenia itp.)
    document.querySelectorAll('.validation-message').forEach(div => { div.textContent = ''; });
    document.querySelectorAll('#clcrForm input, #clcrForm select').forEach(inp => {
      inp.classList.remove('error', 'is-filled', 'must-fill');
    });

    // Schowaj wszystkie karty z wynikami i wyczyść treści
    ['results', 'elecCard', 'stoneCard'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    ['clcrInfo', 'elecInfo'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = '';
    });
    // Kontenery wyników KT/V
    ['ktvResult', 'ektvResult'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });

    // Wyczyść nagłówek z imieniem i nazwiskiem
    const patientNameEl = document.getElementById('patientName');
    if (patientNameEl) patientNameEl.textContent = '';

    // Przywróć domyślny stan sekcji KT/V
    const advToggle = document.getElementById('ktvToggle');
    const advBox = document.getElementById('ktvFields');
    if (advToggle) advToggle.checked = false;
    if (advBox) advBox.style.display = 'none';

    // Wyczyść live‑listę i filtr formuł
    const live = document.getElementById('formulaLive');
    if (live) { live.style.display = 'none'; live.innerHTML = ''; }
    const searchInput = document.getElementById('formulaSearch');
    if (searchInput) searchInput.value = '';

    // Przelicz interfejs po resecie (ukryje przyciski eksportu/AI via observer)
    if (typeof window.update === 'function') window.update();

    // Dla przejrzystości przewiń do formularza
    try { if (form) form.scrollIntoView({ behavior: 'smooth' }); } catch (e) { }
  }
  /* ---------- 5.6 PRZYCISK CZYSZCZENIA FORMULARZA ---------- */
  // Po załadowaniu skryptu dodajemy obsługę zdarzenia kliknięcia dla
  // przycisku „Wyczyść wszystkie pola”.  Akcja resetuje cały formularz,
  // usuwa komunikaty walidacyjne, ukrywa wyniki oraz przywraca domyślne
  // ustawienia sekcji zaawansowanej KT/V.  Przy pierwszym uruchomieniu
  // przycisk jest ukryty i pojawia się dopiero po wprowadzeniu
  // minimalnych danych (obsługa w funkcji update()).
  const clearBtn = document.getElementById('clearBtn');
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        // schowaj przycisk od razu po kliknięciu (bez migotania)
        const clearContainer = document.getElementById('clearContainer');
        if (clearContainer) clearContainer.style.display = 'none';
        // wykonaj pełny reset
        resetApp(false);
      });
    }
</script>

<!-- Moduł obsługi kliknięć listy dynamicznych wyników wyszukiwania -->
<script>
// Ten moduł nasłuchuje kliknięć na elementach listy wyników wyświetlanej pod filtrem
// wyszukiwania formuł. Pozwala wybrać formułę bez konieczności zamykania listy rozwijanej.
document.addEventListener('DOMContentLoaded', function() {
  const liveList = document.getElementById('formulaLive');
  if (!liveList) return;
  liveList.addEventListener('click', function(evt) {
    const item = evt.target.closest('.fl-item');
    if (!item) return;
    const id = item.getAttribute('data-id');
    if (!id) return;
    // ustaw nową wartość w głównym selektorze
    const selectEl = document.getElementById('formulaPicker');
    if (selectEl) selectEl.value = id;
    // zresetuj pole wyszukiwania
    const searchInput = document.getElementById('formulaSearch');
    if (searchInput) searchInput.value = '';
    // przywróć pełną listę kategorii (bez filtra)
    if (typeof renderFormulaOptions === 'function') {
      renderFormulaOptions('');
    }
    // ukryj dynamiczną listę
    liveList.style.display = 'none';
    liveList.innerHTML = '';
    // uruchom standardową obsługę zmiany poprzez wywołanie zdarzenia 'change' na selektorze
    // dispatchujemy zdarzenie 'change', aby zadziałał nasłuch przypisany w DOMContentLoaded
    if (selectEl) {
      const evt = new Event('change', { bubbles: true });
      selectEl.dispatchEvent(evt);
    }
  });
});
</script>

<!-- 6. INFO BUTTONS: automatyczne dodawanie przycisków „Info” oraz dymków narzędziowych -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ------- 3.1 AUTOMATYCZNE DODAWANIE PRZYCISKU INFO (jeśli go brak) ------- */
  document.querySelectorAll('input[id], select[id]').forEach(field => {
    // pomiń, jeśli już przerobione lub brak rodzica
    if (field.parentElement && field.parentElement.classList.contains('input-group')) return;

    const label = field.closest('label');
    if (!label) return;
    // Skip placeholder rows entirely – these labels are only used to
    // maintain equal row heights and should never produce a visible
    // input-group wrapper.  Without this guard, the wrapper would
    // unhide the underlying input and create unlabeled fields.
    if (label.classList.contains('placeholder-row')) return;

    /* utwórz kontener .input-group */
    const wrapper = document.createElement('div');
    wrapper.className = 'input-group';

    // wstaw wrapper tuż po label (zachowuje semantykę)
    label.insertAdjacentElement('afterend', wrapper);
    wrapper.appendChild(field);
    // Jeżeli pole jest typu checkbox, umożliwiamy zawijanie przycisku Info pod polem,
    // aby zapobiec wychodzeniu przycisku poza kontener w widoku poziomym.
    if (field.type === 'checkbox') {
      wrapper.classList.add('wrap-info');
      // For specific checkbox fields we want the Info button centered relative to
      // the control. Add a special marker class so CSS can target these wrappers.
      if (field.id === 'ktvToggle' || field.id === 'includeKTV') {
        wrapper.classList.add('center-info');
      }
    }

    /* przycisk Info */
    const btn = document.createElement('button');
    btn.type  = 'button';
    btn.className = 'info-btn';
    btn.textContent = 'Info';
    const tipId = 'tip-' + field.id;
    btn.setAttribute('aria-controls', tipId);
    btn.setAttribute('aria-expanded','false');
    wrapper.appendChild(btn);

    /* tooltip */
    const tooltip = document.createElement('div');
    tooltip.id = tipId;
    tooltip.className = 'tooltip';
    tooltip.setAttribute('role','tooltip');
    tooltip.setAttribute('aria-hidden','true');

    /* treść: z data-info albo z globalnej tablicy infoTexts */
    const customText = field.dataset.info ||
                       (typeof infoTexts === 'object' ? infoTexts[field.id] : '');
    tooltip.textContent = customText || 'Brak opisu.';
    wrapper.appendChild(tooltip);
  });

  /* ------- 3.2 OBSŁUGA PRZYCISKÓW ------- */
  const hideAllTips = () => {
    document.querySelectorAll('.tooltip.visible').forEach(tip => {
      tip.classList.remove('visible');
      tip.setAttribute('aria-hidden','true');
      const btn = document.querySelector(`[aria-controls="${tip.id}"]`);
      if (btn) btn.setAttribute('aria-expanded','false');
    });
  };

  document.addEventListener('click', e => {
    const btn = e.target.closest('.info-btn');
    if (!btn){
      hideAllTips();               /* kliknięcie poza – zamknij */
      return;
    }

    /* kliknięto przycisk Info */
    const tipId    = btn.getAttribute('aria-controls');
    const tooltip  = document.getElementById(tipId);
    if (!tooltip) return;

    const isOpen = tooltip.classList.contains('visible');
    hideAllTips();
    if (!isOpen){
      tooltip.classList.add('visible');
      tooltip.setAttribute('aria-hidden','false');
      btn.setAttribute('aria-expanded','true');
    }
  });

  /* klawisz Esc zamyka dymki */
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') hideAllTips();
  });
});
</script>

<!-- Script: version selection and dynamic form handling -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const paramRow = document.querySelector('.param-row');
  const ktvCard = document.getElementById('ktvCard');
  // Ensure param row and KT/V card are hidden initially
  if (paramRow) paramRow.style.display = 'none';
  if (ktvCard) ktvCard.style.display = 'none';
  const versionOptions = document.querySelectorAll('.version-option');

      // === SPOT SPLIT HELPERS — split spotSet across two columns in 'spot' mode ===
      function ensureSpotSetRight() {
        const rightCol = document.querySelector('#clcrForm > .param-row > .param-col:nth-child(2)');
        if (!rightCol) return null;
        let fs = document.getElementById('spotSetRight');
        if (!fs) {
          fs = document.createElement('fieldset');
          fs.id = 'spotSetRight';
          fs.className = 'advanced-field pro-field';
          const lg = document.createElement('legend');
          lg.textContent = 'Parametry z próbki moczu (cd.)';
          fs.appendChild(lg);
          rightCol.appendChild(fs);
        }
        return fs;
      }
      function moveSpotPairTo(ctrlId, targetFieldset) {
        const ctrl = document.getElementById(ctrlId);
        if (!ctrl || !targetFieldset) return;
        const wrapper = ctrl.closest('.input-group');
        let label = null;
        if (wrapper) label = wrapper.previousElementSibling;
        else label = ctrl.closest('label');
        if (label && label.parentElement !== targetFieldset) targetFieldset.appendChild(label);
        if (wrapper && wrapper.parentElement !== targetFieldset) targetFieldset.appendChild(wrapper);
        else if (!wrapper && ctrl.parentElement !== targetFieldset) targetFieldset.appendChild(ctrl);
      }
      function splitSpotIntoTwoColumns() {
        const leftFs  = document.getElementById('spotSet');
        const rightFs = ensureSpotSetRight();
        if (!leftFs || !rightFs) return;
        const rightIds = [
          'Ox_Cr_spot','Cit_Cr_spot',
          'U_PO4_spot','U_PO4_spot_unit',
          'S_PO4_spot','S_PO4_spot_unit',
          'Scr_spot','Scr_spot_unit'
        ];
        rightIds.forEach(id => moveSpotPairTo(id, rightFs));
      }
      function restoreSpotToLeft() {
        const leftFs  = document.getElementById('spotSet');
        const rightFs = document.getElementById('spotSetRight');
        if (!leftFs) return;
        const fullOrder = [
          'Ucr_spot','Ucr_spot_unit','U_Alb','U_ACR','Ca_spot','Ca_spot_unit','U_pH',
          'Ox_Cr_spot','Cit_Cr_spot','U_PO4_spot','U_PO4_spot_unit',
          'S_PO4_spot','S_PO4_spot_unit','Scr_spot','Scr_spot_unit'
        ];
        fullOrder.forEach(id => moveSpotPairTo(id, leftFs));
        if (rightFs && rightFs.parentElement) rightFs.parentElement.removeChild(rightFs);
      }
  function applyVersion(version) {
    // Persist the chosen version on the global object so that update()
    // can tailor the displayed results accordingly.  Without this the
    // update() routine has no knowledge of the user’s version choice.
    window.currentVersion = version;
    // Preserve unit selects to avoid losing default values when switching modes
    const preservedUnits = {};
    ['ScrUnit','S_PO4_unit'].forEach(id => {
      const el = document.getElementById(id);
      if (el) preservedUnits[id] = el.value;
    });
    // Highlight selected option
    versionOptions.forEach(el => {
      el.classList.toggle('selected', el.dataset.version === version);
    });
    // Always show param row when a version is chosen
    if (paramRow) paramRow.style.display = '';
    // Show/hide advanced fields
    const advFields = document.querySelectorAll('.advanced-field');
    if (version === 'basic') {
      // Upewnij się, że sekcje surowicy i dobowej zbiórki moczu są widoczne po powrocie z trybu próbki
      const serumSetEl_basic = document.getElementById('serumSet');
      const dzmSetEl_basic   = document.getElementById('dzmSet');
      if (serumSetEl_basic) serumSetEl_basic.style.display = '';
      if (dzmSetEl_basic)   dzmSetEl_basic.style.display   = '';

      // Always restore spot layout when leaving spot mode
      restoreSpotToLeft();
      advFields.forEach(el => {
        // Hide the advanced element itself
        el.style.display = 'none';
        // If this element is a label followed by an input-group wrapper, hide the wrapper too
        const next = el.nextElementSibling;
        if (next && next.classList && next.classList.contains('input-group')) {
          next.style.display = 'none';
          // Clear values in inputs/selects inside the wrapper
          next.querySelectorAll('input, select').forEach(inp => {
            // Nie usuwaj jednostek kreatyniny (ScrUnit), wapnia w surowicy (S_Ca_unit),
            // fosforanów w surowicy (S_PO4_unit) ani wapnia z próbki (Ca_spot_unit) podczas czyszczenia
            if (inp && inp.id && (inp.id === 'ScrUnit' || inp.id === 'Ca_spot_unit' || inp.id === 'Ucr_spot_unit'
               || inp.id === 'S_Ca_unit' || inp.id === 'S_PO4_unit' || inp.id === 'U_PO4_spot_unit')) return;
            inp.value = '';
          });
        } else {
          // Clear values of any inputs/selects inside the advanced element
        el.querySelectorAll('input, select').forEach(inp => {
          if (inp && inp.id && (inp.id === 'ScrUnit' || inp.id === 'Ca_spot_unit' || inp.id === 'Ucr_spot_unit'
             || inp.id === 'S_Ca_unit' || inp.id === 'S_PO4_unit' || inp.id === 'U_PO4_spot_unit')) return;
          inp.value = '';
        });
        }
      });
      // When using the basic version, also hide the results card for other indicators
      const elecCardEl = document.getElementById('elecCard');
      const elecInfoEl = document.getElementById('elecInfo');
      if (elecCardEl) elecCardEl.style.display = 'none';
      if (elecInfoEl) elecInfoEl.innerHTML = '';

      // Additionally hide any KT/V result boxes when using the basic version.
      // These elements may persist if they were previously shown in advanced
      // mode. Clearing them here ensures they stay hidden when the user
      // switches back to the basic calculator.
      const ktvResEl  = document.getElementById('ktvResult');
      const ektvResEl = document.getElementById('ektvResult');
      if (ktvResEl)  ktvResEl.style.display  = 'none';
      if (ektvResEl) ektvResEl.style.display = 'none';
    } else if (version === 'advanced') {
      // Przywróć widoczność sekcji surowicy i dobowej zbiórki moczu (jeśli ukryto w trybie próbki)
      const serumSetEl_adv = document.getElementById('serumSet');
      const dzmSetEl_adv   = document.getElementById('dzmSet');
      if (serumSetEl_adv) serumSetEl_adv.style.display = '';
      if (dzmSetEl_adv)   dzmSetEl_adv.style.display   = '';

      // Always restore spot layout when leaving spot mode
      restoreSpotToLeft();
      // Show all advanced fields except those reserved exclusively for the
      // profesjonalny tryb (oznaczone klasą pro-field) oraz kartę KT/V.
      // Dzięki temu kalkulator zaawansowany udostępnia dodatkowe pola
      // elektrolitowe, ale ukrywa elementy dostępne tylko w wersji pro.
      advFields.forEach(el => {
        // Determine if the element belongs to a pro‑only field or is a placeholder row.
        const isProOrPlaceholder = (el.id === 'ktvCard' || el.classList.contains('pro-field') || el.classList.contains('placeholder-row'));
        if (isProOrPlaceholder) {
          // Hide the label itself
          el.style.display = 'none';
          // Clear any values inside this element, zachowując wybrane jednostki
          el.querySelectorAll('input, select').forEach(inp => {
            // Nie czyść wyboru jednostki dla kreatyniny w surowicy, wapnia w surowicy,
            // fosforanów w surowicy, wapnia w próbce ani kreatyniny w próbce moczu
            if (inp && inp.id && (inp.id === 'ScrUnit' || inp.id === 'Ca_spot_unit' || inp.id === 'Ucr_spot_unit'
               || inp.id === 'S_Ca_unit' || inp.id === 'S_PO4_unit' || inp.id === 'U_PO4_spot_unit')) return;
            inp.value = '';
          });
        } else {
          el.style.display = '';
        }
        const next = el.nextElementSibling;
        if (next && next.classList && next.classList.contains('input-group')) {
          // Hide the wrapper for pro‑only fields and placeholder rows; otherwise show it
          next.style.display = isProOrPlaceholder ? 'none' : '';
          if (isProOrPlaceholder) {
            next.querySelectorAll('input, select').forEach(inp => {
          if (inp && inp.id && (inp.id === 'ScrUnit' || inp.id === 'Ca_spot_unit' || inp.id === 'Ucr_spot_unit'
             || inp.id === 'S_Ca_unit' || inp.id === 'S_PO4_unit' || inp.id === 'U_PO4_spot_unit')) return;
              inp.value = '';
            });
          }
        }
      });
      // Hide any KT/V result boxes when in the advanced version.  These may
      // have been populated during a prior professional session and
      // therefore must be cleared explicitly.
      const ktvResEl  = document.getElementById('ktvResult');
      const ektvResEl = document.getElementById('ektvResult');
      if (ktvResEl)  ktvResEl.style.display  = 'none';
      if (ektvResEl) ektvResEl.style.display = 'none';
      // In advanced mode, the results card can be displayed based on available results (update() will control visibility)
    } else if (version === 'spot') {
      // Wersja „Obliczenia z próbki moczu”: ukryj sekcje surowicy i dobowej zbiórki moczu,
      // pozostawiając jedynie pola w sekcji próbki moczu.  Wyczyść wartości w ukrytych
      // sekcjach, aby nie wpływały na obliczenia.  Zablokuj również KT/V.
      const serumSetEl = document.getElementById('serumSet');
      const dzmSetEl   = document.getElementById('dzmSet');
      if (serumSetEl) {
        serumSetEl.style.display = 'none';
        // Czyść pola sekcji surowicy, ale zachowaj wartość jednostki kreatyniny w surowicy
        serumSetEl.querySelectorAll('input, select').forEach(inp => {
          // Zachowaj wybrane jednostki dla kreatyniny w surowicy oraz
          // wapnia i fosforanów w surowicy.  Te wartości przydadzą się po
          // powrocie z trybu próbki moczu.
          if (inp && inp.id && (inp.id === 'ScrUnit' || inp.id === 'S_Ca_unit' || inp.id === 'S_PO4_unit')) return;
          inp.value = '';
        });
      }
      if (dzmSetEl) {
        dzmSetEl.style.display = 'none';
        dzmSetEl.querySelectorAll('input, select').forEach(inp => { inp.value = ''; });
      }
      advFields.forEach(el => {
        const isKtvOrPlaceholder = (el.id === 'ktvCard' || el.classList.contains('placeholder-row'));
        // Determine if this advanced element belongs to the spot section
        const inSpotSection = el.closest('#spotSet') || el.closest('#spotSetRight');
        if (isKtvOrPlaceholder) {
          el.style.display = 'none';
          // Czyść wartości w KTV/placeholderach, zachowując jednostki
          el.querySelectorAll('input, select').forEach(inp => {
            if (inp && inp.id && (inp.id === 'ScrUnit' || inp.id === 'Ca_spot_unit' || inp.id === 'Ucr_spot_unit'
               || inp.id === 'S_Ca_unit' || inp.id === 'S_PO4_unit' || inp.id === 'U_PO4_spot_unit')) return;
            inp.value = '';
          });
        } else if (inSpotSection) {
          // W sekcji próbkowej pokazujemy wszystkie pola zaawansowane (także pro‑field)
          el.style.display = '';
        } else {
          // Dla pozostałych pól ukrywamy je i czyścimy ich wartości
          el.style.display = 'none';
          el.querySelectorAll('input, select').forEach(inp => {
            if (inp && inp.id && (inp.id === 'ScrUnit' || inp.id === 'Ca_spot_unit' || inp.id === 'Ucr_spot_unit'
               || inp.id === 'S_Ca_unit' || inp.id === 'S_PO4_unit' || inp.id === 'U_PO4_spot_unit')) return;
            inp.value = '';
          });
        }
        const next = el.nextElementSibling;
        if (next && next.classList && next.classList.contains('input-group')) {
          if (isKtvOrPlaceholder) {
            next.style.display = 'none';
            next.querySelectorAll('input, select').forEach(inp => {
              if (inp && inp.id && (inp.id === 'ScrUnit' || inp.id === 'Ca_spot_unit' || inp.id === 'Ucr_spot_unit'
                 || inp.id === 'S_Ca_unit' || inp.id === 'S_PO4_unit' || inp.id === 'U_PO4_spot_unit')) return;
              inp.value = '';
            });
          } else if (inSpotSection) {
            next.style.display = '';
          } else {
            next.style.display = 'none';
            next.querySelectorAll('input, select').forEach(inp => {
              if (inp && inp.id && (inp.id === 'ScrUnit' || inp.id === 'Ca_spot_unit' || inp.id === 'Ucr_spot_unit'
                 || inp.id === 'S_Ca_unit' || inp.id === 'S_PO4_unit' || inp.id === 'U_PO4_spot_unit')) return;
              inp.value = '';
            });
          }
        }
      });
      // For spot version, split spotSet across two columns
      splitSpotIntoTwoColumns();
      // Ukryj wyniki KT/V (jak w trybie zaawansowanym)
      const ktvResEl  = document.getElementById('ktvResult');
      const ektvResEl = document.getElementById('ektvResult');
      if (ktvResEl)  ktvResEl.style.display  = 'none';
      if (ektvResEl) ektvResEl.style.display = 'none';
      // In version „spot”, the update() will decide which results to display
    } else if (version === 'pro') {
      // W trybie profesjonalnym również pokazujemy sekcje surowicy i dobowej zbiórki moczu
      const serumSetEl_pro = document.getElementById('serumSet');
      const dzmSetEl_pro   = document.getElementById('dzmSet');
      if (serumSetEl_pro) serumSetEl_pro.style.display = '';
      if (dzmSetEl_pro)   dzmSetEl_pro.style.display   = '';

      // Always restore spot layout when leaving spot mode
      restoreSpotToLeft();
      // In the professional version all advanced fields should be visible
      // except for placeholder rows, which serve purely as spacers.  Show
      // the KT/V card and all pro‑specific fields, but hide the placeholder
      // labels and their wrappers.
      advFields.forEach(el => {
        const isPlaceholder = el.classList.contains('placeholder-row');
        if (isPlaceholder) {
          // Placeholder rows serve only as visual spacers and should remain hidden
          el.style.display = 'none';
        } else {
          // Show all other advanced fields in professional mode
          el.style.display = '';
        }
        const next = el.nextElementSibling;
        if (next && next.classList && next.classList.contains('input-group')) {
          next.style.display = isPlaceholder ? 'none' : '';
        }
      });

      /*
       * W trybie profesjonalnym karta „Ryzyko kamicy nerkowej” (stoneCard)
       * nie powinna być domyślnie wyświetlana, jeżeli użytkownik
       * nie wprowadził jeszcze żadnych danych.  W poprzedniej
       * implementacji element otrzymywał display:"" wraz z innymi
       * polami zaawansowanymi, co skutkowało pustą kartą na dole
       * formularza zaraz po wyborze wersji pro.  Ukrywamy ją tutaj,
       * aby update() mógł później samodzielnie zdecydować, czy
       * wyświetlić kartę na podstawie obecności wyników (stoneHtml
       * lub shtml).
       */
      const stoneCardEl_pro = document.getElementById('stoneCard');
      if (stoneCardEl_pro) {
        stoneCardEl_pro.style.display = 'none';
      }
    } else {
      // Unknown or not-yet-supported version.  For forward compatibility we
      // retain the previous behaviour of notifying the user about the
      // professional version’s unavailability and aborting the switch.
      alert('Wersja profesjonalna będzie dostępna w przyszłości.');
      return;
    }
    // Restore preserved unit values after clearing operations
    if (preservedUnits) {
      ['ScrUnit','S_PO4_unit'].forEach(id => {
        const el = document.getElementById(id);
        if (el && preservedUnits[id]) {
          el.value = preservedUnits[id];
        }
      });
    }
    // Trigger recalculation of results
    if (typeof update === 'function') update();
  }
  versionOptions.forEach(el => {
    el.addEventListener('click', () => {
      // Ignore clicks on disabled options
      if (el.classList.contains('disabled')) return;

      /*
       * Jeśli użytkownik kliknie ponownie w już wybraną wersję kalkulatora,
       * przycisk zostanie odznaczony, a sekcja z parametrami oraz
       * dotychczasowe wyniki zostaną zwinięte.  Dzięki temu możliwe jest
       * szybkie schowanie formularza i rozpoczęcie wyboru innej wersji.
       */
      if (el.classList.contains('selected')) {
        // Restore spot layout when deselecting a version
        restoreSpotToLeft();
        // usuń wyróżnienie ze wszystkich opcji
        versionOptions.forEach(opt => opt.classList.remove('selected'));
        // schowaj wiersz parametrów
        const pr = document.querySelector('.param-row');
        if (pr) pr.style.display = 'none';
        // ukryj również kartę wyniku klirensu/egfr
        const resultsCard = document.getElementById('results');
        if (resultsCard) resultsCard.style.display = 'none';
        const elecCard = document.getElementById('elecCard');
        if (elecCard) elecCard.style.display = 'none';
        const stoneCard = document.getElementById('stoneCard');
        if (stoneCard) stoneCard.style.display = 'none';
        // ukryj wyniki KT/V jeśli widoczne
        const ktvResEl  = document.getElementById('ktvResult');
        const ektvResEl = document.getElementById('ektvResult');
        if (ktvResEl)  ktvResEl.style.display  = 'none';
        if (ektvResEl) ektvResEl.style.display = 'none';
        // schowaj przyciski pobierania raportów
        const pdfBtn  = document.getElementById('downloadPDF');
        const docBtn  = document.getElementById('downloadDOCX');
        if (pdfBtn) pdfBtn.style.display = 'none';
        if (docBtn) docBtn.style.display = 'none';
        // wyczyść kontenery z wynikami
        const clcrInfoEl  = document.getElementById('clcrInfo');
        const elecInfoEl  = document.getElementById('elecInfo');
        const stoneInfoEl = document.getElementById('stoneInfo');
        if (clcrInfoEl)  clcrInfoEl.innerHTML  = '';
        if (elecInfoEl)  elecInfoEl.innerHTML  = '';
        if (stoneInfoEl) stoneInfoEl.innerHTML = '';
        // zresetuj aktualną wersję na wartość pustą
        window.currentVersion = '';
        // nie wywołuj applyVersion ponownie
        return;
      }

      /*
       * Provide subtle haptic feedback on devices that support the
       * Vibration API.  When a user selects one of the calculator
       * versions (basic, advanced or professional) on a touchscreen
       * smartphone, the device will vibrate briefly to acknowledge the
       * selection.  The check for navigator.vibrate ensures that the
       * method exists before calling it, avoiding errors on desktop
       * browsers.  A vibration pattern of ~30 ms is short enough
       * to feel responsive without being distracting.  On devices
       * without vibration support the call is silently ignored.
       */
      if (typeof navigator !== 'undefined' && typeof navigator.vibrate === 'function') {
        try {
          navigator.vibrate(30);
        } catch (err) {
          // Some browsers may throw if vibration is not allowed; fail silently
        }
      }

      const version = el.dataset.version;
      applyVersion(version);
    });
  });
});
</script>

<!-- Service worker registration for Progressive Web App functionality -->
<!-- Logika banera instalacyjnego PWA.  Ten skrypt nasłuchuje zdarzenia
     `beforeinstallprompt`, wyświetla pasek instalacyjny i wywołuje prompt
     instalacyjny po kliknięciu. Zapamiętuje decyzję użytkownika w
     localStorage, aby baner nie pojawiał się ponownie. -->
<script>
  (function() {
    let deferredPrompt;
    const banner = document.getElementById('pwaInstallBanner');
    const installBtn = document.getElementById('pwaInstallButton');
    const dismissBtn = document.getElementById('pwaDismissButton');

    // Jeśli użytkownik już podjął decyzję (zainstalował lub odrzucił), nie
    // pokazujemy banera.
    const savedDecision = (typeof localStorage !== 'undefined') ? localStorage.getItem('pwaInstallDecision') : null;
    if (savedDecision && banner) {
      banner.style.display = 'none';
    }

    window.addEventListener('beforeinstallprompt', function(e) {
      // Jeśli wcześniej zapisano decyzję, nie wyświetlamy ponownie.
      if (typeof localStorage !== 'undefined' && localStorage.getItem('pwaInstallDecision')) {
        return;
      }
      // Zapobiegamy automatycznemu pojawieniu się wbudowanego banera i
      // przechowujemy wydarzenie do późniejszego użycia.
      e.preventDefault();
      deferredPrompt = e;
      if (banner) {
        banner.style.display = 'flex';
      }
    });

    if (installBtn) {
      installBtn.addEventListener('click', async function() {
        if (!deferredPrompt) {
          return;
        }
        // Wywołaj wbudowany prompt instalacyjny
        deferredPrompt.prompt();
        try {
          const { outcome } = await deferredPrompt.userChoice;
          if (typeof localStorage !== 'undefined') {
            if (outcome === 'accepted') {
              localStorage.setItem('pwaInstallDecision', 'installed');
            } else {
              localStorage.setItem('pwaInstallDecision', 'dismissed');
            }
          }
        } finally {
          deferredPrompt = null;
          if (banner) {
            banner.style.display = 'none';
          }
        }
      });
    }

    if (dismissBtn) {
      dismissBtn.addEventListener('click', function() {
        if (typeof localStorage !== 'undefined') {
          localStorage.setItem('pwaInstallDecision', 'dismissed');
        }
        if (banner) {
          banner.style.display = 'none';
        }
      });
    }

    // Nasłuchujemy zdarzenia instalacji PWA (np. gdy użytkownik zainstaluje
    // aplikację z menu przeglądarki). Po instalacji ukrywamy baner.
    window.addEventListener('appinstalled', function() {
      if (typeof localStorage !== 'undefined') {
        localStorage.setItem('pwaInstallDecision', 'installed');
      }
      if (banner) {
        banner.style.display = 'none';
      }
    });
  })();
</script>

<script>
  if ('serviceWorker' in navigator) {
    // Register the Workbox-based service worker once the page has loaded.
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js').catch(function(err) {
        console.warn('ServiceWorker registration failed:', err);
      });
    });
  }
</script>
</body>
</html>
