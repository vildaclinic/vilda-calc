
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<title>Kalkulator klirensu kreatyniny – Vilda Clinic</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- Manifest and PWA meta -->
    <!-- Link to the web app manifest so browsers know how to install the app. -->
    <link rel="manifest" href="manifest.json">
    <!-- Ikony Apple w wielu rozmiarach; iOS użyje odpowiedniego rozmiaru w zależności od urządzenia -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/icon-120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="icons/icon-76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72.png">
    <link rel="apple-touch-icon" sizes="57x57" href="icons/icon-57.png">

<!-- 1. IDENTYCZNA SZATA GRAFICZNA -->
<style>
:root {
  --primary: #00838d;
  --secondary: #00b0a6;
  --bg: #ffffff;
  --card: #f5f9f9;
  --text: #333;
  --radius: 8px;
  --shadow: 0 2px 6px rgba(0,0,0,.08);
  --danger: #c62828;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  background: var(--bg);
  color: var(--text);
}
header {
  background: var(--primary);
  color: #fff;
  text-align: center;
  padding: 1rem;
}
h1 { margin: 0; font-size: clamp(1.4rem,3vw,2rem); }
.container { max-width: 960px; margin-inline: auto; padding: 1rem; }
fieldset {
  border: 1px solid #d0dede;
  background: var(--card);
  padding: 1.4rem 1rem 1rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 1.5rem;
  position: relative;
}
legend {
  font-weight: 600;
  color: var(--primary);
  background: var(--card);
  padding: 0 .6rem;
  font-size: 1rem;
  position: absolute;
  top: -0.7rem;
  left: 0;
}
label {
  display: block;
  margin-top: 0.7rem;
  font-size: 0.95rem;
}
input, select, option {
  font-family: system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  width: 100%;
  padding: 0.45rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1rem;
}

/*
 * The native select element can render slightly shorter than text inputs on some
 * platforms because the UA stylesheet uses a different internal line-height.
 * To ensure the unit selector for serum creatinine (ScrUnit) aligns neatly
 * with other input fields, give it an explicit height calculated from the
 * input’s font size, padding and borders. The calculation below mirrors
 * 1rem of text height, 0.9rem total vertical padding (0.45rem top and
 * bottom) and 2 px of border, yielding an overall height matching the
 * number inputs. Adjusting only this select avoids unexpectedly resizing
 * all dropdowns across the form.
 */
#ScrUnit {
  /*
   * Match the vertical height of the text inputs. Inputs inherit a
   * line‑height of roughly 1.2, so the height is the sum of that line
   * height (≈1.2 rem), the vertical padding (0.9 rem) and the 2 px borders.
   * Using calc(2.1rem + 2px) yields ~35.6 px, closely aligning the dropdown
   * with the number/text inputs across browsers. Padding is kept
   * consistent with other controls.
   */
  height: calc(2.1rem + 2px);
  padding: 0.45rem 0.65rem;
  line-height: 1rem;
}
.flex {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  /* Zapobiegamy rozciąganiu elementów na jednakową wysokość, aby uniknąć dużych pustych przestrzeni w polu „Parametry z surowicy i DZM” */
  align-items: flex-start;
}
.snack-row, .meal-row {
  display: grid;
  grid-template-columns: 1fr 100px 34px;
  gap: 0.5rem;
  align-items: center;
  margin-top: 0.5rem;
}
button.icon {
  background: none;
  border: none;
  font-size: 1.35rem;
  cursor: pointer;
  color: var(--danger);
  font-weight: 900;
  line-height: 1;
}
button.icon:hover { opacity: 0.8; }
button.add-row {
  background: var(--secondary);
  color: #fff;
  border: none;
  padding: 0.45rem 0.9rem;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 0.7rem;
}
button.add-row:hover { background: var(--primary); }
#results {
  display: none;
  flex-direction: column;
  gap: 1.5rem;
}
.card {
  /* Przywracamy oryginalny kolor tła kart (tzw. card), aby całe sekcje wyników pozostały w barwie motywu */
  background: var(--card);
  padding: 1rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.activity-time {
  margin: 0.4rem 0;
  font-size: 1.25rem;
  font-weight: 700;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0.6rem;
}
th, td {
  border: 1px solid #ddd;
  padding: 0.6rem;
  text-align: center;
  font-size: 0.95rem;
}
th {
  background: var(--secondary);
  color: #fff;
}
footer {
  margin-top: 2rem;
  text-align: center;
  font-size: 0.85rem;
  color: #666;
  padding: 1rem 0;
  background: #fafafa;
}
@media(min-width: 700px) {
  .grid-two {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
}

/* center calorie burn block */
#timesCard { text-align: center; }

/* Powiększone ramki wyników BMI i BMR */
.result-box {
  /* Zmieniamy kolor obramowania pól wyników na turkusowy jak nagłówek */
  border: 2px solid var(--primary);
  border-radius: 8px;
  padding: 10px;
  margin: 12px 0;
  font-size: 1.3rem;
  /* Domyślnie tło wyników ustawiamy na białe, aby kontenery były jaśniejsze */
  background: #ffffff;
  text-align: center;
  /* Dodajemy delikatny cień, aby pola wyników były spójne z kartami */
  box-shadow: var(--shadow);
}

/* --- legenda wewnątrz ramek fieldset --- */
fieldset {
  position: relative;
  padding-top: 1.0rem;   /* miejsce na legendę */
}
legend {
  position: absolute;
  top: 0;
  left: 0;
  font-size: 1.1rem;
  font-weight: 600;
  padding: 0 .5rem;
  background: var(--card); /* kolor karty, zakrywa linię ramki */
  border-radius: var(--radius);
}
/* zaokrąglone logo jak kontenery wyników */
header img {
  border-radius: var(--radius);
  display: inline-block; /* opcjonalnie, żeby mieć pewność */
}
/* Wyśrodkowanie nagłówka w karcie "Droga do normy BMI" */
#toNormCard h2 {
  text-align: center;
}

html, body {
  height: 100%;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  scroll-behavior: smooth;
}
/* =====================  UI REFINEMENTS – 2025‑06‑29  ===================== */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
body {
  font-size: 16px;
  line-height: 1.5;
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}

/* Styl raportu PDF – wyświetlany tylko podczas generowania PDF. Używa większych fontów
   i klarownego układu, aby raport był czytelny na jednej stronie A4. */
#pdfReport {
  font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  font-size: 14px;
  line-height: 1.4;
  color: var(--text);
  width: 100%;
  max-width: 180mm; /* ogranicz szerokość raportu, aby zmieścił się na stronie A4 (210 mm minus marginesy) */
  margin: 0 auto;
  padding: 0;
}
#pdfReport .section {
  margin-bottom: 10px;
  page-break-inside: avoid;
}
#pdfReport h2 {
  font-size: 22px;
  margin: 0 0 6px;
  color: var(--primary);
}
#pdfReport h3 {
  font-size: 16px;
  margin: 8px 0 4px;
  color: var(--secondary);
}
#pdfReport p {
  margin: 2px 0;
}
#pdfReport .result-item {
  margin: 2px 0;
  font-size: 14px;
}
#pdfReport .result-item strong {
  font-weight: 600;
}
#pdfReport .range {
  color: #666;
  font-style: italic;
  margin-left: 2px;
}
#pdfReport .out-of-range {
  color: var(--danger);
  font-weight: 600;
}

/* Buttons */
button,
input[type="button"],
input[type="submit"] {
  cursor: pointer;
  font: inherit;
  border: none;
  border-radius: var(--radius);
  padding: 0.55rem 1.1rem;
  background: var(--primary);
  color: #fff;
  transition: background 0.2s ease, box-shadow 0.2s ease;
}
button:hover,
input[type="button"]:hover,
input[type="submit"]:hover {
  background: var(--secondary);
  box-shadow: var(--shadow);
}
button:disabled {
  opacity: 0.45;
  cursor: not-allowed;
}

/* Icon (×) buttons inside rows */
button.icon {
  background: transparent;
  color: var(--danger);
  font-size: 1.25rem;
  padding: 0.25rem 0.5rem;
  line-height: 1;
}
button.icon:hover {
  background: rgba(198,40,40,0.1);
}

/* Inputs & selects */
input[type="number"],
input[type="text"],
select {
  width: 100%;
  max-width: 100%;
  padding: 0.45rem 0.65rem;
  border: 1px solid #d0d7da;
  border-radius: var(--radius);
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
input:focus,
select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(0,131,141,0.25);
}

/* Table design */
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 0.6rem 0.75rem;
  text-align: left;
}
thead th {
  background: var(--primary);
  color: #fff;
  font-weight: 600;
}
tbody tr:nth-child(odd) {
  /* Tło kart z wynikami ustawione na białe, zgodnie z prośbą użytkownika */
  background: #ffffff;
}
tbody tr:hover {
  background: rgba(0,176,166,0.08);
}

/* Card shadow & radius unification */
/* Przywracamy kolor tła sekcji (np. kart klirensu) do barwy motywu, pozostawiając białe tło tylko dla pól wyników (.result-box) */
section.card,
#toNormCard {
  border-radius: var(--radius);
  background: var(--card);
  box-shadow: var(--shadow);
  padding: 1rem;
}

/* Responsive horizontal scrolling for wide tables */
.table-scroll {
  overflow-x: auto;
}
.table-scroll > table {
  min-width: 520px;
}

/* Utility */
.text-center { text-align: center; }
.text-right { text-align: right; }

/* Mobile tweaks */
@media(max-width: 600px) {
  th, td { padding: 0.5rem; }
  button, input[type="button"], input[type="submit"] {
    width: 100%;
    margin-top: 0.5rem;
  }
}

/* ======================================================================== */

/* === FORM GRID LAYOUT 2025‑07‑02 FIX === */
#clcrForm {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  grid-template-rows: auto 1fr;
  gap: 1rem;
}
#clcrForm > div {
  display: flex;
  flex-direction: column;
}
#clcrForm > div fieldset {
  flex: 1 1 auto;
}
#clcrForm > .patient-card {
  grid-column: 1 / -1;
  align-self: start;
}
#clcrForm > .patient-card fieldset {
  height: auto;
}

/* === RESULT HIGHLIGHT 2025‑06‑29 ===================== */
:root {
  --brand: #00838d;
  --brand-light: #00b0a6;
  --card-bg: #ffffff;
  --radius: 12px;
  --shadow-s: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-l: 0 4px 22px rgba(0,0,0,0.14);
  --anim-fast: 150ms ease;
}

button,
input[type="submit"] {
  transition: transform var(--anim-fast), box-shadow var(--anim-fast);
}
button:hover,
input[type="submit"]:hover,
button:focus-visible,
input[type="submit"]:focus-visible {
  transform: translateY(-1px) scale(1.02);
  box-shadow: var(--shadow-l);
}

.result-card {
  background: var(--card-bg);
  border: 2px solid var(--brand);
  border-radius: var(--radius);
  box-shadow: var(--shadow-s);
  padding: 1.25rem 1.5rem;
  position: relative;
  overflow: hidden;
}
.result-card.--pulse::after {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--brand-light);
  opacity: 0;
  z-index: -1;
  animation: pulseBG 1s ease-out forwards;
}
@keyframes pulseBG {
  0% { opacity: 0.15; }
  100% { opacity: 0; }
}

.result-number {
  font: 600 2.75rem/1 "Inter", sans-serif;
  letter-spacing: -0.02em;
  color: var(--brand);
  display: inline-flex;
  align-items: flex-end;
}
.result-number small {
  font-size: 0.45em;
  margin-left: 0.1em;
  color: #444;
}

@keyframes fadeSlideUp {
  0% { opacity: 0; transform: translateY(12px); }
  100% { opacity: 1; transform: translateY(0); }
}
.animate-in {
  animation: fadeSlideUp 0.45s cubic-bezier(0.4,0,0.2,1);
}

@media (prefers-reduced-motion: reduce) {
  * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; }
}

/* === DATA CARDS 2025‑06‑29 ===================== */
.data-card {
  background: var(--card);
  border: 2px solid var(--primary);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 1.25rem 1rem;
  overflow: auto;
}

.data-card table {
  width: 100%;
  border-collapse: collapse;
}

.data-card thead {
  background: var(--primary);
  color: #fff;
}

.data-card th,
.data-card td {
  padding: 0.4rem 0.6rem;
  text-align: center;
}

.data-card tr:nth-child(even) {
  background: rgba(0,0,0,0.03);
}

/* === PLAN RESULTS TWO-COLUMN LAYOUT 2025‑06‑30 === */
#planResults {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
@media(max-width: 600px) {
  #planResults {
    grid-template-columns: 1fr;
  }
}

/* === BMI & BMR BLOCK FRAME PATCH 2025‑06‑30 === */
#bmiCard {
  border: 1px solid #d0dede;
}

/* === TIMES CARD FRAME PATCH 2025‑06‑30 === */
#timesCard {
  border: 1px solid #d0dede;
}

/* === UI TWEAKS – 50 centyl & Plan (2025‑06‑30) === */
.bmi50-info {
  font-size: 1.3rem !important;
  font-weight: 600;
  display: block;
  margin-top: 6px;
}
.bmi50-info .bmi50-number {
  font-size: 1.4rem;
  font-weight: 600;
}
.plan-time {
  font-size: 1.5rem;
  font-weight: 600;
  display: inline-block;
  margin-bottom: 2px;
}

/* === PATCH 2025‑07‑01 – PLAN & 50 centyl UI === */
.small-50 { font-size: 0.1rem; font-weight: 500; }
.plan-time, .plan-month, .plan-year {
  font-size: 1.5rem;
  font-weight: 600;
  display: inline-block;
  margin-bottom: 2px;
}

/* === PLAN CARD – override font size ONLY in plan columns (added 2025‑07‑01) === */
.plan-col .result-number {
  font-size: 1.4rem;
  font-weight: 600;
}

/* === SPACING FIX FOR FIELDSETS – 2025‑08‑01 ===
   Zastępujemy układ grid dla formularza #clcrForm układem kolumnowym flex,
   aby sekcje (Dane pacjenta, Parametry z surowicy i DZM, Parametry z dobowej zbiórki moczu)
   były rozmieszczone w równych odstępach pionowych. Dodatkowo param-row
   jest układem poziomym flex na duże ekrany z zawijaniem, a param-col definiuje
   minimalną szerokość każdej kolumny. */
#clcrForm {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  /* nadpisujemy wrap i align-items z klasy .flex, aby elementy nie zawijały się i
     każdy wiersz zajmował całą szerokość formularza */
  flex-wrap: nowrap;
  align-items: stretch;
}
/* Specjalne dopasowanie kontenera z parametrami – element param-row musi
   nadpisać domyślne ustawienia #clcrForm > div, aby kolumny były ustawione obok
   siebie i miały niezależną wysokość. */
#clcrForm > .param-row {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 1rem;
}
#clcrForm > .param-row > .param-col {
  flex: 1 1 320px;
}

/* === WIDTH EQUALIZATION FOR PATIENT FIELDSET (2025‑08‑03) ===
   Aby sekcja „Dane pacjenta” miała identyczną szerokość jak pola
   „Parametry z surowicy i DZM” oraz „Parametry z dobowej zbiórki moczu”,
   ograniczamy jej szerokość na dużych ekranach do połowy szerokości
   kontenera formularza (z uwzględnieniem odstępu między kolumnami).
   Na mniejszych ekranach pole to wypełnia całą dostępną szerokość,
   dzięki czemu zachowujemy spójny wygląd zarówno w widoku mobilnym,
   jak i w trybie PC. */
@media (min-width: 700px) {
  #clcrForm > .patient-card {
    /* Aby sekcja „Dane pacjenta” miała dokładnie taką samą szerokość
       jak pojedyncza kolumna wiersza parametrów, obliczamy ją na podstawie
       sumy szerokości dwóch kolumn param-row oraz odstępu między nimi.
       Każda kolumna param-row zajmuje połowę szerokości wiersza
       pomniejszoną jedynie o odstęp między kolumnami (1 rem). Dlatego
       odejmujemy jedynie tę przerwę, a nie całkowity padding kontenera. */
    width: calc((100% - 1rem) / 2);
    /* Zapobiegamy automatycznemu rozciąganiu, aby zachować powyższą szerokość. */
    flex: 0 0 auto;
  }
}
@media (max-width: 699px) {
  #clcrForm > .patient-card {
    /* Na małych ekranach sekcja wypełnia pełną szerokość kontenera,
       tak jak pozostałe pola, co zapewnia spójny układ. */
    width: 100%;
  }
}

/* === PATCH 2025‑07‑01 – pełna szerokość karty Inne wskaźniki === */
#elecCard { grid-column: 1 / -1; }
#elecInfo {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
#elecInfo .result-box {
  /*
     Domyślnie każda karta wyniku zajmuje co najmniej około 260 px
     szerokości i może rosnąć w zależności od dostępnego miejsca.
     Ustawiamy min-width na 0, aby elementy mogły się zmniejszać
     poniżej swojego flex-basis bez generowania poziomego przewijania.
  */
  flex: 1 1 260px;
  min-width: 0;
}

/*
  W widokach mobilnych (np. telefony w orientacji pionowej) wymuszamy,
  aby każdy wynik był wyświetlany w osobnym wierszu na pełną
  szerokość kontenera. Dzięki temu długie etykiety nie będą
  wychodziły poza granice sekcji, a układ pozostanie czytelny.
*/
@media (max-width: 600px) {
  #elecInfo .result-box {
    flex: 1 1 100%;
  }
}

/* === OUT-OF-RANGE HIGHLIGHT === */
/* === STAGE HIGHLIGHT COLORS (KDIGO G3a/G3b) === */
.result-box.warn-orange {
  background: #fff3e0;   /* jasny pomarańczowy */
  border-color: #ffa726; /* pomarańcz */
}
.result-box.warn-orange strong {
  color: #ef6c00;
}
.result-box.warn-yellow {
  background: #fffde7;   /* jasny żółty */
  border-color: #fff176; /* żółty */
}
.result-box.warn-yellow strong {
  color: #fbc02d;
}

.result-box.out-of-range {
  background: #ffebee;
  border-color: #e57373;
}
.result-box.out-of-range strong {
  color: #c62828;
}

/* === EQUAL HEIGHT INPUT CARDS (2025-07-02) === */
/* Modyfikujemy układ formularza #clcrForm tak, aby stosował flexbox w pionie zamiast
   siatki. Dzięki temu każda sekcja formularza (Dane pacjenta, Parametry z surowicy i DZM,
   Parametry z dobowej zbiórki moczu) jest renderowana jako osobny wiersz o wysokości
   dopasowanej do zawartości, a odstępy między nimi określa właściwość gap. */
#clcrForm {
  display: flex !important;
  flex-direction: column;
  gap: 1rem;
}
#clcrForm > div {
  display: flex;
  flex-direction: column;
}
#clcrForm fieldset {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
}
/* helper boxes (optional) fill remaining flex space */
.helper-box {
  margin-top: auto;
  font-size: 0.85rem;
  color: #555;
  background: #eef4f4;
  border: 1px dashed var(--primary);
  border-radius: var(--radius);
  padding: 0.6rem;
}

#clcrForm {
  /* Finalna definicja formularza wykorzystuje flexbox w pionie,
     zapewniając równe odstępy między sekcjami bez sztucznego wydłużania wierszy. */
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
#clcrForm > div {
  display: flex;
  flex-direction: column;
  min-width: 0;  /* avoid overflow */
}
#clcrForm > div.patient-card {
  grid-column: 1 / -1;
}
/* two-column layout inside patient fieldset */
#patientSet {
  display: grid;
  grid-template-columns: 1fr 1fr;
  column-gap: 1rem;
}
/* make labels stretch full width inside patient grid */
#patientSet label {
  margin-top: 0.7rem;
}

/* === FULL‑WIDTH “Klirens / eGFR” CARD (2025‑07‑02) === */
#clcrCard {
  grid-column: 1 / -1;  /* rozciąga się na obie kolumny kontenera #results */
}
  /* ------- Walidacja i podpowiedzi ------- */
  .validation-message {
    color: var(--danger);
    font-size: 0.8rem;
    line-height: 1.2;
  }
  .error {
    border-color: var(--danger) !important;
  }
  .info-icon {
    margin-left: 4px;
    cursor: help;
    color: var(--primary);
    font-size: 1rem;
    line-height: 1;
    vertical-align: middle;
    display: inline-block;
  }
  .info-icon:hover {
    color: var(--primary);
  }
  /* additional classes for validation and tooltips */
  .input-error    { border: 2px solid #d00 !important; }
  .tooltip-icon   { cursor: help; font-weight: bold; color: #36c; margin-left: 4px; }

  /* simple cards used for extra sections (e.g. advanced KT/V) */
  /* Ujednolicony wygląd kart – zaokrąglone narożniki jak w innych sekcjach */
  .card{ border: 1px solid #ccc; padding: 12px; margin: 12px 0; border-radius: var(--radius); }
  .card h2{ margin-top: 0; font-size: 1.1rem; text-align: left; }

  /* Layout for advanced KT/V fields: use flex instead of grid to align labels and icons like other inputs */
  #ktvFields > div {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  #ktvFields label {
    flex: 1 1 160px;
  }

  /* Make form fields white regardless of system dark/light mode */
  input,
  select,
  option {
    background-color: #fff;
    color: var(--text);
  }

  /* === MOBILE BUTTON PADDING – 2025‑08‑03 === */
  @media (max-width: 600px) {
    #downloadPDF,
    #downloadDOCX,
    #askAI {
      /* szerokość jak pola w .container → 100 % minus 2 × 1 rem wewn. odstępu  */
      width: calc(100% - 2rem);
      /* identyczny odstęp boczny jak .container (1 rem) */
      margin-left: 1rem;
      margin-right: 1rem;
    }
  }

  /* === AI FIELDSET SPACING (po przeniesieniu do .container) === */
  #aiFieldset {
    /* zachowujemy wygląd fieldsetów, dodajemy tylko odstęp od poprzedniej karty */
    margin-top: 1.5rem;
  }

  /* === EQUAL HEIGHT PARAM-SECTIONS IN LANDSCAPE – 2025‑08‑03 === */
  /*
     W widoku poziomym (ekrany szersze niż ~700 px) wyrównujemy wysokość
     kolumn z parametrami z surowicy/DZM oraz dobowej zbiórki moczu.
     Domyślnie flexbox rozciąga elementy po przekątnej tylko wtedy, gdy
     align-items ustawione jest na "stretch". Wcześniejsze poprawki
     ustawiają align-items: flex-start, co zapobiegało rozciąganiu
     krótszej kolumny i skutkowało nierównymi wysokościami. Teraz
     przywracamy zachowanie stretch tylko dla wiersza parametrów na
     szerokich ekranach. Dzięki temu sekcja „Parametry z surowicy i DZM”
     w widoku poziomym będzie równa wysokością sekcji „Parametry z
     dobowej zbiórki moczu” i rozciągnie się do dolnej granicy tego
     kontenera.
  */
  @media (min-width: 700px) {
    #clcrForm > .param-row {
      align-items: stretch;
    }
    /* Upewniamy się, że same fieldsety w kolumnach wypełniają przestrzeń
       wysokościową, aby rozciąganie było widoczne. */
    #clcrForm > .param-row > .param-col {
      display: flex;
      flex-direction: column;
    }
    #clcrForm > .param-row > .param-col fieldset {
      /* elementy fieldset elastycznie wypełniają dostępną przestrzeń */
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }
  }

  /* === PLACEHOLDER ROWS FOR SYMMETRY – 2025‑08‑03 === */
  /* Wiersze o klasie .placeholder-row są używane jako niewidoczne odstępy w
     sekcji „Parametry z surowicy i DZM”, aby liczba rzędów w lewej
     kolumnie odpowiadała liczbie pól w kolumnie prawej. W widoku
     poziomym są niewidoczne, ale zachowują wysokość dzięki
     visibility:hidden. W widoku pionowym całkowicie je ukrywamy, aby
     uniknąć dużych pustych przestrzeni. */
  .placeholder-row {
    visibility: hidden;
  }
  @media (max-width: 699px) {
    .placeholder-row {
      display: none;
    }
  }

  /* === INFO‑BUTTON & TOOLTIP – 2025‑08‑03 === */

  /* kontener input + przycisk Info */
  .input-group{
    position:relative;
    display:flex;
    align-items:stretch;
    gap:0.5rem;
  }
  .input-group input,
  .input-group select{
    flex:1 1 auto;           /* przejmij całą dostępną szerokość */
  }

  /* przycisk Info */
  .info-btn{
    flex:0 0 auto;
    background:#00b0a6;      /* turkus – dopasuj do motywu */
    color:#fff;
    font-weight:600;
    border:none;
    border-radius:var(--radius,6px);
    padding:0.5rem 1rem;
    cursor:pointer;
    transition:background .2s,transform .15s;
  }
  .info-btn:hover{background:#00838d;}
  .info-btn:focus{
    outline:2px solid #00838d;
    outline-offset:2px;
  }

  /* dymek */
  .tooltip{
    display:none;            /* ukryty domyślnie */
    position:absolute;
    top:100%; left:0;
    margin-top:0.35rem;
    max-width:280px;
    padding:0.75rem;
    background:#f0f9f9;      /* jasny turkus */
    color:#000;
    border:1px solid #00b0a6;
    border-radius:4px;
    box-shadow:0 2px 8px rgba(0,0,0,.15);
    z-index:1000;
  }
  /* strzałka */
  .tooltip::before{
    content:"";
    position:absolute;
    top:-6px; left:22px;
    border:6px solid transparent;
    border-bottom-color:#f0f9f9;
  }
  /* widoczny dymek */
  .tooltip.visible{display:block;}

  /* Dodatkowa logika dla pól typu checkbox: zawijaj elementy wewnątrz, aby przycisk Info nie wychodził poza kontener */
  .wrap-info{
    flex-wrap: wrap;
  }
  /* Nie rozciągaj pól typu checkbox na całą szerokość w obrębie .wrap-info */
  .wrap-info input[type="checkbox"],
  .wrap-info select[type="checkbox"]{
    flex: 0 0 auto;
  }
  /* Gdy przycisk Info znajduje się obok checkboxa, pozwól mu zawijać się na nową linię bez rozciągania na pełną szerokość */
  .wrap-info .info-btn{
    flex: 0 0 auto;
    margin-top: 0.25rem;
  }

  /* mobile: keep the same horizontal alignment for the Info button as on larger screens.
     Previously we switched the .input-group to a 2/3‑1/3 grid on narrow screens, which
     caused the Info buttons to take up one third of the available width and
     mis‑align relative to their inputs. To ensure the placement and alignment of the
     Info buttons remains consistent between single‑column and two‑column layouts,
     we retain the flex layout on small screens and let the button size itself to
     its content. */
  @media(max-width:600px){
    .input-group{
      display:flex;          /* remain a horizontal flex container */
      align-items:stretch;   /* match the height of its children */
    }
    .info-btn{
      width:auto;            /* do not force full width; size based on content */
      align-self:stretch;    /* match input height */
    }
  }

  /* Center Info buttons for specific checkbox fields. The toggle for advanced KT/V
     calculations (#ktvToggle) and the option to include KT/V in the AI report
     (#includeKTV) are rendered as checkboxes with an adjacent Info button. By default
     checkbox wrappers (.wrap-info) add a top margin to the Info button which pushes it
     down and misaligns it with the checkbox and label. The rules below remove that
     top margin and vertically center the button within the wrapper. */
  #ktvToggle + .info-btn,
  #includeKTV + .info-btn {
    margin-top: 0;
    align-self: center;
  }

  /* When a wrapper has the .center-info class (added in the JS for specific
     checkbox fields), center the checkbox and its Info button horizontally.
     We rely on flexbox to distribute space around the two children evenly. */
  .center-info {
    justify-content: center;
  }
  .center-info .info-btn {
    margin-top: 0;
  }
</style>

<!-- 2. BIBLIOTEKI -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Biblioteka do generowania plików DOCX. Jeśli z jakiegoś powodu nie zostanie załadowana (np. brak internetu), skrypt wykorzysta prosty fallback HTML/RTF. -->
    <script src="https://cdn.jsdelivr.net/npm/docx@7.7.0/build/index.js"></script>
</head>

<body>
<header>
  <img src="logo_vilda.jpeg" alt="Vilda Clinic logo" style="max-width:160px;margin-bottom:10px;border-radius:var(--radius);">
  <h1>Kalkulator klirensu kreatyniny / eGFR</h1>
</header>

<div class="container">

  <!-- 3. FORMULARZ DANYCH PACJENTA -->
  <form id="clcrForm" class="flex" onsubmit="return false;">
    <div class="patient-card" style="flex:1 1 300px;">
      <fieldset id="patientSet"><legend>Dane pacjenta</legend>
        <label>Imię i nazwisko:
          <input type="text" id="fullName"></label>
        <label>Wiek (lata):
          <input type="number" id="age" min="0" max="120" required></label>
        <label>Płeć:
          <select id="sex">
            <option value="M">Mężczyzna</option>
            <option value="F">Kobieta</option>
          </select></label>
        <label>Masa ciała (kg):
          <input type="number" id="weight" min="2" max="300" required></label>
        <label>Wzrost (cm):
          <input type="number" id="height" min="30" max="250" required></label>
      </fieldset>
    </div>

    <div class="param-row">
      <div class="param-col">
        <fieldset><legend>Parametry z surowicy i DZM</legend>
        <!-- Pole kreatyniny z możliwością wyboru jednostki (mg/dl lub µmol/L) -->
        <!-- Podział pola kreatyniny w surowicy na dwie osobne linie: wartość oraz jednostka.
             Dzięki temu w widoku poziomym każdy wiersz zajmuje jedną komórkę siatki,
             co ułatwia wyrównanie pól po lewej i prawej stronie. -->
        <label>Kreatynina w surowicy:
          <input type="number" step="0.01" id="Scr" required>
        </label>
        <label>Jednostka kreatyniny w surowicy:
          <select id="ScrUnit">
            <option value="mg/dl">mg/dl</option>
            <option value="umol">µmol/L</option>
          </select>
        </label>
        <label>Kreatynina w moczu 24 h (mg/dl):
          <input type="number" step="0.1" id="Ucr"></label>
        <label>Objętość dobowej zbiórki moczu (ml):
          <input type="number" id="V24" placeholder="np. 1500"></label>

        <label>Sód (Na, mmol/L):
          <input type="number" id="S_Na" step="0.1"></label>
        <label>Potas (K, mmol/L):
          <input type="number" id="S_K" step="0.1"></label>
        <label>Chlorki (Cl, mmol/L):
          <input type="number" id="S_Cl" step="0.1"></label>
        <label>HCO₃⁻ (mmol/L):
          <input type="number" id="S_HCO3" step="0.1"></label>
        <label>Fosfor (PO₄, mg/dl):
          <input type="number" id="S_PO4" step="0.1"></label>
        <label>Kwas moczowy (mg/dl):
          <input type="number" id="S_UA" step="0.1"></label>
        <!-- Dodajemy ukryte wiersze do wyrównania liczby pól z kolumną po prawej stronie.
             Dzięki temu każdy wiersz po lewej i prawej stronie ma tę samą wysokość
             w widoku poziomym, a cała sekcja pozostaje symetryczna. Wiersze te
             pozostają niewidoczne (przez visibility:hidden), zachowując jednak
             swoją wysokość. Na małych ekranach są całkowicie ukrywane (display:none)
             za pomocą odpowiedniej klasy CSS. -->
        <label class="placeholder-row"><input type="number" style="visibility:hidden;"></label>
        </fieldset>
      </div>
      <div class="param-col">
        <fieldset><legend>Parametry z dobowej zbiórki moczu</legend>
        <label>Sód (Na, mmol/L):
          <input type="number" id="U_Na" step="0.1"></label>
        <label>Potas (K, mmol/L):
          <input type="number" id="U_K" step="0.1"></label>
        <label>Chlorki (Cl, mmol/L):
          <input type="number" id="U_Cl" step="0.1"></label>
        <label>HCO₃⁻ (mmol/L):
          <input type="number" id="U_HCO3" step="0.1"></label>
        <label>Fosfor (PO₄, mg/dl):
          <input type="number" id="U_PO4" step="0.1"></label>
        <label>Kwas moczowy (mg/dl):
          <input type="number" id="U_UA" step="0.1"></label>
        <!-- Zmiana jednostek: wapń w mmol/L, magnez w mg/L, białko całkowite w mg/24 h -->
        <label>Wapń (Ca, mmol/L):
          <input type="number" id="U_Ca" step="0.1"></label>
        <label>Magnez (Mg, mg/L):
          <input type="number" id="U_Mg" step="0.1"></label>
        <label>Białko całkowite (mg/24 h):
          <input type="number" id="U_Prot" step="1"></label>
        <!-- ======  NOWE POLA  – albumina + automatyczny ACR  ====== -->
        <label>Albumina w próbce moczu (mg/L):
          <input type="number" id="U_Alb" step="0.1"></label>
        <label>Albumina/kreatynina (ACR, mg/g):
          <input type="number" id="U_ACR" step="0.1" readonly></label>
        </fieldset>
      </div>
    </div>

    <!-- ⚙️ Zaawansowane obliczenia KT/V (ukryte do czasu zaznaczenia) -->
    <div class="card">
      <label>
        <input type="checkbox" id="ktvToggle">
        Pokaż zaawansowane obliczenia KT/V
      </label>

      <div id="ktvFields" style="display:none;margin-top:8px;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:6px">
          <label>Czas dializy (h):
            <input type="number" id="ktvTime" step="0.1" data-max="8">
          </label>
          <label>Ubytek masy (UF, kg):
            <input type="number" id="ktvUF" step="0.1" data-max="10">
          </label>
          <label>Masa ciała po dializie (kg):
            <input type="number" id="ktvW" step="0.1" data-max="300">
          </label>
          <label>Mocznik przed (mg/dl):
            <input type="number" id="UreaPre" step="1" data-max="400">
          </label>
          <label>Mocznik po (mg/dl):
            <input type="number" id="UreaPost" step="1" data-max="400">
          </label>
        </div>

        <!-- wyniki -->
        <div id="ktvResult" class="result-box" style="display:none;"></div>
        <div id="ektvResult" class="result-box" style="display:none;"></div>
      </div>
    </div>
  </form>

  <!-- 4. WYNIKI -->
  <div id="results" class="grid-two" style="display:none;">
    <div class="card" id="clcrCard">
      <h3 id="patientName" class="text-center" style="margin:0 0 0.4rem 0;"></h3>
      <h2 class="text-center">Klirens / eGFR</h2>
      <p class="text-center" style="font-size:1.2em;">w nawiasach podano zakres referencyjny dla płci i wieku</p>
      <div id="clcrInfo"></div>
      <small>*Klirens 24 h obliczany tylko, gdy podasz zarówno Ucr, V24 i Scr.</small>
    </div>
  </div>
<div class="card" id="elecCard" style="display:none;">
    <h2 class="text-center">Inne wskaźniki</h2>
    <p class="text-center" style="font-size:1.2em;">w nawiasach podano zakres referencyjny dla płci i wieku</p>
    <div id="elecInfo"></div>
  </div>

  <!-- przyciski eksportu -->
  <button id="downloadPDF" hidden style="display:block; margin:20px auto;">Pobierz raport PDF</button>
  <!-- Przycisk do pobierania raportu w formacie DOCX/RTF; ukryty dopóki nie ma wyników -->
  <button id="downloadDOCX" hidden style="display:block; margin:20px auto;">Pobierz raport DOCX</button>

  <!-- ⇩⇩⇩  SEK‑CJA  AI  ⇩⇩⇩ -->
  <fieldset id="aiFieldset" hidden>
    <legend>Interpretacja AI</legend>
    <p>Po naciśnięciu przycisku poniżej system przygotuje gotowe zapytanie do asystenta AI (np. ChatGPT) na podstawie wprowadzonych danych i wszystkich obliczonych wyników. Zapytanie zostanie automatycznie skopiowane do schowka, aby można je było łatwo wkleić do asystenta i uzyskać interpretację wyników.</p>
    <!-- Opcjonalne dołączenie wyników KT/V do raportu AI -->
    <label style="display:block; margin:0.5rem 0;">
      <input type="checkbox" id="includeKTV">
      Uwzględnij wyniki KT/V w raporcie AI
    </label>
    <button id="askAI">Zapytaj AI</button>
  </fieldset>
  <!-- ⇧⇧⇧  KONIEC SEK‑CJI AI  ⇧⇧⇧ -->

</div> <!-- /.container -->

<!-- Kontener do tworzenia eleganckiego raportu PDF. Jest niewidoczny na stronie. -->
<div id="pdfReport" style="display:none;"></div>
<footer>© <script>document.write(new Date().getFullYear())</script> Vilda Clinic</footer>

<!-- 5. LOGIKA JS -->
<script>
/* ---------- 5.1 ŁADOWANIE ARKUSZA Z NORMAMI ---------- */
let normy = null;
(async () => {
  const wb = XLSX.read(await (await fetch('klirens.xlsx')).arrayBuffer());
  // przyjmujemy, że normy i opisy są w pierwszym arkuszu
  normy = XLSX.utils.sheet_to_json(wb.Sheets['Arkusz1'], {header: 1, raw: true});
})();

/* ---------- 5.2 FUNKCJE OBLICZENIOWE ---------- */
function BSA_DuBois(weight, height) {
  return 0.007184 * Math.pow(weight, 0.425) * Math.pow(height, 0.725);
}

/* 1) Klirens dobowy (ml/min/1.73 m²) */
function clCr24h(Ucr_mg_dl, V24_ml, Scr_mg_dl, BSA) {
  const cl = (Ucr_mg_dl * V24_ml) / (Scr_mg_dl * 1440);  // 1440 min = 24 h
  return cl * (1.73 / BSA);
}

/* 2) Cockcroft–Gault (ml/min, *nie* znormalizowany do 1.73 m²) */
function clCrCG(sex, age, weight, Scr) {
  const k = sex === 'F' ? 0.85 : 1;
  return ((140 - age) * weight * k) / (72 * Scr);
}

/*
 * Zmieniono implementację: usunięto starszy wzór CKD‑EPI 2021 bez współczynnika płci.
 * Aktualnie stosowany jest wzór CKD‑EPI 2022 (NEJM 2021, KDIGO 2022), który
 * zawiera w sobie mnożnik 1.012 dla kobiet. Funkcja eGFR_CKD_EPI_2022
 * pozostaje poniżej i jest jedyną używaną w obliczeniach.
 */

/* 3b) eGFR – CKD‑EPI 2022 (creatinine‑only, race‑free)
   Współczynniki wg Inker et al., NEJM 2021; rekomendacja KDIGO 2022.
   GFR = 142 × min(Scr/κ,1)^α × max(Scr/κ,1)^–1.200 × 0.9938^Age × 1.012 (if female) */
function eGFR_CKD_EPI_2022(sex, age, Scr) {
  const κ = sex === 'F' ? 0.7 : 0.9;
  const α = sex === 'F' ? -0.241 : -0.302;
  const min = Math.min(Scr / κ, 1);
  const max = Math.max(Scr / κ, 1);
  let gfr = 142 * Math.pow(min, α) * Math.pow(max, -1.200) * Math.pow(0.9938, age);
  if (sex === 'F') gfr *= 1.012;          // współczynnik płci
  return gfr;
}

/* --- KT/V (Daugirdas) i eKt/V ---------------------------------- */
function ktvDaugirdas(R, tHrs, UFkg, Wkg) {
  if (!R || !tHrs || !UFkg || !Wkg) return null;
  const r  = parseFloat(R);
  const t  = parseFloat(tHrs);
  const UF = parseFloat(UFkg);
  const W  = parseFloat(Wkg);
  if (r <= 0 || r >= 1 || t <= 0) return null;
  const first  = -Math.log(r - 0.008 * t);
  const second = (4 - 3.5 * r) * (UF / W);
  return first + second;           // spKt/V
}
function eKtV(spKtV, tMin) {
  if (!spKtV || !tMin) return null;
  return spKtV * (tMin / (tMin + 35));   // przybliżenie
}

/* 4a) klasyczny Schwartz ze zmiennym k */
function kSchwartzVar(ageY, sex) {
  // ustalanie współczynnika k w zależności od wieku i płci
  if (ageY < 0.083) return 0.33;               // wcześniaki < 1 m‑ca
  if (ageY < 1)      return 0.45;               // niemowlęta 1‑12 m‑cy
  if (ageY < 13)     return 0.55;               // dzieci 1‑<13 l.
  if (ageY < 18)     return (sex === 'M' ? 0.70 : 0.55); // nastolatki
  return 0.55;                                 // fallback
}
function clCrSchwartzVar(height_cm, Scr, ageY, sex) {
  // GFR i zastosowane k zwracane jako obiekt
  const k = kSchwartzVar(ageY, sex);
  return { gfr: (k * height_cm) / Scr, k };
}
/* 4b) Bedside Schwartz (IDMS 2009) – stałe k = 0,413 */
function clCrSchwartzIDMS(height_cm, Scr) {
  const k = 0.413;
  return { gfr: (k * height_cm) / Scr, k };
}

/* ===  NOWE OBLICZENIA  =============================================== */

/* ---------- 5.2a  ZAKRESY REFERENCYJNE ---------- */
const refRanges = {
  UA_mgkg:  { child: {min: 0, max: 12}, adult: {min: 0, max: 13},  senior: {min: 0, max: 13} },
  Ca_mgkg:  { child: {min: 0, max: 4},  adult: {min: 0, max: 3},   senior: {min: 0, max: 3} },
  Mg_mgkg:  { child: {min: 0, max: 3.0}, adult: {min: 0, max: 2.0}, senior: {min: 0, max: 2.0} },
  PO4_mgkg: { child: {min: 0, max: 40}, adult: {min: 0, max: 35},  senior: {min: 0, max: 35} },
  Prot_mgkg:{ child: {min: 0, max: 100}, adult: {min: 0, max: 150}, senior: {min: 0, max: 150} },
  Na_mmol_d:{ child: {min: 20, max: 180}, adult: {min: 40, max: 220}, senior: {min: 40, max: 220} },
  K_mmol_d: { child: {min: 10, max: 80}, adult: {min: 25, max: 100}, senior: {min: 25, max: 100} },
  KM_Cr:    { child: {min: 0, max: 0.8}, adult: {min: 0, max: 0.6}, senior: {min: 0, max: 0.6} },
  Ca_Cr:    { child: {min: 0, max: 0.2}, adult: {min: 0, max: 0.11}, senior: {min: 0, max: 0.11} },
  Mg_Ca:    { child: {min: 0.2, max: 0.6}, adult: {min: 0.2, max: 0.6}, senior: {min: 0.2, max: 0.6} },
  PO4_Cr:   { child: {min: 0, max: 2.5}, adult: {min: 0, max: 2.5}, senior: {min: 0, max: 2.5} },
  B_Cr:     { child: {min: 0, max: 0.15}, adult: {min: 0, max: 0.15}, senior: {min: 0, max: 0.15} },
  TRPpct:   { child: {min: 90, max: 99}, adult: {min: 85, max: 99}, senior: {min: 80, max: 99} },
  FENa_pct: { child: {min: 0, max: 1.5}, adult: {min: 0, max: 1},  senior: {min: 0, max: 1} },
  FEHCO3_pct:{ child: {min: 0, max: 5},   adult: {min: 0, max: 5},   senior: {min: 0, max: 5} },
  K_frac:   { child: {min: 30, max: 70}, adult: {min: 15, max: 80},  senior: {min: 15, max: 80} },
  AGs:      { child: {min: 8, max: 16},  adult: {min: 8, max: 12},  senior: {min: 8, max: 14} },
  AGu:      { child: {min: 30, max: 60}, adult: {min: 30, max: 50}, senior: {min: 30, max: 50} },
  ktv:      { adult: {min: 1.2, max: 2.5}, senior: {min: 1.2, max: 2.5} }
  ,
  /* Normy dla frakcji wydalniczej potasu (FEK) oraz chlorków (FECl). Wartości
     przybliżone: u dzieci FEK 10–25 %, u dorosłych 4–16 %, u seniorów 4–15 %. Dla
     FECl brak jednoznacznych norm – przyjęto zakres 2–15 % u dzieci i 1–15 %
     u dorosłych/seniorów. */
  FEK_pct: { child: {min: 10, max: 25}, adult: {min: 4, max: 16}, senior: {min: 4, max: 15} },
  FECl_pct:{ child: {min: 2, max: 15}, adult: {min: 1, max: 15}, senior: {min: 1, max: 15} }
};

const clRefRanges = {
  cl24: { child: {min: 90, max: 140}, adult: {min: 90, max: 130}, senior: {min: 60, max: 120} },
  cg:   { child: {min: 90, max: 140}, adult: {min: 90, max: 130}, senior: {min: 60, max: 120} },
  egfr: { child: {min: 90, max: 140}, adult: {min: 90, max: 120}, senior: {min: 60, max: 120} },
  sch:  { child: {min: 90, max: 140} }
};

/* uniwersalny wzór na wydalanie mg/kg/d (U mg/dl, V ml/24h, w kg) */
const excr_mgkg = (U_mg_dl, V_ml, kg) => (U_mg_dl && V_ml && kg)
       ? (U_mg_dl * V_ml) / (100 * kg) : null;

/* wydalanie mmol/d (U mmol/L, V ml) */
const excr_mmol_d = (U_mmol_L, V_ml) => (U_mmol_L && V_ml)
       ? (U_mmol_L * V_ml) / 1000 : null;

/* frakcja wydalnicza – generyczna (%, U_x, S_x, U_cr, S_cr) */
const FE = (U_x, S_x, U_cr, S_cr) => (U_x && S_x && U_cr && S_cr)
       ? (U_x * S_cr) / (S_x * U_cr) * 100 : null;

/* wskaźnik X/Cr (U mg/dl : U_cr mg/dl) */
const ratio = (U, U_cr) => (U && U_cr) ? U / U_cr : null;

/* TRP – Tubular Reabsorption of Phosphate (%) */
const TRP = (U_PO4, S_PO4, U_Cr, S_Cr) => (U_PO4 && S_PO4 && U_Cr && S_Cr)
       ? (1 - (U_PO4 * S_Cr) / (S_PO4 * U_Cr)) * 100 : null;

/* anion gap (serum) = Na + K – Cl – HCO3 [mmol/L] */
const AG_serum = (Na, K, Cl, HCO3) => (Na && Cl && HCO3)
       ? ((Na + (K || 0)) - Cl - HCO3) : null;

/* anion gap (urine) = U_Na + U_K – U_Cl [mmol/L] */
const AG_urine = (U_Na, U_K, U_Cl) => (U_Na && U_Cl)
       ? ((U_Na + (U_K || 0)) - U_Cl) : null;

/* wskaźnik K/(K+Na) w moczu (%) */
const K_frac = (U_K, U_Na) => (U_K && U_Na) ? U_K / (U_K + U_Na) * 100 : null;

/* KT/V (jedno-zabiegowy uproszczony dializacyjny): K – klirens mocznika,
   t – czas dializy (h), V – TBW; tu przyjmujemy K = CG‑ClCr, t = 4 h,
   V = 0.6 * kg; –> możesz dostosować wg ośrodka */
const KT_V = (ClCr, kg, tHrs = 4) => (ClCr && kg)
       ? (ClCr * tHrs * 60) / (0.6 * kg) : null;

/* ---------- 5.3 PRZELICZANIE I WYŚWIETLANIE ---------- */
const $ = id => document.getElementById(id);
document.querySelectorAll('#clcrForm input, #clcrForm select')
        .forEach(el => el.addEventListener('input', update));

// Maksymalne realistyczne wartości dla pól liczbowych – używane do walidacji
const maxValues = {
  age: 120,
  weight: 300,
  height: 250,
  Scr: 20,
  Ucr: 500,
  V24: 10000,
  S_Na: 200,
  S_K: 10,
  S_Cl: 200,
  S_HCO3: 50,
  S_PO4: 20,
  S_UA: 30,
  U_Na: 300,
  U_K: 200,
  U_Cl: 300,
  U_HCO3: 200,
  U_PO4: 200,
  U_UA: 200,
  U_Ca: 10,
  U_Mg: 100,
  U_Prot: 5000,
  U_Alb: 5000,
  U_ACR: 20000
};

// Krótkie opisy dla każdej zmiennej; używane w dymkach informacyjnych
const infoTexts = {
  fullName: 'Imię i nazwisko pacjenta.',
  age: 'Wiek pacjenta w latach.',
  sex: 'Płeć pacjenta (M – mężczyzna, F – kobieta).',
  weight: 'Masa ciała w kilogramach, używana w obliczeniach BSA i Cockcroft–Gault.',
  height: 'Wzrost w centymetrach, używany w obliczeniach BSA.',
  Scr: 'Stężenie kreatyniny w surowicy; potrzebne do obliczeń klirensu i eGFR.',
  Ucr: 'Stężenie kreatyniny w moczu z dobowej zbiórki; niezbędne do obliczenia klirensu.',
  V24: 'Objętość dobowej zbiórki moczu w mililitrach.',
  S_Na: 'Stężenie sodu w surowicy (mmol/L).',
  S_K: 'Stężenie potasu w surowicy (mmol/L).',
  S_Cl: 'Stężenie chlorków w surowicy (mmol/L).',
  S_HCO3: 'Stężenie wodorowęglanów w surowicy (mmol/L).',
  S_PO4: 'Stężenie fosforanów w surowicy (mg/dl).',
  S_UA: 'Stężenie kwasu moczowego w surowicy (mg/dl).',
  U_Na: 'Stężenie sodu w moczu (mmol/L).',
  U_K: 'Stężenie potasu w moczu (mmol/L).',
  U_Cl: 'Stężenie chlorków w moczu (mmol/L).',
  U_HCO3: 'Stężenie wodorowęglanów w moczu (mmol/L).',
  U_PO4: 'Stężenie fosforanów w moczu (mg/dl).',
  U_UA: 'Stężenie kwasu moczowego w moczu (mg/dl).',
  U_Ca: 'Stężenie wapnia w moczu (mmol/L).',
  U_Mg: 'Stężenie magnezu w moczu (mg/L).',
  U_Prot: 'Białko całkowite wydalone w moczu w ciągu 24 godzin (mg).',
  U_Alb: 'Stężenie albuminy w próbce moczu (mg/L); używane do obliczenia ACR.',
  U_ACR: 'Stosunek albuminy do kreatyniny (mg/g), obliczany automatycznie.'
  ,
  /* Dodatkowe pola bez opisu w oryginalnej tabeli */
  ScrUnit: 'Jednostka stężenia kreatyniny w surowicy (mg/dl lub µmol/L).'
  ,
  /* Pola zaawansowanych obliczeń KT/V i opcje raportu AI */
  ktvToggle: 'Zaznacz to pole, aby pokazać sekcję zaawansowanych obliczeń KT/V.',
  ktvTime:   'Czas trwania pojedynczej sesji dializy w godzinach (t, h).',
  ktvUF:     'Ubytek masy podczas dializy, czyli ultrafiltracja, w kilogramach (UF, kg).',
  ktvW:      'Masa ciała pacjenta po zakończeniu dializy, w kilogramach (W, kg).',
  UreaPre:   'Stężenie mocznika we krwi przed rozpoczęciem dializy (mg/dl).',
  UreaPost:  'Stężenie mocznika we krwi po zakończeniu dializy (mg/dl).',
  includeKTV:'Zaznacz to pole, aby dołączyć obliczone wyniki KT/V w raporcie AI.'
};

// Po załadowaniu dokumentu dodaj elementy walidacyjne i ikony informacyjne
document.addEventListener('DOMContentLoaded', () => {
  // Dodaj kontener na komunikat walidacyjny pod każdym polem liczbowym
  document.querySelectorAll('#clcrForm input[type="number"]').forEach(input => {
    const msg = document.createElement('div');
    msg.className = 'validation-message';
    input.parentNode.appendChild(msg);
  });
  // Dodaj ikony informacyjne do etykiet
  // (Ten kod został dezaktywowany, gdyż nowe przyciski Info generują dymki automatycznie)
  /*
  Object.keys(infoTexts).forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      const label = el.closest('label');
      if (label && !label.querySelector('.info-icon')) {
        const icon = document.createElement('span');
        icon.className = 'info-icon';
        icon.title = infoTexts[id];
        icon.textContent = 'ℹ️';
        // Znajdź pierwszy element formularza w etykiecie i wstaw ikonę przed nim
        const firstFormEl = label.querySelector('input, select, textarea');
        if (firstFormEl) {
          label.insertBefore(icon, firstFormEl);
        } else {
          label.appendChild(icon);
        }
      }
    }
  });
  */
});

// Funkcja walidująca pojedyncze pole. Zwraca true, jeśli poprawne.
function validateField(input) {
  const id = input.id;
  const val = parseFloat(input.value);
  const msg = input.parentNode.querySelector('.validation-message');
  // Jeżeli pole puste, usuń błąd
  if (!input.value) {
    if (msg) msg.textContent = '';
    input.classList.remove('error');
    return true;
  }
  if (isNaN(val)) {
    if (msg) msg.textContent = 'Nieprawidłowa liczba';
    input.classList.add('error');
    return false;
  }
  if (val < 0) {
    if (msg) msg.textContent = 'Wartość nie może być ujemna';
    input.classList.add('error');
    return false;
  }
  // Specjalny przypadek dla kreatyniny w surowicy – uwzględnij jednostkę
  if (id === 'Scr') {
    let mgdlVal = val;
    const unitEl = document.getElementById('ScrUnit');
    const unit = unitEl ? unitEl.value : 'mg/dl';
    if (unit === 'umol') mgdlVal = val / 88.4;
    if (maxValues.Scr !== undefined && mgdlVal > maxValues.Scr) {
      if (msg) msg.textContent = 'Wartość wydaje się zbyt wysoka';
      input.classList.add('error');
      return false;
    }
  } else if (maxValues[id] !== undefined && val > maxValues[id]) {
    if (msg) msg.textContent = 'Wartość wydaje się zbyt wysoka';
    input.classList.add('error');
    return false;
  }
  if (msg) msg.textContent = '';
  input.classList.remove('error');
  return true;
}

function update() {
  const fullName = $('fullName').value.trim();
  $('patientName').textContent = fullName || '';
  const age    = +$('age').value;
  const sex    = $('sex').value;
  const weight = +$('weight').value;
  const height = +$('height').value;
  // Przeliczanie kreatyniny w surowicy z uwzględnieniem wybranej jednostki.
  const scrInput = +$('Scr').value;
  const scrUnit  = $('ScrUnit') ? $('ScrUnit').value : 'mg/dl';
  const Scr    = (scrInput && scrUnit === 'umol') ? (scrInput / 88.4) : scrInput;
  const Ucr    = +$('Ucr').value;
  const U_Alb  = +$('U_Alb').value;        // albumina w moczu (mg/L)

  /* ----------  ACR: automatyczne wyliczenie ---------- */
  const manualACR = +$('U_ACR').value;     // ewentualna wartość wpisana ręcznie
  let   ACR = manualACR;
  if (!ACR && U_Alb && Ucr) {
    // przelicz albuminę z mg/L → mg/dl (÷10), następnie mg/g kreatyniny (×1000 / Ucr)
    const Alb_mg_dl = U_Alb / 10;
    ACR = (Alb_mg_dl * 1000) / Ucr;
    // wpisz do pola (z 1 miejscem po przecinku); readonly → pokazujemy wynik userowi
    $('U_ACR').value = ACR.toFixed(1);
  }
  const V24    = +$('V24').value;

  // Walidacja wszystkich pól liczbowych. Jeżeli istnieje błąd, ukrywamy wyniki.
  document.querySelectorAll('#clcrForm input[type="number"]').forEach(el => validateField(el));
  if (document.querySelector('#clcrForm .error')) {
    $('results').style.display = 'none';
    $('elecCard').style.display = 'none';
    return;
  }

  const coreReady = age && weight && height && Scr;  // baza do klirensu
  const somethingReady = [...document.querySelectorAll('#clcrForm input')].some(el => el.value);
  if (!somethingReady) {
    $('results').style.display = 'none';
    return; // nic nie wpisano
  }

  const BSA = BSA_DuBois(weight, height);
  let clHtml = `<div class="result-box"><strong>Powierzchnia ciała</strong> ${BSA.toFixed(2)} m²</div>`;

  /* === Funkcja do wstawiania wyników z normą i kolorem === */
  function clBox(label, val, unit = '', code) {
    if (val === null || isNaN(val)) return;
    const ageGroup = age < 18 ? 'child' : (age < 65 ? 'adult' : 'senior');
    const rangeSet = clRefRanges[code]?.[ageGroup] || null;
    let inRange = true;
    let rangeText = '';
    if (rangeSet) {
      const lo = (rangeSet.min !== undefined) ? rangeSet.min : '';
      const hi = (rangeSet.max !== undefined) ? rangeSet.max : '';
      rangeText = ` (<span class="range">${lo !== '' ? lo : '–'}‑${hi !== '' ? hi : '–'}${unit}</span>)`;
      if ((rangeSet.min !== undefined && val < rangeSet.min) || (rangeSet.max !== undefined && val > rangeSet.max)) {
        inRange = false;
      }
    }
    clHtml += `<div class="result-box${inRange ? '' : ' out-of-range'}"><strong>${label}:</strong> ${val.toFixed(0)}${unit}${rangeText}</div>`;
  }

  /* — Klirens dobowy — */
  // Klirens kreatyniny z dobowej zbiórki moczu (ml/min/1.73 m²)
  if (Ucr && V24 && Scr && BSA) {
    const cl24 = clCr24h(Ucr, V24, Scr, BSA);
    clBox('Klirens 24 h (DZM)', cl24, ' ml/min/1.73 m²', 'cl24');
  }
  /* — Cockcroft‑Gault — */
  const cg = clCrCG(sex, age, weight, Scr);
  clBox('Cockcroft–Gault', cg, ' ml/min', 'cg');

  /* — Cockcroft‑Gault znormalizowany do 1,73 m² — */
  if (BSA) {
    const cgNorm = cg * 1.73 / BSA;          // przeliczenie jak w 24‑h klirensie
    clBox('Cockcroft–Gault (1,73 m²)', cgNorm, ' ml/min/1.73 m²', 'cg');
  }

  /* — aktualny eGFR CKD‑EPI — */
  // Wzór CKD‑EPI (NEJM 2021; KDIGO 2022) jest wykorzystywany jako domyślny.
  // Starsza wersja (bez współczynnika 1.012 dla kobiet) została usunięta.
  const egfr = eGFR_CKD_EPI_2022(sex, age, Scr);
  clBox('eGFR (CKD‑EPI)', egfr, ' ml/min/1.73 m²', 'egfr');

  /* — Klasyfikacja PChN (KDIGO) — */
  let stageDesc = '', stageClass = '';
  if (egfr >= 90) {
    stageDesc = 'G1 – prawidłowa funkcja';
  } else if (egfr >= 60) {
    stageDesc = 'G2 – łagodne ↓';
  } else if (egfr >= 45) {
    stageDesc = 'G3a – umiarkowane ↓';
    stageClass = 'warn-yellow';
  } else if (egfr >= 30) {
    stageDesc = 'G3b – umiark./ciężkie ↓';
    stageClass = 'warn-orange';
  } else if (egfr >= 15) {
    stageDesc = 'G4 – ciężkie ↓';
    stageClass = 'out-of-range';
  } else {
    stageDesc = 'G5 – niewydolność (dializa)';
    stageClass = 'out-of-range';
  }
  clHtml += `<div class="result-box${stageClass ? ' ' + stageClass : ''}"><strong>Klasyfikacja PChN (KDIGO):</strong> ${stageDesc}</div>`;

  /* ---------  Albuminuria KDIGO (A1–A3)  --------- */
  let albuminDesc = null, albuminClass = '';
  if (ACR) {
    if (ACR < 30) {
      albuminDesc = 'A1 – <30 mg/g (prawidłowa)';
    } else if (ACR <= 300) {
      albuminDesc = 'A2 – 30‑300 mg/g (umiarkowana)';
      albuminClass = 'warn-yellow';
    } else {
      albuminDesc = 'A3 – >300 mg/g (znaczna)';
      albuminClass = 'out-of-range';
    }
    clHtml += `<div class="result-box ${albuminClass}"><strong>Albuminuria (KDIGO):</strong> ${albuminDesc}</div>`;
  }

  /* ---------  Pełna klasyfikacja Gx/Ax  --------- */
  if (stageDesc && albuminDesc) {
    const gCode = stageDesc.split(' ')[0];  // np. G3a
    const aCode = albuminDesc.split(' ')[0]; // np. A2
    clHtml += `<div class="result-box"><strong>Pełna klasyfikacja KDIGO:</strong> ${gCode}/${aCode}</div>`;
  }

  /* — Schwartz (jeśli <18 l.) — */
  if (age < 18) {
    /* klasyczny Schwartz ze zmiennym k */
    const { gfr: schVar, k: kVar } = clCrSchwartzVar(height, Scr, age, sex);
    clBox(`Schwartz (k=${kVar})`, schVar, ' ml/min/1.73 m²', 'sch');
    /* Bedside Schwartz IDMS */
    const { gfr: schIDMS } = clCrSchwartzIDMS(height, Scr);
    clBox('Schwartz Bedside IDMS (k = 0,413)', schIDMS,
      ' ml/min/1.73 m²', 'sch');
  }
  // Show the Klirens / eGFR results only when the essential core parameters have been provided.
  // Without this guard the card could appear with no values (for example when toggling
  // advanced KT/V without entering basic data).  We explicitly set the results display
  // based on the ``coreReady`` flag computed above.
  if (coreReady) {
    $('clcrInfo').innerHTML = clHtml;
    $('results').style.display = 'grid';
  } else {
    // Clear any previous content and hide the results card entirely until basic inputs are ready
    $('clcrInfo').innerHTML = '';
    $('results').style.display = 'none';
  }

  /* ----------  RACHUNEK ELEKTROLITÓW  ---------- */
  const U_Cr = +$('Ucr').value;  // kreatynina w moczu (mg/dl)
  // V24 already defined above
  const kg = weight;

  /* ––– wartości z nowych pól ––– */
  const U_UA  = +$('U_UA').value,  S_UA  = +$('S_UA').value;
  const U_Ca  = +$('U_Ca').value;
  const U_Mg  = +$('U_Mg').value;
  const U_PO4 = +$('U_PO4').value, S_PO4 = +$('S_PO4').value;
  const U_Na  = +$('U_Na').value,  S_Na  = +$('S_Na').value;
  const U_K   = +$('U_K').value,   S_K   = +$('S_K').value;
  const U_Cl  = +$('U_Cl').value,  S_Cl  = +$('S_Cl').value;
  const U_HCO3= +$('U_HCO3').value, S_HCO3 = +$('S_HCO3').value;
  const U_Prot= +$('U_Prot').value;

  // --- Przeliczanie jednostek dla pól z nowymi jednostkami ---
  // Wapń podawany w mmol/L konwertujemy na mg/dl: 1 mmol Ca ≈ 40 mg,
  // a 1 L = 10 dL, więc mg/dl = (mmol/L × 40) / 10 = mmol/L × 4
  const U_Ca_mgdl = U_Ca ? U_Ca * 4 : null;
  // Magnez podawany w mg/L konwertujemy na mg/dl (1 L = 10 dL)
  const U_Mg_mgdl = U_Mg ? U_Mg / 10 : null;

  /* --- WYDALANIA mg/kg/d --- */
  const UA_mgkg  = excr_mgkg(U_UA, V24, kg);
  // Ca i Mg wprowadzane odpowiednio w mmol/L i mg/L – przeliczamy je na mg/dl
  const Ca_mgkg  = excr_mgkg(U_Ca_mgdl, V24, kg);
  const Mg_mgkg  = excr_mgkg(U_Mg_mgdl, V24, kg);
  const PO4_mgkg = excr_mgkg(U_PO4, V24, kg);
  // Białko całkowite podawane w mg/24 h – dla mg/kg/d dzielimy przez masę ciała
  const Prot_mgkg= (U_Prot && kg) ? U_Prot / kg : null;

  /* --- WYDALANIA mmol/d --- */
  const Na_mmol_d = excr_mmol_d(U_Na, V24);
  const K_mmol_d  = excr_mmol_d(U_K, V24);

  /* --- WSKAŹNIKI / RATIO --- */
  const KM_Cr = ratio(U_UA, U_Cr);
  // Ca/Cr: używamy przeliczonego Ca w mg/dl
  const Ca_Cr = ratio(U_Ca_mgdl, U_Cr);
  // Stosunek magnezu do wapnia (Mg/Ca): obie wartości w mg/dl
  const Mg_Ca = (U_Mg_mgdl && U_Ca_mgdl) ? U_Mg_mgdl / U_Ca_mgdl : null;
  const PO4_Cr = ratio(U_PO4, U_Cr);
  // Białko/kreatynina: białko w mg/24h, kreatynina w mg/dl → konwersja kreatyniny na mg/24h
  // mg kreatyniny/24h = U_Cr (mg/dl) * V24 (ml) / 100 (ml per dl)
  const B_Cr  = (U_Prot && U_Cr && V24) ? U_Prot / ((U_Cr * V24) / 100) : null;
  const K_KNa = K_frac(U_K, U_Na);

  /* --- FRAKCJE I LUKI --- */
  const TRPpct    = TRP(U_PO4, S_PO4, U_Cr, Scr);
  const FENa_pct  = FE(U_Na, S_Na, U_Cr, Scr);
  const FEHCO3_pct= FE(U_HCO3, S_HCO3, U_Cr, Scr);
  const AGs = AG_serum(S_Na, S_K, S_Cl, S_HCO3);
  const AGu = AG_urine(U_Na, U_K, U_Cl);

  // Frakcja wydalnicza potasu i chlorków – obliczana analogicznie do FENa.
  const FEK_pct  = FE(U_K, S_K, U_Cr, Scr);
  const FECl_pct = FE(U_Cl, S_Cl, U_Cr, Scr);

  /* --- KT/V (orientacyjnie) --- */
  const ktv = KT_V(cg, kg);  // używamy Cockcroft‑Gault jako K

  /* --- BUDUJEMY HTML --- */
  let ehtml = '';

  function box(label, val, unit = '', code) {
    if (val === null || isNaN(val)) return;
    // Zamieniamy twarde spacje (U+00A0) w etykiecie na zwykłe spacje,
    // aby tekst mógł łamać się w naturalnych miejscach. Jeśli pozostawimy
    // spacje nierozdzielające, cała etykieta staje się jednym długim
    // „słowem”, które może wychodzić poza kontener w wąskim układzie.
    const safeLabel = label.replace(/\u00A0/g, ' ');
    const ageGroup = age < 18 ? 'child' : (age < 65 ? 'adult' : 'senior');
    const rangeSet = refRanges[code]?.[ageGroup] || null;
    let inRange = true;
    let rangeText = '';
    if (rangeSet) {
      const lo = (rangeSet.min !== undefined) ? rangeSet.min : '';
      const hi = (rangeSet.max !== undefined) ? rangeSet.max : '';
      rangeText = ` (<span class="range">${lo !== '' ? lo : '–'}‑${hi !== '' ? hi : '–'}${unit}</span>)`;
      if ((rangeSet.min !== undefined && val < rangeSet.min) || (rangeSet.max !== undefined && val > rangeSet.max)) {
        inRange = false;
      }
    }
    ehtml += `<div class="result-box${inRange ? '' : ' out-of-range'}"><strong>${safeLabel}:</strong> ${val.toFixed(1)} ${unit}${rangeText}</div>`;
  }

  box('Wydalanie kw. moczowego', UA_mgkg, 'mg/kg/d');
  // Rozwinięcie skrótu KM/Cr: stosunek kwasu moczowego do kreatyniny w moczu
  box('KM/Cr (kwas moczowy / kreatynina)', KM_Cr, '');
  // Zastąpienie skrótów opisami zrozumiałymi dla osób spoza branży medycznej.
  // Wydalanie wapnia i stosunek wapnia do kreatyniny
  box('Wydalanie wapnia (Ca)', Ca_mgkg, 'mg/kg/d', 'Ca_mgkg');        box('Stosunek wapnia do kreatyniny (Ca/Cr)', Ca_Cr, '', 'Ca_Cr');
  // Wydalanie magnezu oraz stosunek magnezu do wapnia – rozszerzamy etykiety dla większej czytelności
  // Nowa etykieta „Wydalanie magnezu (Mg)” jasno wskazuje, że chodzi o całkowite wydalanie magnezu w dobowej zbiórce
  // Nowa etykieta „Stosunek magnezu do wapnia (Mg/Ca)” wyjaśnia, że obie wartości w liczniku i mianowniku odnoszą się do stężeń w mg/dl
  box('Wydalanie magnezu (Mg)', Mg_mgkg, 'mg/kg/d', 'Mg_mgkg');                  box('Stosunek magnezu do wapnia (Mg/Ca)', Mg_Ca, '', 'Mg_Ca');
  // Wydalanie fosforanów i stosunek fosforanów do kreatyniny
  box('Wydalanie fosforanów (PO₄)', PO4_mgkg, 'mg/kg/d', 'PO4_mgkg'); box('Stosunek fosforanów do kreatyniny (PO₄/Cr)', PO4_Cr, '', 'PO4_Cr');
  // TRP – reabsorpcja fosforanów (podajemy wyjaśnienie)
  box('Reabsorpcja fosforanów (TRP)', TRPpct, '%', 'TRPpct');
  // Wydalanie sodu i frakcja wydalnicza sodu
  box('Wydalanie sodu (Na)', Na_mmol_d, 'mmol/d', 'Na_mmol_d');       box('Frakcja wydalnicza sodu (FENa)', FENa_pct, '%', 'FENa_pct');
  // Frakcja wydalnicza potasu i chlorków pozostają bez zmian
  box('Frakcja wydalnicza potasu (FEK)', FEK_pct, '%', 'FEK_pct');
  box('Frakcja wydalnicza chlorków (FECl)', FECl_pct, '%', 'FECl_pct');
  // Wydalanie potasu i stosunek potasu do sumy potasu i sodu
  box('Wydalanie potasu (K)', K_mmol_d, 'mmol/d', 'K_mmol_d');        // Wydalanie potasu (K)
  box('Stosunek potasu do sumy potasu i sodu (K/(K+Na))', K_KNa, '%', 'K_frac');
  // Luka anionowa w surowicy i w moczu pozostają bez zmian
  box('Luka anionowa (surowica)', AGs, 'mmol/L', 'AGs');
  box('Luka anionowa (mocz)', AGu, 'mmol/L', 'AGu');
  // Frakcja wodorowęglanów – rozszerzamy opis skrótu
  box('Frakcja wodorowęglanów (HCO₃)', FEHCO3_pct, '%', 'FEHCO3_pct');
  box('Białkomocz', Prot_mgkg, 'mg/kg/d', 'Prot_mgkg');      box('Białko/kreatynina (B/Cr)', B_Cr, '', 'B_Cr');
  // Rozwinięcie skrótu KT/V: stosunek klirensu mocznika do objętości dystrybucji (wartość orientacyjna)
  box('KT/V (klirens mocznika / obj. dystryb., orient.)', ktv, '', 'ktv');

  /* wyświetl lub ukryj kartę */
  $('elecInfo').innerHTML = ehtml;
  $('elecCard').style.display = ehtml ? 'block' : 'none';

  /* ----------  Zaawansowane KT/V  ---------- */
  const advBox   = document.getElementById('ktvFields');
  const advCheck = document.getElementById('ktvToggle');
  if (advBox && advCheck) {
    // Pokaż lub ukryj sekcję z polami KT/V w zależności od zaznaczenia
    advBox.style.display = advCheck.checked ? 'block' : 'none';
    if (advCheck.checked) {
      // Upewnij się, że w sekcji KT/V znajdują się ikony informacyjne przy każdym polu
      const advTips = {
        ktvTime: 'Czas trwania sesji dializy w godzinach (t, h).',
        ktvUF:   'Ubytek masy podczas dializy (ultrafiltracja), w kilogramach (UF, kg).',
        ktvW:    'Masa ciała pacjenta po dializie, w kilogramach (W, kg).',
        UreaPre: 'Stężenie mocznika we krwi przed dializą (mg/dl).',
        UreaPost:'Stężenie mocznika we krwi po dializie (mg/dl).'
      };
      ['ktvTime','ktvUF','ktvW','UreaPre','UreaPost'].forEach(fid => {
        const field = document.getElementById(fid);
        if (field) {
          const lab = field.closest('label');
          if (lab && !lab.querySelector('.info-icon')) {
            const ico = document.createElement('span');
            ico.className = 'info-icon';
            ico.title = advTips[fid] || '';
            ico.textContent = 'ℹ️';
            lab.insertBefore(ico, field);
          }
        }
      });
      // zbierz dane
      const tHrs  = +$('ktvTime').value;
      const UFkg  = +$('ktvUF').value;
      const Wkg   = +$('ktvW').value;
      const pre   = +$('UreaPre').value;
      const post  = +$('UreaPost').value;
      const R     = post && pre ? post / pre : null;

      const spKtv = ktvDaugirdas(R, tHrs, UFkg, Wkg);
      const ekTv  = spKtv ? eKtV(spKtv, tHrs * 60) : null;

      if (spKtv) {
        $('ktvResult').innerHTML = `<strong>KT/V (Daugirdas):</strong> ${spKtv.toFixed(2)}`;
        $('ktvResult').style.display = 'block';
      } else {
        $('ktvResult').style.display = 'none';
      }
      if (ekTv) {
        $('ektvResult').innerHTML = `<strong>eKt/V (wyrównany):</strong> ${ekTv.toFixed(2)}`;
        $('ektvResult').style.display = 'block';
      } else {
        $('ektvResult').style.display = 'none';
      }
    } else {
      // gdy checkbox jest odznaczony, ukryj wyniki KT/V
      if (document.getElementById('ktvResult')) document.getElementById('ktvResult').style.display = 'none';
      if (document.getElementById('ektvResult')) document.getElementById('ektvResult').style.display = 'none';
    }
  }
}


/* ---------- 5.4 EKSPORT PDF (wersja dopracowana – jedna strona) ---------- */
$('downloadPDF').addEventListener('click', async () => {
  // Upewnij się, że wartości są aktualne
  if (typeof update === 'function') update();
  const { jsPDF } = window.jspdf;

  // Przygotuj kontener raportu
  const reportDiv = document.getElementById('pdfReport');
  reportDiv.innerHTML = '';

  // Nagłówek raportu
  const title = document.createElement('h2');
  title.textContent = 'Raport klirensu / eGFR';
  reportDiv.appendChild(title);

  // Dane pacjenta
  const patientSection = document.createElement('div');
  patientSection.className = 'section';
  const patientHeader = document.createElement('h3');
  patientHeader.textContent = 'Dane pacjenta';
  patientSection.appendChild(patientHeader);
  const sexSelect = document.getElementById('sex');
  const sexText = sexSelect?.options[sexSelect.selectedIndex]?.text || '';
  patientSection.innerHTML += `<p><strong>Imię i nazwisko:</strong> ${($('fullName').value || '').trim() || '–'}</p>`;
  patientSection.innerHTML += `<p><strong>Wiek:</strong> ${$('age').value || '–'} lata</p>`;
  patientSection.innerHTML += `<p><strong>Płeć:</strong> ${sexText || '–'}</p>`;
  patientSection.innerHTML += `<p><strong>Masa:</strong> ${$('weight').value || '–'} kg</p>`;
  patientSection.innerHTML += `<p><strong>Wzrost:</strong> ${$('height').value || '–'} cm</p>`;
  reportDiv.appendChild(patientSection);

  // Funkcja pomocnicza kopiująca wynik z kart wyników
  const appendResultsSection = (containerId, sectionTitle) => {
    const src = document.getElementById(containerId);
    if (!src || !src.children || src.children.length === 0) return;
    const section = document.createElement('div');
    section.className = 'section';
    const h3 = document.createElement('h3');
    h3.textContent = sectionTitle;
    section.appendChild(h3);
    Array.from(src.children).forEach(child => {
      const p = document.createElement('p');
      p.className = 'result-item';
      // przenieś klasę out-of-range, jeśli istnieje
      if (child.classList.contains('out-of-range')) p.classList.add('out-of-range');
      // kopiuj HTML etykiety i wartości, zachowując span.range
      p.innerHTML = child.innerHTML;
      section.appendChild(p);
    });
    reportDiv.appendChild(section);
  };
  // Sekcja: Klirens / eGFR
  appendResultsSection('clcrInfo', 'Klirens / eGFR');
  // Sekcja: Inne wskaźniki
  appendResultsSection('elecInfo', 'Inne wskaźniki');

  // Pokaż raport (konieczne do renderowania przez html2canvas)
  reportDiv.style.display = 'block';

  // Ustal margines w mm oraz rozmiary strony
  const margin = 10;
  const page = { w: 210, h: 297 };
  const avail = { w: page.w - margin * 2, h: page.h - margin * 2 };

  // Utwórz canvas z raportu; scale=2 zapewnia wyższą rozdzielczość
  const canvas = await html2canvas(reportDiv, { scale: 2, useCORS: true, backgroundColor: null });

  // Ukryj raport ponownie
  reportDiv.style.display = 'none';

  // Oblicz przeliczniki – piksele na milimetry
  const pxPerMm = canvas.width / avail.w;
  const imgHfull = canvas.height / pxPerMm;
  // Skalowanie, aby obraz zmieścił się w obszarze avail
  const scale = imgHfull > avail.h ? avail.h / imgHfull : 1;
  const imgWmm = avail.w * scale;
  const imgHmm = imgHfull * scale;

  // Utwórz PDF
  const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', compress: true });
  const offsetX = margin + (avail.w - imgWmm) / 2;
  const offsetY = margin + (avail.h - imgHmm) / 2;
  const imgData = canvas.toDataURL('image/png');
  pdf.addImage(imgData, 'PNG', offsetX, offsetY, imgWmm, imgHmm);
  // Nazwa pliku
  const nameSlug = $('fullName').value.trim().replace(/\s+/g, '_');
  const fileName = (nameSlug ? nameSlug + '_' : '') + 'Klirens_VildaClinic.pdf';
  pdf.save(fileName);
});

/* ---------- 5.4b EKSPORT DOCX/RTF (raport tekstowy) ---------- */
// Generuje plik DOCX przy użyciu biblioteki docx, a jeżeli nie jest dostępna – używa prostej wersji HTML w pliku .doc
$('downloadDOCX').addEventListener('click', async () => {
  // upewnij się, że aktualne wyniki są przeliczone
  if (typeof update === 'function') update();
  // przygotuj dane pacjenta
  const sexSelect = document.getElementById('sex');
  const sexText = sexSelect?.options[sexSelect.selectedIndex]?.text || '';
  const patientLines = [
    ['Imię i nazwisko:', ($('fullName').value || '').trim() || '–'],
    ['Wiek:', $('age').value ? $('age').value + ' lata' : '–'],
    ['Płeć:', sexText || '–'],
    ['Masa:', $('weight').value ? $('weight').value + ' kg' : '–'],
    ['Wzrost:', $('height').value ? $('height').value + ' cm' : '–'],
  ];
  // funkcje pomocnicze do pobierania wyników
  function collectResults(containerId) {
    const arr = [];
    const container = document.getElementById(containerId);
    if (!container || !container.children) return arr;
    Array.from(container.children).forEach(child => {
      const text = child.textContent.trim().replace(/\u00A0/g, ' ');
      const isOut = child.classList.contains('out-of-range') || child.classList.contains('warn-orange') || child.classList.contains('warn-yellow');
      arr.push({ text, isOut });
    });
    return arr;
  }
  const clcrResults = collectResults('clcrInfo');
  const elecResults = collectResults('elecInfo');
  // sprawdź, czy biblioteka docx jest dostępna
  if (typeof docx !== 'undefined' && docx.Packer) {
    try {
      const { Document, Paragraph, Packer, TextRun, AlignmentType } = docx;
      const children = [];
      // nagłówek
      children.push(new Paragraph({
        children: [new TextRun({ text: 'Raport klirensu / eGFR', bold: true, size: 32 })],
        alignment: AlignmentType.CENTER,
        spacing: { after: 300 },
      }));
      // dane pacjenta
      children.push(new Paragraph({
        children: [new TextRun({ text: 'Dane pacjenta', bold: true, size: 28 })],
        spacing: { before: 200, after: 100 },
      }));
      patientLines.forEach(([label, value]) => {
        children.push(new Paragraph({
          children: [
            new TextRun({ text: label + ' ', bold: true }),
            new TextRun({ text: value }),
          ],
          spacing: { after: 50 },
        }));
      });
      // sekcje wyników
      function appendDocxSection(title, items) {
        if (!items || items.length === 0) return;
        children.push(new Paragraph({
          children: [new TextRun({ text: title, bold: true, size: 28 })],
          spacing: { before: 200, after: 100 },
        }));
        items.forEach(({ text, isOut }) => {
          children.push(new Paragraph({
            children: [new TextRun({ text: text, color: isOut ? 'C62828' : '000000' })],
            spacing: { after: 50 },
          }));
        });
      }
      appendDocxSection('Klirens / eGFR', clcrResults);
      appendDocxSection('Inne wskaźniki', elecResults);
      // utwórz dokument
      const doc = new Document({
        creator: 'Vilda Clinic',
        description: 'Raport wygenerowany przez kalkulator klirensu kreatyniny / eGFR',
        title: 'Raport klirensu / eGFR',
      });
      doc.addSection({ children });
      const blob = await Packer.toBlob(doc);
      const nameSlug = $('fullName').value.trim().replace(/\s+/g, '_');
      const filename = (nameSlug ? nameSlug + '_' : '') + 'Klirens_VildaClinic.docx';
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      return;
    } catch (e) {
      // jeśli wygenerowanie DOCX się nie powiedzie, przejdź do fallbacku
      console.error('DOCX generation failed, falling back to HTML', e);
    }
  }
  // fallback: wygeneruj prosty dokument HTML/RTF otwieralny w Wordzie
  const htmlParts = [];
  htmlParts.push('<h1 style="text-align:center;">Raport klirensu / eGFR</h1>');
  // dane pacjenta
  htmlParts.push('<h2>Dane pacjenta</h2>');
  patientLines.forEach(([label, value]) => {
    htmlParts.push(`<p><strong>${label}</strong> ${value}</p>`);
  });
  // sekcje wyników
  function appendHtmlSection(title, items) {
    if (!items || items.length === 0) return;
    htmlParts.push(`<h2>${title}</h2>`);
    items.forEach(({ text, isOut }) => {
      const style = isOut ? ' style="color:#c62828;"' : '';
      htmlParts.push(`<p${style}>${text}</p>`);
    });
  }
  appendHtmlSection('Klirens / eGFR', clcrResults);
  appendHtmlSection('Inne wskaźniki', elecResults);
  const htmlContent = `<html><head><meta charset="utf-8"><title>Raport</title></head><body>${htmlParts.join('')}</body></html>`;
  const fallbackBlob = new Blob([String.fromCharCode(0xFEFF) + htmlContent], { type: 'application/msword' });
  const nameSlug2 = $('fullName').value.trim().replace(/\s+/g, '_');
  const fallbackFilename = (nameSlug2 ? nameSlug2 + '_' : '') + 'Klirens_VildaClinic.doc';
  const fallbackUrl = URL.createObjectURL(fallbackBlob);
  const fallbackLink = document.createElement('a');
  fallbackLink.href = fallbackUrl;
  fallbackLink.download = fallbackFilename;
  document.body.appendChild(fallbackLink);
  fallbackLink.click();
  document.body.removeChild(fallbackLink);
  setTimeout(() => URL.revokeObjectURL(fallbackUrl), 1000);
});

/* ---------- 5.4c ZAPYTAJ AI (wysyłanie raportu do modelu językowego) ---------- */
// Ten przycisk tworzy streszczenie raportu i wysyła go do API ChatGPT, aby uzyskać interpretację.
// Aby skorzystać z tej funkcji, należy podać własny klucz API w zmiennej apiKey.
// Więcej informacji: https://platform.openai.com/docs/api-reference/chat/create
$('askAI').addEventListener('click', async () => {
  // Najpierw upewnij się, że wszystkie pola i wyniki są aktualne
  if (typeof update === 'function') update();
  // Zbuduj tekstowy raport na podstawie danych pacjenta i wyników
  const sexSelect = document.getElementById('sex');
  const sexText = sexSelect?.options[sexSelect.selectedIndex]?.text || '';
  const patientInfo = [];
  patientInfo.push(`Imię i nazwisko: ${($('fullName').value || '').trim() || '–'}`);
  patientInfo.push(`Wiek: ${$('age').value || '–'} lata`);
  patientInfo.push(`Płeć: ${sexText || '–'}`);
  patientInfo.push(`Masa: ${$('weight').value || '–'} kg`);
  patientInfo.push(`Wzrost: ${$('height').value || '–'} cm`);
  // Funkcja pomocnicza do zebrania wyników z kontenera
  function collectTexts(id) {
    const arr = [];
    const container = document.getElementById(id);
    if (!container || !container.children) return arr;
    Array.from(container.children).forEach(child => {
      arr.push(child.textContent.trim().replace(/\u00A0/g, ' '));
    });
    return arr;
  }
  const clcrTexts = collectTexts('clcrInfo');
  let elecTexts = collectTexts('elecInfo');
  // Sprawdź, czy użytkownik chce uwzględnić wyniki KT/V w raporcie AI
  const includeKTV = document.getElementById('includeKTV')?.checked;
  if (!includeKTV) {
    // Gdy checkbox nie jest zaznaczony, usuń z listy wszystkie pozycje zawierające „KT/V”
    elecTexts = elecTexts.filter(text => !text.includes('KT/V'));
  } else {
    // Jeśli zaznaczono, dodaj do listy także wyniki zaawansowane (jeśli są obliczone i widoczne)
    const adv1Elem = document.getElementById('ktvResult');
    const adv2Elem = document.getElementById('ektvResult');
    if (adv1Elem && adv1Elem.style.display !== 'none') {
      const txt = adv1Elem.textContent.trim().replace(/\u00A0/g, ' ');
      if (txt) elecTexts.push(txt);
    }
    if (adv2Elem && adv2Elem.style.display !== 'none') {
      const txt2 = adv2Elem.textContent.trim().replace(/\u00A0/g, ' ');
      if (txt2) elecTexts.push(txt2);
    }
  }
  // Scal tekst raportu
  let report = 'Raport klirensu / eGFR\n\n';
  report += 'Dane pacjenta:\n' + patientInfo.join('\n') + '\n\n';
  if (clcrTexts.length > 0) {
    report += 'Klirens / eGFR:\n' + clcrTexts.join('\n') + '\n\n';
  }
  if (elecTexts.length > 0) {
    report += 'Inne wskaźniki:\n' + elecTexts.join('\n') + '\n';
  }
  // Przygotuj treść zapytania do modelu językowego. Obejmuje ona rolę oraz prośbę o interpretację.
  const prompt = [
    'Jesteś asystentem medycznym, który interpretuje raporty laboratoryjne i obliczenia eGFR.',
    'Zinterpretuj następujący raport pacjenta. Podaj krótkie podsumowanie i ewentualne zalecenia:',
    report
  ].join('\n\n');
  const apiKey = '';
  // Jeżeli klucz API nie został ustawiony, przygotuj zapytanie do samodzielnego użycia przez użytkownika
  if (!apiKey) {
    try {
      // Spróbuj skopiować zapytanie do schowka, aby ułatwić wklejenie do ChatGPT
      await navigator.clipboard.writeText(prompt);
      alert('Przygotowano zapytanie do AI. Zostało ono skopiowane do schowka. Wklej je w ChatGPT, aby uzyskać interpretację wyników:\n\n' + prompt);
    } catch (e) {
      // Jeśli kopiowanie do schowka nie jest możliwe (np. z powodów bezpieczeństwa), wyświetl tekst do skopiowania ręcznie
      alert('Przygotowano zapytanie do AI. Z powodu ustawień przeglądarki nie można było automatycznie skopiować tekstu. Skopiuj poniższy tekst ręcznie i wklej go w ChatGPT, aby uzyskać interpretację wyników:\n\n' + prompt);
    }
    return;
  }
  // Jeśli klucz API jest skonfigurowany, wyślij zapytanie do OpenAI i pokaż interpretację.
  const apiUrl = 'https://api.openai.com/v1/chat/completions';
  const payload = {
    model: 'gpt-3.5-turbo',
    messages: [
      { role: 'system', content: 'Jesteś asystentem medycznym, który interpretuje raporty laboratoryjne i obliczenia eGFR.' },
      { role: 'user', content: 'Zinterpretuj następujący raport pacjenta. Podaj krótkie podsumowanie i ewentualne zalecenia:\n\n' + report }
    ],
    temperature: 0.4,
    max_tokens: 400
  };
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify(payload)
    });
    if (!response.ok) {
      throw new Error('Błąd zapytania API: ' + response.status);
    }
    const data = await response.json();
    const answer = data.choices?.[0]?.message?.content || 'Brak odpowiedzi.';
    // Pokaż interpretację w nowym oknie alert (lub w przyszłości w dedykowanym elemencie)
    alert('Interpretacja AI:\n\n' + answer);
  } catch (err) {
    console.error(err);
    alert('Wystąpił błąd podczas łączenia z API. Sprawdź konfigurację i połączenie internetowe.');
  }
});

/* ---------- 5.5 POKAŻ PRZYCISKI EKSPORTU PO WYNIKACH ---------- */
const observer = new MutationObserver(() => {
  const hidden = $('results').style.display === 'none';
  $('downloadPDF').hidden = hidden;
  $('downloadDOCX').hidden = hidden;
  // Sekcja interpretacji AI pokazujemy tylko, gdy są wyniki
  const aiFieldset = document.getElementById('aiFieldset');
  if (aiFieldset) aiFieldset.hidden = hidden;
});
observer.observe($('results'), { attributes: true, attributeFilter: ['style'] });
observer.observe($('elecCard'), { attributes: true, attributeFilter: ['style'] });
</script>

<!-- 6. INFO BUTTONS: automatyczne dodawanie przycisków „Info” oraz dymków narzędziowych -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ------- 3.1 AUTOMATYCZNE DODAWANIE PRZYCISKU INFO (jeśli go brak) ------- */
  document.querySelectorAll('input[id], select[id]').forEach(field => {
    // pomiń, jeśli już przerobione lub brak rodzica
    if (field.parentElement && field.parentElement.classList.contains('input-group')) return;

    const label = field.closest('label');
    if (!label) return;

    /* utwórz kontener .input-group */
    const wrapper = document.createElement('div');
    wrapper.className = 'input-group';

    // wstaw wrapper tuż po label (zachowuje semantykę)
    label.insertAdjacentElement('afterend', wrapper);
    wrapper.appendChild(field);
    // Jeżeli pole jest typu checkbox, umożliwiamy zawijanie przycisku Info pod polem,
    // aby zapobiec wychodzeniu przycisku poza kontener w widoku poziomym.
    if (field.type === 'checkbox') {
      wrapper.classList.add('wrap-info');
      // For specific checkbox fields we want the Info button centered relative to
      // the control. Add a special marker class so CSS can target these wrappers.
      if (field.id === 'ktvToggle' || field.id === 'includeKTV') {
        wrapper.classList.add('center-info');
      }
    }

    /* przycisk Info */
    const btn = document.createElement('button');
    btn.type  = 'button';
    btn.className = 'info-btn';
    btn.textContent = 'Info';
    const tipId = 'tip-' + field.id;
    btn.setAttribute('aria-controls', tipId);
    btn.setAttribute('aria-expanded','false');
    wrapper.appendChild(btn);

    /* tooltip */
    const tooltip = document.createElement('div');
    tooltip.id = tipId;
    tooltip.className = 'tooltip';
    tooltip.setAttribute('role','tooltip');
    tooltip.setAttribute('aria-hidden','true');

    /* treść: z data-info albo z globalnej tablicy infoTexts */
    const customText = field.dataset.info ||
                       (typeof infoTexts === 'object' ? infoTexts[field.id] : '');
    tooltip.textContent = customText || 'Brak opisu.';
    wrapper.appendChild(tooltip);
  });

  /* ------- 3.2 OBSŁUGA PRZYCISKÓW ------- */
  const hideAllTips = () => {
    document.querySelectorAll('.tooltip.visible').forEach(tip => {
      tip.classList.remove('visible');
      tip.setAttribute('aria-hidden','true');
      const btn = document.querySelector(`[aria-controls="${tip.id}"]`);
      if (btn) btn.setAttribute('aria-expanded','false');
    });
  };

  document.addEventListener('click', e => {
    const btn = e.target.closest('.info-btn');
    if (!btn){
      hideAllTips();               /* kliknięcie poza – zamknij */
      return;
    }

    /* kliknięto przycisk Info */
    const tipId    = btn.getAttribute('aria-controls');
    const tooltip  = document.getElementById(tipId);
    if (!tooltip) return;

    const isOpen = tooltip.classList.contains('visible');
    hideAllTips();
    if (!isOpen){
      tooltip.classList.add('visible');
      tooltip.setAttribute('aria-hidden','false');
      btn.setAttribute('aria-expanded','true');
    }
  });

  /* klawisz Esc zamyka dymki */
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') hideAllTips();
  });
});
</script>

<!-- Service worker registration for Progressive Web App functionality -->
<script>
  if ('serviceWorker' in navigator) {
    // Register the service worker after the page has loaded. When online,
    // the registration will check for updates to the service worker script. If a
    // new version is found and installed, the page will reload automatically
    // so that users always see the latest version of the application. This
    // pattern follows Workbox's guidance for handling updates【731475350632385†L1544-L1555】.
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js')
        .then(function(registration) {
          console.log('Service worker registered with scope:', registration.scope);
          // Listen for updates to the service worker. When a new worker is
          // installed and there is already an active controller, reload the page
          // to apply the update. This ensures that the browser checks for a
          // newer version of your app whenever there is an Internet connection.
          registration.onupdatefound = function() {
            const installingWorker = registration.installing;
            if (!installingWorker) return;
            installingWorker.onstatechange = function() {
              if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // If a waiting service worker exists, ask it to skip waiting.
                if (registration.waiting) {
                  registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                }
                // Reload the page to load the new version of the application.
                window.location.reload();
              }
            };
          };
        })
        .catch(function(error) {
          console.error('Service worker registration failed:', error);
        });
    });
  }
</script>
</body>
</html>
